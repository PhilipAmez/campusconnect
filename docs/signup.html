<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign Up - Peerloom</title>
 <link rel="icon" href="/android-chrome-192x192.png" sizes="192x192" type="image/png">
  <link rel="icon" href="/android-chrome-512x512.png" sizes="512x512" type="image/png">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="manifest" href="/site.webmanifest">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <style>
        :root {
            --primary: #7c3aed;
            --secondary: #4f46e5;
            --accent: #a78bfa;
            --text-dark: #1f2937;
            --text-light: #64748b;
            --hover-bg: #f3f4f6;
            --transition: all 0.3s cubic-bezier(.4,0,.2,1);
        }
        body {
            background: linear-gradient(180deg, #f3e8ff 0%, #e0e7ff 100%);
            font-family: 'Segoe UI', 'Inter', Arial, sans-serif;
            min-height: 100vh;
            color: var(--text-dark);
            overflow-x: hidden;
        }
        .navbar {
            position: fixed;
            width: 100%;
            top: 0;
            left: 0;
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.9), rgba(79, 70, 229, 0.9));
            backdrop-filter: blur(5px);
            padding: 0.5rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
            color: white;
            box-shadow: 0 1px 5px rgba(0, 0, 0, 0.05);
        }
        .navbar::before {
            content: '';
            position: absolute;
            top: -20%;
            left: -20%;
            width: 140%;
            height: 140%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            z-index: -1;
            opacity: 0.3;
        }
        .logo img {
            height: 28px;
            transition: transform var(--transition);
        }
        .logo img:hover {
            transform: scale(1.1);
        }
        .nav-links {
            display: flex;
            gap: 1.5rem;
        }
        .nav-link {
            color: white;
            font-weight: 500;
            text-decoration: none;
            padding: 0.5rem 0.8rem;
            border-radius: 0.4rem;
            transition: background 0.2s, color 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .nav-link:hover {
            background: rgba(255, 255, 255, 0.15);
            color: white;
        }
        .auth-title {
            font-style: italic;
            font-weight: 400;
            color: var(--text-dark);
            display: inline-block;
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 0.8rem;
            text-align: center;
            width: 100%;
            margin-bottom: 1.5rem;
        }
        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 1rem;
            padding: 1.5rem;
            max-width: 400px;
            margin: 5rem auto;
            transition: transform 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
        }
        .input-field {
            width: 100%;
            padding: 0.75rem 1rem;
            margin-bottom: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 0.6rem;
            background: rgba(255, 255, 255, 0.2);
            font-size: 1rem;
            color: var(--text-dark);
            transition: border 0.2s;
        }
        .input-field:focus {
            border-color: var(--primary);
            background: rgba(255, 255, 255, 0.3);
            outline: none;
            box-shadow: 0 0 0 2px rgba(167, 139, 250, 0.3);
        }
        .btn {
            font-style: italic;
            font-weight: 400;
            color: var(--text-dark);
            padding: 0.6rem 1.2rem;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 0.5rem;
            cursor: pointer;
            transition: transform 0.2s, background 0.2s;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .btn:hover {
            transform: translateY(-2px);
            background: rgba(255, 255, 255, 0.3);
        }
        .support-button {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 0.5rem;
            padding: 0.7rem 1.3rem;
            color: var(--text-dark);
            font-style: italic;
            font-weight: 400;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: transform 0.3s ease, background 0.3s ease;
            z-index: 1000;
        }
        .support-button:hover {
            transform: translateY(-2px);
            background: rgba(255, 255, 255, 0.3);
        }
        @media (max-width: 480px) {
            .card {
                padding: 1rem;
                margin: 4rem 1rem;
            }
            .input-field {
                padding: 0.7rem;
                font-size: 0.95em;
            }
            .btn {
                padding: 0.5rem 1rem;
                font-size: 0.95rem;
            }
            .support-button {
                padding: 0.5rem 0.8rem;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <a href="index.html" class="logo">
            <img src="../logo.png" alt="Peerloom" onerror="console.warn('Logo not found')">
        </a>
        <div class="nav-links">
            <a href="login.html" class="nav-link"><i class="fas fa-sign-in-alt"></i> Login</a>
            <a href="support.html" class="nav-link"><i class="fas fa-headset"></i> Support</a>
        </div>
    </nav>

    <div class="card">
        <h2 class="auth-title text-xl"><i class="fas fa-user-plus"></i> Sign Up</h2>
        <form id="signupForm">
            <div class="profile-photo-upload" style="display: flex; flex-direction: column; align-items: center; margin-bottom: 1rem;">
                <label for="profilePhoto" style="cursor:pointer;">
                    <img id="profilePhotoPreview" src="https://ui-avatars.com/api/?name=User&background=random&rounded=true" alt="Profile Photo" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 2px solid #a78bfa;">
                    <input type="file" id="profilePhoto" accept="image/*" style="display:none;">
                </label>
                <span style="font-size: 0.9em; color: var(--text-light); margin-top: 0.5rem;">Upload profile photo</span>
            </div>
            <input type="text" id="firstName" class="input-field" placeholder="First name" required>
            <input type="text" id="lastName" class="input-field" placeholder="Last name" required>
            <input type="text" id="username" class="input-field" placeholder="Username (e.g., @charles_fx)" pattern="^@?\w{3,}$" title="Start with @ or a letter, at least 3 characters, only letters, numbers, and underscores." required>
            <input type="tel" id="contact" class="input-field" placeholder="Contact - phone or WhatsApp" required>
            <select id="campus" class="input-field" required>
                <option value="" disabled selected>Select your campus</option>
                <option value="University of Ghana">University of Ghana</option>
                <option value="Kwame Nkrumah University of Science and Technology">Kwame Nkrumah University of Science and Technology</option>
                <option value="Ashesi University">Ashesi University</option>
                <option value="Presbyterian Boys' Secondary School (PRESEC)">Presbyterian Boys' Secondary School (PRESEC)</option>
                <option value="Wesley Girls' High School">Wesley Girls' High School</option>
                <option value="Achimota School">Achimota School</option>
                <option value="Mfantsipim School">Mfantsipim School</option>
                <option value="Adisadel College">Adisadel College</option>
                <option value="St. Augustine's College">St. Augustine's College</option>
                <option value="Opoku Ware School">Opoku Ware School</option>
                <option value="KNUST Senior High School">KNUST Senior High School</option>
                <option value="Tema International School">Tema International School</option>
                <option value="SOS-Hermann Gmeiner International College">SOS-Hermann Gmeiner International College</option>
                <option value="Ghana International School">Ghana International School</option>
                <option value="University of Oxford">University of Oxford</option>
                <option value="Harvard University">Harvard University</option>
                <option value="Massachusetts Institute of Technology">Massachusetts Institute of Technology</option>
                <option value="Stanford University">Stanford University</option>
                <option value="Yale University">Yale University</option>
                <option value="Other">Other (Type Your School)</option>
            </select>
            <input type="text" id="customCampus" class="input-field" placeholder="Type your school" style="display:none; margin-bottom: 1rem;">
            <select id="level" class="input-field" required>
                <option value="" disabled selected>Select your level</option>
                <option value="JHS 1">JHS 1</option>
                <option value="JHS 2">JHS 2</option>
                <option value="JHS 3">JHS 3</option>
                <option value="SHS 1">SHS 1</option>
                <option value="SHS 2">SHS 2</option>
                <option value="SHS 3">SHS 3</option>
                <option value="University 1st Year">University 1st Year</option>
                <option value="University 2nd Year">University 2nd Year</option>
                <option value="University 3rd Year">University 3rd Year</option>
                <option value="University 4th Year">University 4th Year</option>
                <option value="University 5th Year">University 5th Year</option>
                <option value="Master’s / PhD">Master’s / PhD</option>
                <option value="Other">Other (Type Your Level)</option>
            </select>
            <input type="text" id="customLevel" class="input-field" placeholder="Type your level" style="display:none; margin-bottom: 1rem;">
            <input type="email" id="email" class="input-field" placeholder="Email" required>
            <input type="password" id="password" class="input-field" placeholder="Password" required>
            <input type="password" id="confirmPassword" class="input-field" placeholder="Confirm Password" required>
            <button type="submit" class="btn">Sign Up</button>
        </form>
        <p class="text-center mt-4">Already have an account? <a href="login.html" class="text-purple-600">Login</a></p>
    </div>

    <a href="support.html" class="support-button">
        <i class="fas fa-headset"></i>
        <span>Support</span>
    </a>

    <script type="module" src="js/supabaseClient.js"></script>
    <script type="module">
        import { supabase } from './js/supabaseClient.js'
        import './js/toast.js';

        // Preview selected profile photo
        const profilePhotoInput = document.getElementById('profilePhoto');
        const profilePhotoPreview = document.getElementById('profilePhotoPreview');

        profilePhotoInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(evt) {
                profilePhotoPreview.src = evt.target.result;
            };
            reader.readAsDataURL(file);
        });

        // Auto-generate initials avatar if no photo is uploaded
        function generateInitialsAvatar(firstName, lastName) {
            const initials = ((firstName?.[0] || '') + (lastName?.[0] || '')).toUpperCase();
            // Use ui-avatars.com for a circular avatar with initials
            return `https://ui-avatars.com/api/?name=${encodeURIComponent(initials)}&background=random&rounded=true`;
        }

        const form = document.getElementById('signupForm');

        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const firstName = document.getElementById('firstName').value.trim();
            const lastName = document.getElementById('lastName').value.trim();
            const username = document.getElementById('username').value.trim();
            const contact = document.getElementById('contact').value.trim();
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const campusSelect = document.getElementById('campus');
            const customCampusInput = document.getElementById('customCampus');
            const campus = campusSelect.value === 'Other' ? customCampusInput.value.trim() : campusSelect.value;
            const levelSelect = document.getElementById('level');
            const customLevelInput = document.getElementById('customLevel');
            const level = levelSelect.value === 'Other' ? customLevelInput.value.trim() : levelSelect.value;

            if (password !== confirmPassword) {
                return alert('Passwords do not match.');
            }

            // 1. Upload profile photo to Supabase Storage (if selected)
            let profilePhotoUrl = '';
            if (profilePhotoInput.files.length > 0) {
                const file = profilePhotoInput.files[0];
                const fileExt = file.name.split('.').pop();
                const filePath = `avatars/${Date.now()}_${Math.random().toString(36).substr(2, 8)}.${fileExt}`;
                const { data: uploadData, error: uploadError } = await supabase.storage
                    .from('avatars')
                    .upload(filePath, file, { cacheControl: '3600', upsert: false });
                if (uploadError) {
                    alert('Profile photo upload failed: ' + uploadError.message);
                    return;
                }
                // Get public URL
                const { data: urlData } = supabase.storage.from('avatars').getPublicUrl(filePath);
                profilePhotoUrl = urlData.publicUrl;
            } else {
                // No photo uploaded, use initials avatar
                profilePhotoUrl = generateInitialsAvatar(firstName, lastName);
            }

            // 2. Add profilePhotoUrl to both signUp and profile insert
            const { data: signUpData, error: signUpError } = await supabase.auth.signUp({
                email,
                password,
                options: {
                    data: {
                        firstName,
                        lastName,
                        username,
                        contact,
                        profilePhoto: profilePhotoUrl,
                        campus,
                        level
                    }
                }
            });

            if (signUpError) {
                console.error('Sign up error:', signUpError);
                return alert('Sign up failed: ' + signUpError.message);
            }

            const newUser = signUpData.user;

            if (!newUser) {
                alert('Sign-up initiated! Check your inbox to verify your email. You will be able to log in after verification.');
                window.location = 'login.html';
                return;
            }

            const fullName = `${firstName} ${lastName}`.trim();

            const { data: profileData, error: profileError } = await supabase
                .from('profiles')
                .insert({
                    id: newUser.id,
                    full_name: fullName,
                    username,
                    contact: contact,
                    email: newUser.email,
                    profile_photo: profilePhotoUrl,
                    campus,
                    level
                });

            if (profileError) {
                console.error('Profile insertion error:', profileError);
                alert('Sign-up successful, but there was an error saving your profile details: ' + profileError.message);
                window.location = 'login.html';
                return;
            }

            alert('Sign-up successful! Check your inbox to verify your email, then log in.');
            window.location = 'login.html';
        });

        // Show/hide custom campus input
        const campusSelect = document.getElementById('campus');
        const customCampusInput = document.getElementById('customCampus');
        campusSelect.addEventListener('change', function() {
            if (this.value === 'Other') {
                customCampusInput.style.display = '';
                customCampusInput.required = true;
            } else {
                customCampusInput.style.display = 'none';
                customCampusInput.required = false;
            }
        });

        // Show/hide custom level input
        const levelSelect = document.getElementById('level');
        const customLevelInput = document.getElementById('customLevel');
        levelSelect.addEventListener('change', function() {
            if (this.value === 'Other') {
                customLevelInput.style.display = '';
                customLevelInput.required = true;
            } else {
                customLevelInput.style.display = 'none';
                customLevelInput.required = false;
            }
        });
    </script>
</body>
</html>
