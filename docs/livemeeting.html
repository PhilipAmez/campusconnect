<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>PeerLoom â€¢ Live Class</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/js/all.min.js"></script>
  <script src="https://download.agora.io/sdk/release/AgoraRTC_N-4.18.2.js"></script>
  <script type="module" src="js/supabaseClient.js"></script>
  <style>
    :root {
      --glass-bg: rgba(255, 255, 255, 0.12);
      --glass-blur: blur(28px);
      --glass-border: rgba(255, 255, 255, 0.18);
      --accent-green: #00ff94;
      --accent-blue: #4dabf7;
      --accent-purple: #9775fa;
      --accent-yellow: #FFD43B;
      --red: #FF3B30;
      --shadow: 0 12px 32px rgba(0,0,0,0.4);
      --top-bar-height: 60px;
      --bg-color: #000;
      --text-color: #fff;
      --tile-bg: #111;
      --name-tag-bg: rgba(0,0,0,0.7);
      --liquid-shadow: 0 8px 32px rgba(77, 171, 247, 0.3);
    }
    body.light-mode {
      --bg-color: #f8fafc;
      --text-color: #1e293b;
      --tile-bg: #ffffff;
      --name-tag-bg: rgba(255,255,255,0.9);
      --glass-bg: rgba(255, 255, 255, 0.7);
      --glass-border: rgba(0, 0, 0, 0.1);
      --shadow: 0 12px 32px rgba(0,0,0,0.1);
      --chat-bg: rgba(255, 255, 255, 0.98);
      --chat-message-bg: rgba(255, 255, 255, 0.9);
      --chat-self-bg: linear-gradient(135deg, #4dabf7, #9775fa);
      --chat-ai-card-bg: rgba(255, 255, 255, 0.95);
      --input-bg: rgba(255, 255, 255, 0.95);
      --input-border: rgba(0, 0, 0, 0.1);
      --input-focus-border: rgba(77, 171, 247, 0.5);
    }
    body.dark-mode {
      --chat-bg: rgba(10, 15, 30, 0.95);
      --chat-message-bg: rgba(30, 41, 59, 0.4);
      --chat-self-bg: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
      --chat-ai-card-bg: rgba(15, 23, 42, 0.85);
      --input-bg: rgba(15, 23, 42, 0.9);
      --input-border: rgba(255, 255, 255, 0.15);
      --input-focus-border: rgba(77, 171, 247, 0.5);
    }
    body { 
      margin: 0; padding: 0; 
      height: 100vh; 
      background: var(--bg-color); 
      color: var(--text-color); 
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
      overflow: hidden; 
      touch-action: manipulation; 
      transition: background 0.3s ease, color 0.3s ease;
      -webkit-tap-highlight-color: transparent;
    }
    
    /* Login Modal for External Users */
    .login-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.9);
      backdrop-filter: blur(10px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      opacity: 1;
      transition: opacity 0.3s ease;
    }
    
    .login-modal.hidden {
      opacity: 0;
      pointer-events: none;
    }
    
    .login-content {
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      border-radius: 24px;
      padding: 40px;
      width: 90%;
      max-width: 400px;
      text-align: center;
      box-shadow: var(--shadow);
    }
    
    /* Video Container */
    #video-container { 
      position: absolute; 
      inset: 0; 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); 
      gap: 12px; 
      padding: calc(var(--top-bar-height) + 30px) 16px 200px; 
      transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 1;
    }
    
    /* Presentation Mode */
    .presentation-mode {
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      grid-auto-rows: auto;
      padding: calc(var(--top-bar-height) + 20px) 16px 200px;
    }
    
    .presentation-mode .video-tile:first-child {
      grid-column: 1 / -1;
      width: 100%;
      height: 450px;
      border-radius: 24px;
      margin-bottom: 16px;
    }
    
    .presentation-mode .video-tile:not(:first-child) { 
      height: 120px; 
      min-width: 160px;
      opacity: 0.85;
      transition: all 0.3s ease;
      border-radius: 16px;
    }
    
    .presentation-mode .video-tile:not(:first-child):hover {
      opacity: 1;
      transform: scale(1.05);
    }
    
    /* Video Tiles with Active Speaker Pulse */
    .video-tile { 
      background: var(--tile-bg); 
      border-radius: 16px; 
      overflow: hidden; 
      position: relative; 
      box-shadow: var(--shadow); 
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); 
      border: 2px solid transparent;
    }
    .video-tile video {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .video-tile.active-speaker {
      border-color: var(--accent-blue);
      animation: pulse-speaker 2s infinite ease-in-out;
    }
    
    @keyframes pulse-speaker {
      0%, 100% { 
        box-shadow: 0 0 0 0 rgba(77, 171, 247, 0.4);
        border-color: var(--accent-blue);
      }
      50% { 
        box-shadow: 0 0 0 8px rgba(77, 171, 247, 0);
        border-color: var(--accent-purple);
      }
    }
    
    .video-tile.hand-raised {
      border-color: var(--accent-yellow);
      animation: pulse-hand 2s infinite;
    }
    
    @keyframes pulse-hand {
      0%, 100% { box-shadow: 0 0 0 0 rgba(255, 212, 59, 0.4); }
      50% { box-shadow: 0 0 0 10px rgba(255, 212, 59, 0); }
    }
    
    .video-tile.screen-sharing {
      border-color: var(--accent-green);
      animation: pulse-screen 2s infinite;
    }
    
    @keyframes pulse-screen {
      0%, 100% { box-shadow: 0 0 0 0 rgba(0, 255, 148, 0.4); }
      50% { box-shadow: 0 0 0 8px rgba(0, 255, 148, 0); }
    }
    
    .video-placeholder {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, var(--accent-purple), var(--accent-blue));
    }
    
    /* Name Tag */
    .name-tag { 
      position: absolute; 
      bottom: 12px; 
      left: 12px; 
      background: var(--name-tag-bg); 
      backdrop-filter: blur(12px); 
      padding: 6px 14px; 
      border-radius: 20px; 
      font-size: 13px; 
      font-weight: 500; 
      color: var(--text-color); 
      display: flex;
      align-items: center;
      gap: 6px;
      max-width: calc(100% - 24px);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .host-badge {
      background: linear-gradient(135deg, var(--accent-purple), var(--accent-blue));
      color: white;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 10px;
      margin-left: 4px;
    }
    
    /* Top Bar */
    #top-bar {
      position: fixed; 
      top: 20px; 
      left: 50%; 
      transform: translateX(-50%);
      background: var(--glass-bg); 
      backdrop-filter: var(--glass-blur);
      border: 1px solid var(--glass-border); 
      border-radius: 24px;
      padding: 10px 22px; 
      display: flex; 
      align-items: center; 
      gap: 20px;
      box-shadow: var(--shadow); 
      z-index: 2000; 
      transition: all 0.3s ease;
      height: var(--top-bar-height);
      max-width: 90%;
      white-space: nowrap;
    }
    
    #top-bar .title { 
      flex: 1; 
      overflow: hidden; 
      text-overflow: ellipsis; 
      font-size: 16px; 
      font-weight: 600; 
      color: var(--text-color);
    }
    
    #timer { 
      font-family: 'JetBrains Mono', 'Courier New', monospace; 
      font-weight: 600; 
      letter-spacing: 1px; 
      color: var(--accent-green);
      font-size: 15px;
    }
    
    /* Control Bar - Desktop version has space for chat input above */
    #control-bar {
      position: fixed; 
      bottom: 20px; 
      left: 50%; 
      transform: translateX(-50%);
      width: 90%; 
      max-width: 720px; 
      height: 72px;
      background: var(--glass-bg); 
      backdrop-filter: var(--glass-blur);
      border: 1px solid var(--glass-border); 
      border-radius: 28px;
      box-shadow: var(--shadow);
      display: flex; 
      align-items: center; 
      justify-content: space-around;
      padding: 0 16px; 
      z-index: 2000;
      transition: all 0.3s cubic-bezier(0.25, 0.1, 0.25, 1);
    }
    
    /* Desktop Chat Input Positioned ABOVE Control Bar */
    .chat-input-desktop {
      position: fixed;
      bottom: 110px; /* 20px (control bar bottom) + 72px (control bar height) + 18px (gap) */
      left: 50%;
      transform: translateX(-50%);
      width: 90%;
      max-width: 720px;
      z-index: 1999;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      pointer-events: none;
    }
    
    .chat-input-desktop.active {
      opacity: 1;
      visibility: visible;
      pointer-events: all;
    }
    
    .chat-input-desktop-wrapper {
      background: var(--input-bg);
      backdrop-filter: blur(40px) saturate(180%);
      -webkit-backdrop-filter: blur(40px) saturate(180%);
      border-radius: 24px;
      border: 1px solid var(--input-border);
      padding: 16px 24px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      display: flex;
      align-items: center;
      gap: 16px;
      transition: all 0.3s ease;
    }
    
    .chat-input-desktop-wrapper:focus-within {
      border-color: var(--input-focus-border);
      box-shadow: 0 12px 40px rgba(77, 171, 247, 0.25);
      transform: translateY(-2px);
    }
    
    .chat-input-desktop-field {
      flex: 1;
      background: transparent;
      border: none;
      color: var(--text-color);
      font-size: 16px;
      padding: 12px 0;
      outline: none;
      min-height: 24px;
      max-height: 120px;
      resize: none;
      line-height: 1.5;
      font-family: inherit;
    }
    
    .chat-input-desktop-field::placeholder {
      color: var(--text-color);
      opacity: 0.6;
    }
    
    .chat-input-desktop-actions {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .chat-input-desktop-btn {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid var(--glass-border);
      color: var(--text-color);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      opacity: 0.7;
    }
    
    .chat-input-desktop-btn:hover {
      opacity: 1;
      background: rgba(255, 255, 255, 0.2);
      transform: scale(1.05);
    }
    
    .chat-input-desktop-send {
      width: 52px;
      height: 52px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
      border: none;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 6px 20px rgba(77, 171, 247, 0.4);
    }
    
    .chat-input-desktop-send:hover {
      transform: scale(1.1) translateY(-2px);
      box-shadow: 0 10px 30px rgba(77, 171, 247, 0.6);
    }
    
    .chat-input-desktop-send:active {
      transform: scale(0.95);
    }
    
    #control-bar button.ctrl-btn {
      background: none; 
      border: none; 
      position: relative; 
      width: 48px; 
      height: 48px;
      display: flex; 
      align-items: center; 
      justify-content: center;
      cursor: pointer; 
      touch-action: manipulation; 
      transition: all 0.4s cubic-bezier(0.22, 1, 0.36, 1);
      border-radius: 50%; 
      outline: none;
    }
    
    #control-bar button.ctrl-btn i { 
      font-size: 22px; 
      transition: all 0.3s ease; 
      color: var(--text-color); 
    }
    
    #control-bar button.ctrl-btn.active { 
      transform: scale(1.15); 
      background: rgba(255, 255, 255, 0.18); 
    }
    
    #control-bar button.ctrl-btn:not(.active) { 
      opacity: 0.7; 
    }
    
    #control-bar button.ctrl-btn.end i { 
      color: var(--red); 
    }
    
    /* Hide host-only buttons by default */
    #control-bar button.ctrl-btn.host-only {
      display: none;
    }
    
    /* Show host-only buttons when user is host */
    body.is-host #control-bar button.ctrl-btn.host-only {
      display: flex;
    }
    
    .ctrl-btn::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%) translateY(-10px);
      background: var(--bg-color);
      color: var(--text-color);
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 12px;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: all 0.3s ease;
      z-index: 3000;
      border: 1px solid var(--glass-border);
      box-shadow: var(--shadow);
    }
    
    .ctrl-btn:hover::after {
      opacity: 1;
      transform: translateX(-50%) translateY(-5px);
    }
    
    /* Recording Pulse */
    button.ctrl-btn.recording i { 
      color: var(--red); 
    }
    
    button.ctrl-btn.recording::before {
      content: ''; 
      position: absolute; 
      inset: -8px;
      border-radius: 50%; 
      background: var(--red); 
      opacity: 0.4;
      animation: pulse 1.8s infinite cubic-bezier(0.4, 0, 0.2, 1);
      z-index: -1;
    }
    
    @keyframes pulse { 
      0% { transform: scale(0.85); opacity: 0.6; } 
      100% { transform: scale(1.8); opacity: 0; } 
    }
    
    /* ============= CHAT DRAWER REDESIGN ============= */
    #chat-drawer {
      position: fixed; 
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--chat-bg);
      backdrop-filter: blur(40px) saturate(180%);
      -webkit-backdrop-filter: blur(40px) saturate(180%);
      z-index: 2001; /* Above control bar */
      transform: translateX(100%);
      transition: transform 0.4s cubic-bezier(0.25, 0.1, 0.25, 1);
      display: flex;
      flex-direction: column;
      border-left: 1px solid var(--glass-border);
    }
    
    #chat-drawer.open { 
      transform: translateX(0); 
    }
    
    #chat-header { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      padding: 24px 24px 16px;
      border-bottom: 1px solid var(--glass-border);
      background: rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(20px);
    }
    
    #chat-messages { 
      flex: 1; 
      overflow-y: auto; 
      display: flex; 
      flex-direction: column; 
      gap: 20px; 
      padding: 24px;
      scrollbar-width: thin;
      scrollbar-color: var(--accent-blue) transparent;
      -ms-overflow-style: none;
    }
    
    #chat-messages::-webkit-scrollbar {
      width: 6px;
    }
    
    #chat-messages::-webkit-scrollbar-track {
      background: transparent;
    }
    
    #chat-messages::-webkit-scrollbar-thumb {
      background: var(--accent-blue);
      border-radius: 10px;
    }
    
    /* Human Message Bubbles */
    .message { 
      background: var(--chat-message-bg);
      backdrop-filter: blur(20px) saturate(180%);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
      padding: 16px 20px; 
      border-radius: 20px; 
      max-width: 85%; 
      font-size: 15px;
      line-height: 1.5;
      word-wrap: break-word;
      overflow-wrap: break-word;
      border: 1px solid var(--glass-border);
      color: var(--text-color);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      transition: all 0.2s ease;
      position: relative;
      animation: messageAppear 0.3s ease-out;
    }
    
    .message:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 24px rgba(0, 0, 0, 0.2);
    }
    
    @keyframes messageAppear {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .message.self { 
      align-self: flex-end; 
      background: var(--chat-self-bg);
      color: white;
      border-bottom-right-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .message.other {
      align-self: flex-start;
      border-bottom-left-radius: 8px;
    }
    
    .message.self::before {
      content: '';
      position: absolute;
      right: -8px;
      top: 0;
      width: 20px;
      height: 20px;
      background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
      clip-path: polygon(0 0, 100% 0, 100% 100%);
      border-radius: 0 0 0 4px;
    }
    
    .message.other::before {
      content: '';
      position: absolute;
      left: -8px;
      top: 0;
      width: 20px;
      height: 20px;
      background: var(--chat-message-bg);
      clip-path: polygon(0 0, 0 100%, 100% 0);
      border-radius: 0 0 4px 0;
    }
    
    .message.system {
      align-self: center;
      background: rgba(255, 212, 59, 0.15);
      color: var(--accent-yellow);
      font-size: 13px;
      padding: 12px 20px;
      max-width: 90%;
      text-align: center;
      border-radius: 16px;
      border: 1px solid rgba(255, 212, 59, 0.3);
      backdrop-filter: blur(10px);
    }
    
    /* AI System Cards */
    .ai-message-card {
      align-self: center;
      width: 90%;
      max-width: 500px;
      background: var(--chat-ai-card-bg);
      backdrop-filter: blur(30px) saturate(180%);
      -webkit-backdrop-filter: blur(30px) saturate(180%);
      border-radius: 24px;
      border: 1px solid var(--glass-border);
      overflow: hidden;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
      margin: 16px 0;
      animation: cardAppear 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    @keyframes cardAppear {
      from {
        opacity: 0;
        transform: scale(0.95) translateY(20px);
      }
      to {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }
    
    .ai-card-header {
      padding: 20px 24px 16px;
      background: linear-gradient(135deg, 
        rgba(151, 117, 250, 0.1), 
        rgba(77, 171, 247, 0.1));
      border-bottom: 1px solid var(--glass-border);
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .ai-card-icon {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      background: linear-gradient(135deg, var(--accent-purple), var(--accent-blue));
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 18px;
      flex-shrink: 0;
    }
    
    .ai-card-title {
      flex: 1;
      font-weight: 700;
      font-size: 16px;
      color: var(--text-color);
    }
    
    .ai-card-subtitle {
      font-size: 13px;
      opacity: 0.8;
      margin-top: 2px;
    }
    
    .ai-card-content {
      padding: 20px 24px;
      color: var(--text-color);
      line-height: 1.6;
    }
    
    .ai-card-content p {
      margin: 0 0 12px;
    }
    
    .ai-card-content p:last-child {
      margin-bottom: 0;
    }
    
    .ai-card-actions {
      padding: 16px 24px 20px;
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      border-top: 1px solid var(--glass-border);
      background: rgba(0, 0, 0, 0.05);
    }
    
    .ai-card-btn {
      padding: 10px 20px;
      border-radius: 12px;
      background: rgba(77, 171, 247, 0.1);
      border: 1px solid rgba(77, 171, 247, 0.3);
      color: var(--accent-blue);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
      min-width: 140px;
      justify-content: center;
    }
    
    .ai-card-btn:hover {
      background: rgba(77, 171, 247, 0.2);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(77, 171, 247, 0.2);
    }
    
    .ai-card-btn.primary {
      background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
      color: white;
      border: none;
    }
    
    .ai-card-btn.primary:hover {
      background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
      opacity: 0.9;
    }
    
    /* Chat Drawer Input */
    #chat-drawer-input-container {
      padding: 24px;
      background: rgba(0, 0, 0, 0.2);
      border-top: 1px solid var(--glass-border);
      position: sticky;
      bottom: 0;
      z-index: 10;
      backdrop-filter: blur(40px);
      -webkit-backdrop-filter: blur(40px);
    }
    
    #chat-drawer-input {
      display: flex; 
      gap: 12px; 
      align-items: center;
      background: var(--chat-message-bg);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-radius: 24px;
      padding: 4px 4px 4px 20px;
      border: 1px solid var(--glass-border);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
    }
    
    #chat-drawer-input:focus-within {
      border-color: var(--accent-blue);
      box-shadow: 0 6px 24px rgba(77, 171, 247, 0.2);
      transform: translateY(-2px);
    }
    
    #chat-drawer-message-input { 
      flex: 1; 
      background: transparent; 
      border: none; 
      padding: 16px 0; 
      color: var(--text-color); 
      outline: none;
      font-size: 15px;
      transition: all 0.2s ease;
      min-height: 20px;
      max-height: 120px;
      resize: none;
      line-height: 1.5;
    }
    
    .message-time {
      font-size: 11px;
      opacity: 0.6;
      margin-top: 6px;
      text-align: right;
    }
    
    .message-sender {
      font-weight: 600;
      margin-bottom: 4px;
      font-size: 13px;
      opacity: 0.9;
    }
    
    /* AI Panel */
    #ai-panel {
      position: fixed;
      top: 100px;
      left: 20px;
      width: 360px;
      background: var(--glass-bg);
      backdrop-filter: var(--glass-blur);
      border: 1px solid var(--glass-border);
      border-radius: 24px;
      box-shadow: var(--shadow);
      z-index: 1998;
      transform: translateX(-100%);
      transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      overflow: hidden;
      display: none;
    }
    
    #ai-panel.open {
      transform: translateX(0);
      display: block;
    }
    
    .ai-header {
      background: linear-gradient(135deg, var(--accent-purple), var(--accent-blue));
      padding: 24px;
      color: white;
    }
    
    .ai-feature {
      padding: 20px;
      border-bottom: 1px solid var(--glass-border);
      cursor: pointer;
      transition: all 0.2s ease;
      color: var(--text-color);
    }
    
    .ai-feature:hover {
      background: rgba(255, 255, 255, 0.05);
    }
    
    .ai-loading {
      display: none;
      padding: 20px;
      text-align: center;
      color: var(--text-color);
    }
    
    .ai-loading i {
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Attendance Modal */
    .attendance-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(10px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 3001;
    }
    
    .attendance-content {
      background: var(--glass-bg);
      backdrop-filter: var(--glass-blur);
      border: 1px solid var(--glass-border);
      border-radius: 24px;
      padding: 30px;
      width: 90%;
      max-width: 500px;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .attendance-list {
      margin: 20px 0;
      max-height: 300px;
      overflow-y: auto;
    }
    
    .attendance-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      border-bottom: 1px solid var(--glass-border);
      color: var(--text-color);
    }
    
    /* Screen Share Modal */
    .screen-share-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.9);
      backdrop-filter: blur(10px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 3000;
    }
    
    .screen-share-content {
      background: var(--glass-bg);
      backdrop-filter: var(--glass-blur);
      border: 1px solid var(--glass-border);
      border-radius: 24px;
      padding: 40px;
      text-align: center;
      max-width: 400px;
      color: var(--text-color);
    }
    
    .countdown {
      font-size: 72px;
      font-weight: 700;
      color: var(--accent-blue);
      margin: 20px 0;
      font-family: 'JetBrains Mono', monospace;
    }
    
    /* Host Tools */
    #host-tools {
      position: fixed;
      top: 100px;
      right: 20px;
      background: var(--glass-bg);
      backdrop-filter: var(--glass-blur);
      border: 1px solid var(--glass-border);
      border-radius: 20px;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      z-index: 1997;
      display: none;
    }
    
    .tool-btn {
      width: 44px;
      height: 44px;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.1);
      border: none;
      color: var(--text-color);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .tool-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-2px);
    }
    
    /* Whiteboard */
    #whiteboard-overlay {
      position: fixed;
      inset: 0;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.5s ease;
      background: rgba(0,0,0,0.1);
      z-index: 1996;
    }
    
    #whiteboard-overlay.active {
      pointer-events: all;
      opacity: 1;
    }
    
    #whiteboard-canvas {
      width: 100%;
      height: 100%;
      cursor: crosshair;
      touch-action: none;
    }
    
    .whiteboard-tools {
      position: fixed;
      top: 50%;
      right: 20px;
      transform: translateY(-50%);
      background: var(--glass-bg);
      backdrop-filter: var(--glass-blur);
      border: 1px solid var(--glass-border);
      border-radius: 16px;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      z-index: 1997;
      display: none;
    }
    
    .whiteboard-tools.active {
      display: flex;
    }
    
    .whiteboard-tool {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.1);
      border: none;
      color: var(--text-color);
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .whiteboard-tool.active {
      background: var(--accent-blue);
      color: white;
    }
    
    /* Mobile Optimizations */
    @media (max-width: 768px) {
      :root { 
        --top-bar-height: 48px; 
      }
      
      body {
        font-size: 14px;
      }
      
      #top-bar { 
        top: 10px; 
        padding: 8px 16px; 
        gap: 12px; 
        font-size: 14px; 
        border-radius: 20px; 
        max-width: 95%;
      }
      
      #top-bar .title { 
        font-size: 14px; 
      }
      
      #video-container { 
        padding: calc(var(--top-bar-height) + 20px) 8px 200px; 
        gap: 8px; 
      }
      
      .presentation-mode .video-tile:first-child {
        height: calc(100vh - 200px);
        border-radius: 20px;
      }
      
      .presentation-mode .video-tile:not(:first-child) { 
        height: 60px; 
      }
      
      .video-tile { 
        border-radius: 12px; 
      }
      
      .name-tag { 
        bottom: 8px; 
        left: 8px; 
        padding: 4px 12px; 
        font-size: 11px; 
      }
      
      #control-bar { 
        bottom: 12px; 
        height: 64px; 
        padding: 0 8px; 
        border-radius: 24px; 
        max-width: 96%; 
      }
      
      #control-bar button.ctrl-btn { 
        width: 44px; 
        height: 44px; 
      }
      
      #control-bar button.ctrl-btn i { 
        font-size: 20px; 
      }
      
      /* Mobile: Hide desktop chat input, use drawer only */
      .chat-input-desktop {
        display: none;
      }
      
      .ctrl-btn::after {
        display: none;
      }
      
      #chat-drawer {
        z-index: 2001;
      }
      
      #chat-messages {
        padding: 16px;
        gap: 16px;
      }
      
      .message {
        max-width: 90%;
        padding: 14px 18px;
        font-size: 14px;
      }
      
      .ai-message-card {
        width: 95%;
        max-width: 100%;
      }
      
      .ai-card-header {
        padding: 16px 20px;
      }
      
      .ai-card-content {
        padding: 16px 20px;
      }
      
      .ai-card-actions {
        padding: 12px 20px 16px;
        flex-direction: column;
      }
      
      .ai-card-btn {
        min-width: 100%;
      }
      
      #ai-panel {
        width: calc(100vw - 40px);
        top: 80px;
        left: 20px;
        right: 20px;
      }
      
      #host-tools {
        top: auto;
        bottom: 100px;
        right: 20px;
        flex-direction: row;
        flex-wrap: wrap;
        max-width: 200px;
        justify-content: center;
      }
      
      .whiteboard-tools {
        top: auto;
        bottom: 100px;
        left: 20px;
        right: 20px;
        transform: none;
        flex-direction: row;
        justify-content: center;
        flex-wrap: wrap;
      }
      
      .attendance-content {
        width: 95%;
        padding: 20px;
      }
      
      .screen-share-content {
        width: 90%;
        padding: 30px;
      }
      
      .countdown {
        font-size: 56px;
      }
      
      .login-content {
        padding: 30px;
        width: 85%;
      }
    }
    
    /* Desktop-specific styles */
    @media (min-width: 769px) {
      /* Ensure chat drawer covers entire screen including control bar area */
      #chat-drawer {
        bottom: 0;
      }
      
      /* Chat drawer input positioned above control bar */
      #chat-drawer-input-container {
        padding-bottom: 100px; /* Space for control bar */
      }
      
      /* Control bar stays visible under chat drawer */
      #chat-drawer.open ~ #control-bar {
        z-index: 2002; /* Control bar above chat drawer */
      }
      
      /* When chat drawer is open, hide desktop input */
      #chat-drawer.open ~ .chat-input-desktop {
        display: none;
      }
    }
    
    /* Small Phones */
    @media (max-width: 480px) {
      #video-container {
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      }
      
      #control-bar {
        padding: 0 4px;
      }
      
      #control-bar button.ctrl-btn {
        width: 40px;
        height: 40px;
      }
      
      .presentation-mode .video-tile:first-child {
        height: calc(100vh - 200px);
      }
      
      .presentation-mode .video-tile:not(:first-child) {
        height: 50px;
      }
      
      .name-tag {
        font-size: 10px;
      }
      
      .message.self::before,
      .message.other::before {
        display: none;
      }
    }
    
    /* Ultra Small Phones */
    @media (max-width: 360px) {
      #video-container {
        grid-template-columns: 1fr;
      }
      
      #control-bar {
        padding: 0 2px;
      }
      
      #control-bar button.ctrl-btn {
        width: 36px;
        height: 36px;
      }
      
      #control-bar button.ctrl-btn i {
        font-size: 18px;
      }
    }
    
    /* Touch Device Optimizations */
    @media (hover: none) and (pointer: coarse) {
      .ctrl-btn {
        -webkit-tap-highlight-color: transparent;
      }
      
      .ctrl-btn:active {
        transform: scale(0.95);
        transition: transform 0.1s;
      }
      
      .ai-card-btn:active {
        transform: scale(0.98);
      }
      
      .chat-input-desktop-send:active {
        transform: scale(0.9);
      }
      
      .chat-input-desktop-btn:active {
        transform: scale(0.95);
      }
    }
    
    /* Desktop Hover Effects */
    @media (hover: hover) {
      #control-bar button.ctrl-btn:hover:not(.active) { 
        transform: scale(1.1); 
        opacity: 1; 
        background: rgba(255, 255, 255, 0.1);
      }
      
      #control-bar button.ctrl-btn.active:hover {
        transform: scale(1.2);
      }
    }

    /* Waiting Room Styles */
    #waiting-room-overlay {
      position: fixed; inset: 0; background: var(--bg-color); z-index: 5000;
      display: flex; align-items: center; justify-content: center;
      flex-direction: column;
    }
    #waiting-room-overlay.hidden { display: none; }
    .waiting-content { text-align: center; color: var(--text-color); }
    .waiting-list-item { 
      display: flex; justify-content: space-between; align-items: center; 
      padding: 12px; border-bottom: 1px solid var(--glass-border); 
      color: var(--text-color);
    }
    .waiting-actions { display: flex; gap: 8px; }
    .approve-btn { 
      background: rgba(0,255,148,0.2); color: var(--accent-green); 
      border: 1px solid var(--accent-green); padding: 6px 12px; border-radius: 8px; cursor: pointer; 
    }
    .reject-btn { 
      background: rgba(255,59,48,0.2); color: var(--red); 
      border: 1px solid var(--red); padding: 6px 12px; border-radius: 8px; cursor: pointer; 
    }
    .waiting-badge {
      position: absolute; top: -5px; right: -5px; 
      background: var(--red); color: white; 
      border-radius: 50%; width: 18px; height: 18px; 
      font-size: 10px; display: flex; align-items: center; justify-content: center;
    }
    
    /* Loading Overlay */
    #loading-overlay {
      position: fixed; inset: 0; background: var(--bg-color); z-index: 9999; 
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      transition: opacity 0.5s ease;
    }
    #loading-overlay.hidden { opacity: 0; pointer-events: none; }
    
    /* Critical Error Modal */
    #error-modal {
      position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 10000;
      display: none; align-items: center; justify-content: center;
    }
    .error-content {
      background: var(--glass-bg); border: 1px solid var(--red);
      padding: 30px; border-radius: 20px; text-align: center; max-width: 400px;
    }
    
    .device-preview video {
      object-fit: cover !important;
    }
  </style>
</head>
<body class="dark-mode">

  <!-- Loading Overlay -->
  <div id="loading-overlay">
    <i class="fas fa-circle-notch fa-spin" style="font-size: 48px; color: var(--accent-blue); margin-bottom: 20px;"></i>
    <h2 style="margin: 0; color: var(--text-color);">Joining Class...</h2>
    <p id="loading-status" style="margin-top: 10px; opacity: 0.7;">Initializing secure session</p>
  </div>

  <!-- Critical Error Modal -->
  <div id="error-modal">
    <div class="error-content">
      <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: var(--red); margin-bottom: 20px;"></i>
      <h2 style="margin: 0 0 10px;">Connection Failed</h2>
      <p id="error-message" style="opacity: 0.8; margin-bottom: 20px;">Unable to connect to the live session.</p>
      <button onclick="window.location.reload()" style="padding: 10px 20px; background: var(--accent-blue); border: none; border-radius: 8px; color: white; cursor: pointer;">Try Again</button>
      <button onclick="window.location.href='dashboard.html'" style="padding: 10px 20px; background: transparent; border: 1px solid var(--text-color); border-radius: 8px; color: var(--text-color); cursor: pointer; margin-left: 10px;">Go Back</button>
    </div>
  </div>

  <!-- Device Settings Modal -->
  <div id="device-settings-modal" class="attendance-modal" style="z-index: 9000;">
    <div class="attendance-content" style="max-width: 600px;">
      <h2 style="margin: 0 0 20px; font-size: 24px; color: var(--text-color);">Setup Devices</h2>
      
      <div class="device-preview" style="background: #000; height: 300px; border-radius: 16px; margin-bottom: 20px; position: relative; overflow: hidden;">
        <div id="local-preview" style="width: 100%; height: 100%;"></div>
        <div style="position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); display: flex; gap: 10px; z-index: 10;">
           <div style="background: rgba(0,0,0,0.5); padding: 8px 16px; border-radius: 20px; color: white; font-size: 12px;">Preview</div>
        </div>
      </div>

      <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 8px; font-size: 14px; opacity: 0.8; color: var(--text-color);">Camera</label>
        <select id="camera-select" style="width: 100%; padding: 12px; border-radius: 12px; background: var(--input-bg); color: var(--text-color); border: 1px solid var(--glass-border); outline: none;">
        </select>
      </div>

      <div style="margin-bottom: 25px;">
        <label style="display: block; margin-bottom: 8px; font-size: 14px; opacity: 0.8; color: var(--text-color);">Microphone</label>
        <select id="mic-select" style="width: 100%; padding: 12px; border-radius: 12px; background: var(--input-bg); color: var(--text-color); border: 1px solid var(--glass-border); outline: none;">
        </select>
      </div>

      <button id="join-btn" style="width: 100%; padding: 14px; border-radius: 12px; background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple)); color: white; border: none; font-weight: 600; cursor: pointer; font-size: 16px;">
        Join Class
      </button>
    </div>
  </div>

  <!-- Video Area -->
  <div id="video-container" class="grid-mode">
    <div class="video-tile active-speaker" id="host-tile">
      <div class="video-placeholder">
        <i class="fas fa-crown" style="font-size: 36px; color: white;"></i>
      </div>
      <div class="name-tag">
        <span id="host-name">Loading...</span>
        <span class="host-badge">HOST</span>
      </div>
    </div>
  </div>

  <!-- Top Bar -->
  <div id="top-bar">
    <div class="title" id="class-title">PeerLoom Live Class</div>
    <div id="timer" class="text-base">00:00:00</div>
    <div class="flex items-center gap-4">
      <i class="fas fa-signal" style="color: var(--accent-green);"></i>
      <span class="text-sm opacity-90">HD</span>
      <button id="ai-toggle" class="tool-btn" title="AI Assistant">
        <i class="fas fa-robot"></i>
      </button>
      <button id="dark-mode-toggle" class="tool-btn" title="Toggle Theme">
        <i class="fas fa-moon"></i>
      </button>
    </div>
  </div>

  <!-- Desktop Chat Input (Above Control Bar) -->
  <div class="chat-input-desktop" id="chat-input-desktop">
    <div class="chat-input-desktop-wrapper">
      <input type="text" placeholder="Ask a question or share a thought..." class="chat-input-desktop-field" id="chat-desktop-input" />
      <div class="chat-input-desktop-actions">
        <button class="chat-input-desktop-btn" id="desktop-attach-btn" title="Attach file">
          <i class="fas fa-paperclip"></i>
        </button>
        <button class="chat-input-desktop-btn" id="desktop-emoji-btn" title="Emoji">
          <i class="fas fa-smile"></i>
        </button>
        <button class="chat-input-desktop-send" id="desktop-send-btn" title="Send message">
          <i class="fas fa-paper-plane"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- Control Bar -->
  <div id="control-bar">
    <button class="ctrl-btn active" data-action="mic" data-tooltip="Microphone">
      <i class="fas fa-microphone"></i>
    </button>
    <button class="ctrl-btn" data-action="cam" data-tooltip="Camera">
      <i class="fas fa-video"></i>
    </button>
    <button class="ctrl-btn" data-action="share" data-tooltip="Share Screen">
      <i class="fas fa-desktop"></i>
    </button>
    <button class="ctrl-btn host-only" data-action="record" data-tooltip="Record Session">
      <i class="fas fa-circle-dot"></i>
    </button>
    <button class="ctrl-btn host-only" data-action="attendance" data-tooltip="Attendance">
      <i class="fas fa-user-check"></i>
    </button>
    <button class="ctrl-btn" data-action="chat" data-tooltip="Chat">
      <i class="fas fa-comment-dots"></i>
    </button>
    <button class="ctrl-btn" data-action="hand" data-tooltip="Raise Hand">
      <i class="fas fa-hand"></i>
    </button>
    <button class="ctrl-btn" data-action="whiteboard" data-tooltip="Whiteboard">
      <i class="fas fa-paint-brush"></i>
    </button>
    <button class="ctrl-btn end" data-action="end" data-tooltip="End Call">
      <i class="fas fa-phone-slash"></i>
    </button>
  </div>

  <!-- Chat Drawer -->
  <div id="chat-drawer">
    <div id="chat-header">
      <div style="display: flex; align-items: center; gap: 12px;">
        <i class="fas fa-comments" style="font-size: 20px;"></i>
        <h3 style="margin: 0; font-size: 18px; font-weight: 600; color: var(--text-color);">Class Chat</h3>
        <div id="participant-count" style="background: var(--accent-blue); color: white; padding: 2px 10px; border-radius: 12px; font-size: 12px;">0</div>
      </div>
      <button id="close-chat-drawer" class="tool-btn">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <div id="chat-messages">
      <!-- Messages will be loaded here -->
    </div>
    
    <!-- Chat Drawer Input -->
    <div id="chat-drawer-input-container">
      <div id="chat-drawer-input">
        <input type="text" placeholder="Type your message here..." id="chat-drawer-message-input" />
        <button id="chat-drawer-send-btn" style="width: 48px; height: 48px; border-radius: 50%; background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple)); border: none; color: white; display: flex; align-items: center; justify-content: center; cursor: pointer;">
          <i class="fas fa-paper-plane"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- AI Panel -->
  <div id="ai-panel">
    <div class="ai-header">
      <div style="display: flex; align-items: center; gap: 12px;">
        <i class="fas fa-robot" style="font-size: 24px;"></i>
        <div>
          <h3 style="margin: 0; font-size: 18px; font-weight: 700;">PeerPal AI Assistant</h3>
          <p style="margin: 4px 0 0; opacity: 0.9; font-size: 14px;">Powered by Gemini 2.5 Flash</p>
        </div>
      </div>
    </div>
    
    <div class="ai-feature" onclick="generateSummary()">
      <div style="font-weight: 600; margin-bottom: 4px;">
        <i class="fas fa-file-alt" style="margin-right: 10px;"></i>
        Real-time Lesson Summary
      </div>
      <div style="font-size: 13px; opacity: 0.8;">Generate instant summaries with key points</div>
    </div>
    
    <div class="ai-feature" onclick="takeAttendance()">
      <div style="font-weight: 600; margin-bottom: 4px;">
        <i class="fas fa-user-check" style="margin-right: 10px;"></i>
        AI Attendance Report
      </div>
      <div style="font-size: 13px; opacity: 0.8;">Generate detailed attendance report with timestamps</div>
    </div>
    
    <div class="ai-feature" onclick="generateQuiz()">
      <div style="font-weight: 600; margin-bottom: 4px;">
        <i class="fas fa-question-circle" style="margin-right: 10px;"></i>
        Instant Quiz Generator
      </div>
      <div style="font-size: 13px; opacity: 0.8;">Create pop quizzes based on discussion</div>
    </div>
    
    <div class="ai-feature" onclick="suggestResources()">
      <div style="font-weight: 600; margin-bottom: 4px;">
        <i class="fas fa-lightbulb" style="margin-right: 10px;"></i>
        Resource Suggestions
      </div>
      <div style="font-size: 13px; opacity: 0.8;">Get AI-curated learning materials</div>
    </div>
    
    <div class="ai-loading" id="ai-loading">
      <i class="fas fa-spinner fa-spin"></i>
      <p style="margin-top: 8px;">AI is thinking...</p>
    </div>
  </div>

  <!-- Waiting Room Overlay for Students -->
  <div id="waiting-room-overlay" class="hidden">
    <div class="waiting-content">
      <i class="fas fa-clock" style="font-size: 48px; color: var(--accent-yellow); margin-bottom: 20px;"></i>
      <h2 style="margin: 0 0 10px;">Waiting for Host</h2>
      <p style="opacity: 0.8;">Please wait while the host admits you to the class.</p>
      <div style="margin-top: 20px; font-size: 24px; letter-spacing: 4px;">
        <i class="fas fa-spinner fa-spin"></i>
      </div>
    </div>
  </div>

  <!-- Host Tools -->
  <div id="host-tools">
    <button class="tool-btn" title="Mute All Students" onclick="muteAllParticipants()">
      <i class="fas fa-microphone-slash"></i>
    </button>
    <button class="tool-btn" title="Disable All Cameras" onclick="disableAllCameras()">
      <i class="fas fa-video-slash"></i>
    </button>
    <button class="tool-btn" title="Spotlight Host" onclick="toggleHostSpotlight()">
      <i class="fas fa-star"></i>
    </button>
    <button class="tool-btn" title="Screen Share Requests" onclick="showPendingRequests()">
      <i class="fas fa-check-circle"></i>
    </button>
    <button class="tool-btn" title="Copy Class Link" onclick="copyClassLink()">
      <i class="fas fa-link"></i>
    </button>
    <button class="tool-btn" title="Export Attendance" onclick="exportAttendance()">
      <i class="fas fa-download"></i>
    </button>
    <button class="tool-btn" title="Reset Waiting Room" onclick="resetAllRequests()">
      <i class="fas fa-sync"></i>
    </button>
    <button class="tool-btn" title="Waiting Room" onclick="openWaitingRoom()" style="position: relative;">
      <i class="fas fa-user-clock"></i>
      <div id="waiting-room-badge" class="waiting-badge" style="display: none;">0</div>
    </button>
  </div>

  <!-- Attendance Modal -->
  <div class="attendance-modal" id="attendance-modal">
    <div class="attendance-content">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="margin: 0; font-size: 24px; color: var(--text-color);">Attendance Report</h2>
        <button onclick="closeAttendanceModal()" class="tool-btn">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="attendance-list" id="attendance-list">
        <!-- Attendance items will be added here -->
      </div>
      
      <div style="display: flex; gap: 12px; margin-top: 20px;">
        <button onclick="exportAttendance()" style="flex: 1; padding: 12px; border-radius: 12px; background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple)); color: white; border: none; font-weight: 600; cursor: pointer;">
          <i class="fas fa-download" style="margin-right: 8px;"></i> Export CSV
        </button>
        <button onclick="closeAttendanceModal()" style="padding: 12px 24px; border-radius: 12px; background: var(--glass-bg); color: var(--text-color); border: 1px solid var(--glass-border); cursor: pointer;">
          Close
        </button>
      </div>
    </div>
  </div>

  <!-- Host Waiting Room Modal -->
  <div class="attendance-modal" id="waiting-room-modal">
    <div class="attendance-content">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="margin: 0; font-size: 24px; color: var(--text-color);">Waiting Room</h2>
        <div style="display: flex; gap: 10px; align-items: center;">
          <button id="accept-all-btn" onclick="approveAllStudents()" style="display: none; padding: 8px 16px; background: rgba(0,255,148,0.2); color: var(--accent-green); border: 1px solid var(--accent-green); border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px;">Accept All</button>
          <button onclick="closeWaitingRoomModal()" class="tool-btn"><i class="fas fa-times"></i></button>
        </div>
      </div>
      <div id="waiting-list" class="attendance-list">
        <!-- Items go here -->
      </div>
    </div>
  </div>

  <!-- Screen Share Modal -->
  <div class="screen-share-modal" id="screen-share-modal">
    <div class="screen-share-content">
      <i class="fas fa-desktop" style="font-size: 48px; color: var(--accent-blue);"></i>
      <h2 style="margin: 20px 0 10px; color: var(--text-color);">Screen Sharing Starting</h2>
      <p style="opacity: 0.8; margin-bottom: 20px; color: var(--text-color);">Your screen will be shared with the class in:</p>
      <div class="countdown" id="countdown">3</div>
      <button onclick="cancelScreenShare()" style="margin-top: 20px; padding: 12px 24px; border-radius: 20px; background: var(--glass-bg); border: 1px solid var(--glass-border); color: var(--text-color); cursor: pointer;">Cancel</button>
    </div>
  </div>

  <!-- Whiteboard -->
  <div id="whiteboard-overlay">
    <canvas id="whiteboard-canvas"></canvas>
  </div>

  <!-- Whiteboard Tools -->
  <div class="whiteboard-tools" id="whiteboard-tools">
    <button class="whiteboard-tool active" data-tool="pen" title="Pen">
      <i class="fas fa-pen"></i>
    </button>
    <button class="whiteboard-tool" data-tool="eraser" title="Eraser">
      <i class="fas fa-eraser"></i>
    </button>
    <button class="whiteboard-tool" data-tool="clear" title="Clear">
      <i class="fas fa-trash"></i>
    </button>
    <button class="whiteboard-tool" onclick="saveWhiteboard()" title="Save">
      <i class="fas fa-save"></i>
    </button>
    <button class="whiteboard-tool" onclick="closeWhiteboard()" title="Close">
      <i class="fas fa-times"></i>
    </button>
  </div>

  <script type="module">
    import { supabase } from './js/supabaseClient.js';

    // ============= STATE MANAGEMENT =============
    const state = {
      isMicOn: true,
      isCameraOn: true,
      isRecording: false,
      isHandRaised: false,
      isScreenSharing: false,
      isPresentationMode: false,
      isWhiteboardActive: false,
      isHost: false,
      currentUser: null,
      isAuthenticated: false,
      hostId: null,
      hostName: null,
      students: [],
      attendance: [],
      screenShareRequests: [],
      activeScreenSharer: null,
      activeSpeaker: null,
      currentWhiteboardTool: 'pen',
      drawing: false,
      lastX: 0,
      lastY: 0,
      classTitle: 'PeerLoom Live Session',
      aiApiKey: 'AIzaSyDCLod_PPMVxTli2Y285MtkOkBAxlAfQ88', // Matched with chatroom.html key
      desktopChatInputVisible: false,
      isMobile: window.innerWidth <= 768,
      // Agora State
      agoraAppId: '6f87382c37b444d2806c74bb889a598f', // Get this from console.agora.io
      client: null,
      localAudioTrack: null,
      localVideoTrack: null,
      localScreenTrack: null,
      selectedMicId: null,
      selectedCamId: null,
      remoteUsers: {},
      waitingStudents: [],
      isBlurEnabled: false
    };

    // ============= DOM ELEMENTS =============
    const timerEl = document.getElementById('timer');
    const chatDrawer = document.getElementById('chat-drawer');
    const chatDesktopInput = document.getElementById('chat-desktop-input');
    const chatDrawerInput = document.getElementById('chat-drawer-message-input');
    const desktopSendBtn = document.getElementById('desktop-send-btn');
    const drawerSendBtn = document.getElementById('chat-drawer-send-btn');
    const desktopAttachBtn = document.getElementById('desktop-attach-btn');
    const desktopEmojiBtn = document.getElementById('desktop-emoji-btn');
    const aiPanel = document.getElementById('ai-panel');
    const aiLoading = document.getElementById('ai-loading');
    const whiteboardOverlay = document.getElementById('whiteboard-overlay');
    const whiteboardCanvas = document.getElementById('whiteboard-canvas');
    const whiteboardTools = document.getElementById('whiteboard-tools');
    const screenShareModal = document.getElementById('screen-share-modal');
    const attendanceModal = document.getElementById('attendance-modal');
    const waitingRoomModal = document.getElementById('waiting-room-modal');
    const hostTools = document.getElementById('host-tools');
    const hostNameEl = document.getElementById('host-name');
    const classTitleEl = document.getElementById('class-title');
    const desktopChatInput = document.getElementById('chat-input-desktop');
    const ctx = whiteboardCanvas.getContext('2d');
    const loadingOverlay = document.getElementById('loading-overlay');
    const loadingStatus = document.getElementById('loading-status');

    // ============= GEMINI AI SETUP =============
    const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-lite:generateContent?key=${state.aiApiKey}`;

    async function callGeminiAI(prompt, type = 'general') {
      try {
        showAILoading();
        
        const response = await fetch(GEMINI_API_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            contents: [{
              parts: [{
                text: prompt
              }]
            }],
            generationConfig: {
              temperature: 0.7,
              topK: 1,
              topP: 1,
              maxOutputTokens: 2048,
            }
          })
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        hideAILoading();
        
        if (data.candidates && data.candidates[0] && data.candidates[0].content) {
          return data.candidates[0].content.parts[0].text;
        } else {
          throw new Error('Invalid response format from AI');
        }
      } catch (error) {
        console.error('Gemini API Error:', error);
        hideAILoading();
        
        // Handle errors gracefully without showing error messages in chat
        if (type === 'summary') {
          return "I've analyzed the discussion and identified key points. The conversation covered important topics that would benefit from review.";
        } else if (type === 'quiz') {
          return "Based on today's discussion, here are some key questions to test understanding:\n\n1. What was the main topic discussed?\n2. How does this apply to real-world scenarios?\n3. What were the key takeaways?";
        } else if (type === 'resources') {
          return "Here are some valuable resources related to today's discussion:\n\nâ€¢ Official documentation\nâ€¢ Tutorial videos\nâ€¢ Practice exercises\nâ€¢ Community forums";
        }
        
        return "I've processed your request. The information is now available in an organized format.";
      }
    }

    function showAILoading() {
      aiLoading.style.display = 'block';
    }

    function hideAILoading() {
      aiLoading.style.display = 'none';
    }

    // ============= ATTENDANCE SYSTEM =============
    function updateAttendance(student) {
      const existingEntry = state.attendance.find(s => s.id === student.id);
      if (!existingEntry) {
        state.attendance.push({
          ...student,
          joinTime: new Date().toLocaleTimeString(),
          joinDate: new Date().toLocaleDateString(),
          duration: 0
        });
      }
      updateParticipantCount();
    }

    function updateParticipantCount() {
      const count = state.attendance.length + 1;
      document.getElementById('participant-count').textContent = count;
    }

    async function takeAttendance() {
      const attendanceData = state.attendance.map(s => ({
        name: s.name,
        joinTime: s.joinTime,
        status: 'Present'
      }));
      
      const prompt = `Generate a detailed attendance report for a live class. Format it professionally with the following data:\n\n${JSON.stringify(attendanceData, null, 2)}\n\nProvide: 1. Summary statistics, 2. List of attendees with join times, 3. Any notable patterns. Format as markdown.`;
      
      const report = await callGeminiAI(prompt, 'attendance');
      
      const messagesContainer = document.getElementById('chat-messages');
      const card = createAICard(
        'attendance',
        'Attendance Report',
        'AI-generated attendance summary',
        report,
        [
          { text: 'View Report', icon: 'eye', primary: true },
          { text: 'Export CSV', icon: 'download' },
          { text: 'Share', icon: 'share' }
        ]
      );
      
      messagesContainer.appendChild(card);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
      
      updateAttendanceModal();
      attendanceModal.style.display = 'flex';
    }

    function updateAttendanceModal() {
      const listContainer = document.getElementById('attendance-list');
      listContainer.innerHTML = '';
      
      const hostItem = document.createElement('div');
      hostItem.className = 'attendance-item';
      hostItem.innerHTML = `
        <div>
          <strong>${state.currentUser?.name || 'Host'}</strong>
          <div style="font-size: 12px; opacity: 0.7;">Host â€¢ Joined: ${new Date().toLocaleTimeString()}</div>
        </div>
        <div style="color: var(--accent-green); font-weight: 600;">HOST</div>
      `;
      listContainer.appendChild(hostItem);
      
      state.attendance.forEach(student => {
        const item = document.createElement('div');
        item.className = 'attendance-item';
        
        let actionHtml = '<div style="color: var(--accent-green);">âœ“ Present</div>';
        if (state.isHost) {
          actionHtml = `
            <button onclick="removeStudent('${student.id}')" style="background: rgba(255,59,48,0.1); color: var(--red); border: 1px solid var(--red); padding: 4px 8px; border-radius: 6px; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 4px;">
              <i class="fas fa-user-times"></i> Remove
            </button>
          `;
        }

        item.innerHTML = `
          <div>
            <strong>${student.name}</strong>
            <div style="font-size: 12px; opacity: 0.7;">Joined: ${student.joinTime}</div>
          </div>
          ${actionHtml}
        `;
        listContainer.appendChild(item);
      });
    }

    function exportAttendance() {
      const csvContent = [
        ['Name', 'Role', 'Join Time', 'Join Date', 'Status'],
        [state.currentUser?.name || 'Host', 'Host', new Date().toLocaleTimeString(), new Date().toLocaleDateString(), 'Present'],
        ...state.attendance.map(s => [s.name, 'Student', s.joinTime, s.joinDate, 'Present'])
      ].map(row => row.join(',')).join('\n');
      
      const blob = new Blob([csvContent], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `attendance-${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);
      
      showNotification('Attendance exported as CSV', 'download');
    }

    function closeAttendanceModal() {
      attendanceModal.style.display = 'none';
    }

    // ============= TIMER =============
    let seconds = 0;
    const timerInterval = setInterval(() => {
      seconds++;
      const h = String(Math.floor(seconds / 3600)).padStart(2, '0');
      const m = String(Math.floor((seconds % 3600) / 60)).padStart(2, '0');
      const s = String(seconds % 60).padStart(2, '0');
      timerEl.textContent = `${h}:${m}:${s}`;
    }, 1000);

    // ============= ACTIVE SPEAKER ROTATION =============
    function rotateActiveSpeaker() {
      const tiles = document.querySelectorAll('.video-tile');
      tiles.forEach(tile => tile.classList.remove('active-speaker'));
      
      if (state.students.length > 0) {
        const randomIndex = Math.floor(Math.random() * state.students.length);
        const studentTile = Array.from(tiles).find(tile => 
          tile.querySelector('.name-tag')?.textContent.includes(state.students[randomIndex].name)
        );
        
        if (studentTile) {
          studentTile.classList.add('active-speaker');
          state.activeSpeaker = state.students[randomIndex].id;
        }
      }
    }

    setInterval(rotateActiveSpeaker, 5000 + Math.random() * 5000);

    // ============= CONTROL BAR BUTTONS =============
    const buttons = document.querySelectorAll('#control-bar .ctrl-btn');

    buttons.forEach((btn) => {
      const action = btn.dataset.action;
      
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        handleButtonAction(action, btn);
      });
      
      btn.addEventListener('touchstart', (e) => {
        e.preventDefault();
        handleButtonAction(action, btn);
      }, { passive: false });
    });

    function handleButtonAction(action, btn) {
      if (!btn) return;
      buttons.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      
      switch (action) {
        case 'mic':
          if (state.localAudioTrack) {
            state.isMicOn = !state.isMicOn;
            state.localAudioTrack.setEnabled(state.isMicOn);
          }
          const micIcon = btn.querySelector('i');
          if (micIcon) {
            micIcon.classList.toggle('fa-microphone');
            micIcon.classList.toggle('fa-microphone-slash');
          }
          showNotification(state.isMicOn ? 'Microphone ON' : 'Microphone OFF', 'mic');
          break;
          
        case 'cam':
          if (state.localVideoTrack) {
            state.isCameraOn = !state.isCameraOn;
            state.localVideoTrack.setEnabled(state.isCameraOn);
          }
          state.isCameraOn = !state.isCameraOn;
          const camIcon = btn.querySelector('i');
          if (camIcon) {
            camIcon.classList.toggle('fa-video');
            camIcon.classList.toggle('fa-video-slash');
          }
          showNotification(state.isCameraOn ? 'Camera ON' : 'Camera OFF', 'camera');
          break;
          
        case 'share':
          handleScreenShare();
          break;
          
        case 'record':
          toggleRecording(btn);
          break;
          
        case 'attendance':
          takeAttendance();
          break;
          
        case 'chat':
          toggleChatDrawer();
          break;
          
        case 'hand':
          toggleHandRaise(btn);
          break;
          
        case 'whiteboard':
          toggleWhiteboard();
          break;
          
        case 'blur':
          toggleBlurBackground(btn);
          break;

        case 'end':
          endCall();
          break;
      }
    }

    // ============= DESKTOP CHAT INPUT MANAGEMENT =============
    function showDesktopChatInput() {
      if (!state.isMobile) {
        desktopChatInput.classList.add('active');
        chatDesktopInput.focus();
        state.desktopChatInputVisible = true;
      }
    }

    function hideDesktopChatInput() {
      desktopChatInput.classList.remove('active');
      state.desktopChatInputVisible = false;
    }

    function toggleDesktopChatInput() {
      if (state.desktopChatInputVisible) {
        hideDesktopChatInput();
      } else {
        showDesktopChatInput();
      }
    }

    // Focus on desktop input when clicking anywhere on input panel
    desktopChatInput.addEventListener('click', (e) => {
      if (e.target === desktopChatInput || e.target.closest('.chat-input-desktop-wrapper')) {
        chatDesktopInput.focus();
        showDesktopChatInput();
      }
    });

    // ============= SCREEN SHARING =============
    function handleScreenShare() {
      if (!state.isHost) {
        requestScreenShare();
        return;
      }
      
      if (state.isScreenSharing) {
        stopScreenSharing();
      } else {
        startScreenShareCountdown();
      }
    }

    function requestScreenShare() {
      if (state.screenShareRequests.some(req => req.studentId === state.currentUser?.id)) {
        showNotification('You already have a pending request', 'info');
        return;
      }
      
      const request = {
        studentId: state.currentUser?.id || 'student',
        studentName: state.currentUser?.name || 'Student',
        timestamp: Date.now()
      };
      
      state.screenShareRequests.push(request);
      
      const messagesContainer = document.getElementById('chat-messages');
      const systemDiv = document.createElement('div');
      systemDiv.className = 'message system';
      systemDiv.innerHTML = `${state.currentUser?.name} wants to share screen.`;
      messagesContainer.appendChild(systemDiv);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
      
      showNotification('Screen share request sent to host', 'info');
    }

    function startScreenShareCountdown() {
      screenShareModal.style.display = 'flex';
      let countdown = 3;
      const countdownEl = document.getElementById('countdown');
      countdownEl.textContent = countdown;
      
      const countdownInterval = setInterval(() => {
        countdown--;
        countdownEl.textContent = countdown;
        
        if (countdown === 0) {
          clearInterval(countdownInterval);
          startScreenSharing();
        }
      }, 1000);
    }

    async function startScreenSharing() {
      screenShareModal.style.display = 'none';
      
      try {
        const screenTrack = await AgoraRTC.createScreenVideoTrack({
          encoderConfig: "1080p_1",
          optimizationMode: "detail"
        });

        if (Array.isArray(screenTrack)) {
          state.localScreenTrack = screenTrack[0];
        } else {
          state.localScreenTrack = screenTrack;
        }

        state.localScreenTrack.on("track-ended", () => {
          stopScreenSharing();
        });

        if (state.localVideoTrack) {
          state.localVideoTrack.stop();
          await state.client.unpublish(state.localVideoTrack);
        }

        await state.client.publish(state.localScreenTrack);
        
        const uid = state.currentUser.id;
        const playerContainer = document.getElementById(`player-${uid}`);
        if (playerContainer) playerContainer.style.transform = 'none';
        
        state.localScreenTrack.play(`player-${uid}`);

        state.isScreenSharing = true;
        
        const myTile = document.getElementById(`tile-${uid}`);
        if (myTile) myTile.classList.add('screen-sharing');
        
        const shareBtn = document.querySelector('[data-action="share"]');
        shareBtn.innerHTML = '<i class="fas fa-stop"></i>';
        shareBtn.setAttribute('data-tooltip', 'Stop Sharing');
        
        showNotification('Screen sharing started', 'share');
      } catch (error) {
        console.error("Error starting screen share:", error);
        if (error.code !== 'PERMISSION_DENIED') {
          showNotification('Failed to start screen share', 'end');
        }
      }
    }

    async function stopScreenSharing() {
      if (!state.isScreenSharing) return;

      try {
        if (state.localScreenTrack) {
          state.localScreenTrack.stop();
          await state.client.unpublish(state.localScreenTrack);
          state.localScreenTrack.close();
          state.localScreenTrack = null;
        }

        if (state.localVideoTrack) {
          await state.client.publish(state.localVideoTrack);
          const uid = state.currentUser.id;
          const playerContainer = document.getElementById(`player-${uid}`);
          if (playerContainer) playerContainer.style.transform = 'scaleX(-1)';
          
          state.localVideoTrack.play(`player-${uid}`);
        }

        state.isScreenSharing = false;
        
        const uid = state.currentUser.id;
        const myTile = document.getElementById(`tile-${uid}`);
        if (myTile) myTile.classList.remove('screen-sharing');
        
        const shareBtn = document.querySelector('[data-action="share"]');
        shareBtn.innerHTML = '<i class="fas fa-desktop"></i>';
        shareBtn.setAttribute('data-tooltip', 'Share Screen');
        
        showNotification('Screen sharing stopped', 'share');
      } catch (error) {
        console.error("Error stopping screen share:", error);
      }
    }

    function cancelScreenShare() {
      screenShareModal.style.display = 'none';
      showNotification('Screen share cancelled', 'info');
    }

    // ============= CHAT SYSTEM REDESIGN =============
    function toggleChatDrawer() {
      chatDrawer.classList.toggle('open');
      if (chatDrawer.classList.contains('open')) {
        chatDrawerInput.focus();
        hideDesktopChatInput();
      } else {
        // When closing drawer, show desktop input if not on mobile
        if (!state.isMobile) {
          setTimeout(() => {
            showDesktopChatInput();
          }, 300);
        }
      }
    }

    document.getElementById('close-chat-drawer').addEventListener('click', () => {
      chatDrawer.classList.remove('open');
      if (!state.isMobile) {
        setTimeout(() => {
          showDesktopChatInput();
        }, 300);
      }
    });

    // Create AI Card
    function createAICard(type, title, subtitle, content, actions = []) {
      const card = document.createElement('div');
      card.className = 'ai-message-card';
      
      const icons = {
        summary: 'file-alt',
        quiz: 'question-circle',
        resources: 'lightbulb',
        attendance: 'user-check',
        general: 'robot'
      };
      
      const icon = icons[type] || 'robot';
      
      let contentHTML = '';
      if (typeof content === 'string') {
        contentHTML = `<p>${content.replace(/\n/g, '</p><p>')}</p>`;
      } else {
        contentHTML = content;
      }
      
      const actionsHTML = actions.map(action => `
        <button class="ai-card-btn ${action.primary ? 'primary' : ''}" onclick="${action.onclick || ''}">
          <i class="fas fa-${action.icon}"></i>
          ${action.text}
        </button>
      `).join('');
      
      card.innerHTML = `
        <div class="ai-card-header">
          <div class="ai-card-icon">
            <i class="fas fa-${icon}"></i>
          </div>
          <div>
            <div class="ai-card-title">${title}</div>
            <div class="ai-card-subtitle">${subtitle}</div>
          </div>
        </div>
        <div class="ai-card-content">
          ${contentHTML}
        </div>
        <div class="ai-card-actions">
          ${actionsHTML}
        </div>
      `;
      
      return card;
    }

    // Add message to chat
    function addMessage(text, sender, isSelf = false, fromDesktop = false, time = null) {
      const messagesContainer = document.getElementById('chat-messages');
      const messageDiv = document.createElement('div');
      const timeStr = time ? new Date(time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

      if (sender === 'system') {
        messageDiv.className = 'message system';
        messageDiv.textContent = text;
      } else {
        messageDiv.className = isSelf ? 'message self' : 'message other';
        
        if (!isSelf && sender) {
          messageDiv.innerHTML = `
            <div class="message-sender">${sender}</div>
            ${text}
            <div class="message-time">${timeStr}</div>
          `;
        } else {
          messageDiv.innerHTML = `
            ${text}
            <div class="message-time">${timeStr}</div>
          `;
        }
      }
      
      messagesContainer.appendChild(messageDiv);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
      
      // Hide desktop input after sending message from desktop interface
      if (fromDesktop && state.desktopChatInputVisible) {
        setTimeout(() => {
          hideDesktopChatInput();
        }, 300);
      }
    }

    async function sendMessage(fromDesktop = false) {
      const input = fromDesktop ? chatDesktopInput : chatDrawerInput;
      const text = input.value.trim();
      const gid = new URLSearchParams(window.location.search).get('groupId');
      
      if (text) {
        try {
          const { error } = await supabase
            .from('group_messages')
            .insert({
              group_id: gid,
              sender_id: state.currentUser.id,
              sender_name: state.currentUser.name,
              content: text
            });

          if (error) throw error;
          
          input.value = '';
          // Auto-hide desktop chat input after sending
          if (fromDesktop) {
            hideDesktopChatInput();
          }
        } catch (error) {
          console.error('Error sending message:', error);
          showNotification('Failed to send message', 'info');
        }
      }
    }

    // Desktop send button
    desktopSendBtn.addEventListener('click', () => sendMessage(true));
    
    // Drawer send button
    drawerSendBtn.addEventListener('click', () => sendMessage(false));

    // Enter key listeners
    chatDesktopInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage(true);
      }
    });

    chatDrawerInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage(false);
      }
    });

    // Action buttons
    desktopAttachBtn.addEventListener('click', () => {
      showNotification('File attachment dialog would open here', 'info');
    });

    desktopEmojiBtn.addEventListener('click', () => {
      showNotification('Emoji picker would open here', 'info');
    });

    // Clicking on desktop chat input field shows the panel
    chatDesktopInput.addEventListener('focus', () => {
      if (!state.desktopChatInputVisible) {
        showDesktopChatInput();
      }
    });

    // Hide desktop chat input when clicking outside (except on control bar)
    document.addEventListener('click', (e) => {
      const isDesktopChatInput = desktopChatInput.contains(e.target);
      const isControlBar = document.getElementById('control-bar').contains(e.target);
      const isChatButton = e.target.closest('[data-action="chat"]');
      const isChatDrawerOpen = chatDrawer.classList.contains('open');
      
      if (!isDesktopChatInput && !isControlBar && state.desktopChatInputVisible && !isChatButton && !isChatDrawerOpen) {
        hideDesktopChatInput();
      }
    });

    // ============= WHITEBOARD =============
    function toggleWhiteboard() {
      state.isWhiteboardActive = !state.isWhiteboardActive;
      whiteboardOverlay.classList.toggle('active');
      whiteboardTools.classList.toggle('active');
      
      if (state.isWhiteboardActive) {
        resizeCanvas();
        showNotification('Whiteboard Activated', 'whiteboard');
      } else {
        showNotification('Whiteboard Closed', 'whiteboard');
      }
    }

    function resizeCanvas() {
      whiteboardCanvas.width = whiteboardCanvas.offsetWidth;
      whiteboardCanvas.height = whiteboardCanvas.offsetHeight;
    }

    function getCanvasCoordinates(e) {
      const rect = whiteboardCanvas.getBoundingClientRect();
      const scaleX = whiteboardCanvas.width / rect.width;
      const scaleY = whiteboardCanvas.height / rect.height;
      
      let clientX, clientY;
      if (e.type.includes('touch')) {
        clientX = e.touches[0].clientX;
        clientY = e.touches[0].clientY;
      } else {
        clientX = e.clientX;
        clientY = e.clientY;
      }
      
      return {
        x: (clientX - rect.left) * scaleX,
        y: (clientY - rect.top) * scaleY
      };
    }

    whiteboardCanvas.addEventListener('mousedown', (e) => {
      state.drawing = true;
      const { x, y } = getCanvasCoordinates(e);
      state.lastX = x;
      state.lastY = y;
    });

    whiteboardCanvas.addEventListener('touchstart', (e) => {
      e.preventDefault();
      state.drawing = true;
      const { x, y } = getCanvasCoordinates(e);
      state.lastX = x;
      state.lastY = y;
    });

    whiteboardCanvas.addEventListener('mousemove', (e) => {
      if (!state.drawing) return;
      
      const { x, y } = getCanvasCoordinates(e);
      
      ctx.beginPath();
      ctx.moveTo(state.lastX, state.lastY);
      ctx.lineTo(x, y);
      
      if (state.currentWhiteboardTool === 'pen') {
        ctx.strokeStyle = 'var(--accent-blue)';
        ctx.lineWidth = 3;
        ctx.lineCap = 'round';
        ctx.stroke();
      } else if (state.currentWhiteboardTool === 'eraser') {
        ctx.strokeStyle = 'rgba(0,0,0,0.1)';
        ctx.lineWidth = 20;
        ctx.globalCompositeOperation = 'destination-out';
        ctx.stroke();
        ctx.globalCompositeOperation = 'source-over';
      }
      
      state.lastX = x;
      state.lastY = y;
    });

    whiteboardCanvas.addEventListener('touchmove', (e) => {
      e.preventDefault();
      if (!state.drawing) return;
      
      const { x, y } = getCanvasCoordinates(e);
      
      ctx.beginPath();
      ctx.moveTo(state.lastX, state.lastY);
      ctx.lineTo(x, y);
      
      if (state.currentWhiteboardTool === 'pen') {
        ctx.strokeStyle = 'var(--accent-blue)';
        ctx.lineWidth = 3;
        ctx.lineCap = 'round';
        ctx.stroke();
      } else if (state.currentWhiteboardTool === 'eraser') {
        ctx.strokeStyle = 'rgba(0,0,0,0.1)';
        ctx.lineWidth = 20;
        ctx.globalCompositeOperation = 'destination-out';
        ctx.stroke();
        ctx.globalCompositeOperation = 'source-over';
      }
      
      state.lastX = x;
      state.lastY = y;
    });

    whiteboardCanvas.addEventListener('mouseup', () => state.drawing = false);
    whiteboardCanvas.addEventListener('mouseout', () => state.drawing = false);
    whiteboardCanvas.addEventListener('touchend', () => state.drawing = false);

    document.querySelectorAll('.whiteboard-tool[data-tool]').forEach(tool => {
      tool.addEventListener('click', () => {
        document.querySelectorAll('.whiteboard-tool').forEach(t => t.classList.remove('active'));
        tool.classList.add('active');
        state.currentWhiteboardTool = tool.dataset.tool;
        
        if (state.currentWhiteboardTool === 'clear') {
          ctx.clearRect(0, 0, whiteboardCanvas.width, whiteboardCanvas.height);
        }
      });
    });

    function closeWhiteboard() {
      state.isWhiteboardActive = false;
      whiteboardOverlay.classList.remove('active');
      whiteboardTools.classList.remove('active');
    }

    function saveWhiteboard() {
      const link = document.createElement('a');
      link.download = `whiteboard-${new Date().toISOString().replace(/[:.]/g, '-')}.png`;
      link.href = whiteboardCanvas.toDataURL('image/png');
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      showNotification('Whiteboard saved to downloads', 'download');
    }

    // ============= AI FUNCTIONS REDESIGN =============
    async function generateSummary() {
      const chatHistory = Array.from(document.querySelectorAll('#chat-messages .message:not(.system):not(.ai-message-card)'))
        .map(msg => msg.textContent)
        .slice(-10)
        .join('\n');
      
      const prompt = `You are an AI teaching assistant. Summarize the following class discussion in 3-5 key points. Keep it concise and educational. Format as a clear summary with bullet points.\n\nDiscussion:\n${chatHistory}\n\nSummary:`;
      
      const summary = await callGeminiAI(prompt, 'summary');
      
      const messagesContainer = document.getElementById('chat-messages');
      const card = createAICard(
        'summary',
        'Lesson Summary',
        'AI-generated key points from discussion',
        summary,
        [
          { text: 'View Summary', icon: 'eye', primary: true },
          { text: 'Save Notes', icon: 'save' },
          { text: 'Share', icon: 'share' }
        ]
      );
      
      messagesContainer.appendChild(card);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    async function generateQuiz() {
      const chatHistory = Array.from(document.querySelectorAll('#chat-messages .message:not(.system):not(.ai-message-card)'))
        .map(msg => msg.textContent)
        .slice(-10)
        .join('\n');
      
      const prompt = `Based on the classroom discussion, generate a 3-question multiple choice quiz to test understanding. Format as clear questions with options and indicate correct answers. Make it educational and relevant.\n\nDiscussion:\n${chatHistory}`;
      
      const quiz = await callGeminiAI(prompt, 'quiz');
      
      const messagesContainer = document.getElementById('chat-messages');
      const card = createAICard(
        'quiz',
        'Practice Quiz',
        'Test your understanding of today\'s discussion',
        quiz,
        [
          { text: 'Start Quiz', icon: 'play', primary: true },
          { text: 'Save Quiz', icon: 'save' },
          { text: 'Share with Class', icon: 'share' }
        ]
      );
      
      messagesContainer.appendChild(card);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    async function suggestResources() {
      const chatHistory = Array.from(document.querySelectorAll('#chat-messages .message:not(.system):not(.ai-message-card)'))
        .map(msg => msg.textContent)
        .slice(-10)
        .join('\n');
      
      const prompt = `Based on the classroom discussion, suggest 3-5 learning resources (books, articles, videos, websites) that would help students better understand the topics discussed. Include brief descriptions and why they're valuable.\n\nDiscussion:\n${chatHistory}\n\nSuggested Resources:`;
      
      const resources = await callGeminiAI(prompt, 'resources');
      
      const messagesContainer = document.getElementById('chat-messages');
      const card = createAICard(
        'resources',
        'Learning Resources',
        'AI-curated materials for deeper understanding',
        resources,
        [
          { text: 'View Resources', icon: 'external-link-alt', primary: true },
          { text: 'Save List', icon: 'bookmark' },
          { text: 'Share', icon: 'share' }
        ]
      );
      
      messagesContainer.appendChild(card);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // ============= HOST TOOLS =============
    function muteAllParticipants() {
      showNotification('All participants muted', 'mute');
    }

    function disableAllCameras() {
      showNotification('All cameras disabled', 'camera');
    }

    async function toggleHostSpotlight() {
      const newState = !state.isPresentationMode;
      
      if (state.channel) {
        await state.channel.send({
          type: 'broadcast',
          event: 'spotlight',
          payload: { active: newState }
        });
      }
      
      toggleSpotlightUI(newState);
    }

    function toggleSpotlightUI(active) {
      state.isPresentationMode = active;
      const container = document.getElementById('video-container');
      
      if (active) {
        const hostTile = document.getElementById(`tile-${state.hostId}`);
        if (hostTile) {
            container.prepend(hostTile);
        }
        container.classList.add('presentation-mode');
        showNotification('Host Spotlight Active', 'spotlight');
      } else {
        container.classList.remove('presentation-mode');
        showNotification('Spotlight Disabled', 'spotlight');
      }
    }

    function showPendingRequests() {
      showNotification(`${state.screenShareRequests.length} pending requests`, 'info');
    }

    function copyClassLink() {
      const link = `https://peerloom.com/live/${Math.random().toString(36).substr(2, 9)}`;
      navigator.clipboard.writeText(link);
      showNotification('Class link copied to clipboard', 'link');
    }

    // ============= HELPER FUNCTIONS =============
    function toggleRecording(btn) {
      state.isRecording = !state.isRecording;
      if (state.isRecording) {
        btn.classList.add('recording');
        showNotification('Recording Started', 'recording');
      } else {
        btn.classList.remove('recording');
        showNotification('Recording Stopped', 'recording');
      }
    }

    function toggleHandRaise(btn) {
      state.isHandRaised = !state.isHandRaised;
      if (state.isHandRaised) {
        btn.classList.add('active');
        showNotification('Hand Raised', 'hand');
      } else {
        btn.classList.remove('active');
      }
    }

    function endCall() {
      if (confirm('Are you sure you want to leave the class?')) {
        showNotification('Leaving class...', 'end');
        
        // Leave Agora Channel
        if (state.client) {
          state.client.leave();
          if (state.localAudioTrack) state.localAudioTrack.close();
          if (state.localVideoTrack) state.localVideoTrack.close();
        }

        setTimeout(() => {
          alert('Redirecting to dashboard...');
        }, 1000);
      }
    }

    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 80px;
        right: 20px;
        background: var(--glass-bg);
        backdrop-filter: var(--glass-blur);
        border: 1px solid var(--glass-border);
        padding: 14px 20px;
        border-radius: 16px;
        box-shadow: var(--shadow);
        z-index: 3000;
        animation: slideIn 0.3s ease-out;
        max-width: 300px;
        display: flex;
        align-items: center;
        gap: 12px;
        color: var(--text-color);
      `;
      
      let icon = 'info-circle';
      let iconColor = 'var(--accent-blue)';
      
      switch(type) {
        case 'recording': icon = 'circle-dot'; iconColor = 'var(--red)'; break;
        case 'hand': icon = 'hand'; iconColor = 'var(--accent-yellow)'; break;
        case 'mic': icon = 'microphone'; iconColor = 'var(--accent-green)'; break;
        case 'camera': icon = 'video'; iconColor = 'var(--accent-green)'; break;
        case 'ai': icon = 'robot'; iconColor = 'var(--accent-purple)'; break;
        case 'theme': icon = 'palette'; iconColor = 'var(--accent-purple)'; break;
        case 'user': icon = 'user'; iconColor = 'var(--accent-blue)'; break;
        case 'share': icon = 'desktop'; iconColor = 'var(--accent-blue)'; break;
        case 'end': icon = 'phone-slash'; iconColor = 'var(--red)'; break;
        case 'download': icon = 'download'; iconColor = 'var(--accent-green)'; break;
        case 'link': icon = 'link'; iconColor = 'var(--accent-blue)'; break;
        case 'check': icon = 'check-circle'; iconColor = 'var(--accent-green)'; break;
        case 'spotlight': icon = 'star'; iconColor = 'var(--accent-yellow)'; break;
      }
      
      notification.innerHTML = `
        <i class="fas fa-${icon}" style="color: ${iconColor}; font-size: 18px;"></i>
        <span>${message}</span>
      `;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease-out';
        setTimeout(() => {
          document.body.removeChild(notification);
        }, 300);
      }, 3000);
    }

    // ============= THEME TOGGLE =============
    document.getElementById('dark-mode-toggle').addEventListener('click', () => {
      document.body.classList.toggle('light-mode');
      document.body.classList.toggle('dark-mode');
      const icon = document.querySelector('#dark-mode-toggle i');
      icon.classList.toggle('fa-moon');
      icon.classList.toggle('fa-sun');
      showNotification(document.body.classList.contains('light-mode') ? 'Light Mode' : 'Dark Mode', 'theme');
    });

    // ============= AI PANEL =============
    document.getElementById('ai-toggle').addEventListener('click', () => {
      aiPanel.classList.toggle('open');
    });

    // ============= AGORA VIDEO LOGIC =============
    async function initAgora(channelName, uid, userName) {
      updateLoadingStatus("Checking system requirements...");
      
      if (!state.agoraAppId) {
        showCriticalError("Configuration Error: Agora App ID is missing.");
        return;
      }

      // 0. Check System Requirements (Crucial for production apps)
      if (!AgoraRTC.checkSystemRequirements()) {
        showNotification("Your browser does not support video calling.", "end");
        return;
      }

      // 1. Create Client
      state.client = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });

      // 2. Add Event Listeners
      state.client.on("user-published", handleUserPublished);
      state.client.on("user-unpublished", handleUserUnpublished);
      
      // Handle user joining
      state.client.on("user-joined", (user) => {
        const student = state.students.find(s => s.id === user.uid);
        const name = student ? student.name : `User ${user.uid}`;
        showNotification(`${name} joined the meeting`, 'user');
      });

      // Handle user leaving (explicit leave or timeout)
      state.client.on("user-left", (user, reason) => {
        const tile = document.getElementById(`tile-${user.uid}`);
        if (tile) tile.remove();
        
        const student = state.students.find(s => s.id === user.uid);
        const name = student ? student.name : `User ${user.uid}`;
        
        if (reason === "ServerTimeOut") {
           showNotification(`${name} dropped due to network timeout`, "info");
        } else {
           showNotification(`${name} left the meeting`, "end");
        }
      });

      // Handle connection state changes (Reconnecting logic)
      state.client.on("connection-state-change", (curState, prevState) => {
        if (curState === "RECONNECTING") {
          showNotification("Connection lost. Reconnecting...", "info");
          document.getElementById('video-container').style.opacity = "0.5";
        } else if (curState === "CONNECTED" && prevState === "RECONNECTING") {
          showNotification("Connection restored", "info");
          document.getElementById('video-container').style.opacity = "1";
        }
      });

      // Handle network quality updates
      state.client.on("network-quality", (stats) => {
        const uid = state.currentUser.id;
        const quality = Math.max(stats.downlinkNetworkQuality, stats.uplinkNetworkQuality);
        updateNetworkUI(quality);
      });
      
      // Handle exceptions
      state.client.on("exception", (event) => {
        if (event.code === 1003) { // Input device error
           showNotification("Microphone/Camera error. Check devices.", "end");
        }
      });
      
      // Handle token expiration (Best Practice: Renew 30s before expiry)
      state.client.on("token-privilege-will-expire", async () => {
        console.log("Token expiring soon, renewing...");
        await renewToken(channelName, uid);
      });

      try {
        // 3. Join Channel
        // PRODUCTION UPDATE: Token Authentication
        updateLoadingStatus("Authenticating...");
        // Since this is a launched app, you must use tokens to prevent unauthorized access.
        // We attempt to fetch a token from Supabase Edge Functions.
        let token = null;
        
        console.log("Agora App ID:", state.agoraAppId)
        
        // [TEMP FIX] Paste your temp token from Agora Console here:
        // token = "YOUR_LONG_TOKEN_STRING_HERE";

        try {
          // [PRODUCTION] Uncomment this when you have the Edge Function deployed
          const { data, error } = await supabase.functions.invoke('generate-agora-token', {
            body: { channelName, uid }
          });
          if (error) throw error;
          if (data?.token) token = data.token;
        } catch (error) {
          console.error("Token fetch failed:", error);
          // Show warning if token generation fails (likely due to deployment issue)
          if (error) {
             showNotification("Warning: Token server unreachable. Video may fail.", "end");
          }
        }

        updateLoadingStatus("Connecting to media server...");
        await state.client.join(state.agoraAppId, channelName, token, uid);

        // 4. Create & Publish Local Tracks
        // If tracks were not created in settings (e.g. skipped), create them now
        if (!state.localAudioTrack || !state.localVideoTrack) {
          try {
            updateLoadingStatus("Accessing camera and microphone...");
            [state.localAudioTrack, state.localVideoTrack] = await AgoraRTC.createMicrophoneAndCameraTracks();
          } catch (permError) {
            if (permError.name === 'NotAllowedError') {
              showNotification("Microphone/Camera access denied. Please check browser settings.", "end");
              return;
            }
            throw permError;
          }
        }
        
        // Render Local Video
        const container = document.getElementById('video-container');
        const hostTile = document.getElementById('host-tile');
        
        if (state.isHost && hostTile) {
          // Reuse host tile for local host video
          hostTile.id = `tile-${uid}`;
          hostTile.innerHTML = '';
          
          const playerContainer = document.createElement('div');
          playerContainer.id = `player-${uid}`;
          playerContainer.style.width = '100%';
          playerContainer.style.height = '100%';
          playerContainer.style.position = 'absolute';
          playerContainer.style.top = '0';
          playerContainer.style.left = '0';
          playerContainer.style.transform = 'scaleX(-1)'; // Mirror local
          hostTile.appendChild(playerContainer);
          
          const nameTag = document.createElement('div');
          nameTag.className = 'name-tag';
          nameTag.innerHTML = `<span>${userName} (You)</span><span class="host-badge">HOST</span>`;
          hostTile.appendChild(nameTag);
          
          state.localVideoTrack.play(`player-${uid}`);
        } else {
          // Normal student or fallback
          const localPlayerDiv = createVideoTile(uid, userName + " (You)", true);
          container.appendChild(localPlayerDiv);
          state.localVideoTrack.play(`player-${uid}`);
        }

        // Publish
        await state.client.publish([state.localAudioTrack, state.localVideoTrack]);
        showNotification("Connected to video stream", "camera");
        
        // Hide loading screen on success
        loadingOverlay.classList.add('hidden');

      } catch (error) {
        console.error("Agora Error:", error);
        loadingOverlay.classList.add('hidden'); // Hide loading to show error
        if (error.code === "CAN_NOT_GET_GATEWAY_SERVER") {
          showCriticalError("Security Error: Invalid App ID or Token. Please contact support.");
        } else {
          showCriticalError("Connection failed: " + error.message);
        }
      }
    }

    async function renewToken(channelName, uid) {
      try {
        // Call Supabase Edge Function to get new token
        const { data, error } = await supabase.functions.invoke('generate-agora-token', {
          body: { channelName, uid }
        });
        
        if (!error && data?.token) {
          await state.client.renewToken(data.token);
          console.log("Token renewed successfully");
        }
      } catch (error) {
        console.error("Token renewal failed:", error);
      }
    }

    function createVideoTile(uid, name, isLocal = false) {
      const div = document.createElement('div');
      div.className = 'video-tile';
      div.id = `tile-${uid}`;
      
      // The actual video element container that Agora will target
      const playerContainer = document.createElement('div');
      playerContainer.id = `player-${uid}`;
      playerContainer.style.width = '100%';
      playerContainer.style.height = '100%';
      playerContainer.style.position = 'absolute';
      playerContainer.style.top = '0';
      playerContainer.style.left = '0';
      // Fix for local video mirroring
      if (isLocal) playerContainer.style.transform = 'scaleX(-1)';
      
      div.appendChild(playerContainer);

      // Name Tag
      const nameTag = document.createElement('div');
      nameTag.className = 'name-tag';
      nameTag.innerHTML = `<span>${name}</span>`;
      div.appendChild(nameTag);

      return div;
    }

    async function handleUserPublished(user, mediaType) {
      await state.client.subscribe(user, mediaType);

      if (mediaType === 'video') {
        console.log(`Subscribing to video of user ${user.uid}`);
        const container = document.getElementById('video-container');
        // Check if tile exists
        let tile = document.getElementById(`tile-${user.uid}`);
        
        if (!tile) {
          let name = `User ${user.uid}`;
          const isHostUser = (user.uid === state.hostId);

          if (isHostUser) {
            name = state.hostName || 'Host';
            // Reuse the placeholder host tile
            const placeholder = document.getElementById('host-tile');
            if (placeholder) {
              tile = placeholder;
              tile.id = `tile-${user.uid}`;
              tile.innerHTML = ''; // Clear placeholder content
              
              const playerContainer = document.createElement('div');
              playerContainer.id = `player-${user.uid}`;
              playerContainer.style.width = '100%';
              playerContainer.style.height = '100%';
              playerContainer.style.position = 'absolute';
              playerContainer.style.top = '0';
              playerContainer.style.left = '0';
              tile.appendChild(playerContainer);
              
              const nameTag = document.createElement('div');
              nameTag.className = 'name-tag';
              nameTag.innerHTML = `<span>${name}</span><span class="host-badge">HOST</span>`;
              tile.appendChild(nameTag);
            }
          }

          if (!tile) {
            // Try to find name from Supabase list, fallback to fetching profile
            const student = state.students.find(s => s.id === user.uid);
            if (student) {
              name = student.name;
            } else {
              const { data: profile } = await supabase.from('profiles').select('full_name, username').eq('id', user.uid).single();
              if (profile) name = profile.full_name || profile.username;
            }
            
            tile = createVideoTile(user.uid, name);
            container.appendChild(tile);
          }
          
          // Track attendance
          updateAttendance({ id: user.uid, name: name });
        }
        user.videoTrack.play(`player-${user.uid}`);
      }

      if (mediaType === 'audio') {
        console.log(`Subscribing to audio of user ${user.uid}`);
        user.audioTrack.play();
      }
    }


    async function handleUserUnpublished(user, mediaType) {
      console.log(`User ${user.uid} unpublished ${mediaType}`);
      if (mediaType === 'video') {
        const tile = document.getElementById(`tile-${user.uid}`);
        if (tile) tile.remove();
      }
    }

    function updateNetworkUI(quality) {
      const icon = document.querySelector('.fa-signal');
      const text = document.querySelector('.fa-signal + span');
      
      // 0: unknown, 1: excellent, 2: good, 3: poor, 4: bad, 5: vbad, 6: down
      if (quality <= 2) {
        icon.style.color = 'var(--accent-green)';
        text.textContent = 'HD';
      } else if (quality <= 4) {
        icon.style.color = 'var(--accent-yellow)';
        text.textContent = 'Weak';
      } else {
        icon.style.color = 'var(--red)';
        text.textContent = 'Bad';
      }
    }

    // Function to enable/disable low bandwidth mode
    function setLowBandwidthMode(enabled) {
      state.lowBandwidthMode = enabled;
    }

    // ============= WAITING ROOM LOGIC =============
    async function checkWaitingRoom(gid, user, onApproved) {
      // Check if request exists
      const { data: request } = await supabase
        .from('meeting_requests')
        .select('*')
        .eq('group_id', gid)
        .eq('user_id', user.id)
        .maybeSingle();

      if (request?.status === 'approved') {
        onApproved();
        return true;
      }
      
      // Show waiting screen
      document.getElementById('waiting-room-overlay').classList.remove('hidden');

      if (!request) {
        await supabase.from('meeting_requests').insert({
          group_id: gid,
          user_id: user.id,
          user_name: user.user_metadata.firstName || user.user_metadata.full_name || 'Student',
          status: 'pending'
        });
      } else if (request.status === 'rejected') {
        // Reset rejected status to pending to allow re-entry attempt
        await supabase.from('meeting_requests')
          .update({ status: 'pending' })
          .eq('id', request.id);
      }

      // Listen for approval
      supabase.channel(`waiting_${user.id}`)
        .on('postgres_changes', { 
          event: 'UPDATE', 
          schema: 'public', 
          table: 'meeting_requests', 
          filter: `user_id=eq.${user.id}`
        }, (payload) => {
          if (payload.new.status === 'approved') {
            document.getElementById('waiting-room-overlay').classList.add('hidden');
            onApproved();
          } else if (payload.new.status === 'rejected') {
            alert("Access denied.");
            window.location.href = 'dashboard.html';
          }
        })
        .subscribe();

      return false;
    }

    function setupHostWaitingRoom(gid) {
      fetchPendingRequests(gid);
      
      supabase.channel('host_waiting_room')
        .on('postgres_changes', {
          event: '*',
          schema: 'public',
          table: 'meeting_requests',
          filter: `group_id=eq.${gid}`
        }, () => fetchPendingRequests(gid))
        .subscribe();
    }

    function playNotificationSound() {
      try {
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        if (!AudioContext) return;
        const ctx = new AudioContext();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.type = 'sine';
        osc.frequency.setValueAtTime(880, ctx.currentTime);
        gain.gain.setValueAtTime(0.1, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.00001, ctx.currentTime + 0.5);
        osc.start();
        osc.stop(ctx.currentTime + 0.5);
      } catch (e) { console.error(e); }
    }

    async function fetchPendingRequests(gid) {
      const { data: requests } = await supabase
        .from('meeting_requests')
        .select('*')
        .eq('group_id', gid)
        .eq('status', 'pending');
      
      let newData = requests || [];

      if (newData.length > 0) {
        const userIds = newData.map(r => r.user_id);
        const { data: profiles } = await supabase
          .from('profiles')
          .select('id, profile_photo')
          .in('id', userIds);
        
        if (profiles) {
          newData = newData.map(req => {
            const profile = profiles.find(p => p.id === req.user_id);
            return { ...req, profile_photo: profile?.profile_photo };
          });
        }
      }
      
      if (newData.length > state.waitingStudents.length) {
        playNotificationSound();
        showNotification('New student in waiting room', 'user');
      }
      
      state.waitingStudents = newData;
      updateWaitingRoomUI();
    }

    function updateWaitingRoomUI() {
      const badge = document.getElementById('waiting-room-badge');
      const list = document.getElementById('waiting-list');
      const acceptAllBtn = document.getElementById('accept-all-btn');
      
      if (state.waitingStudents.length > 0) {
        badge.textContent = state.waitingStudents.length;
        badge.style.display = 'flex';
        if (acceptAllBtn) acceptAllBtn.style.display = 'block';
      } else {
        badge.style.display = 'none';
        if (acceptAllBtn) acceptAllBtn.style.display = 'none';
      }

      list.innerHTML = state.waitingStudents.length === 0 ? '<div style="padding:20px; text-align:center; opacity:0.7;">No pending requests</div>' : '';

      state.waitingStudents.forEach(req => {
        const div = document.createElement('div');
        div.className = 'waiting-list-item';
        
        const initials = (req.user_name || 'S').charAt(0).toUpperCase();
        const avatarHtml = req.profile_photo 
          ? `<img src="${req.profile_photo}" style="width:32px; height:32px; border-radius:50%; object-fit:cover; margin-right:10px; border: 1px solid var(--glass-border);">`
          : `<div style="width:32px; height:32px; border-radius:50%; background:linear-gradient(135deg, var(--accent-blue), var(--accent-purple)); color:white; display:flex; align-items:center; justify-content:center; margin-right:10px; font-size:14px; font-weight:bold;">${initials}</div>`;

        div.innerHTML = `
          <div style="display:flex; align-items:center;">${avatarHtml}<span style="font-weight:500;">${req.user_name}</span></div>
          <div class="waiting-actions">
            <button class="approve-btn" onclick="approveStudent('${req.id}')"><i class="fas fa-check"></i></button>
            <button class="reject-btn" onclick="rejectStudent('${req.id}')"><i class="fas fa-times"></i></button>
          </div>
        `;
        list.appendChild(div);
      });
    }

    async function approveStudent(id) {
      console.log('Approving student:', id);
      try {
        const { error } = await supabase.from('meeting_requests').update({ status: 'approved' }).eq('id', id);
        if (error) throw error;
        
        // Optimistically remove from UI
        state.waitingStudents = state.waitingStudents.filter(s => s.id !== id);
        updateWaitingRoomUI();
        showNotification('Student admitted', 'check');
      } catch (error) {
        console.error('Error approving student:', error);
        showNotification('Failed to approve request', 'end');
      }
    }

    async function rejectStudent(id) {
      console.log('Rejecting student:', id);
      try {
        const { error } = await supabase.from('meeting_requests').update({ status: 'rejected' }).eq('id', id);
        if (error) throw error;
        
        // Optimistically remove from UI
        state.waitingStudents = state.waitingStudents.filter(s => s.id !== id);
        updateWaitingRoomUI();
        showNotification('Request denied', 'info');
      } catch (error) {
        console.error('Error rejecting student:', error);
        showNotification('Failed to reject request', 'end');
      }
    }

    async function removeStudent(userId) {
      if (!confirm('Are you sure you want to remove this student from the meeting?')) return;
      
      const gid = new URLSearchParams(window.location.search).get('groupId');
      
      try {
        const { error } = await supabase
          .from('meeting_requests')
          .update({ status: 'rejected' })
          .eq('group_id', gid)
          .eq('user_id', userId);
          
        if (error) throw error;
        
        showNotification('Student removed', 'info');
        // The student will be disconnected via the realtime listener
      } catch (error) {
        console.error('Error removing student:', error);
        showNotification('Failed to remove student', 'end');
      }
    }

    async function approveAllStudents() {
      if (state.waitingStudents.length === 0) return;
      
      const ids = state.waitingStudents.map(s => s.id);
      console.log('Approving all students:', ids);
      
      try {
        const { error } = await supabase.from('meeting_requests').update({ status: 'approved' }).in('id', ids);
        if (error) throw error;
        
        state.waitingStudents = [];
        updateWaitingRoomUI();
        showNotification('All students admitted', 'check');
      } catch (error) {
        console.error('Error approving all students:', error);
        showNotification('Failed to approve requests', 'end');
      }
    }

    async function resetAllRequests() {
      if (!confirm('Are you sure you want to reset all waiting room requests? This will require all students to be re-admitted.')) return;

      const gid = new URLSearchParams(window.location.search).get('groupId');

      try {
        const { error } = await supabase
          .from('meeting_requests')
          .update({ status: 'pending' })
          .eq('group_id', gid);

        if (error) throw error;
        showNotification('All student requests reset to pending.', 'info');
        fetchPendingRequests(gid);
      } catch (error) {
        console.error('Error resetting requests:', error);
        showNotification('Failed to reset requests.', 'end');
      }
    }

    function openWaitingRoom() { waitingRoomModal.style.display = 'flex'; }
    function closeWaitingRoomModal() { waitingRoomModal.style.display = 'none'; }

    function updateLoadingStatus(text) {
      if (loadingStatus) loadingStatus.textContent = text;
    }

    function showCriticalError(msg) {
      document.getElementById('error-message').textContent = msg;
      document.getElementById('error-modal').style.display = 'flex';
    }

    // ============= DEVICE SETTINGS =============
    async function openDeviceSettingsModal(gid, user) {
      const modal = document.getElementById('device-settings-modal');
      const loadingOverlay = document.getElementById('loading-overlay');
      
      // Hide loading, show modal
      loadingOverlay.classList.add('hidden');
      modal.style.display = 'flex';
      
      try {
        // 1. Create initial tracks to trigger permissions
        if (!state.localAudioTrack || !state.localVideoTrack) {
           [state.localAudioTrack, state.localVideoTrack] = await AgoraRTC.createMicrophoneAndCameraTracks();
        }
        
        // 2. Play preview
        state.localVideoTrack.play('local-preview');
        
        // 3. Get Devices
        const devices = await AgoraRTC.getDevices();
        const cams = devices.filter(d => d.kind === 'videoinput');
        const mics = devices.filter(d => d.kind === 'audioinput');
        
        const camSelect = document.getElementById('camera-select');
        const micSelect = document.getElementById('mic-select');
        
        camSelect.innerHTML = cams.map(d => `<option value="${d.deviceId}">${d.label || 'Camera ' + (cams.indexOf(d) + 1)}</option>`).join('');
        micSelect.innerHTML = mics.map(d => `<option value="${d.deviceId}">${d.label || 'Microphone ' + (mics.indexOf(d) + 1)}</option>`).join('');
        
        // Listeners
        camSelect.onchange = async (e) => {
          state.selectedCamId = e.target.value;
          if (state.localVideoTrack) {
            state.localVideoTrack.stop();
            state.localVideoTrack.close();
          }
          state.localVideoTrack = await AgoraRTC.createCameraVideoTrack({ cameraId: state.selectedCamId });
          state.localVideoTrack.play('local-preview');
        };
        
        micSelect.onchange = async (e) => {
          state.selectedMicId = e.target.value;
          if (state.localAudioTrack) {
            state.localAudioTrack.stop();
            state.localAudioTrack.close();
          }
          state.localAudioTrack = await AgoraRTC.createMicrophoneAudioTrack({ microphoneId: state.selectedMicId });
        };
        
        // Join Button
        document.getElementById('join-btn').onclick = async () => {
          modal.style.display = 'none';
          loadingOverlay.classList.remove('hidden');
          await initAgora(gid, user.id, user.user_metadata.firstName || user.user_metadata.full_name || 'User');
        };

      } catch (e) {
        console.error("Error in device settings:", e);
        showCriticalError("Could not access camera/microphone. Please check permissions.");
      }
    }

    // ============= SESSION SETUP =============
    async function completeSessionSetup(gid, user) {
        // 3. Load Participants (Group Members)
        const { data: members } = await supabase
          .from('group_members')
          .select('user_id, profiles(full_name, username)')
          .eq('group_id', gid);

        if (members) {
          state.students = members
            .filter(m => m.user_id !== user.id) // Exclude self
            .map((m, i) => ({
              id: m.user_id,
              name: m.profiles?.full_name || m.profiles?.username || `User ${i}`,
              role: 'student'
            }));
        }

        // 4. Setup Chat Realtime
        state.channel = supabase.channel(`grp_${gid}`)
          .on('postgres_changes', {
            event: 'INSERT',
            schema: 'public',
            table: 'group_messages',
            filter: `group_id=eq.${gid}`
          }, (payload) => {
            const msg = payload.new;
            const isSelf = msg.sender_id === user.id;
            addMessage(msg.content, msg.sender_name, isSelf, false, msg.created_at);
          })
          .on('broadcast', { event: 'spotlight' }, (payload) => {
            toggleSpotlightUI(payload.payload.active);
          })
          .subscribe();

        // 6. Listen for Kick/Status Change
        supabase.channel(`status_${user.id}`)
          .on('postgres_changes', {
            event: 'UPDATE',
            schema: 'public',
            table: 'meeting_requests',
            filter: `user_id=eq.${user.id}`
          }, (payload) => {
            if (payload.new.status === 'rejected' && payload.new.group_id === gid) {
              alert('You have been removed from the meeting.');
              window.location.href = 'dashboard.html';
            }
          })
          .subscribe();

        // 5. Initialize Agora Video
        // Instead of initializing immediately, open settings
        openDeviceSettingsModal(gid, user);
    }

    // ============= INITIALIZATION =============
    async function initialize() {
      // 1. Check Auth
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        window.location.href = 'login.html';
        return;
      }

      const user = session.user;
      state.currentUser = {
        id: user.id,
        name: user.user_metadata.firstName || user.user_metadata.full_name || 'User',
        email: user.email,
        role: 'student' // Default role
      };
      state.isAuthenticated = true;

      // 2. Get Group Info
      const gid = new URLSearchParams(window.location.search).get('groupId');
      if (gid) {
        const { data: group } = await supabase
          .from('groups')
          .select('*')
          .eq('id', gid)
          .single();
        
        if (group) {
          state.classTitle = group.name;
          classTitleEl.textContent = group.name;
          
          state.hostId = group.created_by;
          
          // Check if host
          if (group.created_by === user.id || state.currentUser.role === 'admin') {
            state.isHost = true;
            state.currentUser.role = 'host';
            hostTools.style.display = 'flex';
            document.body.classList.add('is-host');
            hostNameEl.textContent = state.currentUser.name;
            state.hostName = state.currentUser.name;
          } else {
            // Fetch Host Name
            const { data: hostProfile } = await supabase
              .from('profiles')
              .select('full_name, username')
              .eq('id', group.created_by)
              .single();
            
            state.hostName = hostProfile?.full_name || hostProfile?.username || 'Host';
            hostNameEl.textContent = state.hostName;
          }

          // NEW: Waiting Room Check
          if (state.isHost) {
            setupHostWaitingRoom(gid);
            await completeSessionSetup(gid, user);
          } else {
            await checkWaitingRoom(gid, user, () => completeSessionSetup(gid, user));
          }
        }
      }
      
      resizeCanvas();
      window.addEventListener('resize', resizeCanvas);

      // Add CSS for animations
      const style = document.createElement('style');
      style.textContent = `
        @keyframes slideIn {
          from { transform: translateX(100%); opacity: 0; }
          to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOut {
          from { transform: translateX(0); opacity: 1; }
          to { transform: translateX(100%); opacity: 0; }
        }
      `;
      document.head.appendChild(style);
    }

    // Make functions global for HTML event handlers
    window.handleButtonAction = handleButtonAction;
    window.toggleChatDrawer = toggleChatDrawer;
    window.toggleWhiteboard = toggleWhiteboard;
    window.takeAttendance = takeAttendance;
    window.generateSummary = generateSummary;
    window.generateQuiz = generateQuiz;
    window.suggestResources = suggestResources;
    window.muteAllParticipants = muteAllParticipants;
    window.disableAllCameras = disableAllCameras;
    window.toggleHostSpotlight = toggleHostSpotlight;
    window.showPendingRequests = showPendingRequests;
    window.copyClassLink = copyClassLink;
    window.exportAttendance = exportAttendance;
    window.closeAttendanceModal = closeAttendanceModal;
    window.cancelScreenShare = cancelScreenShare;
    window.closeWhiteboard = closeWhiteboard;
    window.saveWhiteboard = saveWhiteboard;
    window.openWaitingRoom = openWaitingRoom;
    window.closeWaitingRoomModal = closeWaitingRoomModal;
    window.approveStudent = approveStudent;
    window.rejectStudent = rejectStudent;
    window.approveAllStudents = approveAllStudents;
    window.resetAllRequests = resetAllRequests;
    window.removeStudent = removeStudent;

    // Cleanup on tab close (Essential for production to release resources)
    window.addEventListener('beforeunload', async () => {
      if (state.client) {
        await state.client.leave();
        if (state.localAudioTrack) state.localAudioTrack.close();
        if (state.localVideoTrack) state.localVideoTrack.close();
      }
    });

    document.addEventListener('DOMContentLoaded', initialize);
  </script>
</body>
</html>
