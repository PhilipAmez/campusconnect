
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>PeerLoom â€¢ Live Class</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/js/all.min.js"></script>
  <script src="https://download.agora.io/sdk/release/AgoraRTC_N-4.18.2.js"></script>
  <script type="module" src="js/supabaseClient.js"></script>
  <link rel="stylesheet" href="livemeeting.css" />
</head>
<body class="dark-mode">

  <!-- Loading Overlay -->
  <div id="loading-overlay">
    <i class="fas fa-circle-notch fa-spin" style="font-size: 48px; color: var(--accent-blue); margin-bottom: 20px;"></i>
    <h2 style="margin: 0; color: var(--text-color);">Joining Class...</h2>
    <p id="loading-status" style="margin-top: 10px; opacity: 0.7;">Initializing secure session</p>
  </div>

  <!-- Critical Error Modal -->
  <div id="error-modal">
    <div class="error-content">
      <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: var(--red); margin-bottom: 20px;"></i>
      <h2 style="margin: 0 0 10px;">Connection Failed</h2>
      <p id="error-message" style="opacity: 0.8; margin-bottom: 20px;">Unable to connect to the live session.</p>
      <button onclick="rejoinSession()" style="padding: 10px 20px; background: var(--accent-blue); border: none; border-radius: 8px; color: white; cursor: pointer;">Rejoin Session</button>
      <button onclick="window.location.href='dashboard.html'" style="padding: 10px 20px; background: transparent; border: 1px solid var(--text-color); border-radius: 8px; color: var(--text-color); cursor: pointer; margin-left: 10px;">Go Back</button>
    </div>
  </div>

  <!-- Styled Confirmation Modal -->
  <div id="confirmation-modal" style="position: fixed; inset: 0; background: rgba(0, 0, 0, 0.7); z-index: 9999; display: none; align-items: center; justify-content: center;">
    <div style="background: var(--glass-bg); backdrop-filter: var(--glass-blur); border: 1px solid var(--glass-border); padding: 30px; border-radius: 20px; text-align: center; max-width: 400px; box-shadow: var(--shadow);">
      <h2 id="modal-title" style="margin: 0 0 15px; font-size: 24px; color: var(--text-color);">Confirm Action</h2>
      <p id="modal-message" style="opacity: 0.8; margin-bottom: 25px;">Are you sure?</p>
      <div style="display: flex; gap: 10px; justify-content: center;">
        <button id="modal-cancel" style="padding: 12px 24px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 12px; color: var(--text-color); cursor: pointer; font-weight: 600; transition: all 0.2s;">Cancel</button>
        <button id="modal-confirm" style="padding: 12px 24px; background: var(--accent-blue); border: none; border-radius: 12px; color: white; cursor: pointer; font-weight: 600; transition: all 0.2s;">Confirm</button>
      </div>
    </div>
  </div>

  <!-- Device Settings Modal -->
  <div id="device-settings-modal" class="attendance-modal" style="z-index: 9000;">
    <div class="attendance-content" style="max-width: 600px;">
      <h2 style="margin: 0 0 20px; font-size: 24px; color: var(--text-color);">Setup Devices</h2>
      
      <div class="device-preview" style="background: #000; height: 300px; border-radius: 16px; margin-bottom: 20px; position: relative; overflow: hidden;">
        <div id="local-preview" style="width: 100%; height: 100%;"></div>
        <div style="position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); display: flex; gap: 10px; z-index: 10;">
           <div style="background: rgba(0,0,0,0.5); padding: 8px 16px; border-radius: 20px; color: white; font-size: 12px;">Preview</div>
        </div>
      </div>

      <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 8px; font-size: 14px; opacity: 0.8; color: var(--text-color);">Camera</label>
        <select id="camera-select" style="width: 100%; padding: 12px; border-radius: 12px; background: var(--input-bg); color: var(--text-color); border: 1px solid var(--glass-border); outline: none;">
        </select>
      </div>

      <div style="margin-bottom: 25px;">
        <label style="display: block; margin-bottom: 8px; font-size: 14px; opacity: 0.8; color: var(--text-color);">Microphone</label>
        <select id="mic-select" style="width: 100%; padding: 12px; border-radius: 12px; background: var(--input-bg); color: var(--text-color); border: 1px solid var(--glass-border); outline: none;">
        </select>
      </div>

      <button id="join-btn" style="width: 100%; padding: 14px; border-radius: 12px; background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple)); color: white; border: none; font-weight: 600; cursor: pointer; font-size: 16px;">
        Join Class
      </button>
    </div>
  </div>

  <!-- Video Area -->
  <div id="video-container" class="grid-mode">
    <div class="video-tile active-speaker" id="host-tile">
      <div class="video-placeholder">
        <i class="fas fa-crown" style="font-size: 36px; color: white;"></i>
      </div>
      <div class="name-tag">
        <span id="host-name">Loading...</span>
        <span class="host-badge">HOST</span>
      </div>
    </div>
  </div>

  <!-- Top Bar -->
  <div id="top-bar">
    <div class="title" id="class-title">PeerLoom Live Class</div>
    <div id="timer" class="text-base">00:00:00</div>
    <div class="flex items-center gap-4">
      <i class="fas fa-signal" style="color: var(--accent-green);"></i>
      <span class="text-sm opacity-90">HD</span>
      <button id="ai-toggle" class="tool-btn" title="AI Assistant">
        <i class="fas fa-robot"></i>
      </button>
      <button id="dark-mode-toggle" class="tool-btn" title="Toggle Theme">
        <i class="fas fa-moon"></i>
      </button>
    </div>
  </div>

  <!-- Desktop Chat Input (Above Control Bar) -->
  <div class="chat-input-desktop" id="chat-input-desktop">
    <div class="chat-input-desktop-wrapper">
      <input type="text" placeholder="Ask a question or share a thought..." class="chat-input-desktop-field" id="chat-desktop-input" />
      <div class="chat-input-desktop-actions">
        <button class="chat-input-desktop-btn" id="desktop-attach-btn" title="Attach file">
          <i class="fas fa-paperclip"></i>
        </button>
        <button class="chat-input-desktop-btn" id="desktop-emoji-btn" title="Emoji">
          <i class="fas fa-smile"></i>
        </button>
        <button class="chat-input-desktop-send" id="desktop-send-btn" title="Send message">
          <i class="fas fa-paper-plane"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- Control Bar -->
  <div id="control-bar">
    <button class="ctrl-btn active" data-action="mic" data-tooltip="Microphone">
      <i class="fas fa-microphone"></i>
    </button>
    <button class="ctrl-btn" data-action="cam" data-tooltip="Camera">
      <i class="fas fa-video"></i>
    </button>
    <button class="ctrl-btn" data-action="share" data-tooltip="Share Screen">
      <i class="fas fa-desktop"></i>
    </button>
    <button class="ctrl-btn host-only" data-action="record" data-tooltip="Record Session">
      <i class="fas fa-circle-dot"></i>
    </button>
    <button class="ctrl-btn host-only" data-action="attendance" data-tooltip="Attendance">
      <i class="fas fa-user-check"></i>
    </button>
    <button class="ctrl-btn" data-action="chat" data-tooltip="Chat">
      <i class="fas fa-comment-dots"></i>
    </button>
    <button class="ctrl-btn" data-action="hand" data-tooltip="Raise Hand">
      <i class="fas fa-hand"></i>
    </button>
    <button class="ctrl-btn" data-action="whiteboard" data-tooltip="Whiteboard">
      <i class="fas fa-paint-brush"></i>
    </button>
    <button class="ctrl-btn end" data-action="end" data-tooltip="End Call">
      <i class="fas fa-phone-slash"></i>
    </button>
  </div>

  <!-- Chat Drawer -->
  <div id="chat-drawer">
    <div id="chat-header">
      <div style="display: flex; align-items: center; gap: 12px;">
        <i class="fas fa-comments" style="font-size: 20px;"></i>
        <h3 style="margin: 0; font-size: 18px; font-weight: 600; color: var(--text-color);">Class Chat</h3>
        <div id="participant-count" style="background: var(--accent-blue); color: white; padding: 2px 10px; border-radius: 12px; font-size: 12px;">0</div>
      </div>
      <button id="close-chat-drawer" class="tool-btn">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <div id="chat-messages">
      <!-- Messages will be loaded here -->
    </div>
    
    <!-- Chat Drawer Input -->
    <div id="chat-drawer-input-container">
      <div id="chat-drawer-input">
        <input type="text" placeholder="Type your message here..." id="chat-drawer-message-input" />
        <button id="chat-drawer-send-btn" style="width: 48px; height: 48px; border-radius: 50%; background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple)); border: none; color: white; display: flex; align-items: center; justify-content: center; cursor: pointer;">
          <i class="fas fa-paper-plane"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- AI Panel -->
  <div id="ai-panel">
    <div class="ai-header">
      <div style="display: flex; align-items: center; gap: 12px;">
        <i class="fas fa-robot" style="font-size: 24px;"></i>
        <div>
          <h3 style="margin: 0; font-size: 18px; font-weight: 700;">PeerPal AI Assistant</h3>
          <p style="margin: 4px 0 0; opacity: 0.9; font-size: 14px;">Powered by Gemini 2.5 Flash</p>
        </div>
      </div>
    </div>
    
    <div class="ai-feature" onclick="generateSummary()">
      <div style="font-weight: 600; margin-bottom: 4px;">
        <i class="fas fa-file-alt" style="margin-right: 10px;"></i>
        Real-time Lesson Summary
      </div>
      <div style="font-size: 13px; opacity: 0.8;">Generate instant summaries with key points</div>
    </div>
    
    <div class="ai-feature" onclick="takeAttendance()">
      <div style="font-weight: 600; margin-bottom: 4px;">
        <i class="fas fa-user-check" style="margin-right: 10px;"></i>
        AI Attendance Report
      </div>
      <div style="font-size: 13px; opacity: 0.8;">Generate detailed attendance report with timestamps</div>
    </div>
    
    <div class="ai-feature" onclick="generateQuiz()">
      <div style="font-weight: 600; margin-bottom: 4px;">
        <i class="fas fa-question-circle" style="margin-right: 10px;"></i>
        Instant Quiz Generator
      </div>
      <div style="font-size: 13px; opacity: 0.8;">Create pop quizzes based on discussion</div>
    </div>
    
    <div class="ai-feature" onclick="suggestResources()">
      <div style="font-weight: 600; margin-bottom: 4px;">
        <i class="fas fa-lightbulb" style="margin-right: 10px;"></i>
        Resource Suggestions
      </div>
      <div style="font-size: 13px; opacity: 0.8;">Get AI-curated learning materials</div>
    </div>
    
    <div class="ai-loading" id="ai-loading">
      <i class="fas fa-spinner fa-spin"></i>
      <p style="margin-top: 8px;">AI is thinking...</p>
    </div>
  </div>

  <!-- Waiting Room Overlay for Students -->
  <div id="waiting-room-overlay" class="hidden">
    <div class="waiting-content">
      <i class="fas fa-clock" style="font-size: 48px; color: var(--accent-yellow); margin-bottom: 20px;"></i>
      <h2 style="margin: 0 0 10px;">Waiting for Host</h2>
      <p style="opacity: 0.8;">Please wait while the host admits you to the class.</p>
      <div style="margin-top: 20px; font-size: 24px; letter-spacing: 4px;">
        <i class="fas fa-spinner fa-spin"></i>
      </div>
    </div>
  </div>

  <!-- Host Tools -->
  <div id="host-tools">
    <button class="tool-btn" title="Mute All Students" id="mute-all-btn" onclick="muteAllParticipants()">
      <i class="fas fa-microphone-slash"></i>
    </button>
    <button class="tool-btn" title="Unmute All Students" id="unmute-all-btn" onclick="unmuteAllParticipants()" style="display:none;">
      <i class="fas fa-microphone"></i>
    </button>
    <button class="tool-btn" title="Disable All Cameras" id="disable-cameras-btn" onclick="disableAllCameras()">
      <i class="fas fa-video-slash"></i>
    </button>
    <button class="tool-btn" title="Enable All Cameras" id="enable-cameras-btn" onclick="enableAllCameras()" style="display:none;">
      <i class="fas fa-video"></i>
    </button>
    <button class="tool-btn" title="Lock All Media" id="lock-media-btn" onclick="lockAllMedia()">
      <i class="fas fa-shield-alt"></i>
    </button>
    <button class="tool-btn" title="Unlock All Media" id="unlock-media-btn" onclick="unlockAllMedia()" style="display:none;">
      <i class="fas fa-shield-alt" style="color: var(--accent-green);"></i>
    </button>
    <button id="spotlight-btn" class="tool-btn" title="Spotlight Host" onclick="toggleHostSpotlight()">
      <i class="fas fa-star"></i>
    </button>
    <button class="tool-btn" title="Screen Share Requests" onclick="showPendingRequests()">
      <i class="fas fa-check-circle"></i>
    </button>
    <button class="tool-btn" title="Copy Class Link" onclick="copyClassLink()">
      <i class="fas fa-link"></i>
    </button>
    <button class="tool-btn" title="Export Attendance" onclick="exportAttendance()">
      <i class="fas fa-download"></i>
    </button>
    <button class="tool-btn" title="Reset Waiting Room" onclick="resetAllRequests()">
      <i class="fas fa-sync"></i>
    </button>
    <button class="tool-btn" title="Waiting Room" onclick="openWaitingRoom()" style="position: relative;">
      <i class="fas fa-user-clock"></i>
      <div id="waiting-room-badge" class="waiting-badge" style="display: none;">0</div>
    </button>
    <button class="tool-btn" title="Clear All Hands" onclick="clearAllHands()">
      <i class="fas fa-hands"></i>
    </button>
  </div>

  <!-- Attendance Modal -->
  <div class="attendance-modal" id="attendance-modal">
    <div class="attendance-content">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="margin: 0; font-size: 24px; color: var(--text-color);">Attendance Report</h2>
        <button onclick="closeAttendanceModal()" class="tool-btn">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="attendance-list" id="attendance-list">
        <!-- Attendance items will be added here -->
      </div>
      
      <div style="display: flex; gap: 12px; margin-top: 20px;">
        <button onclick="exportAttendance()" style="flex: 1; padding: 12px; border-radius: 12px; background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple)); color: white; border: none; font-weight: 600; cursor: pointer;">
          <i class="fas fa-download" style="margin-right: 8px;"></i> Export CSV
        </button>
        <button onclick="closeAttendanceModal()" style="padding: 12px 24px; border-radius: 12px; background: var(--glass-bg); color: var(--text-color); border: 1px solid var(--glass-border); cursor: pointer;">
          Close
        </button>
      </div>
    </div>
  </div>

  <!-- Host Waiting Room Modal -->
  <div class="attendance-modal" id="waiting-room-modal">
    <div class="attendance-content">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="margin: 0; font-size: 24px; color: var(--text-color);">Waiting Room</h2>
        <div style="display: flex; gap: 10px; align-items: center;">
          <button id="accept-all-btn" onclick="approveAllStudents()" style="display: none; padding: 8px 16px; background: rgba(0,255,148,0.2); color: var(--accent-green); border: 1px solid var(--accent-green); border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px;">Accept All</button>
          <button onclick="closeWaitingRoomModal()" class="tool-btn"><i class="fas fa-times"></i></button>
        </div>
      </div>
      <div id="waiting-list" class="attendance-list">
        <!-- Items go here -->
      </div>
    </div>
  </div>

  <!-- Screen Share Modal -->
  <div class="screen-share-modal" id="screen-share-modal">
    <div class="screen-share-content">
      <i class="fas fa-desktop" style="font-size: 48px; color: var(--accent-blue);"></i>
      <h2 style="margin: 20px 0 10px; color: var(--text-color);">Screen Sharing Starting</h2>
      <p style="opacity: 0.8; margin-bottom: 20px; color: var(--text-color);">Your screen will be shared with the class in:</p>
      <div class="countdown" id="countdown">3</div>
      <button onclick="cancelScreenShare()" style="margin-top: 20px; padding: 12px 24px; border-radius: 20px; background: var(--glass-bg); border: 1px solid var(--glass-border); color: var(--text-color); cursor: pointer;">Cancel</button>
    </div>
  </div>

  <!-- Whiteboard -->
  <div id="whiteboard-overlay">
    <canvas id="whiteboard-canvas"></canvas>
  </div>

  <!-- Whiteboard Tools -->
  <div class="whiteboard-tools" id="whiteboard-tools">
    <button class="whiteboard-tool active" data-tool="pen" title="Pen">
      <i class="fas fa-pen"></i>
    </button>
    <button class="whiteboard-tool" data-tool="eraser" title="Eraser">
      <i class="fas fa-eraser"></i>
    </button>
    <button class="whiteboard-tool" data-tool="clear" title="Clear">
      <i class="fas fa-trash"></i>
    </button>
    <button class="whiteboard-tool" onclick="saveWhiteboard()" title="Save">
      <i class="fas fa-save"></i>
    </button>
    <button class="whiteboard-tool" onclick="closeWhiteboard()" title="Close">
      <i class="fas fa-times"></i>
    </button>
  </div>
  <script src="livemeeting.js" type="module"></script>
    </body>

</html>