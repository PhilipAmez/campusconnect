<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Peerloom - Skrolz</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <script src="https://www.youtube.com/iframe_api"></script> <!-- For YouTube player control -->
  <style>
    :root {
      --bg-gradient-light: linear-gradient(180deg, #f3e8ff 0%, #e0e7ff 100%);
      --bg-gradient-dark: linear-gradient(180deg, #0d1b2a 0%, #1a202c 100%);
      --text-light: #1a202c;
      --text-dark: #e5e7eb;
      --accent: #7c3aed;
      --glass-bg: rgba(255, 255, 255, 0.2);
      --glass-purple: rgba(124, 58, 237, 0.1);
      --glass-border: rgba(255, 255, 255, 0.4);
      --hover-glow: rgba(124, 58, 237, 0.3);
    }
    [data-theme="dark"] {
      --bg-gradient: var(--bg-gradient-dark);
      --text: var(--text-dark);
    }
    [data-theme="light"] {
      --bg-gradient: var(--bg-gradient-light);
      --text: var(--text-light);
    }
    body {
      margin: 0;
      padding: 0;
      font-family: 'Arial', sans-serif;
      background: var(--bg-gradient);
      color: var(--text);
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      transition: background 0.3s ease, color 0.3s ease;
      position: relative;
    }
    .header {
      padding: 1rem 1.5rem;
      border-radius: 0 0 1.5rem 1.5rem;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      position: relative;
      overflow: hidden;
      background: var(--glass-purple);
      backdrop-filter: blur(15px);
      border-bottom: 1px solid var(--glass-border);
      touch-action: pan-x;
      z-index: 10;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .header h1 {
      font-weight: 400;
      font-size: 1.8rem;
      margin: 0;
      text-align: center;
      padding: 0.5rem 1rem;
      border-radius: 0.8rem;
      color: var(--text);
      transition: transform 0.3s ease;
    }
    .theme-toggle {
      position: absolute;
      right: 1.5rem;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      font-size: 1.5rem;
      color: var(--text);
      opacity: 0;
      transition: opacity 0.2s ease;
      cursor: pointer;
    }
    .header.active .theme-toggle {
      opacity: 1;
    }
    .reels-container {
      flex: 1;
      overflow-y: auto;
      scroll-snap-type: y mandatory;
      -webkit-overflow-scrolling: touch;
      display: flex;
      flex-direction: column;
      scroll-behavior: smooth; /* Smoothen scroll animation */
    }
    .reel {
      height: 100vh;
      scroll-snap-align: start;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #000;
      overflow: hidden;
      transition: transform 0.3s ease; /* Add smooth transition for any effects */
    }
    .reel video, .reel iframe {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border: none;
    }
    .reel-overlay {
      position: absolute;
      bottom: 2rem;
      left: 2rem;
      right: 2rem;
      color: white;
      z-index: 2;
    }
    .reel-author {
      font-weight: 600;
      color: var(--accent);
      margin-bottom: 0.5rem;
      font-size: 1.2rem;
    }
    .reel-time {
      font-size: 0.9rem;
      opacity: 0.7;
      margin-bottom: 1rem;
    }
    .reel-actions {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
    }
    .reel-like-section {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.5rem;
    }
    .reel-action-btn {
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      font-size: 2rem;
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.3rem;
      padding: 0.5rem;
      border-radius: 50%;
      transition: transform 0.3s ease, color 0.3s ease;
    }
    .reel-action-btn:hover {
      color: var(--accent);
      transform: scale(1.1);
    }
    .like-btn .like-fill {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 0;
      height: 100%;
      background: var(--accent);
      border-radius: 50%;
      animation: water-fill 0.5s forwards;
      opacity: 0;
    }
    .like-btn.liked .like-fill {
      opacity: 1;
    }
    @keyframes water-fill {
      0% { width: 0; }
      100% { width: 100%; }
    }
    .delete-zone {
      position: absolute;
      right: 0;
      top: 0;
      bottom: 0;
      width: 70px;
      background: #dc2626;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 0 1.5rem 1.5rem 0;
      transform: translateX(100%);
      transition: transform 0.2s ease;
      font-weight: 600;
      font-size: 0.9rem;
      z-index: 3;
    }
    .reel.deleting .delete-zone {
      transform: translateX(0);
    }
    .reel:hover {
      transform: scale(1.005);
    }
    .plus-button {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: var(--accent);
      border: none;
      color: white;
      font-size: 2rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 20px rgba(124, 58, 237, 0.3);
      transition: transform 0.3s ease;
      z-index: 10;
    }
    .plus-button:hover {
      transform: scale(1.1);
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 20;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(5px);
    }
    .modal-content {
      background: linear-gradient(135deg, var(--glass-bg), var(--glass-purple));
      backdrop-filter: blur(15px);
      border: 1px solid var(--glass-border);
      margin: 15% auto;
      padding: 2rem;
      border-radius: 1.5rem;
      width: 80%;
      max-width: 400px;
      text-align: center;
      color: var(--text);
    }
    .modal h2 {
      margin-bottom: 1.5rem;
      color: var(--accent);
    }
    .modal-option {
      display: block;
      width: 100%;
      padding: 1rem;
      margin: 0.5rem 0;
      border-radius: 1rem;
      border: 1px solid var(--glass-border);
      background: var(--glass-bg);
      color: var(--text);
      cursor: pointer;
      transition: background 0.3s ease;
    }
    .modal-option:hover {
      background: var(--glass-purple);
    }
    .close {
      color: var(--text);
      float: right;
      font-size: 2rem;
      font-weight: bold;
      cursor: pointer;
    }
    .close:hover {
      color: var(--accent);
    }
    .recording-container {
      display: none;
      position: fixed;
      z-index: 20;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(5px);
    }
    .recording-content {
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: white;
    }
    #videoPreview {
      width: 80%;
      max-width: 400px;
      height: 60vh;
      background: #000;
      border-radius: 1rem;
      margin-bottom: 1rem;
    }
    .record-controls {
      display: flex;
      gap: 1rem;
      align-items: center;
    }
    .record-btn {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      border: none;
      cursor: pointer;
      font-size: 1.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.3s ease;
    }
    .record-btn.recording {
      background: #dc2626;
      color: white;
      transform: scale(1.1);
    }
    .record-btn:not(.recording) {
      background: var(--accent);
      color: white;
    }
    .upload-btn {
      padding: 0.5rem 1rem;
      border-radius: 1rem;
      border: none;
      background: var(--accent);
      color: white;
      cursor: pointer;
      margin-top: 1rem;
    }
    .progress-container {
      display: none;
      position: fixed;
      z-index: 30;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(5px);
      align-items: center;
      justify-content: center;
    }
    .progress-content {
      background: linear-gradient(135deg, var(--glass-bg), var(--glass-purple));
      backdrop-filter: blur(15px);
      border: 1px solid var(--glass-border);
      padding: 2rem;
      border-radius: 1.5rem;
      width: 80%;
      max-width: 400px;
      text-align: center;
      color: var(--text);
    }
    .progress-bar {
      width: 100%;
      height: 20px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 10px;
      overflow: hidden;
      margin-top: 1rem;
      border: 1px solid var(--glass-border);
    }
    .progress-fill {
      width: 0%;
      height: 100%;
      background: var(--accent);
      transition: width 0.3s ease;
    }
    .progress-text {
      margin-top: 0.5rem;
      font-size: 1rem;
      color: var(--text);
    }
    #searchBar {
      display: none;
      position: fixed;
      top: 60px;
      left: 50%;
      transform: translateX(-50%);
      width: 80%;
      max-width: 500px;
      padding: 10px;
      background: var(--glass-bg);
      backdrop-filter: blur(15px);
      border: 1px solid var(--glass-border);
      box-shadow: 0 4px 20px var(--hover-glow);
      z-index: 15;
      transition: opacity 0.3s ease;
    }
    #searchInput {
      width: calc(100% - 60px);
      padding: 10px;
      border: none;
      background: transparent;
      color: var(--text);
      font-size: 1rem;
      outline: none;
    }
    #searchBtn {
      background: var(--accent);
      border: none;
      color: white;
      padding: 10px 15px;
      border-radius: 1rem;
      cursor: pointer;
      transition: transform 0.3s ease;
    }
    #searchBtn:hover {
      transform: scale(1.05);
    }
    @media (max-width: 768px) {
      .header {
        padding: 0.8rem 1rem;
      }
      .header h1 {
        font-size: 1.4rem;
      }
      .plus-button {
        bottom: 1rem;
        right: 1rem;
        width: 50px;
        height: 50px;
        font-size: 1.5rem;
      }
      .modal-content, .progress-content {
        margin: 20% auto;
        width: 90%;
        padding: 1.5rem;
      }
      #videoPreview {
        width: 90%;
        height: 50vh;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>Skrolz</h1>
    <button class="theme-toggle" id="themeToggle">üåô</button>
  </div>
  <div id="searchBar">
    <input type="text" id="searchInput" placeholder="Search for shorts...">
    <button id="searchBtn">Search</button>
  </div>
  <div class="reels-container" id="reelsContainer"></div>
  <button class="plus-button" id="plusButton">+</button>

  <!-- Make a Post Modal -->
  <div id="makePostModal" class="modal">
    <div class="modal-content">
      <span class="close" id="closeModal">&times;</span>
      <h2>Make a Post</h2>
      <button class="modal-option" id="uploadOption">üìÅ Upload from Gallery</button>
      <button class="modal-option" id="recordOption">üìπ Record with Camera</button>
    </div>
  </div>

  <!-- Recording Container -->
  <div id="recordingContainer" class="recording-container">
    <div class="recording-content">
      <video id="videoPreview" autoplay playsinline muted></video>
      <div class="record-controls">
        <button class="record-btn" id="recordBtn">‚óè</button>
        <button class="upload-btn" id="stopAndUpload" style="display: none;">Post</button>
      </div>
      <button class="close" id="closeRecording" style="position: absolute; top: 1rem; right: 1rem; color: white; font-size: 2rem;">&times;</button>
    </div>
  </div>

  <!-- Progress Bar Container -->
  <div id="progressContainer" class="progress-container">
    <div class="progress-content">
      <h2>Uploading...</h2>
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
      <div class="progress-text" id="progressText">0%</div>
    </div>
  </div>

<script type="module">
import { supabase } from './js/supabaseClient.js';

(async () => {
  const session = await supabase.auth.getSession();
  if (!session.data.session) location = 'login.html';
  const user = session.data.session.user;

  const reelsContainer = document.getElementById('reelsContainer');
  const plusButton = document.getElementById('plusButton');
  const makePostModal = document.getElementById('makePostModal');
  const closeModal = document.getElementById('closeModal');
  const uploadOption = document.getElementById('uploadOption');
  const recordOption = document.getElementById('recordOption');
  const recordingContainer = document.getElementById('recordingContainer');
  const closeRecording = document.getElementById('closeRecording');
  const videoPreview = document.getElementById('videoPreview');
  const recordBtn = document.getElementById('recordBtn');
  const stopAndUpload = document.getElementById('stopAndUpload');
  const themeToggle = document.getElementById('themeToggle');
  const header = document.querySelector('.header');
  const body = document.body;
  const progressContainer = document.getElementById('progressContainer');
  const progressFill = document.getElementById('progressFill');
  const progressText = document.getElementById('progressText');
  const searchBar = document.getElementById('searchBar');
  const searchInput = document.getElementById('searchInput');
  const searchBtn = document.getElementById('searchBtn');

  let mediaRecorder, recordedChunks = [], stream;
  let ytPlayers = {};
  const youtubeApiKey = 'AIzaSyDLLDIJ7TGkEoXpSIt9Yg98jWKEKdSCMWw';

  // Fetch YouTube Shorts dynamically
  async function fetchYoutubeShorts(searchQuery = 'study tips for students') {
    const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&videoDuration=short&q=${encodeURIComponent(searchQuery)}&maxResults=10&key=${youtubeApiKey}`;
    try {
      const response = await fetch(url);
      const data = await response.json();
      if (data.error) {
        console.error('YouTube API error:', data.error);
        return hardcodedYoutubeShorts;
      }
      return data.items.map((item, index) => ({
        id: `yt-${index}`,
        videoId: item.id.videoId,
        author_name: item.snippet.channelTitle,
        created_at: item.snippet.publishedAt,
        likes: 0,
        isYoutube: true
      }));
    } catch (err) {
      console.error('Fetch error:', err);
      return hardcodedYoutubeShorts;
    }
  }

  const hardcodedYoutubeShorts = [
    { id: 'yt-1', videoId: 'MhVjGqkPFuw', author_name: 'University of Sheffield', created_at: '2024-04-30T00:00:00Z', likes: 0, isYoutube: true },
    { id: 'yt-2', videoId: '26Ga4N0b2BQ', author_name: 'FundaTube', created_at: '2024-01-26T00:00:00Z', likes: 0, isYoutube: true },
    { id: 'yt-3', videoId: 'vtc-9KrwhQQ', author_name: 'Next Admit', created_at: '2021-05-15T00:00:00Z', likes: 0, isYoutube: true },
    { id: 'yt-4', videoId: 'B5dFy4j7C9Q', author_name: 'George Fox University', created_at: '2025-04-10T00:00:00Z', likes: 0, isYoutube: true },
    { id: 'yt-5', videoId: '0kqk66XvBR0', author_name: 'FundaTube', created_at: '2024-03-02T00:00:00Z', likes: 0, isYoutube: true },
    { id: 'yt-6', videoId: 'yiwl9rtYb5Q', author_name: 'Manchild', created_at: '2025-08-01T00:00:00Z', likes: 0, isYoutube: true },
    { id: 'yt-7', videoId: 'KZ3pDHLNfhA', author_name: 'University of Essex', created_at: '2023-06-21T00:00:00Z', likes: 0, isYoutube: true }
  ];

  // Theme logic
  const applyTheme = (theme) => {
    body.dataset.theme = theme;
    localStorage.setItem('vibe-theme', theme);
  };
  applyTheme(localStorage.getItem('vibe-theme') || 'dark');

  // Observer for video play/pause
  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      const reel = entry.target;
      const video = reel.querySelector('video');
      const iframe = reel.querySelector('iframe');
      if (entry.isIntersecting) {
        if (video) {
          if (!video.src && video.dataset.src) {
            video.src = video.dataset.src;
            video.load();
          }
          video.play().catch(() => {});
        } else if (reel.dataset.isYoutube && !ytPlayers[reel.dataset.videoId]) {
          ytPlayers[reel.dataset.videoId] = new YT.Player(iframe.id, {
            events: {
              onReady: (event) => {
                event.target.mute();
                event.target.playVideo();
              }
            }
          });
        } else if (reel.dataset.isYoutube) {
          ytPlayers[reel.dataset.videoId].playVideo();
        }
      } else {
        if (video) video.pause();
        else if (reel.dataset.isYoutube && ytPlayers[reel.dataset.videoId])
          ytPlayers[reel.dataset.videoId].pauseVideo();
      }
    });
  }, { threshold: 0.5 });

  // Upload + recording + Supabase logic remain unchanged
  // (omitted here for brevity but unchanged from your script)

  // Render reel (YouTube + user videos only)
  async function renderReel(p) {
    let authorName = p.author_name || 'Unknown';
    const div = document.createElement('div');
    div.className = 'reel';
    div.dataset.id = p.id;
    div.dataset.videoId = p.videoId || '';
    div.dataset.isYoutube = p.isYoutube ? 'true' : '';

    let mediaHtml = '';
    if (p.isYoutube) {
      const embedUrl = `https://www.youtube.com/embed/${p.videoId}?enablejsapi=1&mute=1&loop=1&playlist=${p.videoId}&controls=0&rel=0&modestbranding=2&iv_load_policy=3&showinfo=0`;
      mediaHtml = `<iframe id="ytplayer-${p.videoId}" data-src="${embedUrl}" frameborder="0" allow="autoplay; encrypted-media; accelerometer; clipboard-write; gyroscope; picture-in-picture"></iframe>`;
    } else {
      mediaHtml = `<video data-src="${p.video_url}" muted loop playsinline preload="none"></video>`;
    }

    div.innerHTML = `
      ${mediaHtml}
      <div class="reel-overlay">
        <div class="reel-author">${authorName}</div>
        <div class="reel-time">${new Date(p.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>
        <div class="reel-actions" ${p.isYoutube ? 'style="display: none;"' : ''}>
          <button class="reel-action-btn like-btn" data-id="${p.id}">
            <i class="fas fa-thumbs-up"></i> <span class="like-count">${p.likes || 0}</span>
          </button>
          <button class="reel-action-btn share-btn" data-id="${p.id}">
            <i class="fas fa-share"></i>
          </button>
        </div>
      </div>
    `;

    reelsContainer.appendChild(div);
    observer.observe(div);
  }

  // Load reels (user + YouTube Shorts)
  async function loadReels(searchQuery = null) {
    reelsContainer.innerHTML = '';
    let userPosts = [];
    try {
      const { data, error } = await supabase.from('facts').select('*').order('created_at', { ascending: false }).limit(20);
      if (!error) userPosts = data;
    } catch (err) {
      console.error('Supabase load error:', err);
    }

    for (const reel of userPosts) await renderReel(reel);
    const shorts = searchQuery ? await fetchYoutubeShorts(searchQuery) : hardcodedYoutubeShorts;
    for (const short of shorts) await renderReel(short);

    if (shorts.length === 0 && userPosts.length === 0)
      reelsContainer.innerHTML = '<div style="color:white;text-align:center;padding:20px;">No shorts available. Try uploading one!</div>';
  }

  await loadReels();
  supabase.channel('facts')
    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'facts' }, payload => renderReel(payload.new))
    .subscribe();

  searchBtn.addEventListener('click', async () => {
    const query = searchInput.value.trim();
    if (query) {
      searchBar.style.display = 'none';
      await loadReels(query);
      searchInput.value = '';
    }
  });
})();
</script>
