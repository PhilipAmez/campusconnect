<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Peerloom - Facts</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    :root {
      --bg-gradient-light: linear-gradient(180deg, #f3e8ff 0%, #e0e7ff 100%);
      --bg-gradient-dark: linear-gradient(180deg, #0d1b2a 0%, #1a202c 100%);
      --text-light: #1a202c;
      --text-dark: #e5e7eb;
      --accent: #7c3aed;
      --glass-bg: rgba(255, 255, 255, 0.2);
      --glass-purple: rgba(124, 58, 237, 0.1);
      --glass-border: rgba(255, 255, 255, 0.4);
      --hover-glow: rgba(124, 58, 237, 0.3);
    }
    [data-theme="dark"] {
      --bg-gradient: var(--bg-gradient-dark);
      --text: var(--text-dark);
    }
    [data-theme="light"] {
      --bg-gradient: var(--bg-gradient-light);
      --text: var(--text-light);
    }
    body {
      margin: 0;
      padding: 0;
      font-family: 'Arial', sans-serif;
      background: var(--bg-gradient);
      color: var(--text);
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      transition: background 0.3s ease, color 0.3s ease;
      position: relative;
    }
    .header {
      padding: 1rem 1.5rem;
      border-radius: 0 0 1.5rem 1.5rem;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      position: relative;
      overflow: hidden;
      background: var(--glass-purple);
      backdrop-filter: blur(15px);
      border-bottom: 1px solid var(--glass-border);
      touch-action: pan-x;
      z-index: 10;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .header h1 {
      font-weight: 400;
      font-size: 1.8rem;
      margin: 0;
      text-align: center;
      padding: 0.5rem 1rem;
      border-radius: 0.8rem;
      color: var(--text);
      transition: transform 0.3s ease;
    }
    .theme-toggle {
      position: absolute;
      right: 1.5rem;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      font-size: 1.5rem;
      color: var(--text);
      opacity: 0;
      transition: opacity 0.2s ease;
      cursor: pointer;
    }
    .header.active .theme-toggle {
      opacity: 1;
    }
    .reels-container {
      flex: 1;
      overflow-y: auto;
      scroll-snap-type: y mandatory;
      -webkit-overflow-scrolling: touch;
      display: flex;
      flex-direction: column;
    }
    .reel {
      height: 100vh;
      scroll-snap-align: start;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #000;
      overflow: hidden;
    }
    .reel video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .reel-overlay {
      position: absolute;
      bottom: 2rem;
      left: 2rem;
      right: 2rem;
      color: white;
      z-index: 2;
    }
    .reel-author {
      font-weight: 600;
      color: var(--accent);
      margin-bottom: 0.5rem;
      font-size: 1.2rem;
    }
    .reel-time {
      font-size: 0.9rem;
      opacity: 0.7;
      margin-bottom: 1rem;
    }
    .reel-actions {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
    }
    .reel-like-section {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.5rem;
    }
    .reel-action-btn {
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      font-size: 2rem;
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.3rem;
      padding: 0.5rem;
      border-radius: 50%;
      transition: transform 0.3s ease, color 0.3s ease;
    }
    .reel-action-btn:hover {
      color: var(--accent);
      transform: scale(1.1);
    }
    .like-btn .like-fill {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 0;
      height: 100%;
      background: var(--accent);
      border-radius: 50%;
      animation: water-fill 0.5s forwards;
      opacity: 0;
    }
    .like-btn.liked .like-fill {
      opacity: 1;
    }
    @keyframes water-fill {
      0% { width: 0; }
      100% { width: 100%; }
    }
    .delete-zone {
      position: absolute;
      right: 0;
      top: 0;
      bottom: 0;
      width: 70px;
      background: #dc2626;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 0 1.5rem 1.5rem 0;
      transform: translateX(100%);
      transition: transform 0.2s ease;
      font-weight: 600;
      font-size: 0.9rem;
      z-index: 3;
    }
    .reel.deleting .delete-zone {
      transform: translateX(0);
    }
    .reel:hover {
      transform: scale(1.005);
    }
    .plus-button {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: var(--accent);
      border: none;
      color: white;
      font-size: 2rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 20px rgba(124, 58, 237, 0.3);
      transition: transform 0.3s ease;
      z-index: 10;
    }
    .plus-button:hover {
      transform: scale(1.1);
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 20;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(5px);
    }
    .modal-content {
      background: linear-gradient(135deg, var(--glass-bg), var(--glass-purple));
      backdrop-filter: blur(15px);
      border: 1px solid var(--glass-border);
      margin: 15% auto;
      padding: 2rem;
      border-radius: 1.5rem;
      width: 80%;
      max-width: 400px;
      text-align: center;
      color: var(--text);
    }
    .modal h2 {
      margin-bottom: 1.5rem;
      color: var(--accent);
    }
    .modal-option {
      display: block;
      width: 100%;
      padding: 1rem;
      margin: 0.5rem 0;
      border-radius: 1rem;
      border: 1px solid var(--glass-border);
      background: var(--glass-bg);
      color: var(--text);
      cursor: pointer;
      transition: background 0.3s ease;
    }
    .modal-option:hover {
      background: var(--glass-purple);
    }
    .close {
      color: var(--text);
      float: right;
      font-size: 2rem;
      font-weight: bold;
      cursor: pointer;
    }
    .close:hover {
      color: var(--accent);
    }
    .recording-container {
      display: none;
      position: fixed;
      z-index: 20;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(5px);
    }
    .recording-content {
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: white;
    }
    #videoPreview {
      width: 80%;
      max-width: 400px;
      height: 60vh;
      background: #000;
      border-radius: 1rem;
      margin-bottom: 1rem;
    }
    .record-controls {
      display: flex;
      gap: 1rem;
      align-items: center;
    }
    .record-btn {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      border: none;
      cursor: pointer;
      font-size: 1.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.3s ease;
    }
    .record-btn.recording {
      background: #dc2626;
      color: white;
      transform: scale(1.1);
    }
    .record-btn:not(.recording) {
      background: var(--accent);
      color: white;
    }
    .upload-btn {
      padding: 0.5rem 1rem;
      border-radius: 1rem;
      border: none;
      background: var(--accent);
      color: white;
      cursor: pointer;
      margin-top: 1rem;
    }
    .progress-container {
      display: none;
      position: fixed;
      z-index: 30;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(5px);
      align-items: center;
      justify-content: center;
    }
    .progress-content {
      background: linear-gradient(135deg, var(--glass-bg), var(--glass-purple));
      backdrop-filter: blur(15px);
      border: 1px solid var(--glass-border);
      padding: 2rem;
      border-radius: 1.5rem;
      width: 80%;
      max-width: 400px;
      text-align: center;
      color: var(--text);
    }
    .progress-bar {
      width: 100%;
      height: 20px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 10px;
      overflow: hidden;
      margin-top: 1rem;
      border: 1px solid var(--glass-border);
    }
    .progress-fill {
      width: 0%;
      height: 100%;
      background: var(--accent);
      transition: width 0.3s ease;
    }
    .progress-text {
      margin-top: 0.5rem;
      font-size: 1rem;
      color: var(--text);
    }
    @media (max-width: 768px) {
      .header {
        padding: 0.8rem 1rem;
      }
      .header h1 {
        font-size: 1.4rem;
      }
      .plus-button {
        bottom: 1rem;
        right: 1rem;
        width: 50px;
        height: 50px;
        font-size: 1.5rem;
      }
      .modal-content, .progress-content {
        margin: 20% auto;
        width: 90%;
        padding: 1.5rem;
      }
      #videoPreview {
        width: 90%;
        height: 50vh;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>Facts</h1>
    <button class="theme-toggle" id="themeToggle">üåô</button>
  </div>
  <div class="reels-container" id="reelsContainer"></div>
  <button class="plus-button" id="plusButton">+</button>

  <!-- Make a Post Modal -->
  <div id="makePostModal" class="modal">
    <div class="modal-content">
      <span class="close" id="closeModal">&times;</span>
      <h2>Make a Post</h2>
      <button class="modal-option" id="uploadOption">üìÅ Upload from Gallery</button>
      <button class="modal-option" id="recordOption">üìπ Record with Camera</button>
    </div>
  </div>

  <!-- Recording Container -->
  <div id="recordingContainer" class="recording-container">
    <div class="recording-content">
      <video id="videoPreview" autoplay playsinline muted></video>
      <div class="record-controls">
        <button class="record-btn" id="recordBtn">‚óè</button>
        <button class="upload-btn" id="stopAndUpload" style="display: none;">Post</button>
      </div>
      <button class="close" id="closeRecording" style="position: absolute; top: 1rem; right: 1rem; color: white; font-size: 2rem;">&times;</button>
    </div>
  </div>

  <!-- Progress Bar Container -->
  <div id="progressContainer" class="progress-container">
    <div class="progress-content">
      <h2>Uploading...</h2>
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
      <div class="progress-text" id="progressText">0%</div>
    </div>
  </div>

  <script type="module">
    import { supabase } from './js/supabaseClient.js';

    (async () => {
      const session = await supabase.auth.getSession();
      if (!session.data.session) location = 'login.html';
      const user = session.data.session.user;
      const reelsContainer = document.getElementById('reelsContainer');
      const plusButton = document.getElementById('plusButton');
      const makePostModal = document.getElementById('makePostModal');
      const closeModal = document.getElementById('closeModal');
      const uploadOption = document.getElementById('uploadOption');
      const recordOption = document.getElementById('recordOption');
      const recordingContainer = document.getElementById('recordingContainer');
      const closeRecording = document.getElementById('closeRecording');
      const videoPreview = document.getElementById('videoPreview');
      const recordBtn = document.getElementById('recordBtn');
      const stopAndUpload = document.getElementById('stopAndUpload');
      const themeToggle = document.getElementById('themeToggle');
      const header = document.querySelector('.header');
      const body = document.body;
      const progressContainer = document.getElementById('progressContainer');
      const progressFill = document.getElementById('progressFill');
      const progressText = document.getElementById('progressText');

      let mediaRecorder;
      let recordedChunks = [];
      let stream;

      // Theme toggle with swipe
      let startX;
      header.addEventListener('mousedown', (e) => {
        startX = e.clientX;
        header.style.transition = 'none';
      });
      header.addEventListener('mousemove', (e) => {
        if (e.buttons === 1) {
          const dx = e.clientX - startX;
          if (dx < -50) header.classList.add('active');
          else if (dx > -50) header.classList.remove('active');
        }
      });
      header.addEventListener('mouseup', () => {
        header.style.transition = 'transform 0.3s ease';
        if (header.classList.contains('active')) {
          applyTheme(body.dataset.theme === 'dark' ? 'light' : 'dark');
        }
        header.classList.remove('active');
      });
      header.addEventListener('mouseleave', () => {
        header.style.transition = 'transform 0.3s ease';
        header.classList.remove('active');
      });

      // Touch events for mobile
      header.addEventListener('touchstart', (e) => {
        startX = e.touches[0].clientX;
        header.style.transition = 'none';
      });
      header.addEventListener('touchmove', (e) => {
        const dx = e.touches[0].clientX - startX;
        if (dx < -50) header.classList.add('active');
        else if (dx > -50) header.classList.remove('active');
      });
      header.addEventListener('touchend', () => {
        header.style.transition = 'transform 0.3s ease';
        if (header.classList.contains('active')) {
          applyTheme(body.dataset.theme === 'dark' ? 'light' : 'dark');
        }
        header.classList.remove('active');
      });

      const applyTheme = (theme) => {
        body.dataset.theme = theme;
        localStorage.setItem('vibe-theme', theme);
      };
      applyTheme(localStorage.getItem('vibe-theme') || 'dark');

      // Video play/pause management with lazy loading
      const observerOptions = {
        root: null,
        threshold: 0.5,
        rootMargin: '0px'
      };
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          const video = entry.target.querySelector('video');
          if (entry.isIntersecting) {
            if (!video.src && video.dataset.src) {
              video.src = video.dataset.src;
              video.load();
            }
            video.play().catch(e => console.log('Play failed:', e));
            entry.target.classList.add('active');
          } else {
            video.pause();
            entry.target.classList.remove('active');
          }
        });
      }, observerOptions);

      // Plus button click
      plusButton.addEventListener('click', () => {
        makePostModal.style.display = 'block';
      });

      // Close modal
      closeModal.addEventListener('click', () => {
        makePostModal.style.display = 'none';
      });
      window.addEventListener('click', (e) => {
        if (e.target === makePostModal) {
          makePostModal.style.display = 'none';
        }
      });

      // Upload option
      uploadOption.addEventListener('click', () => {
        makePostModal.style.display = 'none';
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'video/mp4,video/webm';
        input.onchange = (e) => handleVideoUpload(e.target.files[0]);
        input.click();
      });

      // Record option
      recordOption.addEventListener('click', async () => {
        makePostModal.style.display = 'none';
        try {
          stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }, audio: true });
          videoPreview.srcObject = stream;
          recordingContainer.style.display = 'block';
          recordBtn.textContent = '‚óè';
        } catch (err) {
          console.error('Camera error:', err);
          alert('Camera access denied or not supported.');
        }
      });

      // Close recording
      closeRecording.addEventListener('click', () => {
        stopRecording();
        recordingContainer.style.display = 'none';
        if (stream) {
          stream.getTracks().forEach(track => track.stop());
        }
      });

      // Record button
      recordBtn.addEventListener('click', () => {
        if (!mediaRecorder || mediaRecorder.state === 'inactive') {
          mediaRecorder = new MediaRecorder(stream);
          mediaRecorder.ondataavailable = (e) => {
            if (e.data.size > 0) recordedChunks.push(e.data);
          };
          mediaRecorder.onstop = () => {
            console.log('Recorded chunks:', recordedChunks);
            const blob = new Blob(recordedChunks, { type: 'video/webm' });
            const url = URL.createObjectURL(blob);
            videoPreview.srcObject = null;
            videoPreview.src = url;
            stopAndUpload.style.display = 'inline-block';
            recordBtn.textContent = '‚úì';
          };
          mediaRecorder.start();
          recordBtn.classList.add('recording');
          recordBtn.textContent = '‚èπ';
        } else if (mediaRecorder.state === 'recording') {
          mediaRecorder.stop();
          recordBtn.classList.remove('recording');
          recordedChunks = [];
        }
      });

      // Stop and upload
      stopAndUpload.addEventListener('click', async () => {
        const videoSrc = videoPreview.src;
        if (videoSrc.startsWith('blob:')) {
          const blob = new Blob(recordedChunks, { type: 'video/webm' });
          await handleVideoUpload(blob);
        }
        stopRecording();
        recordingContainer.style.display = 'none';
      });

      function stopRecording() {
        if (mediaRecorder && mediaRecorder.state === 'recording') {
          mediaRecorder.stop();
        }
        if (stream) {
          stream.getTracks().forEach(track => track.stop());
        }
      }

      // Handle video upload/post
      async function handleVideoUpload(file) {
        if (!file) {
          alert('No file selected');
          return;
        }
        if (!session.data.session) {
          alert('Please log in to upload');
          location = 'login.html';
          return;
        }
        const maxSize = 50 * 1024 * 1024; // 50MB
        if (file.size > maxSize) {
          alert('File too large. Max 50MB.');
          return;
        }
        const validTypes = ['video/mp4', 'video/webm'];
        if (!validTypes.includes(file.type)) {
          alert('Please upload an MP4 or WebM video');
          return;
        }
        const fileExt = file.type.split('/')[1] || 'webm';
        const fileName = `${Date.now()}.${fileExt}`;
        console.log('Uploading:', fileName, 'Size:', file.size, 'Type:', file.type);

        // Show progress bar
        progressContainer.style.display = 'flex';
        progressFill.style.width = '0%';
        progressText.textContent = '0%';

        const { data: uploadData, error: uploadError } = await supabase.storage
          .from('facts')
          .upload(fileName, file, {
            upsert: true,
            onUploadProgress: (progress) => {
              const percent = Math.round((progress.loaded / progress.total) * 100);
              progressFill.style.width = `${percent}%`;
              progressText.textContent = `${percent}%`;
            }
          });

        if (uploadError) {
          console.error('Upload error:', uploadError);
          alert('Upload failed: ' + uploadError.message);
          progressContainer.style.display = 'none';
          return;
        }
        progressContainer.style.display = 'none';

        const { data: publicUrlData } = supabase.storage.from('facts').getPublicUrl(fileName);
        const videoUrl = publicUrlData.publicUrl;
        console.log('Uploaded video URL:', videoUrl);

        const { error } = await supabase.from('facts').insert({
          author_id: user.id,
          author_name: user.user_metadata?.full_name || user.email.split('@')[0],
          video_url: videoUrl,
          created_at: new Date().toISOString(),
          likes: 0
        });
        if (error) {
          console.error('Insert error:', error);
          alert('Post failed: ' + error.message);
        } else {
          loadReels();
        }
      }

      // Render reel
      async function renderReel(p) {
        let authorName = p.author_name || (p.author_id === 'peerloom-ai' ? 'Peerloom AI' : null);
        if (!authorName && p.author_id) {
          try {
            const { data: authUser, error } = await supabase.auth.admin.getUserById(p.author_id);
            if (error) throw error;
            authorName = authUser.user.user_metadata?.full_name || authUser.user.email.split('@')[0];
            if (!authorName.includes(' ')) {
              authorName = authUser.user.email ? authUser.user.email.split('@')[0].replace('.', ' ').split(' ')[0] + ' User' : 'Unknown';
            }
          } catch (error) {
            console.error(`Failed to fetch name for author_id ${p.author_id}:`, error.message);
            authorName = 'Unknown';
          }
        }

        const div = document.createElement('div');
        div.className = 'reel';
        div.dataset.id = p.id;
        div.innerHTML = `
          <video data-src="${p.video_url}" muted loop playsinline preload="none"></video>
          <div class="reel-overlay">
            <div class="reel-author">${authorName}</div>
            <div class="reel-time">${new Date(p.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>
            <div class="reel-actions">
              <div class="reel-like-section">
                <button class="reel-action-btn like-btn" data-id="${p.id}"><i class="fas fa-thumbs-up"></i> <span class="like-count">${p.likes || 0}</span>
                  <div class="like-fill"></div>
                </button>
              </div>
              <div class="reel-like-section">
                <button class="reel-action-btn share-btn" data-id="${p.id}"><i class="fas fa-share"></i></button>
              </div>
            </div>
          </div>
          <div class="delete-zone">Delete</div>
        `;
        reelsContainer.appendChild(div);
        observer.observe(div);

        // Like with water-fill animation
        const likeBtn = div.querySelector('.like-btn');
        if (p.author_id !== user.id) {
          likeBtn.addEventListener('click', async () => {
            likeBtn.classList.add('liked');
            setTimeout(() => likeBtn.classList.remove('liked'), 500);
            const { data, error } = await supabase.rpc('increment_likes', { post_id: p.id });
            if (!error) {
              likeBtn.querySelector('.like-count').textContent = data[0].likes;
            } else {
              console.error('Like error:', error);
            }
          });
        } else {
          likeBtn.style.display = 'none';
        }

        // Share
        const shareBtn = div.querySelector('.share-btn');
        if (p.author_id !== user.id) {
          shareBtn.addEventListener('click', () => {
            const shareUrl = `${window.location.origin}/facts.html?reel=${p.id}`;
            navigator.clipboard.writeText(shareUrl).then(() => alert('Link copied to clipboard!'));
          });
        } else {
          shareBtn.style.display = 'none';
        }

        // Delete (only for author)
        if (p.author_id === user.id) {
          let startX;
          div.addEventListener('mousedown', (e) => {
            startX = e.clientX;
            div.style.transition = 'none';
          });
          div.addEventListener('mousemove', (e) => {
            if (e.buttons === 1) {
              const dx = e.clientX - startX;
              if (dx < -50) div.classList.add('deleting');
              else if (dx > -50) div.classList.remove('deleting');
              div.style.transform = `translateX(${dx}px)`;
            }
          });
          div.addEventListener('mouseup', async () => {
            div.style.transition = 'transform 0.2s ease';
            if (div.classList.contains('deleting')) {
              const { data: postData } = await supabase.from('facts').select('video_url').eq('id', p.id).single();
              if (postData?.video_url) {
                const videoPath = postData.video_url.split('/').slice(-2).join('/');
                await supabase.storage.from('facts').remove([videoPath]);
              }
              await supabase.from('facts').delete().eq('id', p.id);
              reelsContainer.removeChild(div);
            } else {
              div.style.transform = 'translateX(0)';
              div.classList.remove('deleting');
            }
          });
          div.addEventListener('mouseleave', () => {
            div.style.transition = 'transform 0.2s ease';
            div.style.transform = 'translateX(0)';
            div.classList.remove('deleting');
          });

          // Touch events for mobile
          div.addEventListener('touchstart', (e) => {
            startX = e.touches[0].clientX;
            div.style.transition = 'none';
          });
          div.addEventListener('touchmove', (e) => {
            const dx = e.touches[0].clientX - startX;
            if (dx < -50) div.classList.add('deleting');
            else if (dx > -50) div.classList.remove('deleting');
            div.style.transform = `translateX(${dx}px)`;
          });
          div.addEventListener('touchend', async () => {
            div.style.transition = 'transform 0.2s ease';
            if (div.classList.contains('deleting')) {
              const { data: postData } = await supabase.from('facts').select('video_url').eq('id', p.id).single();
              if (postData?.video_url) {
                const videoPath = postData.video_url.split('/').slice(-2).join('/');
                await supabase.storage.from('facts').remove([videoPath]);
              }
              await supabase.from('facts').delete().eq('id', p.id);
              reelsContainer.removeChild(div);
            } else {
              div.style.transform = 'translateX(0)';
              div.classList.remove('deleting');
            }
          });
        }
      }

      // Load and subscribe to facts
      async function loadReels() {
        const { data, error } = await supabase.from('facts').select('*').order('created_at', { ascending: false }).limit(20);
        if (error) {
          console.error('Load error:', error);
          return;
        }
        reelsContainer.innerHTML = '';
        for (const reel of data) {
          await renderReel(reel);
        }
      }
      await loadReels();
      supabase.channel('facts')
        .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'facts' },
          payload => renderReel(payload.new))
        .subscribe();
    })();
  </script>
</body>
</html>
