<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Peerloom</title>
    <link rel="icon" href="/android-chrome-192x192.png" sizes="192x192" type="image/png">
    <link rel="icon" href="/android-chrome-512x512.png" sizes="512x512" type="image/png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="manifest" href="/site.webmanifest">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script type="module" src="js/supabaseClient.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Great+Vibes&display=swap');
        :root {
            --primary: #7c3aed;
            --secondary: #4f46e5;
            --accent: #a78bfa;
            --text-dark: #1f2937;
            --text-light: #64748b;
            --hover-bg: #f3f4f6;
            --transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            --bg: linear-gradient(135deg, #f3e8ff 0%, #e0e7ff 100%);
        }
        [data-theme="dark"] {
            --bg-primary: #1f2937;
            --bg-secondary: #374151;
            --text-dark: #f9fafb;
            --text-light: #9ca3af;
            --hover-bg: #4b5563;
            --primary: #7c3aed;
            --secondary: #4f46e5;
            --accent: #a78bfa;
            --bg: linear-gradient(135deg, #1f2937 0%, #111827 100%);
        }
        body {
            background: var(--bg);
            font-family: 'Segoe UI', 'Inter', Arial, sans-serif;
            min-height: 100vh;
            color: var(--text-dark);
            overflow-x: hidden;
            transition: background 0.5s ease, color 0.5s ease;
            margin: 0;
            padding: 0;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior-y: contain;
        }
       
        ::-webkit-scrollbar {
            width: 0;
            height: 0;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: transparent;
        }
        * {
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
       
        .splash-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: radial-gradient(circle at top, #0a0a0a 0%, #000 100%);
            color: #fff;
            font-family: 'Great Vibes', cursive;
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            overflow: hidden;
        }
        .snowflake {
            position: fixed;
            top: -10px;
            color: white;
            font-size: 1em;
            opacity: 0.8;
            pointer-events: none;
            animation: fall linear infinite;
            text-shadow: 0 0 8px rgba(255, 255, 255, 0.8);
            z-index: 1;
        }
        @keyframes fall {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(360deg); opacity: 0.7; }
        }
        .splash-screen {
            position: relative;
            width: 90%;
            max-width: 900px;
            background: linear-gradient(145deg, #000, #111);
            border-radius: 20px;
            box-shadow: 0 0 40px rgba(255, 215, 0, 0.15);
            padding: 50px 30px 70px;
            text-align: center;
            z-index: 10;
            overflow: hidden;
            animation: fadeIn 2s ease forwards;
        }
        .splash-title {
            font-size: 3rem;
            background: linear-gradient(90deg, #d4af37, #f9f295, #d4af37);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 25px rgba(255, 215, 0, 0.4);
            margin-bottom: 20px;
        }
        .splash-text {
            font-size: 1.1rem;
            color: #e0e0e0;
            line-height: 1.7;
            max-width: 700px;
            margin: 0 auto 30px;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
        }
        .highlight {
            color: gold;
            font-weight: bold;
        }
        .enter-btn {
            padding: 14px 36px;
            font-size: 1.1rem;
            border: 2px solid gold;
            border-radius: 40px;
            background: transparent;
            color: gold;
            cursor: pointer;
            transition: all 0.4s ease;
        }
        .enter-btn:hover {
            background: gold;
            color: #000;
            box-shadow: 0 0 25px gold;
        }
        .terms {
            margin-top: 40px;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
            max-width: 650px;
            margin-left: auto;
            margin-right: auto;
            line-height: 1.5;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; visibility: hidden; }
        }
       
        .dashboard-content {
            display: block;
        }
       
        .nav-icon {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            color: inherit;
        }
        .notification-badge {
            position: absolute;
            top: -2px;
            right: -4px;
            width: 10px;
            height: 10px;
            background-color: var(--danger, #ef4444);
            border-radius: 50%;
            border: 2px solid var(--bg-primary, white);
            transform: scale(0);
            transition: transform 0.2s ease-in-out;
            animation: pulse 2s infinite;
        }
        .notification-badge.visible {
            transform: scale(1);
        }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }

        .mobile-bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: var(--glass-bg, rgba(255, 255, 255, 0.1));
            backdrop-filter: blur(15px);
            border-top: 1px solid var(--glass-border, rgba(255, 255, 255, 0.2));
            display: none;
            justify-content: space-evenly;
            align-items: center;
            padding: 0.5rem 0 calc(0.5rem + env(safe-area-inset-bottom, 0));
            z-index: 1001;
        }
        .mobile-bottom-nav a {
            color: var(--text-dark);
            text-decoration: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 0.6rem;
            opacity: 0.7;
            transition: opacity 0.2s ease, color 0.2s ease;
        }
        .mobile-bottom-nav a i { font-size: 1.1rem; margin-bottom: 0.1rem; }
        .mobile-bottom-nav a:hover,
        .mobile-bottom-nav a.active {
            opacity: 1;
            color: var(--primary);
        }
        .mobile-bottom-nav a.active i {
            transform: scale(1.1);
        }
        .mobile-bottom-nav a.active span {
            font-weight: 600;
        }

        .navbar {
            position: fixed;
            width: 100%;
            top: 0;
            left: 0;
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.9), rgba(79, 70, 229, 0.9));
            backdrop-filter: blur(5px);
            padding: 0.5rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
            transition: var(--transition);
            color: white;
            box-shadow: 0 1px 5px rgba(0, 0, 0, 0.05);
        }
        .navbar::before {
            content: '';
            position: absolute;
            top: -20%;
            left: -20%;
            width: 140%;
            height: 140%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            z-index: -1;
            opacity: 0.3;
        }
        .logo img {
            height: 28px;
            transition: transform var(--transition);
        }
        .logo img:hover {
            transform: scale(1.1);
        }
        .nav-links {
            display: none;
        }
        .nav-link {
            color: white;
            font-weight: 500;
            text-decoration: none;
            padding: 0.5rem 0.8rem;
            border-radius: 0.4rem;
            transition: background 0.2s, color 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1rem;
        }
        .nav-link:hover {
            background: rgba(255, 255, 255, 0.15);
            color: white;
        }
        .nav-toggle {
            display: block;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: white;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 0.3rem;
            transition: background var(--transition);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .nav-toggle:hover {
            background: rgba(255, 255, 255, 0.25);
        }
        .nav-links.mobile {
            display: none;
            flex-direction: column;
            gap: 0.5rem;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            position: fixed;
            top: 60px;
            display: none !important;
            left: 0;
            right: 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border-radius: 0 0 0.7rem 0.7rem;
            padding: 1rem 0.5rem;
            z-index: 1001;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .nav-links.mobile.show {
            display: flex;
        }
        .nav-links.mobile a {
            color: #000000 !important;
            padding: 0.8rem 1rem;
            border-radius: 0.4rem;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 0.7rem;
            min-width: 0;
            background: rgba(124, 58, 237, 0.05);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(124, 58, 237, 0.1);
            transition: all 0.3s ease;
            font-weight: 500;
        }
        .nav-links.mobile a:hover {
            background: rgba(124, 58, 237, 0.1);
            color: var(--primary) !important;
            transform: translateX(5px);
            border-color: rgba(124, 58, 237, 0.3);
        }
        .nav-links.mobile a i {
            color: var(--primary);
            width: 20px;
            text-align: center;
        }
        .dashboard {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            padding: 4rem 1rem 1.5rem;
            margin-top: 0;
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
            min-width: 0;
            transition: filter 0.3s ease;
            overscroll-behavior-y: contain;
        }
        .sidebar, .main-content, .connections {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 1rem;
            padding: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: var(--transition);
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior-y: contain;
            max-height: calc(100vh - 5rem);
        }
        .sidebar:active,
        .sidebar:focus,
        .main-content:active,
        .main-content:focus,
        .connections:active,
        .connections:focus {
            overscroll-behavior-y: contain;
        }
        .sidebar, .connections {
            flex: 1 1 100%;
            max-width: 100%;
        }
        .main-content {
            flex: 1 1 100%;
            max-width: 100%;
            margin: 0;
        }
        .auth-title {
            font-style: italic;
            font-weight: 600;
            color: var(--text-dark);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 1rem 1.5rem;
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            border-radius: 1rem;
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
            border-left: 4px solid var(--primary);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: var(--transition);
        }
        .auth-title:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        .card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 0.8rem;
            padding: 1rem;
            margin-bottom: 1rem;
            transition: transform 0.2s;
        }
        .card:hover {
            transform: translateY(-2px);
        }
        .search-bar, .input-field, .textarea-field {
            width: 100%;
            padding: 0.75rem;
            margin-bottom: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 0.6rem;
            background: rgba(255, 255, 255, 0.2);
            font-size: 1rem;
            color: var(--text-dark);
            transition: border 0.2s;
            font-family: inherit;
        }
        .search-bar:focus, .input-field:focus, .textarea-field:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 2px rgba(167, 139, 250, 0.3);
        }
        .textarea-field {
            min-height: 80px;
            resize: vertical;
        }
        .search-container {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            margin-bottom: 1rem;
        }
        .search-bar {
            flex: 1;
        }
        .btn {
            font-style: italic;
            font-weight: 400;
            color: var(--text-dark);
            padding: 0.6rem 1.2rem;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 0.5rem;
            cursor: pointer;
            transition: transform 0.2s, background 0.2s, color 0.2s;
            white-space: nowrap;
            min-width: fit-content;
        }
        .btn:hover {
            transform: translateY(-2px);
            background: rgba(255, 255, 255, 0.3);
            color: var(--primary);
        }
        .my-active-groups-btn {
            background: transparent !important;
            border: 2px solid var(--primary) !important;
            color: var(--primary) !important;
            font-weight: 500 !important;
            margin-bottom: 1.5rem;
            width: 100%;
            animation: pulseBorder 3s infinite ease-in-out;
        }
        @keyframes pulseBorder {
            0%, 100% {
                border-color: var(--primary);
                box-shadow: 0 0 5px rgba(124, 58, 237, 0.3);
            }
            50% {
                border-color: var(--accent);
                box-shadow: 0 0 15px rgba(167, 139, 250, 0.5);
            }
        }
        .search-btn {
            background: linear-gradient(45deg, #00c4ff, #007bff);
            border: none;
            border-radius: 0.5rem;
            padding: 0.6rem 1.2rem;
            color: white;
            transition: transform 0.2s, background 0.2s;
        }
        .search-btn:hover {
            transform: translateY(-2px);
            background: linear-gradient(45deg, #00e4ff, #009bff);
        }
        .group-item, .connection-item {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            padding: 0.8rem;
            border-radius: 0.8rem;
            transition: background 0.2s, transform 0.2s;
            flex-wrap: nowrap;
            margin-bottom: 0.8rem;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .group-item:hover, .connection-item:hover {
            background: rgba(237, 233, 254, 0.3);
            transform: translateX(4px);
            border-color: rgba(124, 58, 237, 0.2);
        }
        .connection-item {
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 1rem;
            align-items: center;
            min-height: 72px;
        }
        .connection-avatar {
            grid-column: 1;
            flex-shrink: 0;
        }
        .connection-info {
            grid-column: 2;
            min-width: 0;
            overflow: hidden;
        }
        .connection-actions {
            grid-column: 3;
            flex-shrink: 0;
        }
        .avatar {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-weight: bold;
            font-size: 1.2rem;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            overflow: hidden;
            flex-shrink: 0;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        .avatar:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3);
        }
        .avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }
        .video-container {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%;
            height: 0;
            overflow: hidden;
            border-radius: 0.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: box-shadow 0.2s ease;
            margin-top: 0.5rem;
        }
        .video-container:hover {
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
        }
        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 0.5rem;
        }
        .video-grid {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        #courseList {
            position: relative;
            min-height: 400px;
        }
        .ptr-indicator {
            position: absolute;
            top: -50px;
            left: 50%;
            transform: translateX(-50%);
            display: none;
            align-items: center;
            gap: 0.5rem;
            color: var(--primary);
            font-size: 0.9rem;
            transition: opacity 0.3s ease;
            z-index: 10;
        }
        .ptr-indicator.show {
            display: flex;
            opacity: 1;
        }
        .ptr-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(124, 58, 237, 0.3);
            border-top: 2px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        .loading {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #a78bfa;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
            display: none;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 1rem;
            padding: 1.5rem 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 2000;
            color: var(--text-dark);
            text-align: center;
            font-style: italic;
            font-size: 1.2rem;
            animation: fadeIn 0.3s ease;
        }
        .modal.show {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .blur-background {
            filter: blur(5px);
            pointer-events: none;
        }
        .session-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 0.8rem;
            padding: 0.5rem 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            color: var(--text-dark);
            z-index: 999;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: var(--transition);
        }
        .session-indicator.active {
            color: #10b981;
        }
        .session-indicator.warning {
            color: #f59e0b;
        }
        .session-indicator.expiring {
            color: #ef4444;
            animation: pulse 1s infinite;
        }
        .session-indicator .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* ================== PEERPAL AI ORB ================== */
        .peerpal-container {
            position: fixed;
            bottom: 100px; /* CHANGED: Moved up to be above mobile nav */
            right: 30px;
            z-index: 2000;
            pointer-events: auto;
            transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .peerpal-orb {
            width: 72px;
            height: 72px;
            background: rgba(15, 23, 42, 0.08);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-radius: 50%;
            box-shadow: 
                inset 0 1px 1px rgba(255, 255, 255, 0.1),
                inset 0 -1px 2px rgba(0, 0, 0, 0.2),
                0 0 0 1px rgba(255, 255, 255, 0.05),
                0 8px 32px rgba(31, 41, 71, 0.4);
            position: relative;
            cursor: pointer;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
            animation: peerpal-float 6s ease-in-out infinite;
        }

        .peerpal-orb::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(
                circle at 30% 30%,
                rgba(120, 119, 198, 0.15) 0%,
                rgba(96, 165, 250, 0.08) 30%,
                transparent 70%
            );
            border-radius: 50%;
            opacity: 0.7;
        }

        .peerpal-orb::after {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(
                135deg,
                rgba(129, 140, 248, 0.3),
                rgba(96, 165, 250, 0.2),
                rgba(168, 85, 247, 0.3)
            );
            border-radius: 50%;
            z-index: -1;
            opacity: 0;
            transition: opacity 0.4s ease;
            filter: blur(12px);
        }

        .peerpal-orb:hover {
            transform: scale(1.08);
            box-shadow: 
                inset 0 1px 2px rgba(255, 255, 255, 0.15),
                inset 0 -1px 4px rgba(0, 0, 0, 0.25),
                0 0 0 1px rgba(255, 255, 255, 0.08),
                0 12px 40px rgba(31, 41, 71, 0.6);
        }

        .peerpal-orb:hover::after {
            opacity: 1;
        }

        .peerpal-core {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 24px;
            height: 24px;
            background: radial-gradient(
                circle at center,
                rgba(255, 255, 255, 0.95) 0%,
                rgba(226, 232, 240, 0.8) 70%,
                transparent 100%
            );
            border-radius: 50%;
            box-shadow: 
                inset 0 1px 2px rgba(255, 255, 255, 0.8),
                0 0 20px rgba(255, 255, 255, 0.4);
            animation: peerpal-pulse 4s ease-in-out infinite;
        }

        .peerpal-core::before,
        .peerpal-core::after {
            content: '';
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
        }

        .peerpal-core::before {
            width: 8px;
            height: 8px;
            top: -16px;
            left: 8px;
            animation: peerpal-sparkle 3s ease-in-out infinite;
        }

        .peerpal-core::after {
            width: 6px;
            height: 6px;
            bottom: -14px;
            right: 10px;
            animation: peerpal-sparkle 3s ease-in-out infinite 0.5s;
        }

        .peerpal-ripple {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 1px solid rgba(255, 255, 255, 0.1);
            animation: peerpal-ripple 3s linear infinite;
        }

        .peerpal-ripple:nth-child(2) {
            animation-delay: 1s;
        }

        .peerpal-ripple:nth-child(3) {
            animation-delay: 2s;
        }

        .peerpal-panel {
            position: fixed;
            bottom: 190px; /* CHANGED: Adjusted for new orb position */
            right: 30px;
            width: 380px;
            max-width: calc(100vw - 60px);
            height: 520px;
            max-height: calc(100vh - 200px);
            background: rgba(15, 23, 42, 0.12);
            backdrop-filter: blur(40px) saturate(180%);
            -webkit-backdrop-filter: blur(40px) saturate(180%);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.12);
            box-shadow: 
                0 25px 70px rgba(0, 0, 0, 0.45),
                inset 0 1px 0 rgba(255, 255, 255, 0.12),
                inset 0 -1px 0 rgba(0, 0, 0, 0.2);
            z-index: 1999;
            opacity: 0;
            visibility: hidden;
            transform: translateY(20px) scale(0.95);
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .peerpal-panel.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0) scale(1);
        }

        .peerpal-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                linear-gradient(
                    to bottom,
                    transparent 0%,
                    transparent 85%,
                    rgba(96, 165, 250, 0.03) 100%
                ),
                repeating-linear-gradient(
                    0deg,
                    transparent,
                    transparent 1px,
                    rgba(255, 255, 255, 0.02) 1px,
                    rgba(255, 255, 255, 0.02) 2px
                );
            pointer-events: none;
            z-index: 1;
            border-radius: 20px;
        }

        .peerpal-panel::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                radial-gradient(
                    circle at 20% 80%,
                    rgba(129, 140, 248, 0.03) 0%,
                    transparent 50%
                ),
                radial-gradient(
                    circle at 80% 20%,
                    rgba(96, 165, 250, 0.02) 0%,
                    transparent 50%
                );
            pointer-events: none;
            z-index: 1;
            opacity: 0.5;
            animation: liquid-shimmer 15s ease-in-out infinite;
        }

        .peerpal-header {
            padding: 22px 28px 18px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: linear-gradient(
                to bottom,
                rgba(255, 255, 255, 0.08),
                transparent
            );
            position: relative;
            z-index: 2;
            flex-shrink: 0;
        }

        .peerpal-title {
            display: flex;
            align-items: center;
            gap: 12px;
            color: rgba(255, 255, 255, 0.98);
            font-size: 17px;
            font-weight: 500;
            margin: 0;
            letter-spacing: -0.01em;
        }

        .peerpal-title::before {
            content: '';
            width: 9px;
            height: 9px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
            flex-shrink: 0;
        }

        .peerpal-subtitle {
            color: rgba(255, 255, 255, 0.65);
            font-size: 12px;
            margin-top: 3px;
            font-weight: 400;
            letter-spacing: 0.02em;
        }

        .peerpal-capabilities {
            padding: 16px 28px 18px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            background: linear-gradient(
                to bottom,
                rgba(255, 255, 255, 0.03),
                transparent
            );
            position: relative;
            z-index: 2;
            flex-shrink: 0;
        }

        .capability-hint {
            color: rgba(255, 255, 255, 0.6);
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            animation: hint-glow 8s ease-in-out infinite;
        }

        .capability-hint::before {
            content: 'âœ¨';
            font-size: 11px;
            opacity: 0.7;
        }

        .peerpal-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px 28px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            position: relative;
            z-index: 2;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .peerpal-messages::-webkit-scrollbar {
            display: none;
        }

        .peerpal-messages {
            overscroll-behavior: contain;
            -webkit-overflow-scrolling: touch;
        }

        .message {
            max-width: 85%;
            padding: 14px 18px;
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.5;
            animation: message-appear 0.3s ease-out;
            word-wrap: break-word;
            position: relative;
        }

        .message.user {
            align-self: flex-end;
            background: linear-gradient(
                135deg,
                rgba(96, 165, 250, 0.15),
                rgba(129, 140, 248, 0.15)
            );
            border: 1px solid rgba(255, 255, 255, 0.12);
            color: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .message.ai {
            align-self: flex-start;
            background: rgba(255, 255, 255, 0.07);
            border: 1px solid rgba(255, 255, 255, 0.08);
            color: rgba(255, 255, 255, 0.9);
            box-shadow: 
                inset 0 1px 0 rgba(255, 255, 255, 0.05),
                0 2px 6px rgba(0, 0, 0, 0.1);
        }

        .peerpal-input-container {
            padding: 20px 28px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            background: linear-gradient(
                to top,
                rgba(15, 23, 42, 0.4),
                transparent
            );
            position: relative;
            z-index: 2;
            flex-shrink: 0;
            margin-top: auto;
        }

        .peerpal-input-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 28px;
            right: 28px;
            height: 1px;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.15),
                transparent
            );
        }

        .peerpal-input-wrapper {
            display: flex;
            gap: 12px;
            align-items: flex-end;
            background: rgba(255, 255, 255, 0.07);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 6px 6px 6px 18px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .peerpal-input-wrapper:focus-within {
            border-color: rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.09);
            box-shadow: 
                0 4px 12px rgba(0, 0, 0, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
        }

        .peerpal-input {
            flex: 1;
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.98);
            font-size: 14px;
            padding: 10px 0;
            outline: none;
            min-height: 20px;
            max-height: 100px;
            resize: none;
            font-family: inherit;
            line-height: 1.4;
        }

        .peerpal-input::placeholder {
            color: rgba(255, 255, 255, 0.45);
        }

        .peerpal-send {
            width: 40px;
            height: 40px;
            background: linear-gradient(
                135deg,
                rgba(96, 165, 250, 0.25),
                rgba(129, 140, 248, 0.25)
            );
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            color: rgba(255, 255, 255, 0.95);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            flex-shrink: 0;
            position: relative;
            overflow: hidden;
        }

        .peerpal-send::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(
                135deg,
                rgba(255, 255, 255, 0.1),
                transparent
            );
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .peerpal-send:hover:not(:disabled) {
            background: linear-gradient(
                135deg,
                rgba(96, 165, 250, 0.35),
                rgba(129, 140, 248, 0.35)
            );
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .peerpal-send:hover:not(:disabled)::before {
            opacity: 1;
        }

        .peerpal-send:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
            background: rgba(255, 255, 255, 0.1);
        }

        .peerpal-send i {
            font-size: 15px;
            position: relative;
            z-index: 1;
        }

        .peerpal-typing {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 12px 18px;
            background: rgba(255, 255, 255, 0.07);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 18px;
            align-self: flex-start;
            max-width: 85%;
            backdrop-filter: blur(10px);
        }

        .typing-dot {
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 50%;
            animation: typing-bounce 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        .peerpal-paywall {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.98);
            backdrop-filter: blur(30px) saturate(200%);
            -webkit-backdrop-filter: blur(30px) saturate(200%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            text-align: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 10;
            border-radius: 20px;
        }

        .peerpal-paywall.active {
            opacity: 1;
            visibility: visible;
        }

        .paywall-content {
            max-width: 280px;
            animation: paywall-appear 0.6s cubic-bezier(0.4, 0, 0.2, 1) forwards;
            transform-origin: center;
        }

        .paywall-icon {
            width: 64px;
            height: 64px;
            background: linear-gradient(
                135deg,
                rgba(96, 165, 250, 0.2),
                rgba(129, 140, 248, 0.2)
            );
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
            position: relative;
            overflow: hidden;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        .paywall-icon::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(
                135deg,
                transparent,
                rgba(255, 255, 255, 0.05),
                transparent
            );
        }

        .paywall-icon i {
            font-size: 26px;
            color: rgba(255, 255, 255, 0.95);
            position: relative;
            z-index: 1;
        }

        .paywall-title {
            color: rgba(255, 255, 255, 0.98);
            font-size: 21px;
            font-weight: 500;
            margin-bottom: 12px;
            letter-spacing: -0.01em;
        }

        .paywall-text {
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 8px;
        }

        .paywall-features {
            color: rgba(255, 255, 255, 0.5);
            font-size: 12px;
            line-height: 1.4;
            margin: 16px 0 28px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .paywall-button {
            background: linear-gradient(
                135deg,
                rgba(96, 165, 250, 0.25),
                rgba(129, 140, 248, 0.25)
            );
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 14px;
            color: rgba(255, 255, 255, 0.98);
            padding: 15px 36px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            letter-spacing: 0.02em;
            position: relative;
            overflow: hidden;
        }

        .paywall-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(
                135deg,
                rgba(255, 255, 255, 0.15),
                transparent
            );
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .paywall-button:hover {
            background: linear-gradient(
                135deg,
                rgba(96, 165, 250, 0.35),
                rgba(129, 140, 248, 0.35)
            );
            transform: translateY(-2px);
            box-shadow: 
                0 12px 40px rgba(0, 0, 0, 0.3),
                0 4px 12px rgba(96, 165, 250, 0.2);
        }

        .paywall-button:hover::before {
            opacity: 1;
        }

        .peerpal-usage {
            position: absolute;
            top: 22px;
            right: 28px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 10px;
            padding: 5px 10px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 11px;
            font-weight: 500;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            letter-spacing: 0.03em;
        }

        @keyframes peerpal-float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }

        @keyframes peerpal-pulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            50% { transform: translate(-50%, -50%) scale(1.05); opacity: 0.9; }
        }

        @keyframes peerpal-sparkle {
            0%, 100% { transform: translateY(0); opacity: 0.3; }
            50% { transform: translateY(-4px); opacity: 1; }
        }

        @keyframes peerpal-ripple {
            0% {
                width: 100%;
                height: 100%;
                opacity: 1;
            }
            100% {
                width: 140%;
                height: 140%;
                opacity: 0;
            }
        }

        @keyframes typing-bounce {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-6px); }
        }

        @keyframes message-appear {
            from {
                opacity: 0;
                transform: translateY(8px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes liquid-shimmer {
            0%, 100% {
                opacity: 0.3;
                transform: translateX(0) translateY(0);
            }
            25% {
                opacity: 0.5;
                transform: translateX(2px) translateY(-2px);
            }
            50% {
                opacity: 0.3;
                transform: translateX(-2px) translateY(2px);
            }
            75% {
                opacity: 0.5;
                transform: translateX(2px) translateY(2px);
            }
        }

        @keyframes hint-glow {
            0%, 100% {
                opacity: 0.6;
            }
            50% {
                opacity: 1;
            }
        }

        @keyframes paywall-appear {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(10px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        @media (max-width: 640px) {
            .peerpal-container {
                bottom: 90px; /* CHANGED: Adjusted for mobile */
                right: 20px;
            }

            .peerpal-orb {
                width: 64px;
                height: 64px;
            }

            .peerpal-core {
                width: 20px;
                height: 20px;
            }

            .peerpal-panel {
                bottom: 170px; /* CHANGED: Adjusted for mobile */
                right: 20px;
                left: 20px;
                width: auto;
                height: 500px;
            }
        }

        body:not([data-theme="dark"]) .peerpal-panel,
        body:not([data-theme="dark"]) .peerpal-paywall,
        body:not([data-theme="dark"]) .peerpal-orb {
            filter: brightness(0.95) contrast(1.1);
        }

        /* ================== END PEERPAL STYLES ================== */
       
        @media (max-width: 768px) {
            .splash-title {
                font-size: 2.2rem;
            }
            .splash-text {
                font-size: 1rem;
                padding: 0 10px;
            }
            .enter-btn {
                font-size: 1rem;
                padding: 12px 28px;
            }
            .terms {
                font-size: 0.75rem;
                padding: 0 15px;
            }
           
            .auth-title {
                font-size: 1.25rem;
                padding: 0.8rem 1.2rem;
                margin-bottom: 1rem;
            }
            .sidebar, .main-content, .connections {
                padding: 1rem;
                -webkit-overflow-scrolling: touch;
                scroll-behavior: smooth;
                max-height: none;
                height: auto;
            }
            .card {
                padding: 0.8rem;
            }
            .dashboard {
                padding: 3.5rem 0.5rem 1rem;
                gap: 1rem;
            }
            .search-container {
                flex-direction: column;
            }
            .search-bar, .btn, .search-btn {
                width: 100%;
            }
            .group-item, .connection-item {
                flex-wrap: wrap;
                gap: 0.5rem;
            }
            .avatar {
                width: 40px;
                height: 40px;
                font-size: 1rem;
            }
            .session-indicator {
                bottom: 15px;
                right: 15px;
                bottom: 70px;
                font-size: 0.8rem;
                padding: 0.4rem 0.8rem;
            }
            .video-grid {
                gap: 0.75rem;
            }
            .mobile-bottom-nav {
                display: flex;
            }
            .nav-toggle {
                display: none;
            }
            #courseList {
                min-height: 300px;
            }
            .dashboard {
                flex-direction: column;
            }
            .sidebar {
                order: 1;
            }
            .main-content {
                order: 2;
            }
            .connections {
                order: 3;
            }
            .connection-item {
                grid-template-columns: auto 1fr;
                grid-template-rows: auto auto;
            }
            .connection-avatar {
                grid-column: 1;
                grid-row: 1 / span 2;
            }
            .connection-info {
                grid-column: 2;
                grid-row: 1;
            }
            .connection-actions {
                grid-column: 2;
                grid-row: 2;
                justify-self: start;
                margin-top: 0.5rem;
            }
        }
       
        @media (min-width: 1024px) {
            .dashboard {
                flex-direction: row;
            }
            .nav-links {
                display: flex;
            }
            .nav-toggle {
                display: none !important;
            }
            .sidebar, .connections {
                flex: 1 1 350px;
                max-width: 350px;
            }
            .main-content {
                flex: 2 1 500px;
                max-width: 500px;
            }
        }
       
        @media (max-width: 1023px) and (min-width: 769px) {
            .navbar {
                padding: 0.5rem 0.8rem;
            }
            .nav-links {
                display: none;
            }
            .nav-toggle {
                display: block;
            }
            .nav-links.mobile {
                top: 50px;
                padding: 1rem;
                background: rgba(255, 255, 255, 0.98);
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
            }
            .nav-links.mobile a {
                font-size: 1rem;
                padding: 0.9rem 1rem;
                margin-bottom: 0.3rem;
                background: rgba(255, 255, 255, 0.7);
                border: 1px solid rgba(124, 58, 237, 0.15);
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
                color: #000000 !important;
            }
            .nav-links.mobile a:last-child {
                margin-bottom: 0;
            }
            .dashboard {
                margin-top: 0;
                padding: 3.5rem 0.5rem 1rem;
            }
            .sidebar, .main-content, .connections {
                padding: 0.7rem;
                max-height: none;
                height: auto;
            }
            .card {
                padding: 0.9rem;
            }
            .avatar {
                width: 44px;
                height: 44px;
                font-size: 1.1rem;
            }
            .session-indicator {
                bottom: 15px;
                right: 15px;
                font-size: 0.8rem;
                padding: 0.4rem 0.8rem;
            }
            .video-grid {
                gap: 0.875rem;
            }
        }
       
        @media (max-width: 480px) {
            .navbar {
                padding: 0.3rem 0.5rem;
            }
            .logo img {
                height: 24px;
            }
            .nav-toggle {
                font-size: 1.3rem;
                padding: 0.4rem;
            }
            .nav-links.mobile {
                top: 40px;
                padding: 0.8rem;
                background: rgba(255, 255, 255, 0.98);
            }
            .nav-links.mobile a {
                font-size: 0.95rem;
                padding: 0.8rem;
                color: #000000 !important;
            }
            .dashboard {
                padding: 3.2rem 0.2rem 0.5rem;
            }
            .sidebar, .main-content, .connections {
                padding: 0.5rem;
                max-height: none;
                height: auto;
            }
            .card {
                padding: 0.6rem;
            }
            .search-bar, .input-field, .textarea-field {
                padding: 0.6rem;
            }
            .btn, .search-btn {
                padding: 0.4rem 0.8rem;
            }
            .avatar {
                width: 36px;
                height: 36px;
                font-size: 0.9rem;
            }
            .modal {
                padding: 1rem 1.5rem;
                font-size: 1rem;
            }
            .session-indicator {
                bottom: 10px;
                right: 10px;
                font-size: 0.75rem;
                padding: 0.3rem 0.6rem;
            }
            .video-grid {
                gap: 0.5rem;
            }
            .auth-title {
                font-size: 1.15rem;
                padding: 0.75rem 1rem;
            }
            body {
                -webkit-font-smoothing: antialiased;
                -moz-osx-font-smoothing: grayscale;
            }
        }
       
        @media (max-width: 360px) {
            .splash-title {
                font-size: 1.8rem;
            }
            .splash-text {
                font-size: 0.9rem;
            }
            .enter-btn {
                font-size: 0.9rem;
                padding: 10px 20px;
            }
            .terms {
                font-size: 0.7rem;
            }
            .auth-title {
                font-size: 1.1rem;
                padding: 0.6rem 1rem;
            }
            .dashboard {
                padding: 3rem 0.2rem 0.5rem;
            }
        }

        .skeleton-item {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            padding: 0.8rem;
            border-radius: 0.8rem;
            margin-bottom: 0.8rem;
            background: rgba(255, 255, 255, 0.1);
            overflow: hidden;
            position: relative;
        }
        [data-theme="dark"] .skeleton-item {
            background: rgba(255, 255, 255, 0.05);
        }

        .skeleton-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background-color: var(--hover-bg);
            flex-shrink: 0;
        }

        .skeleton-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .skeleton-line {
            height: 1rem;
            background-color: var(--hover-bg);
            border-radius: 0.25rem;
        }

        .skeleton-line.short { width: 60%; }

        .skeleton-button {
            width: 60px;
            height: 36px;
            background-color: var(--hover-bg);
            border-radius: 0.5rem;
            flex-shrink: 0;
        }

        .skeleton-item::after {
            content: '';
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            animation: shimmer 1.5s infinite;
        }
        [data-theme="dark"] .skeleton-item::after {
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
    </style>
</head>
<body data-theme="light">
    <div id="splashContainer" class="splash-container">
        <div class="splash-screen" id="splash">
            <div class="splash-title">Welcome to PeerLoom âœ¨</div>
            <div class="splash-text">
                Step into the <span class="highlight">world's most vibrant student space</span> â€” where study groups, ideas, and creativity unite.<br><br>
                Create your group, invite friends, and chat instantly with <span class="highlight">PeerPal AI</span> â€” your smart study companion.<br>
                Watch and post creative student content on <span class="highlight">Skrolz</span>, and grow your network while learning together.<br><br>
                ðŸŽ The <span class="highlight">most active group</span> with over 50 members wins <span class="highlight">exclusive PeerLoom rewards</span> every month!<br>
                Share your group link â€” grow your community, boost your rank, and claim the spotlight.
            </div>
            <button class="enter-btn" onclick="enterSite()">Enter PeerLoom</button>
            <div class="terms">
                *Rewards apply to verified groups only. Members must remain active throughout the month. Engagement is based on messages, posts, and Skrolz activity. PeerLoom reserves the right to verify or disqualify inactive or spam groups.
            </div>
        </div>
    </div>
    <div class="dashboard-content">
        <nav class="navbar" id="navbar">
            <a href="index.html" class="logo">
                <img src="../logo.png" alt="Peerloom" onerror="console.warn('Logo not found')">
            </a>
            <div class="nav-links" id="navLinks">
                <a href="about.html" class="nav-link"><i class="fas fa-info-circle"></i> About</a>
                <a href="profile.html" class="nav-link"><i class="fas fa-user"></i> Profile</a>
                <a href="notifications.html" class="nav-link nav-icon" id="notificationsBtnDesktop" aria-label="Notifications">
                    <i class="fas fa-bell"></i>
                    <span class="notification-badge" id="notificationBadgeDesktop"></span>
                </a>
                <a href="feed.html" class="nav-link"><i class="fas fa-scroll"></i> Skrolz</a>
                <a href="logout.html" class="nav-link" id="logout"><i class="fas fa-sign-out-alt"></i> Logout</a>
            </div>
            <div class="nav-links mobile" id="navLinksMobile">
                <a href="about.html" class="nav-link"><i class="fas fa-info-circle"></i> About</a>
                <a href="profile.html" class="nav-link"><i class="fas fa-user"></i> Profile</a>
                <a href="notifications.html" class="nav-link nav-icon" id="notificationsBtnMobile" aria-label="Notifications">
                    <i class="fas fa-bell"></i> Notifications
                    <span class="notification-badge" id="notificationBadgeMobile"></span>
                </a>
                <a href="feed.html" class="nav-link"><i class="fas fa-scroll"></i> Skrolz</a>
                <a href="logout.html" class="nav-link" id="logoutMobile"><i class="fas fa-sign-out-alt"></i> Logout</a>
            </div>
        </nav>
        <div class="dashboard lg:flex lg:flex-row">
            <div class="sidebar">
                <h3 class="auth-title text-xl"><i class="fas fa-users"></i> Groups</h3>
                <div class="search-container">
                    <input type="text" id="groupSearch" class="search-bar" placeholder="Search groups..." />
                    <button class="btn search-btn" id="searchGroupsBtn">Search</button>
                    <div id="groupLoading" class="loading"></div>
                </div>
                <button class="btn my-active-groups-btn" onclick="window.location.href='active-groups.html'">
                    <i class="fas fa-list"></i> My Active Groups
                </button>
                <div class="card">
                    <h4 class="text-lg font-semibold text-purple-600 flex items-center gap-2">
                        <i class="fas fa-lightbulb"></i> Suggested Groups
                    </h4>
                    <div id="suggestedGroups" class="space-y-2">
                    </div>
                </div>
            </div>

            <div class="main-content">
                <h3 class="auth-title text-xl"><i class="fas fa-book"></i> Your Courses</h3>
                <div class="search-container">
                    <input type="text" id="courseSearch" class="search-bar" placeholder="Search educational videos..." />
                    <button class="btn search-btn" id="searchCoursesBtn">Search</button>
                    <div id="courseLoading" class="loading"></div>
                </div>
                <div id="ptrIndicator" class="ptr-indicator">
                    <div class="ptr-spinner"></div>
                    <span>Refreshing videos...</span>
                </div>
                <div id="courseList">
                </div>
            </div>

            <div class="connections">
                <h3 class="auth-title text-xl"><i class="fas fa-user-plus"></i> Connections </h3>
                <div class="search-container">
                    <input type="text" id="connectionSearch" class="search-bar" placeholder="Search for coursemates..." />
                    <button class="btn search-btn" id="searchConnectionsBtn">Search</button>
                    <div id="connectionLoading" class="loading"></div>
                </div>
                <div id="connectionList">
                </div>
            </div>
        </div>
        <div id="sessionIndicator" class="session-indicator active">
            <span class="status-dot"></span>
            <span id="sessionStatus">Session Active</span>
            <span id="sessionTimer">(59:59)</span>
        </div>
        <div id="notificationModal" class="modal">
            <span id="modalMessage">Group inserted</span>
        </div>
        <div class="mobile-bottom-nav">
            <a href="dashboard.html" class="active">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </a>
            <a href="feed.html">
                <i class="fas fa-scroll"></i>
                <span>Skrolz</span>
            </a>
            <a href="notifications.html" class="nav-icon">
                <i class="fas fa-bell"></i>
                <span class="notification-badge"></span>
                <span>Activity</span>
            </a>
            <a href="profile.html">
                <i class="fas fa-user"></i>
                <span>Profile</span>
            </a>
        </div>

        <div class="peerpal-container" id="peerpalContainer">
            <div class="peerpal-orb" id="peerpalOrb">
                <div class="peerpal-ripple"></div>
                <div class="peerpal-ripple"></div>
                <div class="peerpal-ripple"></div>
                <div class="peerpal-core"></div>
            </div>
        </div>

        <div class="peerpal-panel" id="peerpalPanel">
            <div class="peerpal-header">
                <h3 class="peerpal-title">PeerPal AI</h3>
                <p class="peerpal-subtitle">Your premium study companion</p>
                <div class="peerpal-usage" id="peerpalUsage">0/5 requests</div>
            </div>
            
            <div class="peerpal-capabilities">
                <div class="capability-hint">
                    Ask about study strategies, time management, or academic planning
                </div>
            </div>
            
            <div class="peerpal-messages" id="peerpalMessages">
                <div class="message ai">
                    Hello. I'm PeerPal, your premium AI study companion. How can I assist you today?
                </div>
            </div>
            
            <div class="peerpal-input-container">
                <div class="peerpal-input-wrapper">
                    <textarea 
                        class="peerpal-input" 
                        id="peerpalInput" 
                        placeholder="Message PeerPal..." 
                        rows="1"
                        maxlength="2000"
                    ></textarea>
                    <button class="peerpal-send" id="peerpalSend">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
            
            <div class="peerpal-paywall" id="peerpalPaywall">
                <div class="paywall-content">
                    <div class="paywall-icon">
                        <i class="fas fa-lock"></i>
                    </div>
                    <h3 class="paywall-title">Limit Reached</h3>
                    <p class="paywall-text">You've used your 5 free requests</p>
                    <p class="paywall-text">Unlock PeerPal for $1/month</p>
                    <div class="paywall-features">
                        Unlimited requests â€¢ All AI models â€¢ Voice features â€¢ Priority access
                    </div>
                    <button class="paywall-button" id="unlockButton">Unlock Premium</button>
                </div>
            </div>
        </div>
    </div>
    <audio id="notificationSound" preload="auto">
        <source src="/sounds/notification.mp3" type="audio/mpeg">
    </audio>
    <script type="module">
        import { supabase } from './js/supabaseClient.js';
       
        const notificationBadgeDesktop = document.getElementById('notificationBadgeDesktop');
        const notificationBadgeMobile = document.getElementById('notificationBadgeMobile');
        const notificationSound = document.getElementById('notificationSound');

        let logoutTimer;
        const AUTO_LOGOUT_TIME = 60 * 60 * 1000;
        let sessionUpdateInterval;
       
        let snowflakeElements = [];
       
        function applyTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            if (theme === 'dark') {
                createSnowflakes();
            } else {
                removeSnowflakes();
            }
        }
       
        function createSnowflakes() {
            if (snowflakeElements.length > 0) return;
            const snowflakes = 80;
            for (let i = 0; i < snowflakes; i++) {
                const snowflake = document.createElement('div');
                snowflake.classList.add('snowflake');
                snowflake.textContent = 'â„';
                snowflake.style.left = Math.random() * 100 + 'vw';
                snowflake.style.fontSize = Math.random() * 1.5 + 0.5 + 'em';
                snowflake.style.animationDuration = Math.random() * 5 + 5 + 's';
                snowflake.style.animationDelay = Math.random() * 5 + 's';
                document.body.appendChild(snowflake);
                snowflakeElements.push(snowflake);
            }
        }
       
        function removeSnowflakes() {
            snowflakeElements.forEach(snow => snow.remove());
            snowflakeElements = [];
        }
       
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            applyTheme(newTheme);
        }
       
        let touchStartX = 0;
        const navbar = document.getElementById('navbar');
        if (navbar) {
            navbar.addEventListener('touchstart', (e) => {
                touchStartX = e.changedTouches[0].screenX;
            });
            navbar.addEventListener('touchend', (e) => {
                const touchEndX = e.changedTouches[0].screenX;
                const diff = touchStartX - touchEndX;
                if (Math.abs(diff) > 50) {
                    toggleTheme();
                }
            });
        }
       
        function loadTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            applyTheme(savedTheme);
        }
       
        function enterSite() {
            const splashContainer = document.getElementById('splashContainer');
            const dashboardContent = document.querySelector('.dashboard-content');
           
            splashContainer.style.animation = 'fadeOut 1s forwards';
           
            setTimeout(() => {
                splashContainer.style.display = 'none';
                dashboardContent.style.display = 'block';
               
                removeSnowflakes();
               
                loadTheme();
            }, 1000);
        }
       
        function resetLogoutTimer() {
            clearTimeout(logoutTimer);
            logoutTimer = setTimeout(autoLogout, AUTO_LOGOUT_TIME);
            updateSessionIndicator();
        }
       
        function updateSessionIndicator() {
            const sessionIndicator = document.getElementById('sessionIndicator');
            const sessionStatus = document.getElementById('sessionStatus');
            const sessionTimer = document.getElementById('sessionTimer');
          
            if (!sessionIndicator || !sessionStatus || !sessionTimer) return;
          
            const remainingTime = AUTO_LOGOUT_TIME - (Date.now() - (logoutTimer._idleStart || Date.now()));
            const minutes = Math.floor(remainingTime / 60000);
            const seconds = Math.floor((remainingTime % 60000) / 1000);
          
            const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            sessionTimer.textContent = `(${timeString})`;
          
            sessionIndicator.className = 'session-indicator';
            if (remainingTime > 10 * 60 * 1000) {
                sessionIndicator.classList.add('active');
                sessionStatus.textContent = 'Session Active';
            } else if (remainingTime > 2 * 60 * 1000) {
                sessionIndicator.classList.add('warning');
                sessionStatus.textContent = 'Session Expiring Soon';
            } else {
                sessionIndicator.classList.add('expiring');
                sessionStatus.textContent = 'Session About to Expire';
            }
        }
       
        async function autoLogout() {
            console.log('Auto-logging out due to inactivity');
            clearInterval(sessionUpdateInterval);
            const { error } = await supabase.auth.signOut();
            if (!error) {
                window.location.href = 'index.html?message=session_timeout';
            }
        }
       
        function setupActivityListeners() {
            const events = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'];
            events.forEach(event => {
                document.addEventListener(event, resetLogoutTimer, { passive: true });
            });
        }

        async function requestNotificationPermissions() {
            if ('Notification' in window && Notification.permission === 'default') {
                try {
                    const permission = await Notification.requestPermission();
                    console.log('Notification permission:', permission);
                } catch (error) {
                    console.log('Notification permission request failed:', error);
                }
            }
        }

        function playNotificationSound() {
            try {
                if (notificationSound) {
                    notificationSound.currentTime = 0;
                    notificationSound.volume = 0.5;
                    
                    const playPromise = notificationSound.play();
                    if (playPromise !== undefined) {
                        playPromise.catch(error => {
                            console.log('Could not play notification sound:', error);
                        });
                    }
                }
            } catch (error) {
                console.log('Notification sound error:', error);
            }
        }

        async function triggerPushNotification(title, body, tag = 'peerloom-notification') {
            if ('Notification' in window && Notification.permission === 'granted') {
                try {
                    const notification = new Notification(title, {
                        body,
                        tag,
                        icon: '/android-chrome-192x192.png',
                        requireInteraction: false
                    });
                    
                    playNotificationSound();
                    
                    notification.onclick = function() {
                        window.focus();
                        notification.close();
                    };
                    
                    setTimeout(() => notification.close(), 7000);
                    return notification;
                } catch (error) {
                    console.log('Error creating push notification:', error);
                }
            }
            return null;
        }

        function setupRealtimeNotifications(userId) {
            try {
                const channel = supabase
                    .channel('notifications-changes')
                    .on(
                        'postgres_changes',
                        {
                            event: 'INSERT',
                            schema: 'public',
                            table: 'notifications',
                            filter: `user_id=eq.${userId}`
                        },
                        (payload) => {
                            console.log('New notification received in real-time:', payload.new);
                            
                            updateNotificationBadge();
                            
                            playNotificationSound();
                            
                            if (Notification.permission === 'granted') {
                                const notification = payload.new;
                                let title = 'PeerLoom';
                                let body = '';
                                
                                switch (notification.type) {
                                    case 'new_follower':
                                        title = 'New Follower';
                                        body = `${notification.sender_profile?.full_name || 'Someone'} started following you`;
                                        break;
                                    case 'group_join':
                                        title = 'Group Joined';
                                        body = `You joined ${notification.content || 'a group'}`;
                                        break;
                                    case 'message':
                                        title = 'New Message';
                                        body = `New message from ${notification.sender_profile?.full_name || 'Someone'}`;
                                        break;
                                    case 'post_like':
                                        title = 'Post Liked';
                                        body = `${notification.sender_profile?.full_name || 'Someone'} liked your post`;
                                        break;
                                    case 'comment':
                                        title = 'New Comment';
                                        body = `${notification.sender_profile?.full_name || 'Someone'} commented on your post`;
                                        break;
                                    default:
                                        body = notification.content || 'You have a new notification';
                                }
                                
                                triggerPushNotification(title, body);
                            }
                        }
                    )
                    .subscribe((status, err) => {
                        if (status === 'SUBSCRIBED') {
                            console.log('Successfully subscribed to notifications');
                        }
                        if (status === 'CHANNEL_ERROR') {
                            console.error('Error in notifications channel:', err);
                        }
                        if (status === 'TIMED_OUT') {
                            console.error('Notifications channel timed out');
                        }
                        if (status === 'CLOSED') {
                            console.error('Notifications channel closed');
                        }
                    });
                
                return channel;
            } catch (error) {
                console.error('Error setting up realtime notifications:', error);
                return null;
            }
        }

        async function updateNotificationBadge() {
            const { data: { user } } = await supabase.auth.getUser();
            if (!user) return;

            try {
                const { count, error } = await supabase
                    .from('notifications')
                    .select('*', { count: 'exact', head: true })
                    .eq('user_id', user.id)
                    .eq('read', false);

                if (error) throw error;

                if (count > 0) {
                    notificationBadgeDesktop.classList.add('visible');
                    notificationBadgeMobile.classList.add('visible');
                    document.querySelectorAll('.mobile-bottom-nav .notification-badge').forEach(el => el.classList.add('visible'));
                } else {
                    notificationBadgeDesktop.classList.remove('visible');
                    notificationBadgeMobile.classList.remove('visible');
                    document.querySelectorAll('.mobile-bottom-nav .notification-badge').forEach(el => el.classList.remove('visible'));
                }
            } catch (error) { 
                console.error('Error updating notification badge:', error); 
            }
        }

        function setupColumnScrollPrevention() {
            const columns = document.querySelectorAll('.sidebar, .main-content, .connections');
            
            columns.forEach(column => {
                column.addEventListener('wheel', (e) => {
                    const isAtTop = column.scrollTop === 0;
                    const isAtBottom = column.scrollHeight - column.clientHeight <= column.scrollTop + 1;
                    
                    if ((isAtTop && e.deltaY < 0) || (isAtBottom && e.deltaY > 0)) {
                        return;
                    }
                    
                    e.stopPropagation();
                }, { passive: true });

                column.addEventListener('touchstart', (e) => {
                    column.dataset.startY = e.touches[0].clientY;
                }, { passive: true });

                column.addEventListener('touchmove', (e) => {
                    const startY = parseFloat(column.dataset.startY || '0');
                    const currentY = e.touches[0].clientY;
                    const isAtTop = column.scrollTop === 0;
                    const isAtBottom = column.scrollHeight - column.clientHeight <= column.scrollTop + 1;
                    
                    if ((isAtTop && currentY > startY) || (isAtBottom && currentY < startY)) {
                        return;
                    }
                    
                    if (e.cancelable) {
                        e.stopPropagation();
                    }
                }, { passive: false });
            });
        }

        class PeerPalAI {
            constructor() {
                this.orb = document.getElementById('peerpalOrb');
                this.panel = document.getElementById('peerpalPanel');
                this.container = document.getElementById('peerpalContainer');
                this.messages = document.getElementById('peerpalMessages');
                this.input = document.getElementById('peerpalInput');
                this.sendBtn = document.getElementById('peerpalSend');
                this.usageDisplay = document.getElementById('peerpalUsage');
                this.paywall = document.getElementById('peerpalPaywall');
                this.unlockBtn = document.getElementById('unlockButton');
                
                this.isOpen = false;
                this.usageCount = 0;
                this.maxFreeRequests = 5;
                this.isProcessing = false;
                
                this.apiKey = 'simulated-openai-key';
                this.openaiModel = 'gpt-4';
                this.embeddingModel = 'text-embedding-ada-002';
                this.reasoningModel = 'gpt-4-turbo';
                this.ttsModel = 'tts-1';
                this.audioModel = 'whisper-1';
                
                this.init();
            }
            
            init() {
                this.loadUsage();
                
                this.orb.addEventListener('click', () => this.togglePanel());
                this.sendBtn.addEventListener('click', () => this.sendMessage());
                this.input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });
                
                this.input.addEventListener('input', () => {
                    this.input.style.height = 'auto';
                    this.input.style.height = Math.min(this.input.scrollHeight, 100) + 'px';
                });
                
                this.unlockBtn.addEventListener('click', () => {
                    this.showPremiumModal();
                });
                
                document.addEventListener('click', (e) => {
                    if (this.isOpen && 
                        !this.panel.contains(e.target) && 
                        !this.orb.contains(e.target)) {
                        this.closePanel();
                    }
                });
                
                this.messages.addEventListener('wheel', (e) => {
                    const isAtTop = this.messages.scrollTop === 0;
                    const isAtBottom = this.messages.scrollHeight - this.messages.clientHeight <= this.messages.scrollTop + 1;
                    
                    if ((isAtTop && e.deltaY < 0) || (isAtBottom && e.deltaY > 0)) {
                        return;
                    }
                    
                    e.stopPropagation();
                }, { passive: true });
                
                let startY = 0;
                this.messages.addEventListener('touchstart', (e) => {
                    startY = e.touches[0].clientY;
                }, { passive: true });
                
                this.messages.addEventListener('touchmove', (e) => {
                    const currentY = e.touches[0].clientY;
                    const isAtTop = this.messages.scrollTop === 0;
                    const isAtBottom = this.messages.scrollHeight - this.messages.clientHeight <= this.messages.scrollTop + 1;
                    
                    if ((isAtTop && currentY > startY) || (isAtBottom && currentY < startY)) {
                        return;
                    }
                    
                    if (e.cancelable) {
                        e.stopPropagation();
                    }
                }, { passive: false });
            }
            
            loadUsage() {
                const saved = localStorage.getItem('peerpalUsage');
                this.usageCount = saved ? parseInt(saved) : 0;
                this.updateUsageDisplay();
            }
            
            saveUsage() {
                localStorage.setItem('peerpalUsage', this.usageCount.toString());
            }
            
            updateUsageDisplay() {
                this.usageDisplay.textContent = `${this.usageCount}/${this.maxFreeRequests} requests`;
                
                if (this.usageCount >= this.maxFreeRequests) {
                    this.sendBtn.disabled = true;
                    this.input.disabled = true;
                    this.input.placeholder = 'Limit reached. Unlock for more...';
                    this.paywall.classList.add('active');
                } else {
                    this.sendBtn.disabled = false;
                    this.input.disabled = false;
                    this.input.placeholder = 'Message PeerPal...';
                    this.paywall.classList.remove('active');
                }
            }
            
            togglePanel() {
                if (this.isOpen) {
                    this.closePanel();
                } else {
                    this.openPanel();
                }
            }
            
            openPanel() {
                this.isOpen = true;
                this.panel.classList.add('active');
                this.container.style.transform = 'translateY(-10px)';
                
                setTimeout(() => {
                    this.input.focus();
                }, 300);
            }
            
            closePanel() {
                this.isOpen = false;
                this.panel.classList.remove('active');
                this.container.style.transform = 'translateY(0)';
            }
            
            async sendMessage() {
                const message = this.input.value.trim();
                if (!message || this.isProcessing) return;
                
                if (this.usageCount >= this.maxFreeRequests) {
                    this.showPaywall();
                    return;
                }
                
                this.isProcessing = true;
                
                this.addMessage(message, 'user');
                this.input.value = '';
                this.input.style.height = 'auto';
                
                const typingIndicator = this.showTyping();
                
                try {
                    this.usageCount++;
                    this.saveUsage();
                    this.updateUsageDisplay();
                    
                    const response = await this.getAIResponse(message);
                    
                    typingIndicator.remove();
                    
                    this.addMessage(response, 'ai');
                    
                } catch (error) {
                    console.error('AI Error:', error);
                    typingIndicator.remove();
                    this.addMessage('I apologize, but I encountered an error. Please try again.', 'ai');
                    
                    this.usageCount--;
                    this.saveUsage();
                    this.updateUsageDisplay();
                } finally {
                    this.isProcessing = false;
                }
            }
            
            async getAIResponse(message) {
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                const lowerMessage = message.toLowerCase();
                
                if (lowerMessage.includes('study') || lowerMessage.includes('homework')) {
                    return "I can help you with your studies. Consider breaking down complex topics into smaller chunks, using active recall techniques like spaced repetition, and teaching the material to someone elseâ€”it's one of the most effective ways to learn.";
                } else if (lowerMessage.includes('group') || lowerMessage.includes('collaborate')) {
                    return "For effective group study, I recommend setting clear goals for each session, assigning roles, using collaborative tools like shared documents, and scheduling regular check-ins. PeerLoom's group features are perfect for this.";
                } else if (lowerMessage.includes('time') || lowerMessage.includes('schedule')) {
                    return "Try the Pomodoro technique: 25 minutes of focused work followed by a 5-minute break. After four cycles, take a longer 15-30 minute break. This helps maintain focus and prevents burnout.";
                } else if (lowerMessage.includes('stress') || lowerMessage.includes('anxious')) {
                    return "Academic stress is common. Remember to practice self-care: take regular breaks, maintain a consistent sleep schedule, exercise, and don't hesitate to reach out to campus mental health resources if needed.";
                } else if (lowerMessage.includes('career') || lowerMessage.includes('future')) {
                    return "Building your professional network now is crucial. Attend campus events, connect with professors, join relevant student organizations, and consider informational interviews with alumni in fields you're interested in.";
                } else {
                    const responses = [
                        "I'm here to help with your academic journey. Could you elaborate on what specific area you'd like assistance with?",
                        "As your study companion, I can help with study techniques, time management, group collaboration strategies, and academic planning. What's on your mind?",
                        "That's an interesting point. From an academic perspective, I'd recommend approaching this systematically: define your goal, break it into actionable steps, and track your progress.",
                        "I understand. Many students face similar challenges. The key is consistent, deliberate practice and leveraging available resources like study groups and academic support services."
                    ];
                    return responses[Math.floor(Math.random() * responses.length)];
                }
            }
            
            addMessage(text, sender) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${sender}`;
                messageDiv.textContent = text;
                
                this.messages.appendChild(messageDiv);
                this.messages.scrollTop = this.messages.scrollHeight;
            }
            
            showTyping() {
                const typingDiv = document.createElement('div');
                typingDiv.className = 'peerpal-typing';
                typingDiv.innerHTML = `
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                `;
                
                this.messages.appendChild(typingDiv);
                this.messages.scrollTop = this.messages.scrollHeight;
                
                return typingDiv;
            }
            
            showPaywall() {
                this.paywall.classList.add('active');
                this.messages.scrollTop = this.messages.scrollHeight;
            }
            
            showPremiumModal() {
                alert('Premium upgrade would be processed here. In production, this would connect to Stripe/Paddle.\n\nAfter payment, you get:\nâ€¢ Unlimited requests for one month\nâ€¢ Access to all AI models (GPT-4, GPT-4-Turbo, etc.)\nâ€¢ Voice features enabled\nâ€¢ Priority processing');
                
                this.usageCount = 0;
                this.saveUsage();
                this.updateUsageDisplay();
                this.paywall.classList.remove('active');
            }
        }

        let peerPal;
        document.addEventListener('DOMContentLoaded', () => {
            peerPal = new PeerPalAI();
        });
       
        document.addEventListener('DOMContentLoaded', async () => {
            requestNotificationPermissions();
            
            const splashContainer = document.getElementById('splashContainer');
            if (splashContainer) {
                splashContainer.style.display = 'none';
            }
           
            const dashboardContent = document.querySelector('.dashboard-content');
            if (dashboardContent) {
                dashboardContent.style.display = 'block';
            }
           
            loadTheme();
           
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                console.log("No active session found");
                return;
            }
           
            console.log("User authenticated");
           
            resetLogoutTimer();
            setupActivityListeners();
            setupColumnScrollPrevention();
          
            sessionUpdateInterval = setInterval(updateSessionIndicator, 1000);
          
            loadSuggestedGroups();
            loadConnections();
            checkFollowStatus();

            updateNotificationBadge();

            const { data: { user } } = await supabase.auth.getUser();
            if (user) {
                setupRealtimeNotifications(user.id);
            }

            loadDefaultVideos();

            initPullToRefresh();

            setupGroupSearch();
        });

        const logoutButtons = ['logout', 'logoutMobile']
            .map(id => document.getElementById(id))
            .filter(Boolean);
        logoutButtons.forEach(btn => {
            btn.addEventListener('click', async (e) => {
                e.preventDefault();
                clearTimeout(logoutTimer);
                clearInterval(sessionUpdateInterval);
                const { error } = await supabase.auth.signOut();
                if (error) {
                    console.error('Logout failed:', error);
                    return;
                }
                window.location.href = 'index.html?message=logout_success';
            });
        });

        const navToggle = document.getElementById('navToggle');
        const navLinksMobile = document.getElementById('navLinksMobile');
        if (navToggle && navLinksMobile) {
            navToggle.addEventListener('click', () => {
                navLinksMobile.classList.toggle('show');
                resetLogoutTimer();
            });
            document.addEventListener('click', (e) => { if (!navToggle.contains(e.target) && !navLinksMobile.contains(e.target)) { navLinksMobile.classList.remove('show'); } });
            navLinksMobile.addEventListener('touchmove', (e) => { e.preventDefault(); }, { passive: false });
        }

        async function loadSuggestedGroups() {
            const suggestedGroupsDiv = document.getElementById('suggestedGroups');
            if (!suggestedGroupsDiv) return;

            let skeletonHTML = '';
            for (let i = 0; i < 3; i++) {
                skeletonHTML += `
                    <div class="skeleton-item">
                        <div class="skeleton-avatar"></div>
                        <div class="skeleton-info">
                            <div class="skeleton-line"></div>
                            <div class="skeleton-line short"></div>
                        </div>
                        <div class="skeleton-button"></div>
                    </div>
                `;
            }
            suggestedGroupsDiv.innerHTML = skeletonHTML;

            const { data: { user } } = await supabase.auth.getUser();
            if (!user) {
                console.error('No user found');
                return;
            }
           
            const { data: userGroups, error: userGroupsError } = await supabase
                .from('group_members')
                .select('group_id')
                .eq('user_id', user.id);
            if (userGroupsError) {
                console.error('Error loading user groups:', userGroupsError);
                return;
            }
           
            const userGroupIds = userGroups.map(g => g.group_id);
           
            let query = supabase
                .from('groups')
                .select('id, name, course_code, description, created_by')
                .neq('created_by', user.id);
            
            if (userGroupIds.length > 0) {
                query = query.not('id', 'in', `(${userGroupIds.join(',')})`);
            }

            const { data, error } = await query.limit(5);
              
            if (error) {
                console.error('Error loading suggested groups:', error);
                return;
            }
          
            suggestedGroupsDiv.innerHTML = '';
          
            if (data && data.length > 0) {
                data.forEach(group => {
                    const div = document.createElement('div');
                    div.className = 'group-item';
                    div.innerHTML = `
                        <div class="avatar">${group.name.charAt(0).toUpperCase()}</div>
                        <div style="flex: 1; min-width: 0;">
                            <p class="font-semibold text-gray-800 truncate">${group.name}</p>
                            <p class="text-gray-600 text-sm truncate">${group.course_code}</p>
                            ${group.description ? `<p class="text-xs text-gray-500 mt-1 truncate">${group.description}</p>` : ''}
                        </div>
                        <a href="#" class="btn join-btn" data-groupid="${group.id}" style="flex-shrink: 0;">Join</a>
                    `;
                    suggestedGroupsDiv.appendChild(div);
                });
               
                document.querySelectorAll('.join-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        e.preventDefault();
                        resetLogoutTimer();
                        const groupId = btn.dataset.groupid;
                        await joinGroup(groupId, btn);
                    });
                });
            } else {
                suggestedGroupsDiv.innerHTML = '<p class="text-center text-gray-500">No suggested groups found.</p>';
            }
        }

        function loadDefaultVideos() {
            const courseList = document.getElementById('courseList');
            if (!courseList) return;
            
            const videos = [
                {
                    title: 'AI 101 - College Writing',
                    videoId: '2ePf9rue1Ao',
                    icon: 'fas fa-book'
                },
                {
                    title: 'MATH 115 - Calculus I',
                    videoId: 'WUvTyaaNkzM',
                    icon: 'fas fa-calculator'
                },
                {
                    title: 'CHEM 101 - Intro to Chemistry',
                    videoId: 'FSyAehMdpyI',
                    icon: 'fas fa-flask'
                },
                {
                    title: 'CS 101 - Intro to Programming',
                    videoId: 'kqtD5dpn9C8',
                    icon: 'fas fa-code'
                },
                {
                    title: 'PHYS 101 - Physics Fundamentals',
                    videoId: 'TTHazQeM8v8',
                    icon: 'fas fa-atom'
                },
                {
                    title: 'BIO 101 - Biology Basics',
                    videoId: 'LeTKHYL6P4s',
                    icon: 'fas fa-dna'
                }
            ];
            
            const videoGrid = document.createElement('div');
            videoGrid.className = 'video-grid';
            
            videos.forEach(video => {
                const div = document.createElement('div');
                div.className = 'card';
                div.innerHTML = `
                    <h4 class="text-lg font-semibold text-purple-600 flex items-center gap-2">
                        <i class="${video.icon}"></i> ${video.title}
                    </h4>
                    <div class="video-container">
                        <iframe src="https://www.youtube.com/embed/${video.videoId}" title="${video.title}" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                    </div>
                `;
                videoGrid.appendChild(div);
            });
            
            courseList.innerHTML = '';
            courseList.appendChild(videoGrid);
        }

        function setupGroupSearch() {
            const searchGroupsBtn = document.getElementById('searchGroupsBtn');
            const groupSearchInput = document.getElementById('groupSearch');
            
            if (searchGroupsBtn && groupSearchInput) {
                searchGroupsBtn.addEventListener('click', searchGroups);
                groupSearchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        searchGroups();
                    }
                });
            }
        }

        async function searchGroups() {
            const searchTerm = document.getElementById('groupSearch').value.trim();
            const searchGroupsBtn = document.getElementById('searchGroupsBtn');
            const groupLoading = document.getElementById('groupLoading');
            
            if (!searchTerm) {
                loadSuggestedGroups();
                return;
            }

            searchGroupsBtn.disabled = true;
            groupLoading.style.display = 'block';

            const { data: { user } } = await supabase.auth.getUser();
            if (!user) {
                searchGroupsBtn.disabled = false;
                groupLoading.style.display = 'none';
                return;
            }

            const { data: userGroups, error: userGroupsError } = await supabase
                .from('group_members')
                .select('group_id')
                .eq('user_id', user.id);
            
            if (userGroupsError) {
                console.error('Error loading user groups:', userGroupsError);
                searchGroupsBtn.disabled = false;
                groupLoading.style.display = 'none';
                return;
            }
           
            const userGroupIds = userGroups.map(g => g.group_id);

            const { data, error } = await supabase
                .from('groups')
                .select('id, name, course_code, description, created_by')
                .neq('created_by', user.id)
                .not('id', 'in', `(${userGroupIds.join(',')})`)
                .or(`name.ilike.%${searchTerm}%,course_code.ilike.%${searchTerm}%`)
                .limit(5);

            const suggestedGroupsDiv = document.getElementById('suggestedGroups');
            if (!suggestedGroupsDiv) {
                searchGroupsBtn.disabled = false;
                groupLoading.style.display = 'none';
                return;
            }

            if (error) {
                console.error('Error searching groups:', error);
                suggestedGroupsDiv.innerHTML = '<p class="text-center text-red-500">Error searching groups.</p>';
                searchGroupsBtn.disabled = false;
                groupLoading.style.display = 'none';
                return;
            }

            suggestedGroupsDiv.innerHTML = '';

            if (data && data.length > 0) {
                data.forEach(group => {
                    const div = document.createElement('div');
                    div.className = 'group-item';
                    div.innerHTML = `
                        <div class="avatar">${group.name.charAt(0).toUpperCase()}</div>
                        <div style="flex: 1; min-width: 0;">
                            <p class="font-semibold text-gray-800 truncate">${group.name}</p>
                            <p class="text-gray-600 text-sm truncate">${group.course_code}</p>
                            ${group.description ? `<p class="text-xs text-gray-500 mt-1 truncate">${group.description}</p>` : ''}
                        </div>
                        <a href="#" class="btn join-btn" data-groupid="${group.id}" style="flex-shrink: 0;">Join</a>
                    `;
                    suggestedGroupsDiv.appendChild(div);
                });

                document.querySelectorAll('.join-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        e.preventDefault();
                        resetLogoutTimer();
                        const groupId = btn.dataset.groupid;
                        await joinGroup(groupId, btn);
                    });
                });
            } else {
                suggestedGroupsDiv.innerHTML = '<p class="text-center text-gray-500">No groups found matching your search.</p>';
            }
            
            searchGroupsBtn.disabled = false;
            groupLoading.style.display = 'none';
        }
       
        async function joinGroup(groupId, button) {
            const { data: { user } } = await supabase.auth.getUser();
          
            if (!user) {
                showNotification('Please log in to join groups.');
                return;
            }
           
            try {
                const { data: existingMember, error: checkError } = await supabase
                    .from('group_members')
                    .select('*')
                    .eq('group_id', groupId)
                    .eq('user_id', user.id)
                    .single();
                   
                if (existingMember) {
                    showNotification('You are already a member of this group.');
                    return;
                }
               
                const { error } = await supabase
                    .from('group_members')
                    .insert({
                        group_id: groupId,
                        user_id: user.id,
                        joined_at: new Date().toISOString(),
                        role: 'member'
                    });
                  
                if (error) {
                    console.error('Error joining group:', error);
                  
                    if (error.code === '23505') {
                        showNotification('You are already a member of this group.');
                    } else {
                        showNotification('Failed to join group. Please try again.');
                    }
                } else {
                    showNotification('Successfully joined group!');
                  
                    loadSuggestedGroups();
                  
                    if (button) {
                        button.textContent = 'Joined';
                        button.disabled = true;
                        button.style.background = '#d1d5db';
                    }
                    
                    triggerPushNotification('Group Joined', 'You have successfully joined a new study group!');
                }
            } catch (error) {
                console.error('Unexpected error joining group:', error);
                showNotification('An unexpected error occurred while joining the group.');
            }
        }
       
        async function loadConnections() {
            const { data: { user } } = await supabase.auth.getUser();
            if (!user) {
                console.error('No user found');
                return;
            }
           
            try {
                const { data: profiles, error } = await supabase
                    .from('profiles')
                    .select('id, full_name, status, profile_photo, username, department')
                    .neq('id', user.id)
                    .limit(8);
                  
                if (error) {
                    console.error('Supabase error loading connections:', error);
                    throw error;
                }
               
                const connectionList = document.getElementById('connectionList');
                if (!connectionList) return;
              
                let skeletonHTML = '';
                for (let i = 0; i < 4; i++) {
                    skeletonHTML += `
                        <div class="skeleton-item">
                            <div class="skeleton-avatar"></div>
                            <div class="skeleton-info">
                                <div class="skeleton-line"></div>
                                <div class="skeleton-line short"></div>
                            </div>
                            <div class="skeleton-button"></div>
                        </div>
                    `;
                }
                connectionList.innerHTML = skeletonHTML;

                connectionList.innerHTML = '';
               
                if (profiles && profiles.length > 0) {
                    const sampleDepartments = [
                        'Computer Science',
                        'Engineering',
                        'Business Administration',
                        'Psychology',
                        'Biology',
                        'Mathematics',
                        'Political Science',
                        'English Literature'
                    ];
                    
                    const sampleStatuses = ['Online', 'Active 2h ago', 'Active 1d ago', 'Active now'];
                    
                    profiles.forEach((profile, index) => {
                        const fullName = profile.full_name || `Student ${index + 1}`;
                        const status = sampleStatuses[index % sampleStatuses.length];
                        const profilePhoto = profile.profile_photo;
                        const initials = fullName.split(' ').map(n => n[0]).join('').toUpperCase();
                        const department = sampleDepartments[index % sampleDepartments.length];
                      
                        const div = document.createElement('div');
                        div.className = 'connection-item';
                        div.innerHTML = `
                            <div class="connection-avatar">
                                <div class="avatar" onclick="navigateToUserProfile('${profile.id}')">
                                    ${profilePhoto ?
                                        `<img src="${profilePhoto}" alt="${fullName}" />` :
                                        initials
                                    }
                                </div>
                            </div>
                            <div class="connection-info" style="min-width: 0;">
                                <p class="font-semibold text-gray-800 truncate">${fullName}</p>
                                <p class="text-gray-600 text-sm truncate">${department}</p>
                                <p class="text-xs text-gray-500 mt-1 truncate">${status}</p>
                            </div>
                            <div class="connection-actions">
                                <button class="btn follow-btn" data-userid="${profile.id}" style="flex-shrink: 0; padding: 0.4rem 0.8rem; font-size: 0.9rem;">Follow</button>
                            </div>
                        `;
                        connectionList.appendChild(div);
                    });
                   
                    document.querySelectorAll('.follow-btn').forEach(btn => {
                        btn.addEventListener('click', async (e) => {
                            e.preventDefault();
                            resetLogoutTimer();
                            const userId = btn.dataset.userid;
                            await toggleFollowUser(btn, userId);
                        });
                    });
                   
                    checkFollowStatus();
                } else {
                    createSampleConnections();
                }
            } catch (error) {
                console.error('Error loading connections:', error);
                createSampleConnections();
            }
        }

        function createSampleConnections() {
            const connectionList = document.getElementById('connectionList');
            if (!connectionList) return;
            
            const sampleConnections = [
                {
                    id: 'sample1',
                    name: 'Alex Johnson',
                    department: 'Computer Science',
                    status: 'Online',
                    initials: 'AJ'
                },
                {
                    id: 'sample2',
                    name: 'Maria Rodriguez',
                    department: 'Engineering',
                    status: 'Active 2h ago',
                    initials: 'MR'
                },
                {
                    id: 'sample3',
                    name: 'James Wilson',
                    department: 'Business Administration',
                    status: 'Active 1d ago',
                    initials: 'JW'
                },
                {
                    id: 'sample4',
                    name: 'Sarah Chen',
                    department: 'Psychology',
                    status: 'Online',
                    initials: 'SC'
                },
                {
                    id: 'sample5',
                    name: 'David Kim',
                    department: 'Biology',
                    status: 'Active now',
                    initials: 'DK'
                },
                {
                    id: 'sample6',
                    name: 'Emily Parker',
                    department: 'Mathematics',
                    status: 'Online',
                    initials: 'EP'
                },
                {
                    id: 'sample7',
                    name: 'Michael Brown',
                    department: 'Political Science',
                    status: 'Active 3h ago',
                    initials: 'MB'
                },
                {
                    id: 'sample8',
                    name: 'Olivia Taylor',
                    department: 'English Literature',
                    status: 'Active now',
                    initials: 'OT'
                }
            ];
            
            connectionList.innerHTML = '';
            
            sampleConnections.forEach(connection => {
                const div = document.createElement('div');
                div.className = 'connection-item';
                div.innerHTML = `
                    <div class="connection-avatar">
                        <div class="avatar" onclick="navigateToUserProfile('${connection.id}')">
                            ${connection.initials}
                        </div>
                    </div>
                    <div class="connection-info" style="min-width: 0;">
                        <p class="font-semibold text-gray-800 truncate">${connection.name}</p>
                        <p class="text-gray-600 text-sm truncate">${connection.department}</p>
                        <p class="text-xs text-gray-500 mt-1 truncate">${connection.status}</p>
                    </div>
                    <div class="connection-actions">
                        <button class="btn follow-btn" data-userid="${connection.id}" style="flex-shrink: 0; padding: 0.4rem 0.8rem; font-size: 0.9rem;">Follow</button>
                    </div>
                `;
                connectionList.appendChild(div);
            });
            
            document.querySelectorAll('.follow-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    resetLogoutTimer();
                    const userId = btn.dataset.userid;
                    await toggleFollowUser(btn, userId);
                });
            });
            
            checkFollowStatus();
        }
       
        async function checkFollowStatus() {
            const { data: { user } } = await supabase.auth.getUser();
            if (!user) return;
           
            try {
                const { data: following, error } = await supabase
                    .from('followers')
                    .select('following_id')
                    .eq('follower_id', user.id);
                   
                if (error) {
                    console.error('Error checking follow status:', error);
                    return;
                }
               
                const followingIds = following ? following.map(f => f.following_id) : [];
               
                document.querySelectorAll('.follow-btn').forEach(btn => {
                    const userId = btn.dataset.userid;
                    if (followingIds.includes(userId)) {
                        btn.textContent = 'Unfollow';
                        btn.style.background = 'rgba(239, 68, 68, 0.2)';
                        btn.style.color = '#ef4444';
                    } else {
                        btn.textContent = 'Follow';
                        btn.style.background = '';
                        btn.style.color = '';
                    }
                });
            } catch (error) {
                console.error('Error in checkFollowStatus:', error);
            }
        }
       
        async function searchConnections() {
            resetLogoutTimer();
          
            const connectionSearch = document.getElementById('connectionSearch').value.trim();
            const connectionLoading = document.getElementById('connectionLoading');
            const connectionList = document.getElementById('connectionList');
            const searchConnectionsBtn = document.getElementById('searchConnectionsBtn');
          
            if (!connectionList) return;
          
            if (!connectionSearch) {
                loadConnections();
                return;
            }
           
            searchConnectionsBtn.disabled = true;
            connectionLoading.style.display = 'block';
           
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    searchConnectionsBtn.disabled = false;
                    connectionLoading.style.display = 'none';
                    return;
                }
               
                const { data, error } = await supabase
                    .from('profiles')
                    .select('id, full_name, status, profile_photo, username, department')
                    .neq('id', user.id)
                    .or(`full_name.ilike.%${connectionSearch}%,username.ilike.%${connectionSearch}%,department.ilike.%${connectionSearch}%`)
                    .limit(8);
                  
                connectionList.innerHTML = '';
               
                if (error) {
                    console.error('Supabase search error:', error);
                    throw error;
                }
               
                if (data && data.length > 0) {
                    data.forEach(profile => {
                        const fullName = profile.full_name || 'Unknown User';
                        const status = profile.status || 'Offline';
                        const profilePhoto = profile.profile_photo;
                        const initials = fullName.split(' ').map(n => n[0]).join('').toUpperCase();
                        const department = profile.department || 'No department';
                      
                        const div = document.createElement('div');
                        div.className = 'connection-item';
                        div.innerHTML = `
                            <div class="connection-avatar">
                                <div class="avatar" onclick="navigateToUserProfile('${profile.id}')">
                                    ${profilePhoto ?
                                        `<img src="${profilePhoto}" alt="${fullName}" />` :
                                        initials
                                    }
                                </div>
                            </div>
                            <div class="connection-info" style="min-width: 0;">
                                <p class="font-semibold text-gray-800 truncate">${fullName}</p>
                                <p class="text-gray-600 text-sm truncate">${department}</p>
                                <p class="text-xs text-gray-500 mt-1 truncate">${status}</p>
                            </div>
                            <div class="connection-actions">
                                <button class="btn follow-btn" data-userid="${profile.id}" style="flex-shrink: 0; padding: 0.4rem 0.8rem; font-size: 0.9rem;">Follow</button>
                            </div>
                        `;
                        connectionList.appendChild(div);
                    });
                   
                    document.querySelectorAll('.follow-btn').forEach(btn => {
                        btn.addEventListener('click', async (e) => {
                            e.preventDefault();
                            resetLogoutTimer();
                            const userId = btn.dataset.userid;
                            await toggleFollowUser(btn, userId);
                        });
                    });
                   
                    checkFollowStatus();
                } else {
                    connectionList.innerHTML = '<p class="text-center text-gray-500">No users found.</p>';
                }
            } catch (error) {
                console.error('Connection search error:', error);
                connectionList.innerHTML = `<p class="text-center text-red-500">Error searching users: ${error.message}</p>`;
            } finally {
                searchConnectionsBtn.disabled = false;
                connectionLoading.style.display = 'none';
            }
        }

        const YOUTUBE_API_KEY = 'AIzaSyAz4f77FM8h7nyU55ns3Ll3SEdXiSY38AU';
        let lastSearchQuery = '';

        async function searchCourses(refresh = false) {
            resetLogoutTimer();
          
            let courseSearch = document.getElementById('courseSearch').value.trim();
            const courseLoading = document.getElementById('courseLoading');
            const courseList = document.getElementById('courseList');
            const searchCoursesBtn = document.getElementById('searchCoursesBtn');
           
            if (!courseSearch && !refresh) {
                loadDefaultVideos();
                return;
            }
           
            searchCoursesBtn.disabled = true;
            courseLoading.style.display = 'block';
           
            if (refresh && lastSearchQuery) {
                courseSearch = lastSearchQuery;
                const randomTerms = ['tutorial', 'lecture', 'explained', 'basics', 'guide'];
                courseSearch += ' ' + randomTerms[Math.floor(Math.random() * randomTerms.length)];
            }
           
            lastSearchQuery = courseSearch;
           
            try {
                const educationalKeywords = 'educational tutorial lecture course university college learning';
                const query = `${courseSearch} ${educationalKeywords}`;
                const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(query)}&type=video&maxResults=8&key=${YOUTUBE_API_KEY}`;
                const response = await fetch(url);
               
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
               
                const data = await response.json();
                if (data.error) throw new Error(data.error.message || 'YouTube API error');
              
                courseList.innerHTML = '';
               
                if (data.items && data.items.length > 0) {
                    const videoGrid = document.createElement('div');
                    videoGrid.className = 'video-grid';
                   
                    data.items.slice(0, 6).forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'card';
                        div.innerHTML = `
                            <h4 class="text-lg font-semibold text-purple-600 flex items-center gap-2">
                                <i class="fas fa-book"></i> ${item.snippet.title}
                            </h4>
                            <div class="video-container">
                                <iframe src="https://www.youtube.com/embed/${item.id.videoId}" title="${item.snippet.title}" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                            </div>
                        `;
                        videoGrid.appendChild(div);
                    });
                   
                    courseList.appendChild(videoGrid);
                } else {
                    courseList.innerHTML = '<p class="text-center text-gray-500">No educational videos found.</p>';
                }
            } catch (error) {
                console.error('YouTube API error:', error.message);
                loadDefaultVideos();
                showNotification('Error loading videos. Showing default content.');
            } finally {
                searchCoursesBtn.disabled = false;
                courseLoading.style.display = 'none';
            }
        }
       
        let ptrStartY = 0;
        let ptrCurrentY = 0;
        let ptrThreshold = 100;
        let isRefreshing = false;
        
        function initPullToRefresh() {
            const mainContent = document.querySelector('.main-content');
            const ptrIndicator = document.getElementById('ptrIndicator');
           
            if (!mainContent) return;
           
            let isPulling = false;
           
            mainContent.addEventListener('touchstart', (e) => {
                if (mainContent.scrollTop === 0 && !isRefreshing) {
                    ptrStartY = e.touches[0].clientY;
                    isPulling = true;
                }
            }, { passive: true });
           
            mainContent.addEventListener('touchmove', (e) => {
                if (!isPulling || mainContent.scrollTop > 0 || isRefreshing) return;
               
                ptrCurrentY = e.touches[0].clientY;
                const diff = ptrCurrentY - ptrStartY;
               
                if (diff > 0 && diff < ptrThreshold) {
                    if (diff > 50) {
                        ptrIndicator.style.top = `${Math.max(-50 + diff / 2, -50)}px`;
                        ptrIndicator.classList.add('show');
                    }
                }
            }, { passive: true });
           
            mainContent.addEventListener('touchend', async (e) => {
                if (!isPulling || isRefreshing) return;
               
                isPulling = false;
               
                if (ptrCurrentY - ptrStartY >= ptrThreshold) {
                    isRefreshing = true;
                    ptrIndicator.classList.add('show');
                    
                    await searchCourses(true);
                    
                    setTimeout(() => {
                        ptrIndicator.classList.remove('show');
                        isRefreshing = false;
                    }, 500);
                } else {
                    ptrIndicator.classList.remove('show');
                }
            }, { passive: true });
        }
       
        async function toggleFollowUser(button, userId) {
            resetLogoutTimer();
          
            const { data: { user } } = await supabase.auth.getUser();
            if (!user) {
                showNotification('Please log in to follow users.');
                return;
            }
           
            try {
                const { data: existingFollow, error: checkError } = await supabase
                    .from('followers')
                    .select('*')
                    .eq('follower_id', user.id)
                    .eq('following_id', userId)
                    .single();
                   
                if (existingFollow) {
                    const { error } = await supabase
                        .from('followers')
                        .delete()
                        .eq('follower_id', user.id)
                        .eq('following_id', userId);
                      
                    if (error) {
                        console.error('Error unfollowing user:', error);
                        showNotification('Failed to unfollow user. Please try again.');
                    } else {
                        button.textContent = 'Follow';
                        button.style.background = '';
                        button.style.color = '';
                        showNotification('You have unfollowed this user');
                    }
                } else {
                    const { error } = await supabase
                        .from('followers')
                        .insert({
                            follower_id: user.id,
                            following_id: userId
                        });
                      
                    if (error) {
                        console.error('Error following user:', error);
                        showNotification('Failed to follow user. Please try again.');
                    } else {
                        button.textContent = 'Unfollow';
                        button.style.background = 'rgba(239, 68, 68, 0.2)';
                        button.style.color = '#ef4444';
                        showNotification('You are now following this user');
                        
                        triggerPushNotification('New Follower', 'You have a new follower on PeerLoom!');
                    }
                }
            } catch (error) {
                console.error('Unexpected error toggling follow user:', error);
                showNotification('An unexpected error occurred while following the user.');
            }
        }
       
        function navigateToUserProfile(userId) {
            resetLogoutTimer();
            window.location.href = `profile.html?userId=${userId}`;
        }
       
        function showNotification(message, callback) {
            const modal = document.getElementById('notificationModal');
            const body = document.querySelector('.dashboard');
            const modalMessage = document.getElementById('modalMessage');
          
            if (!modal || !body || !modalMessage) return;
          
            modalMessage.textContent = message;
            modal.classList.add('show');
            body.classList.add('blur-background');
           
            setTimeout(() => {
                modal.classList.remove('show');
                body.classList.remove('blur-background');
                if (callback) callback();
            }, 3000);
        }
       
        document.addEventListener('DOMContentLoaded', () => {
            const searchConnectionsBtn = document.getElementById('searchConnectionsBtn');
            if (searchConnectionsBtn) {
                searchConnectionsBtn.addEventListener('click', searchConnections);
            }
           
            const searchCoursesBtn = document.getElementById('searchCoursesBtn');
            if (searchCoursesBtn) {
                searchCoursesBtn.addEventListener('click', () => searchCourses());
            }
           
            const courseSearchInput = document.getElementById('courseSearch');
            if (courseSearchInput) {
                courseSearchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        searchCourses();
                    }
                });
            }
            
            const connectionSearchInput = document.getElementById('connectionSearch');
            if (connectionSearchInput) {
                connectionSearchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        searchConnections();
                    }
                });
            }
        });
       
        window.joinGroup = joinGroup;
        window.toggleFollowUser = toggleFollowUser;
        window.navigateToUserProfile = navigateToUserProfile;
        window.enterSite = enterSite;
        window.toggleTheme = toggleTheme;
        window.triggerPushNotification = triggerPushNotification;

        if (typeof window.openUploadModal === 'undefined') {
            window.openUploadModal = function() { alert('Create post functionality is not available on this page.'); }
        }
document.addEventListener('DOMContentLoaded', async function() {
    const elements = document.querySelectorAll('[data-user-id]');
    
    for (const element of elements) {
        const userId = element.getAttribute('data-user-id');
        if (userId) {
            const { data: profile, error } = await supabase
                .from('profiles')
                .select('*')
                .eq('id', userId)
                .single();
            
            if (profile && !error) {
                const isLecturer = profile.level === 'lecturer' || 
                                   profile.custom_level === 'lecturer' || 
                                   profile.role === 'lecturer';
                const isEmailVerified = profile.verified === true;
                
                if (isLecturer && isEmailVerified) {
                    element.innerHTML += `
                        <span class="lecturer-badge" title="Verified Lecturer">
                            <i class="fas fa-check"></i>
                            Verified Lecturer
                        </span>
                    `;
                }
            }
        }
    }
});
    </script>
</body>
</html>
