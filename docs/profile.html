<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - Peerloom</title>
    <link rel="icon" href="/android-chrome-192x192.png" sizes="192x192" type="image/png">
    <link rel="icon" href="/android-chrome-512x512.png" sizes="512x512" type="image/png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="manifest" href="/site.webmanifest">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script type="module" src="js/supabaseClient.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Great+Vibes&display=swap');
        :root {
            --primary: #7c3aed;
            --secondary: #4f46e5;
            --accent: #a78bfa;
            --text-dark: #1f2937;
            --text-light: #64748b;
            --hover-bg: #f3f4f6;
            --transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            --bg: linear-gradient(135deg, #f3e8ff 0%, #e0e7ff 100%);
            --tooltip-glow: rgba(124, 58, 237, 0.6);
        }
        [data-theme="dark"] {
            --bg-primary: #1f2937;
            --bg-secondary: #374151;
            --text-dark: #f9fafb;
            --text-light: #9ca3af;
            --hover-bg: #4b5563;
            --primary: #7c3aed;
            --secondary: #4f46e5;
            --accent: #a78bfa;
            --bg: linear-gradient(135deg, #1f2937 0%, #111827 100%);
            --tooltip-glow: rgba(167, 139, 250, 0.8);
        }
        body {
            background: var(--bg);
            font-family: 'Segoe UI', 'Inter', Arial, sans-serif;
            min-height: 100vh;
            color: var(--text-dark);
            overflow-x: hidden;
            transition: background 0.5s ease, color 0.5s ease;
        }
        .splash-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: radial-gradient(circle at top, #0a0a0a 0%, #000 100%);
            color: #fff;
            font-family: 'Great Vibes', cursive;
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }
        .snowflake {
            position: fixed;
            top: -10px;
            color: white;
            font-size: 1em;
            opacity: 0.8;
            pointer-events: none;
            animation: fall linear infinite;
            text-shadow: 0 0 8px rgba(255, 255, 255, 0.8);
            z-index: 1;
        }
        @keyframes fall {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(360deg); opacity: 0.7; }
        }
        .splash-screen {
            position: relative;
            width: 90%;
            max-width: 900px;
            background: linear-gradient(145deg, #000, #111);
            border-radius: 20px;
            box-shadow: 0 0 40px rgba(255, 215, 0, 0.15);
            padding: 50px 30px 70px;
            text-align: center;
            z-index: 10;
            overflow: hidden;
            animation: fadeIn 2s ease forwards;
        }
        .splash-title {
            font-size: 3rem;
            background: linear-gradient(90deg, #d4af37, #f9f295, #d4af37);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 25px rgba(255, 215, 0, 0.4);
            margin-bottom: 20px;
        }
        .splash-text {
            font-size: 1.1rem;
            color: #e0e0e0;
            line-height: 1.7;
            max-width: 700px;
            margin: 0 auto 30px;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
        }
        .highlight {
            color: gold;
            font-weight: bold;
        }
        .enter-btn {
            padding: 14px 36px;
            font-size: 1.1rem;
            border: 2px solid gold;
            border-radius: 40px;
            background: transparent;
            color: gold;
            cursor: pointer;
            transition: all 0.4s ease;
        }
        .enter-btn:hover {
            background: gold;
            color: #000;
            box-shadow: 0 0 25px gold;
        }
        .terms {
            margin-top: 40px;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
            max-width: 650px;
            margin-left: auto;
            margin-right: auto;
            line-height: 1.5;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; visibility: hidden; }
        }
        @media (max-width: 768px) {
            .splash-title {
                font-size: 2.2rem;
            }
            .splash-text {
                font-size: 1rem;
                padding: 0 10px;
            }
            .enter-btn {
                font-size: 1rem;
                padding: 12px 28px;
            }
            .terms {
                font-size: 0.75rem;
                padding: 0 15px;
            }
        }
        .navbar {
            position: fixed;
            width: 100%;
            top: 0;
            left: 0;
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.9), rgba(79, 70, 229, 0.9));
            backdrop-filter: blur(5px);
            padding: 0.5rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
            transition: var(--transition);
            color: white;
            box-shadow: 0 1px 5px rgba(0, 0, 0, 0.05);
            touch-action: pan-y;
        }
        .navbar::before {
            content: '';
            position: absolute;
            top: -20%;
            left: -20%;
            width: 140%;
            height: 140%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            z-index: -1;
            opacity: 0.3;
        }
        .logo img {
            height: 28px;
            transition: transform var(--transition);
        }
        .logo img:hover {
            transform: scale(1.1);
        }
        .nav-links {
            display: flex;
            gap: 1.5rem;
        }
        .nav-link {
            color: white;
            font-weight: 500;
            text-decoration: none;
            padding: 0.5rem 0.8rem;
            border-radius: 0.4rem;
            transition: background 0.2s, color 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1rem;
        }
        .nav-link:hover {
            background: rgba(255, 255, 255, 0.15);
            color: white;
        }
        .nav-toggle {
            display: none;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: white;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 0.3rem;
            transition: background var(--transition);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .nav-toggle:hover {
            background: rgba(255, 255, 255, 0.25);
        }
        .nav-links.mobile {
            display: none;
            flex-direction: column;
            gap: 0.5rem;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            position: fixed;
            top: 60px;
            left: 0;
            right: 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border-radius: 0 0 0.7rem 0.7rem;
            padding: 1rem 0.5rem;
            z-index: 1001;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .nav-links.mobile.show {
            display: flex;
        }
        .nav-links.mobile a {
            color: var(--text-dark);
            padding: 0.8rem 1rem;
            border-radius: 0.4rem;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 0.7rem;
            min-width: 0;
            background: rgba(124, 58, 237, 0.05);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(124, 58, 237, 0.1);
            transition: all 0.3s ease;
            font-weight: 500;
        }
        .nav-links.mobile a:hover {
            background: rgba(124, 58, 237, 0.1);
            color: var(--primary);
            transform: translateX(5px);
            border-color: rgba(124, 58, 237, 0.3);
        }
        .nav-links.mobile a i {
            color: var(--primary);
            width: 20px;
            text-align: center;
        }
        .profile-container {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            padding: 4rem 1rem 1.5rem;
            margin-top: 0;
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
            min-width: 0;
            transition: filter 0.3s ease;
        }
        .profile-card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 1rem;
            padding: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: var(--transition);
        }
        .avatar-large {
            width: 120px;
            height: 120px;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-weight: bold;
            font-size: 3rem;
            margin: 0 auto 1rem;
            border: 4px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.2s;
        }
        .avatar-large:hover {
            transform: scale(1.05);
        }
        .auth-title {
            font-style: italic;
            font-weight: 600;
            color: var(--text-dark);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 1rem 1.5rem;
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            border-radius: 1rem;
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
            border-left: 4px solid var(--primary);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1), 0 0 20px rgba(124, 58, 237, 0.3);
            text-shadow: 0 0 10px rgba(124, 58, 237, 0.5);
            transition: var(--transition);
        }
        .auth-title:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15), 0 0 30px rgba(124, 58, 237, 0.5);
            text-shadow: 0 0 15px rgba(124, 58, 237, 0.7);
        }
        .input-field, .textarea-field {
            width: 100%;
            padding: 0.75rem;
            margin-bottom: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 0.6rem;
            background: rgba(255, 255, 255, 0.2);
            font-size: 1rem;
            color: var(--text-dark);
            transition: border 0.2s, box-shadow 0.2s;
            font-family: inherit;
        }
        .input-field:focus, .textarea-field:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 2px rgba(167, 139, 250, 0.3), 0 0 15px rgba(124, 58, 237, 0.4);
        }
        .input-field::placeholder, .textarea-field::placeholder {
            color: var(--text-light);
            text-shadow: 0 0 5px rgba(124, 58, 237, 0.3);
            transition: text-shadow 0.3s ease;
        }
        .input-field:focus::placeholder, .textarea-field:focus::placeholder {
            text-shadow: 0 0 10px rgba(124, 58, 237, 0.6);
        }
        .btn {
            font-style: italic;
            font-weight: 400;
            color: var(--text-dark);
            padding: 0.6rem 1.2rem;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 0.5rem;
            cursor: pointer;
            transition: transform 0.2s, background 0.2s, color 0.2s, box-shadow 0.3s;
            position: relative;
        }
        .btn:hover {
            transform: translateY(-2px);
            background: rgba(255, 255, 255, 0.3);
            color: var(--primary);
            box-shadow: 0 0 15px rgba(124, 58, 237, 0.4);
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        .stat-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 1rem;
            border-radius: 0.8rem;
            text-align: center;
            transition: background 0.2s;
            position: relative;
        }
        .stat-item:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        .loading {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #a78bfa;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
            display: none;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 1rem;
            padding: 1.5rem 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 2000;
            color: var(--text-dark);
            text-align: center;
            font-style: italic;
            font-size: 1.2rem;
            animation: fadeIn 0.3s ease;
        }
        .modal.show {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .blur-background {
            filter: blur(5px);
            pointer-events: none;
        }
        .session-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 0.8rem;
            padding: 0.5rem 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            color: var(--text-dark);
            z-index: 999;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: var(--transition);
        }
        .session-indicator.active {
            color: #10b981;
        }
        .session-indicator.warning {
            color: #f59e0b;
        }
        .session-indicator.expiring {
            color: #ef4444;
            animation: pulse 1s infinite;
        }
        .session-indicator .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        /* Glowing Tooltips */
        [data-tooltip] {
            position: relative;
        }
        [data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.85rem;
            white-space: nowrap;
            z-index: 1001;
            box-shadow: 0 0 20px var(--tooltip-glow);
            animation: glow 0.3s ease-in-out;
            border: 1px solid var(--primary);
        }
        [data-tooltip]:hover::before {
            content: '';
            position: absolute;
            bottom: 115%;
            left: 50%;
            transform: translateX(-50%);
            border: 0.5rem solid transparent;
            border-top-color: rgba(0, 0, 0, 0.8);
            z-index: 1001;
        }
        @keyframes glow {
            0% { box-shadow: 0 0 5px var(--tooltip-glow); }
            50% { box-shadow: 0 0 25px var(--tooltip-glow); }
            100% { box-shadow: 0 0 20px var(--tooltip-glow); }
        }
        @media (max-width: 768px) {
            [data-tooltip]:hover::after {
                bottom: 100%;
                transform: translateX(-50%) translateY(10px);
                white-space: normal;
                max-width: 200px;
                text-align: center;
            }
            [data-tooltip]:hover::before {
                bottom: 90%;
                border-top-color: transparent;
                border-bottom-color: rgba(0, 0, 0, 0.8);
            }
        }
        @media (max-width: 768px) {
            .auth-title {
                font-size: 1.25rem;
                padding: 0.8rem 1.2rem;
                margin-bottom: 1rem;
            }
            .profile-card {
                padding: 1rem;
            }
            .avatar-large {
                width: 80px;
                height: 80px;
                font-size: 2rem;
            }
        }
        @media (min-width: 1024px) {
            .nav-links {
                display: flex;
            }
            .nav-toggle {
                display: none;
            }
        }
        @media (max-width: 1023px) {
            .navbar {
                padding: 0.5rem 0.8rem;
            }
            .nav-links {
                display: none;
            }
            .nav-toggle {
                display: block;
            }
            .nav-links.mobile {
                top: 50px;
                padding: 1rem;
                background: rgba(255, 255, 255, 0.98);
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
            }
            .nav-links.mobile a {
                font-size: 1rem;
                padding: 0.9rem 1rem;
                margin-bottom: 0.3rem;
                background: rgba(255, 255, 255, 0.7);
                border: 1px solid rgba(124, 58, 237, 0.15);
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            }
            .nav-links.mobile a:last-child {
                margin-bottom: 0;
            }
            .profile-container {
                padding: 0.5rem;
            }
            .profile-card {
                padding: 0.7rem;
            }
            .session-indicator {
                bottom: 15px;
                right: 15px;
                font-size: 0.8rem;
                padding: 0.4rem 0.8rem;
            }
        }
        @media (max-width: 480px) {
            .navbar {
                padding: 0.3rem 0.5rem;
            }
            .logo img {
                height: 24px;
            }
            .nav-toggle {
                font-size: 1.3rem;
                padding: 0.4rem;
            }
            .nav-links.mobile {
                top: 40px;
                padding: 0.8rem;
                background: rgba(255, 255, 255, 0.98);
            }
            .nav-links.mobile a {
                font-size: 0.95rem;
                padding: 0.8rem;
            }
            .profile-container {
                padding: 0.2rem;
            }
            .profile-card {
                padding: 0.5rem;
            }
            .input-field, .textarea-field {
                padding: 0.6rem;
            }
            .btn {
                padding: 0.4rem 0.8rem;
            }
            .session-indicator {
                bottom: 10px;
                right: 10px;
                font-size: 0.75rem;
                padding: 0.3rem 0.6rem;
            }
        }
    </style>
</head>
<body data-theme="light">
    <div id="splashContainer" class="splash-container">
        <div class="splash-screen" id="splash">
            <div class="splash-title">Welcome to PeerLoom ‚ú®</div>
            <div class="splash-text">
                Step into the <span class="highlight">world‚Äôs most vibrant student space</span> ‚Äî where study groups, ideas, and creativity unite.<br><br>
                Create your group, invite friends, and chat instantly with <span class="highlight">PeerPal AI</span> ‚Äî your smart study companion.<br>
                Watch and post creative student content on <span class="highlight">Skrolz</span>, and grow your network while learning together.<br><br>
                üéÅ The <span class="highlight">most active group</span> with over 50 members wins <span class="highlight">exclusive PeerLoom rewards</span> every month!<br>
                Share your group link ‚Äî grow your community, boost your rank, and claim the spotlight.
            </div>
            <button class="enter-btn" onclick="enterSite()">Enter PeerLoom</button>
            <div class="terms">
                *Rewards apply to verified groups only. Members must remain active throughout the month. Engagement is based on messages, posts, and Skrolz activity. PeerLoom reserves the right to verify or disqualify inactive or spam groups.
            </div>
        </div>
    </div>
    <nav class="navbar" id="navbar">
        <a href="index.html" class="logo">
            <img src="../logo.png" alt="Peerloom" onerror="console.warn('Logo not found')">
        </a>
        <button class="nav-toggle" id="navToggle" aria-label="Open navigation">
            <i class="fas fa-bars"></i>
        </button>
        <div class="nav-links" id="navLinks">
            <a href="about.html" class="nav-link" data-tooltip="Learn more about PeerLoom"><i class="fas fa-info-circle"></i> About</a>
            <a href="dashboard.html" class="nav-link" data-tooltip="Access your study groups and courses"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
            <a href="feed.html" class="nav-link" data-tooltip="Browse creative student content"><i class="fas fa-scroll"></i> Skrolz</a>
            <a href="logout.html" class="nav-link" id="logout" data-tooltip="Sign out of your account"><i class="fas fa-sign-out-alt"></i> Logout</a>
        </div>
        <div class="nav-links mobile" id="navLinksMobile">
            <a href="about.html" class="nav-link" data-tooltip="Learn more about PeerLoom"><i class="fas fa-info-circle"></i> About</a>
            <a href="dashboard.html" class="nav-link" data-tooltip="Access your study groups and courses"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
            <a href="feed.html" class="nav-link" data-tooltip="Browse creative student content"><i class="fas fa-scroll"></i> Skrolz</a>
            <a href="logout.html" class="nav-link" id="logoutMobile" data-tooltip="Sign out of your account"><i class="fas fa-sign-out-alt"></i> Logout</a>
        </div>
    </nav>
    <div class="profile-container">
        <div class="profile-card">
            <h2 class="auth-title" data-tooltip="View and edit your personal profile information"><i class="fas fa-user"></i> Your Profile</h2>
            <div id="profileAvatar" class="avatar-large" data-tooltip="Click to view full profile image"></div>
            <div id="profileInfo">
                <h3 id="fullName" class="text-2xl font-bold text-center mb-2">Loading...</h3>
                <p id="username" class="text-center text-gray-600 mb-4">@loading</p>
                <p id="department" class="text-center text-gray-500 mb-4">Loading department...</p>
                <p id="status" class="text-center text-gray-500 mb-4">Loading status...</p>
                <div class="stats-grid">
                    <div class="stat-item" data-tooltip="Number of study groups you are a member of">
                        <div class="text-2xl font-bold" id="groupsCount">0</div>
                        <div>Groups</div>
                    </div>
                    <div class="stat-item" data-tooltip="Users following your profile">
                        <div class="text-2xl font-bold" id="followersCount">0</div>
                        <div>Followers</div>
                    </div>
                    <div class="stat-item" data-tooltip="Users you are following">
                        <div class="text-2xl font-bold" id="followingCount">0</div>
                        <div>Following</div>
                    </div>
                </div>
            </div>
            <div id="editForm" style="display: none;">
                <h3 class="auth-title" data-tooltip="Modify your profile details here"><i class="fas fa-edit"></i> Edit Profile</h3>
                <input type="file" id="profilePhoto" accept="image/*" class="input-field" data-tooltip="Upload a new profile photo (JPG, PNG)" />
                <input type="text" id="editFullName" class="input-field" placeholder="Full Name" data-tooltip="Enter your full name" />
                <input type="text" id="editUsername" class="input-field" placeholder="Username" data-tooltip="Choose a unique username" />
                <input type="text" id="editDepartment" class="input-field" placeholder="Department" data-tooltip="Your academic department or major" />
                <textarea id="editStatus" class="textarea-field" placeholder="Status (e.g., Online, Studying CS)" data-tooltip="A short status message about you"></textarea>
                <button class="btn" onclick="updateProfile()" data-tooltip="Save changes to your profile">Update Profile</button>
                <button class="btn" style="background: rgba(239, 68, 68, 0.2); margin-left: 0.5rem;" onclick="toggleEdit()" data-tooltip="Cancel editing and revert changes">Cancel</button>
            </div>
            <button class="btn" onclick="toggleEdit()" style="margin-top: 1rem;" data-tooltip="Begin editing your profile">Edit Profile</button>
            <div id="profileLoading" class="loading"></div>
        </div>
    </div>
    <!-- Session Active Indicator -->
    <div id="sessionIndicator" class="session-indicator active" data-tooltip="Your session will auto-logout after 1 hour of inactivity">
        <span class="status-dot"></span>
        <span id="sessionStatus">Session Active</span>
        <span id="sessionTimer">(59:59)</span>
    </div>
    <!-- Glassmorphism Modal -->
    <div id="notificationModal" class="modal">
        <span id="modalMessage">Profile updated</span>
    </div>
    <script type="module">
        import { supabase } from './js/supabaseClient.js';
        // Auto-logout timer
        let logoutTimer;
        const AUTO_LOGOUT_TIME = 60 * 60 * 1000;
        let sessionUpdateInterval;
        // Theme persistence and snowflakes
        let snowflakeElements = [];
        function applyTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            if (theme === 'dark') {
                createSnowflakes();
            } else {
                removeSnowflakes();
            }
        }
        function createSnowflakes() {
            if (snowflakeElements.length > 0) return;
            const snowflakes = 80;
            for (let i = 0; i < snowflakes; i++) {
                const snowflake = document.createElement('div');
                snowflake.classList.add('snowflake');
                snowflake.textContent = '‚ùÑ';
                snowflake.style.left = Math.random() * 100 + 'vw';
                snowflake.style.fontSize = Math.random() * 1.5 + 0.5 + 'em';
                snowflake.style.animationDuration = Math.random() * 5 + 5 + 's';
                snowflake.style.animationDelay = Math.random() * 5 + 's';
                document.body.appendChild(snowflake);
                snowflakeElements.push(snowflake);
            }
        }
        function removeSnowflakes() {
            snowflakeElements.forEach(snow => snow.remove());
            snowflakeElements = [];
        }
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            applyTheme(newTheme);
        }
        // Swipe gesture
        let touchStartX = 0;
        const navbar = document.getElementById('navbar');
        navbar.addEventListener('touchstart', (e) => {
            touchStartX = e.changedTouches[0].screenX;
        });
        navbar.addEventListener('touchend', (e) => {
            const touchEndX = e.changedTouches[0].screenX;
            const diff = touchStartX - touchEndX;
            if (Math.abs(diff) > 50) {
                toggleTheme();
            }
        });
        function loadTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            applyTheme(savedTheme);
        }
        // Splash functions (same as dashboard)
        function showSplash() {
            const container = document.getElementById('splashContainer');
            container.style.display = 'flex';
            const tempSnowflakes = 80;
            for (let i = 0; i < tempSnowflakes; i++) {
                const snowflake = document.createElement('div');
                snowflake.classList.add('snowflake');
                snowflake.textContent = '‚ùÑ';
                snowflake.style.left = Math.random() * 100 + 'vw';
                snowflake.style.fontSize = Math.random() * 1.5 + 0.5 + 'em';
                snowflake.style.animationDuration = Math.random() * 5 + 5 + 's';
                snowflake.style.animationDelay = Math.random() * 5 + 's';
                document.body.appendChild(snowflake);
                snowflakeElements.push(snowflake);
            }
        }
        function enterSite() {
            const splash = document.getElementById('splash');
            splash.style.animation = 'fadeOut 2s forwards';
            const container = document.getElementById('splashContainer');
            setTimeout(() => {
                container.style.display = 'none';
                removeSnowflakes();
            }, 2000);
            const today = new Date().toISOString().split('T')[0];
            localStorage.setItem('lastSplashShown', today);
        }
        function shouldShowSplash() {
            const today = new Date().toISOString().split('T')[0];
            const lastShown = localStorage.getItem('lastSplashShown');
            return !lastShown || lastShown !== today;
        }
        // Session functions (same as dashboard)
        function resetLogoutTimer() {
            clearTimeout(logoutTimer);
            logoutTimer = setTimeout(autoLogout, AUTO_LOGOUT_TIME);
            updateSessionIndicator();
        }
        function updateSessionIndicator() {
            const sessionIndicator = document.getElementById('sessionIndicator');
            const sessionStatus = document.getElementById('sessionStatus');
            const sessionTimer = document.getElementById('sessionTimer');
            if (!sessionIndicator || !sessionStatus || !sessionTimer) return;
            const remainingTime = AUTO_LOGOUT_TIME - (Date.now() - (logoutTimer._idleStart || Date.now()));
            const minutes = Math.floor(remainingTime / 60000);
            const seconds = Math.floor((remainingTime % 60000) / 1000);
            const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            sessionTimer.textContent = `(${timeString})`;
            sessionIndicator.className = 'session-indicator';
            if (remainingTime > 10 * 60 * 1000) {
                sessionIndicator.classList.add('active');
                sessionStatus.textContent = 'Session Active';
            } else if (remainingTime > 2 * 60 * 1000) {
                sessionIndicator.classList.add('warning');
                sessionStatus.textContent = 'Session Expiring Soon';
            } else {
                sessionIndicator.classList.add('expiring');
                sessionStatus.textContent = 'Session About to Expire';
            }
        }
        async function autoLogout() {
            console.log('Auto-logging out due to inactivity');
            clearInterval(sessionUpdateInterval);
            const { error } = await supabase.auth.signOut();
            if (!error) {
                window.location.href = 'index.html?message=session_timeout';
            }
        }
        function setupActivityListeners() {
            const events = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'];
            events.forEach(event => {
                document.addEventListener(event, resetLogoutTimer, { passive: true });
            });
        }
        // Profile functions
        async function loadProfile(userId = null) {
            const { data: { user } } = await supabase.auth.getUser();
            if (!user) {
                window.location.replace('index.html?message=session_expired');
                return;
            }
            const targetUserId = userId || user.id;
            const { data: profile, error } = await supabase
                .from('profiles')
                .select('*')
                .eq('id', targetUserId)
                .single();
            if (error || !profile) {
                showNotification('Profile not found.');
                return;
            }
            document.getElementById('fullName').textContent = profile.full_name || 'No Name';
            document.getElementById('username').textContent = `@${profile.username || 'no-username'}`;
            document.getElementById('department').textContent = profile.department || 'No department';
            document.getElementById('status').textContent = profile.status || 'No status';
            if (profile.profile_photo) {
                document.getElementById('profileAvatar').innerHTML = `<img src="${profile.profile_photo}" alt="${profile.full_name}" style="width:100%; height:100%; object-fit:cover; border-radius:50%;">`;
            } else {
                const initials = (profile.full_name || 'U').split(' ').map(n => n[0]).join('').toUpperCase();
                document.getElementById('profileAvatar').textContent = initials;
            }
            // Load stats
            const { data: groupsCount } = await supabase.from('group_members').select('count').eq('user_id', targetUserId);
            document.getElementById('groupsCount').textContent = groupsCount?.length || 0;
            const { data: followersCount } = await supabase.from('followers').select('count').eq('following_id', targetUserId);
            document.getElementById('followersCount').textContent = followersCount?.length || 0;
            const { data: followingCount } = await supabase.from('followers').select('count').eq('follower_id', targetUserId);
            document.getElementById('followingCount').textContent = followingCount?.length || 0;
            // Populate edit form if own profile
            if (targetUserId === user.id) {
                document.getElementById('editFullName').value = profile.full_name || '';
                document.getElementById('editUsername').value = profile.username || '';
                document.getElementById('editDepartment').value = profile.department || '';
                document.getElementById('editStatus').value = profile.status || '';
            }
        }
        function toggleEdit() {
            const form = document.getElementById('editForm');
            form.style.display = form.style.display === 'none' ? 'block' : 'none';
        }
        async function updateProfile() {
            const { data: { user } } = await supabase.auth.getUser();
            if (!user) return;
            const fullName = document.getElementById('editFullName').value.trim();
            const username = document.getElementById('editUsername').value.trim();
            const department = document.getElementById('editDepartment').value.trim();
            const status = document.getElementById('editStatus').value.trim();
            const file = document.getElementById('profilePhoto').files[0];
            let profilePhoto = null;
            if (file) {
                const { data, error } = await supabase.storage
                    .from('avatars')
                    .upload(`${user.id}/avatar`, file);
                if (error) {
                    showNotification('Error uploading photo.');
                    return;
                }
                const { data: publicUrl } = supabase.storage.from('avatars').getPublicUrl(`${user.id}/avatar`);
                profilePhoto = publicUrl.data.publicUrl;
            }
            const { error } = await supabase
                .from('profiles')
                .update({
                    full_name: fullName,
                    username: username,
                    department: department,
                    status: status,
                    profile_photo: profilePhoto
                })
                .eq('id', user.id);
            if (error) {
                showNotification('Failed to update profile.');
            } else {
                showNotification('Profile updated successfully!');
                toggleEdit();
                loadProfile();
            }
        }
        function showNotification(message, callback) {
            const modal = document.getElementById('notificationModal');
            const body = document.querySelector('.profile-container');
            const modalMessage = document.getElementById('modalMessage');
            if (!modal || !body || !modalMessage) return;
            modalMessage.textContent = message;
            modal.classList.add('show');
            body.classList.add('blur-background');
            setTimeout(() => {
                modal.classList.remove('show');
                body.classList.remove('blur-background');
                if (callback) callback();
            }, 3000);
        }
        // Gate-keep and load
        document.addEventListener('DOMContentLoaded', async () => {
            loadTheme();
            const urlParams = new URLSearchParams(window.location.search);
            const userId = urlParams.get('userId');
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                window.location.replace('index.html?message=session_expired');
                return;
            }
            if (shouldShowSplash()) {
                showSplash();
                document.querySelector('.profile-container').style.display = 'none';
                const observer = new MutationObserver(() => {
                    if (document.getElementById('splashContainer').style.display === 'none') {
                        document.querySelector('.profile-container').style.display = '';
                        observer.disconnect();
                    }
                });
                observer.observe(document.getElementById('splashContainer'), { attributes: true, attributeFilter: ['style'] });
            }
            resetLogoutTimer();
            setupActivityListeners();
            sessionUpdateInterval = setInterval(updateSessionIndicator, 1000);
            await loadProfile(userId);
        });
        // Logout
        const logoutButtons = ['logout', 'logoutMobile'].map(id => document.getElementById(id)).filter(Boolean);
        logoutButtons.forEach(btn => {
            btn.addEventListener('click', async (e) => {
                e.preventDefault();
                clearTimeout(logoutTimer);
                clearInterval(sessionUpdateInterval);
                const { error } = await supabase.auth.signOut();
                if (!error) {
                    window.location.href = 'index.html?message=logout_success';
                }
            });
        });
        // Nav toggle
        const navToggle = document.getElementById('navToggle');
        const navLinksMobile = document.getElementById('navLinksMobile');
        if (navToggle && navLinksMobile) {
            navToggle.addEventListener('click', () => {
                navLinksMobile.classList.toggle('show');
                resetLogoutTimer();
            });
            document.addEventListener('click', (e) => {
                if (!navToggle.contains(e.target) && !navLinksMobile.contains(e.target)) {
                    navLinksMobile.classList.remove('show');
                }
            });
            navLinksMobile.addEventListener('touchmove', (e) => e.preventDefault(), { passive: false });
        }
        // Global functions
        window.enterSite = enterSite;
        window.toggleEdit = toggleEdit;
        window.updateProfile = updateProfile;
    </script>
</body>
</html>
