<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <title>Peerloom-Chatroom</title>
  <link rel="icon" href="/android-chrome-192x192.png" sizes="192x192" type="image/png">
  <link rel="icon" href="/android-chrome-512x512.png" sizes="512x512" type="image/png">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="manifest" href="/site.webmanifest">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <script type="module" src="js/supabaseClient.js"></script>
  <style>
    :root {
      --glass-bg-light: rgba(255, 255, 255, 0.3);
      --glass-bg-dark: rgba(0, 0, 0, 0.3);
      --text-light: #333333;
      --text-dark: #f9fafb;
      --msg-bg-light: rgba(0, 0, 0, 0.08);
      --msg-bg-dark: rgba(255, 255, 255, 0.08);
      --msg-hover-light: rgba(0, 0, 0, 0.15);
      --msg-hover-dark: rgba(255, 255, 255, 0.15);
      --accent: #4a90e2;
      --ai-bg-light: rgba(0, 102, 255, 0.2);
      --ai-bg-dark: rgba(0, 102, 255, 0.25);
      --circle-bg-dark: rgba(255, 255, 255, 0.2);
      --placeholder-fade: rgba(0, 0, 0, 0.3);
      --gloss-red: rgba(255,71,87,0.14);
      --gloss-red-strong: rgba(255,71,87,0.28);
    }
  
    [data-theme="dark"] {
      --page-bg: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      --glass-bg: rgba(20, 22, 28, 0.95);
      --text: #f1f1f1;
      --msg-bg: rgba(40, 42, 54, 0.95);
      --msg-hover: rgba(60, 62, 74, 1);
      --ai-bg: var(--ai-bg-dark);
      --circle-bg: rgba(30, 32, 38, 0.95);
      --placeholder-fade: rgba(200, 200, 200, 0.3);
      --gloss-red: rgba(255,71,87,0.12);
      --gloss-red-strong: rgba(255,71,87,0.22);
    }
    .upload-progress-container {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    .upload-progress-bar-wrapper {
      flex: 1;
      height: 8px;
      background: rgba(255,255,255,0.1);
      border-radius: 4px;
      overflow: hidden;
    }
    .upload-progress-bar { height: 100%; width: 0%; background: var(--accent); transition: width 0.2s ease; }
    .upload-progress-text { font-size: 0.8rem; font-weight: 500; }
  
    [data-theme="light"] {
      --page-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --glass-bg: var(--glass-bg-light);
      --text: var(--text-light);
      --msg-bg: var(--msg-bg-light);
      --msg-hover: var(--msg-hover-light);
      --ai-bg: var(--ai-bg-light);
      --circle-bg: var(--glass-bg-light);
    }
    [data-theme="light"] .upload-progress-bar-wrapper {
      background: rgba(0,0,0,0.1);
    }
  
    * { margin: 0; padding: 0; box-sizing: border-box; }
  
    html, body {
      height: 100%;
      overflow: hidden;
      position: fixed;
      width: 100%;
    }
  
    body {
      background: var(--page-bg);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      color: var(--text);
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding-top: env(safe-area-inset-top, 0px);
      padding-bottom: env(safe-area-inset-bottom, 0px);
      padding-left: env(safe-area-inset-left, 0px);
      padding-right: env(safe-area-inset-right, 0px);
      transition: background 0.3s ease, color 0.3s ease;
    }
  
    .chat-arena {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      position: relative;
      padding: 0;
    }
  
    .chat-header, .chat-messages, .chat-input-area, .emoji-picker, .mention-list {
      background: var(--glass-bg);
      border-radius: 15px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }
  
    .chat-header {
      padding: 0.8rem 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: relative;
      z-index: 4;
      overflow: visible;
      flex-shrink: 0;
      margin: 0.5rem;
      margin-bottom: 0;
    }
  
    .chat-header h1 {
      font-size: 1.3rem;
      font-style: italic;
      cursor: pointer;
      user-select: none;
      display: inline-block;
    }
  
    .header-actions { display: flex; gap: 0.5rem; }
  
    .chat-messages {
      flex: 1;
      padding: 1rem;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin: 0.5rem;
      margin-top: 0;
      margin-bottom: 0;
    }
  
    .msg {
      max-width: 85%;
      padding: 0.8rem 1rem;
      border-radius: 18px;
      background: var(--msg-bg);
      color: var(--text);
      position: relative;
      transition: all 0.3s ease;
      word-wrap: break-word;
      font-size: 1rem;
      line-height: 1.4;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
      user-select: none;
      -webkit-user-select: none;
      touch-action: pan-y;
    }
  
    .msg.sent {
      align-self: flex-end;
      background: linear-gradient(135deg, var(--accent), #50e3c2);
      color: white;
      border-bottom-right-radius: 4px;
    }
  
    .msg.recv {
      align-self: flex-start;
      background: var(--msg-bg);
      border-bottom-left-radius: 4px;
    }
  
    .msg.ai {
      align-self: flex-start;
      background: var(--ai-bg);
      border-bottom-left-radius: 4px;
      border: 1px solid rgba(74, 144, 226, 0.3);
      font-weight: 500;
      color: var(--text);
    }
  
    .msg:hover { background: var(--msg-hover); }
  
    .sender-name {
      font-size: 0.75rem;
      font-weight: 600;
      opacity: 0.8;
      margin-bottom: 0.3rem;
      align-self: flex-start;
    }
  
    .timestamp {
      font-size: 0.7rem;
      opacity: 0.6;
      margin-top: 0.4rem;
      text-align: right;
    }
  
    .reply-banner {
      font-size: 0.8rem;
      margin-bottom: 0.5rem;
      padding-left: 0.7rem;
      border-left: 2px solid var(--accent);
      opacity: 0.7;
    }
  
    .chat-input-area {
      padding: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
      position: relative;
      flex-shrink: 0;
      margin: 0.5rem;
      margin-top: 0;
    }
  
    .message-bar {
      flex: 1;
      min-height: 44px;
      max-height: 120px;
      border-radius: 20px;
      background: var(--msg-bg);
      color: var(--text);
      font-size: 1rem;
      cursor: text;
      padding: 0.7rem 4rem 0.7rem 1rem;
      outline: none;
      resize: none;
      border: none;
      font-family: inherit;
      line-height: 1.4;
    }
  
    .message-bar:empty:before { content: attr(data-placeholder); color: var(--placeholder-fade); pointer-events: none; }
  
    .send-arrow {
      position: absolute;
      right: 3rem;
      top: 50%;
      transform: translateY(-50%);
      background: var(--circle-bg);
      border: none;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 1.1rem;
      cursor: pointer;
      transition: transform 0.2s ease;
      z-index: 2;
    }
  
    .send-arrow:hover { transform: scale(1.1) translateY(-50%); }
  
    .audio-record {
      position: absolute;
      right: 0.5rem;
      top: 50%;
      transform: translateY(-50%);
      background: var(--circle-bg);
      border: none;
      border-radius: 50%;
      margin-right: 0;
      width: 32px;
      height: 32px;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 1.2rem;
      cursor: pointer;
      transition: all 0.3s ease;
      z-index: 2;
    }
  
    .audio-record:hover { transform: scale(1.1) translateY(-50%); }
    .audio-record.active {
      background: #ff4757;
      color: white;
      box-shadow: 0 0 0 6px rgba(255, 71, 87, 0.3);
      animation: pulse-record 1.5s infinite;
    }
  
    @keyframes pulse-record {
      0% { box-shadow: 0 0 0 0 rgba(255, 71, 87, 0.4); }
      70% { box-shadow: 0 0 0 12px rgba(255, 71, 87, 0); }
      100% { box-shadow: 0 0 0 0 rgba(255, 71, 87, 0); }
    }
  
    .icon-btn {
      background: var(--glass-bg);
      border: none;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 1.2rem;
      cursor: pointer;
      transition: transform 0.2s ease;
      flex-shrink: 0;
    }
  
    .icon-btn:hover { transform: scale(1.1); }
  
    /* FIXED: Dark mode icons and button text */
    [data-theme="dark"] .icon-btn {
      color: white;
    }
  
    [data-theme="dark"] .leave-btn,
    [data-theme="dark"] .share-btn,
    [data-theme="dark"] .modal-btn {
      color: white;
    }
  
    [data-theme="dark"] .leave-btn {
      background: rgba(255,71,87,0.15);
      border: 1px solid rgba(255,71,87,0.4);
    }
  
    [data-theme="dark"] .share-btn {
      background: rgba(74, 144, 226, 0.15);
      border: 1px solid rgba(74, 144, 226, 0.4);
    }
  
    .emoji-picker, .mention-list {
      position: fixed;
      padding: 0.6rem;
      border-radius: 12px;
      display: none;
      flex-wrap: wrap;
      max-width: 280px;
      z-index: 10;
      background: var(--glass-bg);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }
  
    .emoji-picker span, .mention-list div { margin: 0.3rem; padding: 0.4rem 0.6rem; font-size: 1.2rem; border-radius: 6px; cursor: pointer; }
    .emoji-picker span:hover, .mention-list div:hover { background: var(--msg-hover); }
    .drawer-backdrop {
      position: fixed;
      inset: 0;
      background: transparent;
      z-index: 900;
      display: none;
      pointer-events: none;
      transition: background 0.25s ease;
    }
  
    .drawer-backdrop.visible {
      display: block;
      pointer-events: auto;
      background: rgba(0,0,0,0.5);
      animation: backdropFade 240ms ease forwards;
    }
  
    @keyframes backdropFade {
      from { background: rgba(0,0,0,0); }
      to { background: rgba(0,0,0,0.5); }
    }
    .group-drawer {
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      top: 10px;
      width: 95%;
      max-width: 500px;
      height: 0;
      overflow: hidden;
      border-radius: 20px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      transition: height 420ms cubic-bezier(.2,.9,.2,1), opacity 260ms ease, transform 420ms cubic-bezier(.2,.9,.2,1);
      opacity: 0;
      pointer-events: none;
      box-shadow: 0 25px 80px rgba(0,0,0,0.3);
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(30px) saturate(1.8);
      -webkit-backdrop-filter: blur(30px) saturate(1.8);
      border: 1px solid rgba(255,255,255,0.2);
      padding: 0;
    }
    .group-drawer.open {
      height: 80vh;
      opacity: 1;
      pointer-events: auto;
      transform: translateX(-50%) translateY(10px);
    }
    .drawer-header {
      padding: 1rem 1.2rem 0.6rem;
      text-align: center;
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-radius: 20px 20px 0 0;
    }
    .drawer-header h2 {
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 0.3rem;
      color: var(--text);
    }
    .drawer-header p {
      opacity: 0.8;
      font-size: 0.8rem;
      color: var(--text);
    }
    .members-list {
      flex: 1;
      overflow-y: auto;
      padding: 0.6rem 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      background: transparent;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      margin: 0;
    }
    .member-item {
      display: flex;
      align-items: center;
      gap: 0.7rem;
      padding: 0.7rem;
      border-radius: 14px;
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      border: 1px solid rgba(255,255,255,0.15);
      transition: all 0.3s ease;
    }
    .member-item:hover {
      background: rgba(255,255,255,0.15);
      transform: translateX(5px);
      border-color: rgba(255,255,255,0.25);
    }
    .member-item.ai-member {
      background: rgba(74, 144, 226, 0.2);
      border-left: 3px solid var(--accent);
    }
    .member-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      border: 1.5px solid rgba(255,255,255,0.25);
    }
    .member-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 0.2rem;
    }
    .member-name {
      font-weight: 600;
      font-size: 0.9rem;
      color: var(--text);
    }
    .member-role {
      font-size: 0.7rem;
      opacity: 0.8;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text);
    }
    .member-status {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #50e3c2;
      margin-left: auto;
      box-shadow: 0 0 10px rgba(80, 227, 194, 0.5);
    }
    .member-status.ai {
      background: var(--accent);
      box-shadow: 0 0 10px rgba(74, 144, 226, 0.5);
    }
    /* FIXED: Drawer footer with proper button layout */
    .drawer-footer {
      padding: 0.7rem 1rem;
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      border-radius: 0 0 20px 20px;
      display: flex;
      justify-content: space-between;
      gap: 0.5rem;
      flex-wrap: nowrap;
    }
    .leave-btn {
      padding: 0.5rem 1rem;
      background: rgba(255,71,87,0.1);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255,71,87,0.3);
      border-radius: 10px;
      color: #ff4757;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.8rem;
      display: flex;
      align-items: center;
      gap: 0.4rem;
      flex: 1;
      justify-content: center;
      min-width: 0;
      white-space: nowrap;
    }
    .leave-btn:hover {
      background: rgba(255,71,87,0.2);
      transform: translateY(-1px);
      border-color: rgba(255,71,87,0.4);
    }
    .share-btn {
      padding: 0.5rem 1rem;
      background: rgba(74, 144, 226, 0.1);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(74, 144, 226, 0.3);
      border-radius: 10px;
      color: var(--accent);
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.8rem;
      display: flex;
      align-items: center;
      gap: 0.4rem;
      flex: 1;
      justify-content: center;
      min-width: 0;
      white-space: nowrap;
    }
    .share-btn:hover {
      background: rgba(74, 144, 226, 0.2);
      transform: translateY(-1px);
      border-color: rgba(74, 144, 226, 0.4);
    }
    /* ULTRA GLASSY VOICE MESSAGE BUBBLES */
    .voice-message-bubble {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 18px;
      border-radius: 25px;
      min-width: 200px;
      max-width: 300px;
      position: relative;
      overflow: hidden;
      transition: all 0.3s ease;
      cursor: pointer;
      backdrop-filter: blur(20px) saturate(180%);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
      border: 1px solid rgba(255, 255, 255, 0.18);
      box-shadow:
        0 8px 32px rgba(0, 0, 0, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.2),
        inset 0 -1px 0 rgba(0, 0, 0, 0.05);
    }
    /* Sent voice message bubble */
    .msg.sent .voice-message-bubble {
      background: linear-gradient(135deg,
        rgba(255, 255, 255, 0.25) 0%,
        rgba(255, 255, 255, 0.15) 100%);
      background-color: rgba(74, 144, 226, 0.15);
    }
    /* Received voice message bubble */
    .msg.recv .voice-message-bubble {
      background: linear-gradient(135deg,
        rgba(255, 255, 255, 0.2) 0%,
        rgba(255, 255, 255, 0.1) 100%);
      background-color: rgba(0, 0, 0, 0.05);
    }
    .voice-play-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      transition: all 0.3s ease;
      flex-shrink: 0;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow:
        0 4px 15px rgba(0, 0, 0, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }
    .msg.sent .voice-play-btn {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.7));
      color: var(--accent);
    }
    .msg.recv .voice-play-btn {
      background: linear-gradient(135deg, var(--accent), #3a7bd5);
      color: white;
    }
    .voice-waveform {
      flex: 1;
      height: 40px;
      display: flex;
      align-items: center;
      gap: 3px;
      position: relative;
    }
    .wave-bar {
      width: 4px;
      border-radius: 2px;
      background: currentColor;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    .wave-bar::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(to bottom, transparent, rgba(255, 255, 255, 0.5), transparent);
      opacity: 0.6;
    }
    .msg.sent .wave-bar {
      background: linear-gradient(to bottom, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.7));
      box-shadow: 0 0 5px rgba(255, 255, 255, 0.3);
    }
    .msg.recv .wave-bar {
      background: linear-gradient(to bottom, var(--accent), #3a7bd5);
      box-shadow: 0 0 5px rgba(74, 144, 226, 0.3);
    }
    .voice-duration {
      font-size: 0.8rem;
      font-weight: 600;
      opacity: 0.9;
      flex-shrink: 0;
      min-width: 40px;
      text-align: center;
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      padding: 4px 8px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .msg.sent .voice-duration {
      color: rgba(255, 255, 255, 0.9);
      background: rgba(255, 255, 255, 0.15);
    }
    .msg.recv .voice-duration {
      color: var(--text);
      background: rgba(0, 0, 0, 0.05);
    }
    /* Hover effects */
    .voice-message-bubble:hover {
      transform: translateY(-2px);
      box-shadow:
        0 12px 40px rgba(0, 0, 0, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.25),
        inset 0 -1px 0 rgba(0, 0, 0, 0.05);
    }
    .voice-play-btn:hover {
      transform: scale(1.1);
      box-shadow:
        0 6px 20px rgba(0, 0, 0, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.3);
    }
    /* Recording animation */
    .voice-message-bubble.recording {
      animation: pulse-glow 2s infinite;
    }
    @keyframes pulse-glow {
      0% {
        box-shadow:
          0 8px 32px rgba(0, 0, 0, 0.1),
          inset 0 1px 0 rgba(255, 255, 255, 0.2),
          inset 0 -1px 0 rgba(0, 0, 0, 0.05),
          0 0 0 0 rgba(255, 71, 87, 0.4);
      }
      70% {
        box-shadow:
          0 8px 32px rgba(0, 0, 0, 0.1),
          inset 0 1px 0 rgba(255, 255, 255, 0.2),
          inset 0 -1px 0 rgba(0, 0, 0, 0.05),
          0 0 0 10px rgba(255, 71, 87, 0);
      }
      100% {
        box-shadow:
          0 8px 32px rgba(0, 0, 0, 0.1),
          inset 0 1px 0 rgba(255, 255, 255, 0.2),
          inset 0 -1px 0 rgba(0, 0, 0, 0.05),
          0 0 0 0 rgba(255, 71, 87, 0);
      }
    }
    .recording-waveform .wave-bar {
      animation: wavePulse 1.2s infinite ease-in-out;
    }
    .recording-waveform .wave-bar:nth-child(2) { animation-delay: 0.1s; }
    .recording-waveform .wave-bar:nth-child(3) { animation-delay: 0.2s; }
    .recording-waveform .wave-bar:nth-child(4) { animation-delay: 0.3s; }
    .recording-waveform .wave-bar:nth-child(5) { animation-delay: 0.4s; }
    .recording-waveform .wave-bar:nth-child(6) { animation-delay: 0.5s; }
    .recording-waveform .wave-bar:nth-child(7) { animation-delay: 0.6s; }
    .recording-waveform .wave-bar:nth-child(8) { animation-delay: 0.7s; }
    .recording-waveform .wave-bar:nth-child(9) { animation-delay: 0.8s; }
    .recording-waveform .wave-bar:nth-child(10) { animation-delay: 0.9s; }
    @keyframes wavePulse {
      0%, 100% { height: 5px; opacity: 0.5; }
      50% { height: 30px; opacity: 1; }
    }
    /* Playing animation */
    .voice-message-bubble.playing .wave-bar {
      animation: wavePlay 1.5s infinite ease-in-out;
    }
    .voice-message-bubble.playing .wave-bar:nth-child(2) { animation-delay: 0.1s; }
    .voice-message-bubble.playing .wave-bar:nth-child(3) { animation-delay: 0.2s; }
    .voice-message-bubble.playing .wave-bar:nth-child(4) { animation-delay: 0.3s; }
    .voice-message-bubble.playing .wave-bar:nth-child(5) { animation-delay: 0.4s; }
    .voice-message-bubble.playing .wave-bar:nth-child(6) { animation-delay: 0.5s; }
    .voice-message-bubble.playing .wave-bar:nth-child(7) { animation-delay: 0.6s; }
    .voice-message-bubble.playing .wave-bar:nth-child(8) { animation-delay: 0.7s; }
    .voice-message-bubble.playing .wave-bar:nth-child(9) { animation-delay: 0.8s; }
    .voice-message-bubble.playing .wave-bar:nth-child(10) { animation-delay: 0.9s; }
    @keyframes wavePlay {
      0%, 100% { height: 8px; }
      50% { height: 25px; }
    }
    /* Delete button for own voice messages */
    .voice-delete-btn {
      position: absolute;
      top: -8px;
      right: -8px;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: rgba(255, 71, 87, 0.9);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      cursor: pointer;
      opacity: 0;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }
    .msg.sent .voice-message-bubble:hover .voice-delete-btn {
      opacity: 1;
      transform: scale(1);
    }
    .voice-delete-btn:hover {
      background: rgba(255, 71, 87, 1);
      transform: scale(1.1);
    }
    .recording-indicator {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      color: white;
      padding: 12px 24px;
      border-radius: 25px;
      z-index: 10000;
      display: none;
      align-items: center;
      gap: 12px;
      font-weight: 600;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .recording-indicator.active {
      display: flex;
      animation: slideUp 0.3s ease forwards;
    }
    @keyframes slideUp {
      from { transform: translateX(-50%) translateY(20px); opacity: 0; }
      to { transform: translateX(-50%) translateY(0); opacity: 1; }
    }
    .pulse {
      width: 12px;
      height: 12px;
      background: #ff4757;
      border-radius: 50%;
      animation: pulse 1s infinite;
    }
    @keyframes pulse {
      0% { transform: scale(0.8); opacity: 1; }
      50% { transform: scale(1.2); opacity: 0.7; }
      100% { transform: scale(0.8); opacity: 1; }
    }
    .modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .modal-backdrop.visible {
      display: flex;
      opacity: 1;
    }
    .modal-content {
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-radius: 16px;
      padding: 1.5rem;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
      transform: scale(0.9);
      opacity: 0;
      transition: all 0.3s ease;
    }
    .modal-backdrop.visible .modal-content {
      transform: scale(1);
      opacity: 1;
    }
    .modal-header {
      margin-bottom: 1rem;
      text-align: center;
    }
    .modal-title {
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--text);
    }
    .modal-description {
      font-size: 0.9rem;
      opacity: 0.8;
      color: var(--text);
    }
    .modal-input {
      width: 100%;
      padding: 0.8rem 1rem;
      border-radius: 12px;
      background: var(--msg-bg);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: var(--text);
      font-size: 1rem;
      margin-bottom: 1.5rem;
      outline: none;
      transition: border-color 0.3s ease;
    }
    .modal-input:focus {
      border-color: var(--accent);
    }
    .modal-actions {
      display: flex;
      gap: 0.8rem;
      justify-content: flex-end;
    }
    .modal-btn {
      padding: 0.6rem 1.2rem;
      border-radius: 10px;
      border: none;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.9rem;
    }
    .modal-btn.cancel {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text);
    }
    .modal-btn.confirm {
      background: var(--accent);
      color: white;
    }
    .modal-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    .modal-btn.delete {
      background: rgba(255, 71, 87, 0.1);
      color: #ff4757;
      border: 1px solid rgba(255, 71, 87, 0.3);
    }
    .modal-btn.delete:hover {
      background: rgba(255, 71, 87, 0.2);
    }
    /* Back button for mobile */
    .back-button {
      display: none;
      background: var(--glass-bg);
      border: none;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      justify-content: center;
      align-items: center;
      font-size: 1.1rem;
      cursor: pointer;
      transition: transform 0.2s ease;
      flex-shrink: 0;
      color: var(--text);
    }
    .back-button:hover {
      transform: scale(1.1);
    }
    @media (min-width: 769px) {
      body {
        padding: 20px;
        align-items: center;
        justify-content: center;
      }
    
      .chat-arena {
        max-width: 900px;
        width: 95%;
        height: 95vh;
        border-radius: 20px;
        overflow: hidden;
        box-shadow: 0 25px 80px rgba(0, 0, 0, 0.3);
        background: var(--glass-bg);
      }
    
      .chat-header, .chat-messages, .chat-input-area {
        margin: 0.8rem;
      }
    
      .chat-messages {
        padding: 1.5rem;
      }
    
      .msg {
        max-width: 70%;
      }
    
      .group-drawer {
        max-width: 600px;
        height: 0;
      }
    
      .group-drawer.open {
        height: 75vh;
      }
    
      .message-bar {
        font-size: 1.1rem;
        padding: 0.8rem 4rem 0.8rem 1.2rem;
      }
    }
    @media (max-width: 768px) {
      body {
        padding-top: env(safe-area-inset-top, 0px);
        padding-bottom: env(safe-area-inset-bottom, 0px);
      }
    
      .chat-header {
        padding: 0.6rem 0.8rem;
        margin: 0.3rem;
        margin-bottom: 0;
      }
    
      .chat-header h1 {
        font-size: 1.1rem;
      }
    
      .chat-messages {
        padding: 0.8rem;
        gap: 0.8rem;
        margin: 0.3rem;
        margin-top: 0;
        margin-bottom: 0;
        height: calc(100vh - 180px); /* Adjust height to account for keyboard */
        overflow-y: auto;
      }
    
      .msg {
        max-width: 90%;
        padding: 0.7rem 0.9rem;
        font-size: 0.95rem;
      }
    
      .chat-input-area {
        margin: 0.3rem;
        margin-top: 0;
        position: sticky;
        bottom: 0;
        z-index: 10;
      }
    
      .group-drawer {
        width: 98%;
        top: 5px;
      }
    
      .group-drawer.open {
        height: 85vh;
      }
    
      .member-avatar {
        width: 36px;
        height: 36px;
      }
    
      .icon-btn, .send-arrow, .audio-record {
        width: 30px;
        height: 30px;
        font-size: 1rem;
      }
    
      .send-arrow {
        right: 2.8rem;
      }
    
      .message-bar {
        min-height: 42px;
        padding: 0.6rem 3.8rem 0.6rem 0.8rem;
      }
    
      /* FIXED: Mobile drawer footer */
      .drawer-footer {
        flex-direction: row;
        gap: 0.3rem;
      }
    
      .share-btn, .leave-btn {
        font-size: 0.75rem;
        padding: 0.4rem 0.8rem;
      }
    
      /* Show back button on mobile */
      .back-button {
        display: flex;
      }
    }
    @media (max-width: 480px) {
      .chat-header h1 {
        font-size: 1rem;
      }
    
      .msg {
        max-width: 95%;
        padding: 0.6rem 0.8rem;
        font-size: 0.9rem;
      }
    
      .sender-name {
        font-size: 0.7rem;
      }
    
      .timestamp {
        font-size: 0.65rem;
      }
    
      .message-bar {
        font-size: 0.9rem;
      }
    
      .member-avatar {
        width: 32px;
        height: 32px;
      }
    
      .member-name {
        font-size: 0.85rem;
      }
    
      /* FIXED: Extra small screens */
      .drawer-footer {
        flex-wrap: wrap;
      }
    
      .share-btn, .leave-btn {
        min-width: 120px;
        font-size: 0.7rem;
      }
    }
    /* Mobile keyboard fixes */
    @media (max-height: 600px) {
      .chat-messages {
        height: calc(100vh - 160px);
      }
    }
    .ripple { position: absolute; border-radius: 50%; background: rgba(255,255,255,0.4); transform: scale(0); animation: ripple-animation 0.6s linear; pointer-events: none; }
    @keyframes ripple-animation { to { transform: scale(4); opacity: 0; } }
    .mention-list {
      display: none;
      flex-direction: column;
      width: 240px;
      max-height: 200px;
      overflow-y: auto;
      padding: 0.5rem;
      gap: 0.2rem;
      animation: dropdownAppear 0.2s ease-out;
    }
    @keyframes dropdownAppear {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .mention-item {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      padding: 0.6rem 0.8rem;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 0.9rem;
    }
    .mention-item:hover {
      background: var(--msg-hover);
      transform: translateX(4px);
    }
    .mention-item.ai-mention {
      background: rgba(0, 102, 255, 0.1);
      border-left: 3px solid #4a90e2;
    }
    .mention-item.ai-mention:hover {
      background: rgba(0, 102, 255, 0.2);
    }
    .mention-avatar {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      object-fit: cover;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .mention-badge {
      font-size: 0.7rem;
      padding: 0.1rem 0.4rem;
      border-radius: 10px;
      background: var(--accent);
      color: white;
      margin-left: auto;
    }
    .mention {
      color: var(--accent);
      font-weight: 600;
      padding: 0.1rem 0.3rem;
      border-radius: 4px;
      background: rgba(74, 144, 226, 0.1);
      transition: all 0.3s ease;
    }
    .mention.ai-mention {
      background: rgba(0, 102, 255, 0.15);
      cursor: pointer;
      position: relative;
    }
    .mention.ai-mention:hover {
      background: rgba(0, 102, 255, 0.25);
      transform: translateY(-1px);
    }
    .mention.ai-mention::after {
      content: "ðŸ¤–";
      font-size: 0.7rem;
      margin-left: 0.2rem;
      opacity: 0.7;
    }
    @keyframes glow {
      0%, 100% { box-shadow: 0 0 5px rgba(74, 144, 226, 0.3); }
      50% { box-shadow: 0 0 15px rgba(74, 144, 226, 0.6), 0 0 25px rgba(74, 144, 226, 0.4); }
    }
    .mention.ai-mention.glow {
      animation: glow 2s ease-in-out infinite;
    }
    body[data-theme="dark"] ::-webkit-scrollbar { background: #181920; }
    body[data-theme="dark"] ::-webkit-scrollbar-thumb { background: #23242b; }
    [data-theme="dark"] .chat-header, [data-theme="dark"] .chat-messages, [data-theme="dark"] .chat-input-area, [data-theme="dark"] .emoji-picker, [data-theme="dark"] .mention-list { border: 1px solid #23242b; }
    .typing-indicator {
      align-self: flex-start;
      max-width: 70%;
      padding: 0.8rem 1.2rem;
      border-radius: 18px;
      background: var(--msg-bg);
      font-style: italic;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
      border-bottom-left-radius: 4px;
    }
    .typing-indicator.ai {
      background: var(--ai-bg);
    }
    .typing-dots {
      display: flex;
      gap: 4px;
      margin-top: 0.3rem;
    }
    .typing-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--text);
      opacity: 0.6;
      animation: typingAnimation 1.4s infinite ease-in-out;
    }
    .typing-dot:nth-child(1) { animation-delay: 0s; }
    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes typingAnimation {
      0%, 60%, 100% { transform: translateY(0); opacity: 0.6; }
      30% { transform: translateY(-5px); opacity: 1; }
    }
    .reply-context {
      position: absolute;
      bottom: calc(100% + 5px);
      left: 0;
      right: 0;
      background: var(--glass-bg);
      border-radius: 10px;
      padding: 0.7rem;
      display: none;
      align-items: center;
      gap: 0.8rem;
      box-shadow: 0 4px 15px rgba(0,0,0,0.15);
      z-index: 5;
      border-left: 4px solid var(--accent);
      margin: 0 0.5rem;
    }
    .reply-context-content {
      flex: 1;
      overflow: hidden;
    }
    .reply-context-sender {
      font-weight: 600;
      font-size: 0.85rem;
      color: var(--accent);
      margin-bottom: 0.2rem;
    }
    .reply-context-text {
      font-size: 0.8rem;
      opacity: 0.8;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .reply-context-close {
      background: none;
      border: none;
      font-size: 1.1rem;
      color: var(--text);
      opacity: 0.7;
      cursor: pointer;
      transition: all 0.2s ease;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .reply-context-close:hover {
      opacity: 1;
      background: rgba(255,255,255,0.1);
    }
    .swipe-indicator {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      align-items: center;
      gap: 5px;
      color: var(--accent);
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
      font-size: 0.8rem;
    }
    .swipe-indicator.show {
      opacity: 1;
    }
    .swipe-indicator i {
      font-size: 0.9rem;
    }
    .swipe-indicator span {
      font-size: 0.75rem;
      font-weight: 500;
    }
    .msg.swiping {
      transform: translateX(-80px);
      transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.3, 1);
    }
    .msg.replying {
      border: 2px solid var(--accent);
      box-shadow: 0 0 10px rgba(74, 144, 226, 0.3);
    }
    /* Admin Action Buttons */
    .admin-action {
      padding: 0.8rem 1rem;
      background: var(--glass-bg);
      border: none;
      border-radius: 10px;
      color: var(--text);
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      justify-content: flex-start;
      font-size: 0.9rem;
    }
    .admin-action:hover {
      background: var(--msg-hover);
      transform: translateX(5px);
    }
    .member-action {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 0.8rem;
      transition: all 0.2s ease;
    }
    .member-action.promote { background: rgba(74, 144, 226, 0.2); color: var(--accent); }
    .member-action.remove { background: rgba(255, 71, 87, 0.2); color: #ff4757; }
    .member-actions { display: flex; gap: 0.3rem; margin-left: auto; }
  </style>
  <style>
    /* WhatsApp-style File Attachment */
    .file-attachment-card {
      display: flex;
      align-items: center;
      gap: 0.8rem;
      background: rgba(0, 0, 0, 0.1);
      padding: 0.8rem;
      border-radius: 12px;
      min-width: 250px;
    }
    .msg.sent .file-attachment-card {
      background: rgba(255, 255, 255, 0.15);
    }
    .file-icon-wrapper {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      background: var(--accent);
      color: white;
    }
    .file-icon-wrapper .fas {
      font-size: 1.2rem;
    }
    .file-info {
      flex: 1;
      overflow: hidden;
    }
    .file-name {
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-size: 0.9rem;
      margin-bottom: 0.2rem;
    }
    .file-meta {
      font-size: 0.75rem;
      opacity: 0.8;
      text-transform: uppercase;
    }
    .download-btn-wrapper {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.1);
      color: var(--text);
      transition: background 0.2s ease;
    }
    .download-btn-wrapper:hover {
      background: rgba(0, 0, 0, 0.2);
    }
  </style>
  <style>
    /* Download button for images/videos */
    .media-container {
      position: relative;
      display: inline-block;
      max-width: 300px;
      width: 100%;
    }
    .media-download-btn {
      position: absolute;
      bottom: 10px;
      right: 10px;
      background: rgba(0, 0, 0, 0.6);
      color: white;
      border: none;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background 0.2s ease;
      z-index: 1;
    }
    .media-download-btn:hover { background: rgba(0, 0, 0, 0.8); }
    /* Play button overlay for videos */
    .media-play-btn {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.6);
      color: white;
      border: none;
      border-radius: 50%;
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background 0.2s ease, transform 0.2s ease;
      z-index: 1;
      font-size: 1.2rem;
    }
    .media-play-btn:hover { background: rgba(0, 0, 0, 0.8); transform: translate(-50%, -50%) scale(1.1); }
    .media-download-btn .file-size {
      font-size: 0.7rem;
      font-weight: 500;
      margin-left: 0.4rem;
    }
    /* Downloading animation */
    .download-animation {
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
    .media-download-btn.downloading {
      background: rgba(0, 0, 0, 0.8);
      cursor: not-allowed;
    }
  </style>
  <style>
    /* Lightbox for viewing images/videos */
    .lightbox {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      z-index: 3000;
      display: none; /* Hidden by default */
      justify-content: center;
      align-items: center;
      padding: 20px;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .lightbox.visible {
      display: flex;
      opacity: 1;
    }
    .lightbox-close {
      position: absolute;
      top: 20px;
      right: 30px;
      font-size: 40px;
      color: white;
      cursor: pointer;
      transition: transform 0.2s ease;
    }
    .lightbox-close:hover { transform: scale(1.1); }
    .lightbox-content img,
    .lightbox-content video {
      max-width: 90vw;
      max-height: 90vh;
      border-radius: 10px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.5);
    }
  </style>
</head>
<body>
  <div class="chat-arena">
    <div class="chat-header">
      <button class="back-button" id="backButton"><i class="fas fa-arrow-left"></i></button>
      <h1 id="groupTitle"></h1>
      <div class="header-actions">
        <button class="icon-btn" id="voiceCallButton"><i class="fas fa-phone"></i></button>
        <button class="icon-btn" id="videoCallButton"><i class="fas fa-video"></i></button>
        <button class="icon-btn" id="themeToggleButton">ðŸŒ™</button>
        <button class="icon-btn" id="adminPanelButton"><i class="fas fa-cog"></i></button>
      </div>
    </div>
    <div class="chat-messages" id="messagePanel"></div>
    <div class="chat-input-area">
      <button class="icon-btn" id="emojiButton">ðŸ˜„</button>
      <input type="file" id="fileInput" style="display: none;" accept="image/*,video/*,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document" />
      <button class="icon-btn" id="fileShareButton"><i class="fas fa-paperclip"></i></button>
      <textarea id="messageBar" class="message-bar" data-placeholder="Type here" rows="1"></textarea>
      <button class="send-arrow" id="sendMessageButton">âž¤</button>
      <button class="audio-record" id="recordAudioButton"><i class="fas fa-microphone"></i></button>
      <div class="emoji-picker" id="emojiPickerBox"></div>
      <div class="mention-list" id="mentionListBox"></div>
      <div class="reply-context" id="replyContextBox">
        <div class="reply-context-content">
          <div class="reply-context-sender" id="replyContextSender"></div>
          <div class="reply-context-text" id="replyContextText"></div>
        </div>
        <button class="reply-context-close" id="replyContextClose">Ã—</button>
      </div>
    </div>
  </div>
  <!-- Modern Recording Indicator -->
  <div class="recording-indicator" id="recordingIndicator">
    <div class="pulse"></div>
    <span>Recording... Tap to stop</span>
    <div class="recording-time" id="recordingTime">00:00</div>
  </div>
  <!-- Backdrop -->
  <div id="drawerBackdrop" class="drawer-backdrop"></div>
  <!-- CLEAN TRANSPARENT GLASS DRAWER -->
  <div class="group-drawer" id="groupDrawer" aria-hidden="true" role="dialog" aria-label="Group members">
    <div class="drawer-header">
      <h2>Group Members</h2>
      <p>Connect with your team</p>
    </div>
    <div class="members-list" id="membersList"></div>
    <div class="drawer-footer">
      <button class="share-btn" id="shareGroupBtn">
        <i class="fas fa-share-alt"></i>
        Share Group
      </button>
      <button class="leave-btn" id="leaveGroupBtn">
        <i class="fas fa-sign-out-alt"></i>
        Leave Group
      </button>
    </div>
  </div>
  <!-- Lightbox for viewing images/videos -->
  <div class="lightbox" id="lightbox">
    <span class="lightbox-close" id="lightboxClose">&times;</span>
    <div class="lightbox-content" id="lightboxContent">
      <!-- Image or video will be inserted here -->
    </div>
  </div>
  <!-- Share Group Modal -->
  <div class="modal-backdrop" id="shareGroupModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Share Group</div>
        <div class="modal-description">Share this link to invite others to join your group</div>
      </div>
      <input type="text" class="modal-input" id="shareGroupInput" readonly>
      <div class="modal-actions">
        <button class="modal-btn cancel" id="shareGroupCancel">Close</button>
        <button class="modal-btn confirm" id="shareGroupCopy">Copy Link</button>
      </div>
    </div>
  </div>
  <!-- Edit Message Modal -->
  <div class="modal-backdrop" id="editMessageModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Edit Message</div>
        <div class="modal-description">Update your message below</div>
      </div>
      <input type="text" class="modal-input" id="editMessageInput" placeholder="Type your message...">
      <div class="modal-actions">
        <button class="modal-btn cancel" id="editMessageCancel">Cancel</button>
        <button class="modal-btn confirm" id="editMessageConfirm">Update</button>
      </div>
    </div>
  </div>
  <!-- Delete Message Modal -->
  <div class="modal-backdrop" id="deleteMessageModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Delete Message</div>
        <div class="modal-description">Are you sure you want to delete this message? This action cannot be undone.</div>
      </div>
      <div class="modal-actions">
        <button class="modal-btn cancel" id="deleteMessageCancel">Cancel</button>
        <button class="modal-btn delete" id="deleteMessageConfirm">Delete</button>
      </div>
    </div>
  </div>
  <!-- File Preview Modal -->
  <div class="modal-backdrop" id="filePreviewModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Send File</div>
        <div class="modal-description">Review your file before sending.</div>
      </div>
      <div id="filePreviewContent" style="text-align: center; margin-bottom: 1.5rem;">
        <!-- Preview will be inserted here -->
      </div>
      <div class="modal-actions">
        <button class="modal-btn cancel" id="filePreviewCancel">Cancel</button>
        <button class="modal-btn confirm" id="filePreviewSend">Send</button>
      </div>
    </div>
  </div>
  <!-- Admin Panel Modal -->
  <div class="modal-backdrop" id="adminModal">
    <div class="modal-content" style="width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto;">
      <div class="modal-header">
        <div class="modal-title">Admin Panel</div>
      </div>
      <div id="adminActions" style="display: flex; flex-direction: column; gap: 0.5rem; padding: 1rem 0;"></div>
      <div class="modal-actions">
        <button class="modal-btn cancel" id="closeAdmin">Close</button>
      </div>
    </div>
  </div>
  <script>
    // This function is now globally available and can be called by event listeners.
    function showFilePreview(file) {
      const filePreviewContent = document.getElementById('filePreviewContent');
      const filePreviewModal = document.getElementById('filePreviewModal');
      if (!filePreviewContent || !filePreviewModal) {
        console.error('File preview modal elements not found!');
        return;
      }
      let previewHtml = '';
      const fileType = file.type.split('/')[0];
      if (fileType === 'image') {
        previewHtml = `<img src="${URL.createObjectURL(file)}" style="max-height: 200px; border-radius: 8px;">`;
      } else if (fileType === 'video') {
        previewHtml = `<video src="${URL.createObjectURL(file)}" controls style="max-height: 200px; border-radius: 8px;"></video>`;
      } else {
        previewHtml = `<div class="file-attachment-card" style="background: var(--msg-bg);"><div class="file-icon-wrapper"><i class="fas fa-file-alt"></i></div><div class="file-info"><div class="file-name">${file.name}</div><div class="file-meta">${formatFileSize(file.size)}</div></div></div>`;
      }
      filePreviewContent.innerHTML = previewHtml;
      filePreviewModal.classList.add('visible');
    }
  </script>
  <script type="module">
import { supabase } from './js/supabaseClient.js';
const session = await supabase.auth.getSession();
if (!session.data.session) location = 'login.html';
const user = session.data.session.user;
const gid = new URLSearchParams(location.search).get('groupId');
let replyingMsg = null;
let isRecording = false;
let editingMessage = null;
let deletingMessage = null;
let groupCreatorId = null;
let mediaRecorder = null;
let stagedFile = null;
let audioChunks = [];
let recordingTimer = null;
let recordingSeconds = 0;
let userRole = 'member';
let isPublic = false;
let groupInfo = {};
// AI User Configuration
const AI_USER_ID = 'bdb2a62c-7ef7-4f1d-a67a-a3290d276cbe';
const AI_USER_NAME = 'PeerPal AI';
const GEMINI_API_KEY = 'AIzaSyDCLod_PPMVxTli2Y285MtkOkBAxlAfQ88';
// AI Models for PeerPal - UPDATED: Only use gemini-2.5-flash-lite
const AI_MODELS = ['gemini-2.5-flash-lite'];
// Elements
const messagePanel = document.getElementById('messagePanel');
const emojiButton = document.getElementById('emojiButton');
const emojiPickerBox = document.getElementById('emojiPickerBox');
const mentionListBox = document.getElementById('mentionListBox');
const messageBar = document.getElementById('messageBar');
const sendMessageButton = document.getElementById('sendMessageButton');
const fileShareButton = document.getElementById('fileShareButton');
const voiceCallButton = document.getElementById('voiceCallButton');
const videoCallButton = document.getElementById('videoCallButton');
const recordAudioButton = document.getElementById('recordAudioButton');
const recordingIndicator = document.getElementById('recordingIndicator');
const recordingTime = document.getElementById('recordingTime');
const groupTitle = document.getElementById('groupTitle');
const themeToggleButton = document.getElementById('themeToggleButton');
const replyContextBox = document.getElementById('replyContextBox');
const replyContextSender = document.getElementById('replyContextSender');
const replyContextText = document.getElementById('replyContextText');
const replyContextClose = document.getElementById('replyContextClose');
const body = document.body;
const groupDrawer = document.getElementById('groupDrawer');
const membersList = document.getElementById('membersList');
const leaveGroupBtn = document.getElementById('leaveGroupBtn');
const shareGroupBtn = document.getElementById('shareGroupBtn');
const drawerBackdrop = document.getElementById('drawerBackdrop');
const backButton = document.getElementById('backButton');
const adminPanelButton = document.getElementById('adminPanelButton');
const adminModal = document.getElementById('adminModal');
const closeAdmin = document.getElementById('closeAdmin');
// Modal elements
const shareGroupModal = document.getElementById('shareGroupModal');
const shareGroupInput = document.getElementById('shareGroupInput');
const shareGroupCancel = document.getElementById('shareGroupCancel');
const shareGroupCopy = document.getElementById('shareGroupCopy');
const editMessageModal = document.getElementById('editMessageModal');
const editMessageInput = document.getElementById('editMessageInput');
const editMessageCancel = document.getElementById('editMessageCancel');
const editMessageConfirm = document.getElementById('editMessageConfirm');
const deleteMessageModal = document.getElementById('deleteMessageModal');
const deleteMessageCancel = document.getElementById('deleteMessageCancel');
const deleteMessageConfirm = document.getElementById('deleteMessageConfirm');
const filePreviewModal = document.getElementById('filePreviewModal');
const filePreviewContent = document.getElementById('filePreviewContent');
const filePreviewCancel = document.getElementById('filePreviewCancel');
const filePreviewSend = document.getElementById('filePreviewSend');
let memberDetails = [];
let isMember = false;
let aiResponseInProgress = false; // Track if AI response is already in progress
// Theme toggle
const applyTheme = (theme) => {
  body.dataset.theme = theme;
  themeToggleButton.textContent = theme === 'dark' ? 'â˜€ï¸' : 'ðŸŒ™';
  localStorage.setItem('vibe-theme', theme);
};
themeToggleButton.onclick = () => applyTheme(body.dataset.theme === 'dark' ? 'light' : 'dark');
applyTheme(localStorage.getItem('vibe-theme') || 'dark');
// Back button functionality
backButton.onclick = () => {
  window.location.href = 'dashboard.html'; // Update with your actual dashboard URL
};
// Load group info
// Load members with proper profile data
async function loadMembers() {
  try {
    console.log('Loading members for group:', gid);
    const { data, error } = await supabase
      .from('group_members')
      .select(`
        user_id,
        role,
        joined_at,
        profiles ( id, username, full_name, profile_photo )
      `)
      .eq('group_id', gid);
    if (error) {
      console.error('Error loading members with profiles:', error);
      memberDetails = [];
      return;
    }
    memberDetails = data || [];
    isMember = memberDetails.some(m => m.user_id === user.id);
    console.log('Final member details:', memberDetails);
  
  } catch (err) {
    console.error('Unexpected error loading members:', err);
    memberDetails = [];
  }
}
await loadMembers();
// Fetch group info
const { data: grp, error: grpError } = await supabase
  .from('groups')
  .select('name, description, created_by, is_public, course_code')
  .eq('id', gid)
  .single();
if (grpError) {
  console.error('Error fetching group info:', grpError);
} else {
  groupInfo = grp;
  groupCreatorId = grp.created_by;
  isPublic = grp.is_public || false;
  groupTitle.innerHTML = `<span>${grp.name}</span><br><small style="font-size: 0.8rem; opacity: 0.7; font-style: italic;">${grp.description || ''}</small>`;
}
// Determine user role
const userMember = memberDetails.find(m => m.user_id === user.id);
userRole = userMember ? (userMember.role || 'member') : 'member';
if (user.id === groupCreatorId) {
  userRole = 'owner';
}
// Show/hide admin panel button
if (userRole === 'member') {
  adminPanelButton.style.display = 'none';
} else {
  adminPanelButton.style.display = 'flex';
  adminPanelButton.onclick = () => {
    renderAdminActions();
    adminModal.querySelector('.modal-title').textContent = `Admin Panel - ${userRole}`;
    adminModal.classList.add('visible');
  };
}
// Close admin modal
closeAdmin.onclick = () => adminModal.classList.remove('visible');
adminModal.addEventListener('click', (e) => {
  if (e.target === adminModal) {
    adminModal.classList.remove('visible');
  }
});
// Check if AI user is in the group, if not add them
async function ensureAIUserInGroup() {
  const isAIInGroup = memberDetails.some(m => m.user_id === AI_USER_ID);
  if (!isAIInGroup) {
    console.log('Adding AI user to group...');
    try {
      const { error } = await supabase
        .from('group_members')
        .insert({
          group_id: gid,
          user_id: AI_USER_ID,
          role: 'ai'
        });
    
      if (error && error.code !== '23505') {
        console.log('Error adding AI user to group:', error);
      } else {
        await loadMembers();
      }
    } catch (err) {
      console.log('Unexpected error adding AI user:', err);
    }
  }
}
await ensureAIUserInGroup();
// ---------- Enhanced Mention System ----------
let mentionUsers = [];
let currentMentionQuery = '';
const createDefaultAvatar = (name) => {
  const canvas = document.createElement('canvas');
  canvas.width = 64;
  canvas.height = 64;
  const ctx = canvas.getContext('2d');
  const colors = ['#4a90e2', '#50e3c2', '#9013fe', '#f5a623', '#d0021b'];
  const color = colors[name.length % colors.length];
  ctx.fillStyle = color;
  ctx.fillRect(0, 0, 64, 64);
  ctx.fillStyle = 'white';
  ctx.font = '24px Arial';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.fillText(name.charAt(0).toUpperCase(), 32, 32);
  return canvas.toDataURL();
};
function getDisplayName(member) {
  if (member.user_id === AI_USER_ID) {
    return AI_USER_NAME;
  }
  if (member.profiles) {
    return member.profiles.full_name || member.profiles.username || `User ${member.user_id.substring(0,6)}`;
  }
  return `User ${member.user_id.substring(0,6)}`;
}
function initMentionSystem() {
  mentionUsers = [
    {
      id: AI_USER_ID,
      name: AI_USER_NAME,
      username: '@PeerPal AI',
      isAI: true,
      avatar: createDefaultAvatar('AI')
    }
  ];
  if (memberDetails && memberDetails.length > 0) {
    memberDetails.forEach(member => {
      if (member.user_id !== AI_USER_ID) {
        const displayName = getDisplayName(member);
        const username = `@${displayName}`;
      
        mentionUsers.push({
          id: member.user_id,
          name: displayName,
          username: username,
          isAI: false,
          avatar: member.profiles?.profile_photo || createDefaultAvatar(displayName)
        });
      }
    });
  }
  console.log('Mention Users:', mentionUsers);
  messageBar.addEventListener('input', handleMentionInput);
  messageBar.addEventListener('keydown', handleMentionNavigation);
  messageBar.addEventListener('blur', () => {
    setTimeout(() => {
      if (!mentionListBox.matches(':hover')) {
        mentionListBox.style.display = 'none';
      }
    }, 200);
  });
  document.addEventListener('click', (e) => {
    if (!mentionListBox.contains(e.target) && e.target !== messageBar) {
      mentionListBox.style.display = 'none';
    }
  });
}
function handleMentionInput(e) {
  const text = messageBar.value;
  const cursorPos = messageBar.selectionStart;
  const textBeforeCursor = text.substring(0, cursorPos);
  const lastAtPos = textBeforeCursor.lastIndexOf('@');
  if (lastAtPos !== -1) {
    const charBeforeAt = lastAtPos > 0 ? textBeforeCursor[lastAtPos - 1] : ' ';
    if (lastAtPos === 0 || charBeforeAt === ' ' || charBeforeAt === '\n') {
      currentMentionQuery = textBeforeCursor.substring(lastAtPos + 1).toLowerCase();
      showMentionList();
      return;
    }
  }
  mentionListBox.style.display = 'none';
}
function showMentionList() {
  if (!currentMentionQuery) {
    renderMentionList(mentionUsers);
    return;
  }
  const filteredUsers = mentionUsers.filter(user =>
    user.name.toLowerCase().includes(currentMentionQuery) ||
    user.username.toLowerCase().includes(currentMentionQuery)
  );
  renderMentionList(filteredUsers);
}
function renderMentionList(users) {
  mentionListBox.innerHTML = '';
  if (users.length === 0) {
    mentionListBox.style.display = 'none';
    return;
  }
  users.forEach(user => {
    const item = document.createElement('div');
    item.className = `mention-item ${user.isAI ? 'ai-mention' : ''}`;
    item.innerHTML = `
      <img src="${user.avatar}" class="mention-avatar" alt="${user.name}">
      <span>${user.name}</span>
      ${user.isAI ? '<span class="mention-badge">AI</span>' : ''}
    `;
  
    item.addEventListener('click', () => {
      console.log('Mention selected:', user.name);
      selectMention(user);
    });
    mentionListBox.appendChild(item);
  });
  // FIXED: Mention list opens UPWARDS
  const rect = messageBar.getBoundingClientRect();
  mentionListBox.style.left = `${rect.left + window.scrollX}px`;
  // Position above the input area
  mentionListBox.style.bottom = `${window.innerHeight - rect.top + window.scrollY + 10}px`;
  mentionListBox.style.top = 'auto';
  mentionListBox.style.width = `${rect.width}px`;
  mentionListBox.style.display = 'flex';
}
function handleMentionNavigation(e) {
  if (mentionListBox.style.display !== 'flex') return;
  const items = mentionListBox.querySelectorAll('.mention-item');
  const activeItem = mentionListBox.querySelector('.mention-item.active');
  let activeIndex = activeItem ? Array.from(items).indexOf(activeItem) : -1;
  switch(e.key) {
    case 'ArrowDown':
      e.preventDefault();
      activeIndex = (activeIndex + 1) % items.length;
      break;
    case 'ArrowUp':
      e.preventDefault();
      activeIndex = activeIndex <= 0 ? items.length - 1 : activeIndex - 1;
      break;
    case 'Enter':
      e.preventDefault();
      if (activeItem) {
        const userName = activeItem.querySelector('span').textContent;
        const user = mentionUsers.find(u => u.name === userName);
        if (user) {
          selectMention(user);
        }
      }
      return;
    case 'Escape':
      mentionListBox.style.display = 'none';
      return;
    default:
      return;
  }
  items.forEach(item => item.classList.remove('active'));
  if (items[activeIndex]) {
    items[activeIndex].classList.add('active');
  }
}
function selectMention(selectedUser) {
  console.log('Selecting mention:', selectedUser.name);
  const text = messageBar.value;
  const cursorPos = messageBar.selectionStart;
  const textBeforeCursor = text.substring(0, cursorPos);
  const lastAtPos = textBeforeCursor.lastIndexOf('@');
  if (lastAtPos !== -1) {
    const newText = text.substring(0, lastAtPos) + selectedUser.username + ' ' + text.substring(cursorPos);
    messageBar.value = newText;
  
    const newCursorPos = lastAtPos + selectedUser.username.length + 1;
    setTimeout(() => {
      messageBar.setSelectionRange(newCursorPos, newCursorPos);
      messageBar.focus();
    }, 10);
  }
  mentionListBox.style.display = 'none';
  currentMentionQuery = '';
}
function processMentions(content) {
  let processedContent = content;
  const mentionRegex = /(@[^\s]+)/g;
  const mentions = content.match(mentionRegex);
  if (mentions) {
    mentions.forEach(mention => {
      const username = mention.substring(1);
      const user = mentionUsers.find(u =>
        u.name.toLowerCase().includes(username.toLowerCase()) ||
        u.username.toLowerCase() === mention.toLowerCase()
      );
    
      if (user) {
        const mentionClass = user.isAI ? 'mention ai-mention' : 'mention';
        const mentionHtml = `<span class="${mentionClass}" data-user-id="${user.id}">${mention}</span>`;
        processedContent = processedContent.replace(mention, mentionHtml);
      }
    });
  }
  return processedContent;
}
function handleAIMentionClick(userId) {
  console.log('AI mention clicked:', userId);
  if (userId === AI_USER_ID) {
    messageBar.value = messageBar.value.trim() + ' @PeerPal AI ';
    messageBar.focus();
  
    setTimeout(() => {
      checkPeerloomAI('@PeerPal AI');
    }, 500);
  }
}
// ---------- CLEAN TRANSPARENT GLASS DRAWER BEHAVIOUR ----------
function renderMembers() {
  membersList.innerHTML = '';
  // FIXED: Add "Add Member" button at the top for admins
  if (userRole !== 'member') {
    const addBtn = document.createElement('button');
    addBtn.innerHTML = '<i class="fas fa-user-plus"></i> Add Member';
    addBtn.style.cssText = 'display: flex; align-items: center; gap: 0.5rem; padding: 0.7rem; border-radius: 14px; background: rgba(74,144,226,0.2); border: 1px solid var(--accent); color: var(--accent); cursor: pointer; margin-bottom: 0.5rem; font-size: 0.9rem; justify-content: center;';
    addBtn.onclick = showAddMemberPrompt;
    membersList.appendChild(addBtn);
  }
  // Filter out the AI user from the list to be rendered
  const humanMembers = memberDetails.filter(member => member.user_id !== AI_USER_ID);
  if (humanMembers.length === 0) {
    const empty = document.createElement('div');
    empty.className = 'member-item';
    empty.innerHTML = `<div class="member-name">No members found in this group</div>`;
    membersList.appendChild(empty);
    return;
  }
  humanMembers.forEach(member => {
    const displayName = getDisplayName(member);
    const role = member.role || 'member';
    const avatarUrl = member.profiles?.profile_photo || createDefaultAvatar(displayName);
    const item = document.createElement('div');
    item.className = 'member-item';
    item.innerHTML = `
      <img src="${avatarUrl}" class="member-avatar" alt="${displayName}">
      <div class="member-info">
        <div class="member-name">${displayName}</div>
        <div class="member-role">${role.charAt(0).toUpperCase() + role.slice(1)}</div>
      </div>
      <div class="member-status"></div>
    `;
    // Add admin actions if viewer is admin/moderator/owner
    if (userRole !== 'member' && member.user_id !== user.id) {
      const actionsDiv = document.createElement('div');
      actionsDiv.className = 'member-actions';
      const promoteBtn = document.createElement('button');
      promoteBtn.className = 'member-action promote';
      promoteBtn.innerHTML = '<i class="fas fa-star"></i>';
      promoteBtn.title = role === 'member' ? 'Promote to Admin' : (role === 'admin' ? 'Demote to Member' : 'Change Role');
      promoteBtn.onclick = async (e) => {
        e.stopPropagation();
        let newRole = 'member';
        if (role === 'member') newRole = 'admin';
        else if (role === 'admin') newRole = 'member';
        // For multiple levels, could have a sub-menu, but simple toggle for now
        const { error } = await supabase
          .from('group_members')
          .update({ role: newRole })
          .eq('group_id', gid)
          .eq('user_id', member.user_id);
        if (error) {
          alert('Error updating role: ' + error.message);
        } else {
          await loadMembers();
          renderMembers();
        }
      };
      const removeBtn = document.createElement('button');
      removeBtn.className = 'member-action remove';
      removeBtn.innerHTML = '<i class="fas fa-times"></i>';
      removeBtn.title = 'Remove Member';
      removeBtn.onclick = async (e) => {
        e.stopPropagation();
        if (member.user_id === groupCreatorId) {
          return alert('Cannot remove the group owner.');
        }
        if (confirm(`Remove ${displayName} from the group?`)) {
          const { error } = await supabase
            .from('group_members')
            .delete()
            .eq('group_id', gid)
            .eq('user_id', member.user_id);
          if (error) {
            alert('Error removing member: ' + error.message);
          } else {
            await loadMembers();
            renderMembers();
          }
        }
      };
      actionsDiv.appendChild(promoteBtn);
      actionsDiv.appendChild(removeBtn);
      item.appendChild(actionsDiv);
    }
    membersList.appendChild(item);
  });
}
// FIXED: Add member functionality
async function showAddMemberPrompt() {
  const username = prompt('Enter exact username to add:');
  if (!username) return;
  try {
    const { data, error } = await supabase
      .from('profiles')
      .select('id, username, full_name')
      .eq('username', username.toLowerCase())
      .single();
    if (error && error.code !== 'PGRST116') {
      alert('Error searching user: ' + error.message);
      return;
    }
    if (!data) {
      alert('User not found.');
      return;
    }
    await addMember(data.id);
  } catch (err) {
    alert('Error: ' + err.message);
  }
}
async function addMember(userIdToAdd) {
  if (userIdToAdd === user.id) {
    return alert('You are already a member.');
  }
  const existing = memberDetails.find(m => m.user_id === userIdToAdd);
  if (existing) {
    return alert('User already in group.');
  }
  const { error } = await supabase
    .from('group_members')
    .insert({
      group_id: gid,
      user_id: userIdToAdd,
      role: 'member'
    });
  if (error) {
    alert('Error adding member: ' + error.message);
  } else {
    await loadMembers();
    renderMembers();
    alert('Member added successfully!');
  }
}
function openDrawer() {
  renderMembers();
  groupDrawer.classList.add('open');
  groupDrawer.setAttribute('aria-hidden', 'false');
  drawerBackdrop.classList.add('visible');
}
function closeDrawer() {
  groupDrawer.classList.remove('open');
  groupDrawer.setAttribute('aria-hidden', 'true');
  drawerBackdrop.classList.remove('visible');
}
groupTitle.addEventListener('click', (e) => {
  e.stopPropagation();
  if (groupDrawer.classList.contains('open')) {
    closeDrawer();
  } else {
    openDrawer();
  }
});
drawerBackdrop.addEventListener('click', () => closeDrawer());
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape' && groupDrawer.classList.contains('open')) closeDrawer();
});
// ---------- Share Group Feature ----------
shareGroupBtn.onclick = (e) => {
  createRipple(e);
  const groupUrl = `${window.location.origin}${window.location.pathname}?groupId=${gid}`;
  shareGroupInput.value = groupUrl;
  shareGroupModal.classList.add('visible');
};
shareGroupCancel.onclick = () => {
  shareGroupModal.classList.remove('visible');
};
shareGroupCopy.onclick = () => {
  shareGroupInput.select();
  document.execCommand('copy');
  shareGroupCopy.textContent = 'Copied!';
  setTimeout(() => {
    shareGroupCopy.textContent = 'Copy Link';
  }, 2000);
};
shareGroupModal.addEventListener('click', (e) => {
  if (e.target === shareGroupModal) {
    shareGroupModal.classList.remove('visible');
  }
});
// ---------- Leave group with ripple ----------
leaveGroupBtn.onclick = async (e) => {
  createRipple(e);
  if (confirm('Leave group?')) {
    await supabase.from('group_members').delete().eq('group_id', gid).eq('user_id', user.id);
    closeDrawer();
    location.reload();
  }
};
function createRipple(event) {
  const button = event.currentTarget;
  const circle = document.createElement('span');
  const diameter = Math.max(button.clientWidth, button.clientHeight);
  const radius = diameter / 2;
  circle.style.width = circle.style.height = `${diameter}px`;
  circle.style.left = `${event.clientX - button.getBoundingClientRect().left - radius}px`;
  circle.style.top = `${event.clientY - button.getBoundingClientRect().top - radius}px`;
  circle.classList.add('ripple');
  const ripple = button.getElementsByClassName('ripple')[0];
  if (ripple) ripple.remove();
  button.appendChild(circle);
}
document.addEventListener('click', (e) => {
  if (groupDrawer.classList.contains('open') && !groupDrawer.contains(e.target) && !groupTitle.contains(e.target)) {
    closeDrawer();
  }
});
// ---------- Download Tracking & Animation ----------
const downloadedFiles = new Set(JSON.parse(localStorage.getItem('downloadedFiles') || '[]'));
function isDownloaded(url) {
  return downloadedFiles.has(url);
}
function markAsDownloaded(url) {
  downloadedFiles.add(url);
  localStorage.setItem('downloadedFiles', JSON.stringify(Array.from(downloadedFiles)));
}
async function downloadWithAnimation(event, url, filename) {
  event.preventDefault();
  event.stopPropagation();
  const downloadButton = event.currentTarget;
  if (downloadButton.classList.contains('downloading')) return;
  const originalContent = downloadButton.innerHTML;
  downloadButton.innerHTML = '<div class="download-animation"></div>';
  downloadButton.classList.add('downloading');
  try {
    // Fetch the file as a blob
    const response = await fetch(url);
    if (!response.ok) throw new Error('Network response was not ok.');
    const blob = await response.blob();
    // Create a temporary link to trigger the download
    const tempUrl = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.style.display = 'none';
    a.href = tempUrl;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    window.URL.revokeObjectURL(tempUrl);
    a.remove();
    // Mark as downloaded and hide the button
    markAsDownloaded(url);
    downloadButton.style.display = 'none';
  } catch (error) {
    console.error('Download failed:', error);
    alert('Download failed. Please try again.');
    downloadButton.innerHTML = originalContent; // Restore button on error
  } finally {
    downloadButton.classList.remove('downloading');
  }
}
// Make download functions globally available
window.isDownloaded = isDownloaded;
window.downloadWithAnimation = downloadWithAnimation;
// ---------- ULTRA GLASSY VOICE MESSAGE BUBBLES ----------
function createVoiceMessageBubble(audioUrl, isSent, duration, messageId) {
  const bubble = document.createElement('div');
  bubble.className = 'voice-message-bubble';
  const playBtn = document.createElement('div');
  playBtn.className = 'voice-play-btn';
  playBtn.innerHTML = '<i class="fas fa-play"></i>';
  const waveform = document.createElement('div');
  waveform.className = 'voice-waveform';
  // Create waveform bars
  for (let i = 0; i < 10; i++) {
    const bar = document.createElement('div');
    bar.className = 'wave-bar';
    bar.style.height = `${8 + Math.random() * 22}px`;
    waveform.appendChild(bar);
  }
  const durationSpan = document.createElement('div');
  durationSpan.className = 'voice-duration';
  durationSpan.textContent = formatTime(duration || 0);
  bubble.appendChild(playBtn);
  bubble.appendChild(waveform);
  bubble.appendChild(durationSpan);
  // Add delete button if sent or admin
  if (isSent || userRole !== 'member') {
    const deleteBtn = document.createElement('div');
    deleteBtn.className = 'voice-delete-btn';
    deleteBtn.innerHTML = '<i class="fas fa-times"></i>';
    deleteBtn.title = 'Delete voice message';
  
    deleteBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      showDeleteMessageModal(messageId);
    });
  
    bubble.appendChild(deleteBtn);
  }
  // Create hidden audio element
  const audio = document.createElement('audio');
  audio.src = audioUrl;
  audio.preload = 'metadata';
  let isPlaying = false;
  let animationId = null;
  playBtn.addEventListener('click', (e) => {
    e.stopPropagation();
  
    if (isPlaying) {
      audio.pause();
      stopWaveAnimation(waveform);
      playBtn.innerHTML = '<i class="fas fa-play"></i>';
      bubble.classList.remove('playing');
    } else {
      audio.play();
      startWaveAnimation(waveform);
      playBtn.innerHTML = '<i class="fas fa-pause"></i>';
      bubble.classList.add('playing');
    }
  
    isPlaying = !isPlaying;
  });
  audio.addEventListener('ended', () => {
    stopWaveAnimation(waveform);
    playBtn.innerHTML = '<i class="fas fa-play"></i>';
    bubble.classList.remove('playing');
    isPlaying = false;
  });
  audio.addEventListener('loadedmetadata', () => {
    const audioDuration = Math.round(audio.duration);
    durationSpan.textContent = formatTime(audioDuration);
  });
  return bubble;
}
function startWaveAnimation(waveform) {
  const bars = waveform.querySelectorAll('.wave-bar');
  let animationFrame;
  function animate() {
    bars.forEach(bar => {
      const randomHeight = 8 + Math.random() * 25;
      bar.style.height = `${randomHeight}px`;
    });
    animationFrame = requestAnimationFrame(animate);
  }
  animate();
  // Store the animation ID on the waveform element
  waveform.animationId = animationFrame;
}
function stopWaveAnimation(waveform) {
  if (waveform.animationId) {
    cancelAnimationFrame(waveform.animationId);
    waveform.animationId = null;
  }
  const bars = waveform.querySelectorAll('.wave-bar');
  bars.forEach(bar => {
    bar.style.height = '8px';
  });
}
function formatTime(seconds) {
  const mins = Math.floor(seconds / 60);
  const secs = Math.floor(seconds % 60);
  return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
}
// ---------- Messages rendering & history ----------
function render(m) {
  const mine = m.sender_id === user.id;
  const isAI = m.sender_id === AI_USER_ID;
  let senderName;
  if (mine) {
    senderName = user.user_metadata.firstName || user.user_metadata.full_name || 'You';
  } else if (isAI) {
    senderName = AI_USER_NAME;
  } else {
    const senderMember = memberDetails.find(member => member.user_id === m.sender_id);
    if (senderMember) {
      senderName = getDisplayName(senderMember);
    } else {
      senderName = m.sender_name || `User ${m.sender_id.substring(0,6)}`;
    }
  }
  const div = document.createElement('div');
  div.className = `msg ${mine ? 'sent' : isAI ? 'ai' : 'recv'}`;
  div.dataset.id = m.id;
  if (m.reply_to) {
    const br = document.createElement('div');
    br.className = 'reply-banner';
    br.textContent = `${m.reply_to_sender}: ${m.reply_to_text}`;
    div.append(br);
  }
  const nameTag = document.createElement('div');
  nameTag.className = 'sender-name';
  nameTag.textContent = senderName;
  const ct = document.createElement('div');
  if (m.message_type === 'placeholder') {
    ct.innerHTML = m.content;
  } else if (m.message_type === 'uploading') {
    const fileExt = m.file_name?.split('.').pop()?.toUpperCase() || 'FILE';
    ct.innerHTML = `
      <div class="file-attachment-card">
        <div class="file-icon-wrapper"><i class="fas fa-file-alt"></i></div>
        <div class="file-info">
          <div class="file-name">${m.file_name}</div>
          <div class="upload-progress-container"><div class="upload-progress-bar-wrapper"><div class="upload-progress-bar" id="progress-${m.id}"></div></div><span class="upload-progress-text" id="progress-text-${m.id}">0%</span></div>
        </div>
      </div>
    `;
  } else if (m.message_type === 'audio' && m.audio_url) {
    // Create ultra glassy voice message bubble
    const voiceBubble = createVoiceMessageBubble(m.audio_url, mine, null, m.id);
    ct.appendChild(voiceBubble);
  } else if (m.message_type === 'image') {
    div.style.padding = '0.3rem';
    div.style.backgroundColor = 'transparent';
    ct.innerHTML = `<div class="media-container">
                      <img src="${m.content}" alt="${m.file_name || 'Image'}"
                           style="width: 100%; display: block; border-radius: 15px; cursor: pointer;"
                           onclick="openLightbox('${m.content}', 'image')">
                      ${!isDownloaded(m.content) ? `
                        <a href="#" class="media-download-btn" title="Download" onclick="downloadWithAnimation(event, '${m.content}', '${m.file_name || 'image'}')"><i class="fas fa-download"></i></a>
                      ` : ''}
                    </div>`;
  } else if (m.message_type === 'video') {
    div.style.padding = '0.3rem';
    div.style.backgroundColor = 'transparent';
    ct.innerHTML = `<div class="media-container" style="cursor: pointer;" onclick="openLightbox('${m.content}', 'video')">
                      <video src="${m.content}#t=0.1" preload="metadata" style="width: 100%; display: block; border-radius: 15px; pointer-events: none;"></video>
                      <div class="media-play-btn">
                        <i class="fas fa-play"></i>
                      </div>
                      ${!isDownloaded(m.content) ? `
                        <a href="#" class="media-download-btn" title="Download" onclick="event.stopPropagation(); downloadWithAnimation(event, '${m.content}', '${m.file_name || 'video'}')"><i class="fas fa-download"></i></a>
                      ` : ''}
                    </div>`;
  } else if (m.message_type === 'file') {
    const fileExt = m.file_name?.split('.').pop()?.toUpperCase() || 'FILE';
    ct.innerHTML = `
      <div class="file-attachment-card">
        <div class="file-icon-wrapper">
          <i class="fas fa-file-alt"></i>
        </div>
        <div class="file-info">
          <div class="file-name">${m.file_name || 'File'}</div>
          <div class="file-meta">${formatFileSize(m.file_size)} â€¢ ${fileExt} Document</div>
        </div>
        <a href="${m.content}" download="${m.file_name || 'File'}" class="download-btn-wrapper" title="Download">
          <i class="fas fa-download"></i>
        </a>
      </div>`;
  } else {
    ct.innerHTML = processMentions(m.content);
  }
  const ts = document.createElement('div');
  ts.className = 'timestamp';
  ts.textContent = new Date(m.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  div.append(nameTag, ct, ts);
  messagePanel.append(div);
  messagePanel.scrollTop = messagePanel.scrollHeight;
  const aiMentions = div.querySelectorAll('.mention.ai-mention');
  aiMentions.forEach(mention => {
    mention.addEventListener('click', (e) => {
      e.stopPropagation();
      const userId = mention.dataset.userId;
      handleAIMentionClick(userId);
    });
  });
  // For voice messages, only attach delete gesture for own messages
  if (m.message_type === 'audio' && mine) {
    attachDeleteGesture(div, m);
  } else if (m.message_type !== 'audio') {
    // For text messages, attach full gestures
    attachGestures(div, mine, m);
  }
}
async function loadHistory() {
  const { data } = await supabase.from('group_messages').select('*').eq('group_id', gid).order('created_at');
  messagePanel.innerHTML = '';
  data.forEach(render);
}
await loadHistory();
// ---------- FIXED TYPING INDICATORS - NO DUPLICATES ----------
let typingUsers = new Map();
let typingTimeout;
const typingChannel = supabase.channel('typing-indicators', {
  config: {
    broadcast: { self: false }
  }
});
typingChannel
  .on('broadcast', { event: 'typing' }, (payload) => {
    const { user_id, isTyping, user_name } = payload.payload;
  
    if (user_id !== user.id) {
      if (isTyping) {
        typingUsers.set(user_id, { id: user_id, name: user_name });
      } else {
        typingUsers.delete(user_id);
      }
      renderTypingIndicators();
    }
  })
  .subscribe();
messageBar.addEventListener('input', () => {
  clearTimeout(typingTimeout);
  typingChannel.send({
    type: 'broadcast',
    event: 'typing',
    payload: {
      user_id: user.id,
      isTyping: true,
      user_name: user.user_metadata.firstName || user.user_metadata.full_name || 'You'
    }
  });
  typingTimeout = setTimeout(() => {
    typingChannel.send({
      type: 'broadcast',
      event: 'typing',
      payload: {
        user_id: user.id,
        isTyping: false,
        user_name: user.user_metadata.firstName || user.user_metadata.full_name || 'You'
      }
    });
  }, 1000);
});
function renderTypingIndicators() {
  document.querySelectorAll('.typing-indicator').forEach(el => {
    if (!el.classList.contains('ai')) {
      el.remove();
    }
  });
  typingUsers.forEach(typingUser => {
    const typingDiv = document.createElement('div');
    typingDiv.className = 'typing-indicator';
    typingDiv.id = `typing-${typingUser.id}`;
    typingDiv.innerHTML = `
      <div class="sender-name">${typingUser.name}</div>
      <div class="typing-dots">
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
      </div>
    `;
    messagePanel.appendChild(typingDiv);
  });
  messagePanel.scrollTop = messagePanel.scrollHeight;
}
// FIXED: Real-time updates for ALL messages with improved AI reply detection
const messageChannel = supabase.channel(`grp_${gid}`)
  .on('postgres_changes', {
    event: 'INSERT',
    schema: 'public',
    table: 'group_messages',
    filter: `group_id=eq.${gid}`
  }, async (payload) => {
    console.log('New message received:', payload.new);
  
    // Check if we already have this message rendered
    const existingMessage = document.querySelector(`.msg[data-id="${payload.new.id}"]`);
    if (existingMessage) {
      console.log('Message already rendered, skipping');
      return;
    }
  
    if (payload.new.sender_id !== user.id) {
      hideAITypingIndicator();
      render(payload.new);
    
      // FIXED: Enhanced AI response detection for replies to AI messages
      if (payload.new.reply_to) {
        console.log('Message has reply_to, checking if it\'s a reply to AI...');
        const isReplyToAI = await checkIfReplyToAI(payload.new);
        if (isReplyToAI) {
          console.log('Message is a reply to AI, triggering response');
          // Add a small delay to make it feel more natural
          setTimeout(async () => {
            await checkPeerloomAI(payload.new.content || 'Hello');
          }, 1000);
        }
      } else if (payload.new.sender_id !== AI_USER_ID && payload.new.sender_id !== user.id) {
        checkForAIResponse(payload.new);
      }
    }
  })
  .subscribe();
// FIXED: Improved function to check if message is a reply to AI
async function checkIfReplyToAI(message) {
  try {
    console.log('Checking if message is reply to AI, reply_to ID:', message.reply_to);
  
    const { data, error } = await supabase
      .from('group_messages')
      .select('sender_id')
      .eq('id', message.reply_to)
      .single();
  
    if (error) {
      console.log('Error checking reply message:', error);
      return false;
    }
  
    console.log('Original message sender:', data.sender_id);
    const isAIReply = data && data.sender_id === AI_USER_ID;
    console.log('Is reply to AI:', isAIReply);
  
    return isAIReply;
  } catch (err) {
    console.log('Error checking if reply to AI:', err);
    return false;
  }
}
// NEW: Improved AI response detection
async function checkForAIResponse(message) {
  // FIXED: Prevent duplicate AI responses
  if (aiResponseInProgress) {
    console.log('AI response already in progress, skipping...');
    return;
  }
  const messageText = message.content ? message.content.toLowerCase() : '';
  console.log('Checking AI response for message:', {
    text: messageText,
    hasAIMention: messageText.includes('@peerpal ai'),
    hasAIKeywords: hasAIKeywords(messageText)
  });
  if ((message.content && messageText.includes('@peerpal ai')) || hasAIKeywords(messageText)) {
    console.log('Triggering AI response');
    // Set flag to prevent duplicate responses
    aiResponseInProgress = true;
  
    // Add a small delay to make it feel more natural
    setTimeout(async () => {
      await checkPeerloomAI(message.content || 'Hello');
    
      // Reset flag after AI response is complete
      setTimeout(() => {
        aiResponseInProgress = false;
      }, 2000); // Add small buffer to prevent rapid consecutive responses
    }, 1000);
  }
}
function hasAIKeywords(text) {
  if (!text) return false;
  const aiKeywords = [
    'peerpal', 'ai', 'assistant', 'bot', 'help', 'question',
    'how to', 'what is', 'can you', 'could you', 'please help',
    'explain', 'tell me', 'show me', 'advice', 'suggestion'
  ];
  return aiKeywords.some(keyword =>
    text.toLowerCase().includes(keyword.toLowerCase())
  );
}
// Emoji and mention handling
emojiButton.onclick = (e) => {
  e.stopPropagation();
  emojiPickerBox.style.display = emojiPickerBox.style.display === 'flex' ? 'none' : 'flex';
  mentionListBox.style.display = 'none';
};
document.addEventListener('click', (e) => {
  if (!emojiButton.contains(e.target) && !emojiPickerBox.contains(e.target)) {
    emojiPickerBox.style.display = 'none';
  }
});
emojiPickerBox.onclick = (e) => {
  if (e.target.tagName === 'SPAN') {
    messageBar.value += e.target.textContent;
    emojiPickerBox.style.display = 'none';
    sendMessageButton.focus();
  }
};
// Populate emoji picker
for (let i = 0; i < 20; i++) {
  const emoji = String.fromCodePoint(0x1F600 + i);
  const span = document.createElement('span');
  span.textContent = emoji;
  emojiPickerBox.appendChild(span);
}
initMentionSystem();
// ---------- ENHANCED AUDIO MESSAGES FUNCTIONALITY ----------
recordAudioButton.onclick = async () => {
  if (!isRecording) {
    await startRecording();
  } else {
    stopRecording();
  }
};
// Recording timer function
function updateRecordingTime() {
  recordingSeconds++;
  const minutes = Math.floor(recordingSeconds / 60);
  const seconds = recordingSeconds % 60;
  recordingTime.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}
async function startRecording() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream);
    audioChunks = [];
    mediaRecorder.ondataavailable = (event) => {
      if (event.data.size > 0) {
        audioChunks.push(event.data);
      }
    };
    mediaRecorder.onstop = async () => {
      const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
      await uploadAudioMessage(audioBlob);
    
      stream.getTracks().forEach(track => track.stop());
    };
    mediaRecorder.start();
    isRecording = true;
    recordAudioButton.classList.add('active');
    recordingIndicator.classList.add('active');
  
    // Start recording timer
    recordingSeconds = 0;
    recordingTimer = setInterval(updateRecordingTime, 1000);
  
    recordingIndicator.onclick = stopRecording;
  
  } catch (error) {
    console.error('Error starting recording:', error);
    alert('Error accessing microphone. Please check permissions.');
  }
}
function stopRecording() {
  if (mediaRecorder && isRecording) {
    mediaRecorder.stop();
    isRecording = false;
    recordAudioButton.classList.remove('active');
    recordingIndicator.classList.remove('active');
  
    // Clear recording timer
    clearInterval(recordingTimer);
    recordingTime.textContent = '00:00';
  }
}
// FIXED: Audio upload with proper error handling
async function uploadAudioMessage(audioBlob) {
  try {
    const fileName = `audio_${Date.now()}_${user.id}.webm`;
  
    // Upload to Supabase Storage
    const { data, error } = await supabase.storage
      .from('group_audios')
      .upload(fileName, audioBlob);
    if (error) {
      console.error('Storage upload error:', error);
      throw error;
    }
    // Get the public URL
    const { data: { publicUrl } } = supabase.storage
      .from('group_audios')
      .getPublicUrl(fileName);
    console.log('Audio uploaded, public URL:', publicUrl);
    // Create audio message in database
    const { data: messageData, error: messageError } = await supabase
      .from('group_messages')
      .insert({
        group_id: gid,
        sender_id: user.id,
        sender_name: user.user_metadata.firstName,
        content: 'Audio message',
        message_type: 'audio',
        audio_url: publicUrl,
        reply_to: replyingMsg?.id,
        reply_to_sender: replyingMsg?.sender_name,
        reply_to_text: replyingMsg?.content
      })
      .select()
      .single();
    if (messageError) {
      console.error('Message insert error:', messageError);
      throw messageError;
    }
    // Render the audio message immediately
    render(messageData);
  
    // Clear reply context if any
    replyingMsg = null;
    replyContextBox.style.display = 'none';
  } catch (error) {
    console.error('Error uploading audio message:', error);
    alert('Error sending audio message. Please try again.');
  }
}
// Send message - FIXED: Now renders immediately
async function sendMsg() {
  const txt = messageBar.value.trim();
  if (!txt) return;
  typingChannel.send({
    type: 'broadcast',
    event: 'typing',
    payload: {
      user_id: user.id,
      isTyping: false,
      user_name: user.user_metadata.firstName || user.user_metadata.full_name || 'You'
    }
  });
  const { data, error } = await supabase.from('group_messages').insert({
    group_id: gid,
    sender_id: user.id,
    sender_name: user.user_metadata.firstName,
    content: txt,
    reply_to: replyingMsg?.id,
    reply_to_sender: replyingMsg?.sender_name,
    reply_to_text: replyingMsg?.content
  }).select().single();
  if (error) {
    alert('Error: ' + error.message);
    return;
  }
  render(data);
  messageBar.value = '';
  replyingMsg = null;
  replyContextBox.style.display = 'none';
  mentionListBox.style.display = 'none';
  // Check if message should trigger AI response
  const hasAIMention = txt.toLowerCase().includes('@peerpal ai');
  const hasAIKeywordsFlag = hasAIKeywords(txt);
  if (hasAIMention || hasAIKeywordsFlag) {
    // Add a small delay to make it feel more natural
    setTimeout(async () => {
      await checkPeerloomAI(txt);
    }, 1000);
  }
}
sendMessageButton.onclick = sendMsg;
messageBar.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMsg(); }
});
// ---------- ENHANCED GEMINI AI INTEGRATION WITH STUDY BUDDY CAPABILITIES ----------
async function checkPeerloomAI(message) {
  try {
    console.log('Calling Gemini AI with message:', message);
  
    // Show typing indicator for AI
    showAITypingIndicator();
  
    // Clean the message by removing the mention if present
    const cleanMessage = message.replace(/@peerpal ai/gi, '').trim();
  
    let aiReply = "I'm here to help! How can I assist you today?";
  
    // Simulate typing delay for better UX (1-2 seconds)
    await new Promise(resolve => setTimeout(resolve, 1000 + Math.random() * 1000));
  
    // Use only gemini-2.5-flash-lite
    try {
      console.log(`Using model: gemini-2.5-flash-lite`);
      
      // Enhanced prompt for Study Buddy capabilities
      const enhancedPrompt = `You are PeerPal AI, an advanced Study Buddy and educational assistant in a chat application called PeerLoom. You specialize in:

1. EXPLAINING CONFUSING TOPICS: Break down complex concepts into simple, understandable explanations
2. GENERATING PRACTICE QUESTIONS: Create relevant practice questions with explanations
3. SUMMARIZING CONTENT: Summarize PDFs, notes, or study materials
4. EXAM PREP HELP: Help students prepare for exams with study strategies and review

A user has sent you this message: "${cleanMessage}".

Please provide a helpful, educational response that is:
- Clear, accurate, and educational
- Conversational and supportive
- Under 150 words
- Tailored to the user's learning needs

If the message asks for an explanation, provide a clear, step-by-step breakdown.
If it requests practice questions, generate 1-2 relevant questions with brief explanations.
If it's about summarizing, offer to help summarize content.
If it's exam-related, provide study tips or review key concepts.
If it's a general question, provide a helpful educational response.

Always maintain a supportive, encouraging tone as a study buddy.`;

      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-lite:generateContent?key=${GEMINI_API_KEY}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          contents: [{
            parts: [{
              text: enhancedPrompt
            }]
          }],
          generationConfig: {
            temperature: 0.7,
            maxOutputTokens: 300,
            topP: 0.9,
          }
        })
      });
    
      if (!response.ok) {
        const errorText = await response.text();
        console.log(`Model gemini-2.5-flash-lite failed:`, errorText);
        throw new Error(`API Error: ${response.status}`);
      }
    
      const data = await response.json();
      console.log(`Model gemini-2.5-flash-lite response:`, data);
    
      if (data && data.candidates && data.candidates[0] && data.candidates[0].content) {
        aiReply = data.candidates[0].content.parts[0].text;
      } else {
        throw new Error('Invalid response format from AI');
      }
    } catch (modelError) {
      console.log(`Error with model gemini-2.5-flash-lite:`, modelError);
      aiReply = generateSmartStudyResponse(cleanMessage);
    }
  
    // Hide typing indicator
    hideAITypingIndicator();
  
    // Insert AI message
    const { data: aiMessage, error: aiError } = await supabase.from('group_messages').insert({
      group_id: gid,
      sender_id: AI_USER_ID,
      sender_name: AI_USER_NAME,
      content: aiReply,
      role: 'ai'
    }).select().single();
  
    if (aiError) {
      console.error('Error inserting AI message:', aiError);
      hideAITypingIndicator();
    } else {
      // FIXED: Immediately render the AI message
      render(aiMessage);
    }
  
  } catch (error) {
    console.error('PeerPal AI Error:', error);
    hideAITypingIndicator();
  
    const cleanMessage = message.replace(/@peerpal ai/gi, '').trim();
    const fallbackResponse = generateSmartStudyResponse(cleanMessage);
  
    const { data: aiMessage, error: aiError } = await supabase.from('group_messages').insert({
      group_id: gid,
      sender_id: AI_USER_ID,
      sender_name: AI_USER_NAME,
      content: fallbackResponse,
      role: 'ai'
    }).select().single();
  
    if (aiError) {
      console.error('Error inserting fallback AI message:', aiError);
    } else {
      // FIXED: Immediately render the fallback AI message
      render(aiMessage);
    }
  }
}
// Enhanced Study Buddy fallback responses
function generateSmartStudyResponse(message) {
  const lowerMessage = message.toLowerCase();
  
  // Study-related responses
  if (lowerMessage.includes('explain') || lowerMessage.includes('what is') || lowerMessage.includes('how does')) {
    return "I'd be happy to explain that! Could you provide more specific details about what you'd like me to break down? I can help clarify complex topics step by step.";
  }
  
  if (lowerMessage.includes('practice') || lowerMessage.includes('question') || lowerMessage.includes('quiz')) {
    return "Great! Let me generate some practice questions for you. What specific topic or subject would you like to practice?";
  }
  
  if (lowerMessage.includes('summary') || lowerMessage.includes('summarize') || lowerMessage.includes('notes')) {
    return "I can help summarize your study materials! Please share the content you'd like me to summarize, and I'll create a concise overview for you.";
  }
  
  if (lowerMessage.includes('exam') || lowerMessage.includes('test') || lowerMessage.includes('study') || lowerMessage.includes('prepare')) {
    return "Exam preparation is important! I can help you create a study plan, review key concepts, or generate practice questions. What specific subject are you preparing for?";
  }
  
  if (lowerMessage.includes('math') || lowerMessage.includes('calculus') || lowerMessage.includes('algebra')) {
    return "Mathematics can be challenging! I can help explain concepts, work through problems step by step, or provide practice questions. What specific math topic are you working on?";
  }
  
  if (lowerMessage.includes('science') || lowerMessage.includes('physics') || lowerMessage.includes('chemistry') || lowerMessage.includes('biology')) {
    return "Science is fascinating! I can help explain scientific concepts, break down complex processes, or provide study resources. What specific science topic interests you?";
  }
  
  if (lowerMessage.includes('history') || lowerMessage.includes('social studies')) {
    return "History helps us understand our world! I can explain historical events, provide timelines, or discuss important figures and their impacts. What historical period or event are you studying?";
  }
  
  if (lowerMessage.includes('english') || lowerMessage.includes('literature') || lowerMessage.includes('writing')) {
    return "Language arts are essential! I can help with reading comprehension, writing techniques, literary analysis, or grammar. What specific area would you like assistance with?";
  }
  
  // General educational responses
  const studyResponses = [
    "I'm here to help you learn! Feel free to ask me to explain concepts, generate practice questions, help with exam prep, or summarize study materials.",
    "As your study buddy, I can break down complex topics, create practice exercises, or help you review for tests. What would you like to work on?",
    "Learning is more effective with support! I can assist with understanding difficult concepts, creating study guides, or preparing for assessments.",
    "Education is a journey! I'm here to make it easier by explaining concepts clearly, providing practice opportunities, and supporting your study efforts."
  ];
  
  return studyResponses[Math.floor(Math.random() * studyResponses.length)];
}
// Show typing indicator for AI
function showAITypingIndicator() {
  hideAITypingIndicator();
  const typingDiv = document.createElement('div');
  typingDiv.className = 'typing-indicator ai';
  typingDiv.id = 'ai-typing-indicator';
  typingDiv.innerHTML = `
    <div class="sender-name">${AI_USER_NAME}</div>
    <div class="typing-dots">
      <div class="typing-dot"></div>
      <div class="typing-dot"></div>
      <div class="typing-dot"></div>
    </div>
  `;
  messagePanel.appendChild(typingDiv);
  messagePanel.scrollTop = messagePanel.scrollHeight;
}
// Hide typing indicator for AI
function hideAITypingIndicator() {
  const typingIndicator = document.getElementById('ai-typing-indicator');
  if (typingIndicator) {
    typingIndicator.remove();
  }
}
// ---------- MODAL FUNCTIONS ----------
function showEditMessageModal(messageId, currentContent) {
  editingMessage = messageId;
  editMessageInput.value = currentContent;
  editMessageModal.classList.add('visible');
  editMessageInput.focus();
}
function showDeleteMessageModal(messageId) {
  deletingMessage = messageId;
  deleteMessageModal.classList.add('visible');
}
function closeModals() {
  editMessageModal.classList.remove('visible');
  deleteMessageModal.classList.remove('visible');
  shareGroupModal.classList.remove('visible');
  editingMessage = null;
  deletingMessage = null;
}
editMessageConfirm.onclick = async () => {
  if (!editingMessage) return;
  const newContent = editMessageInput.value.trim();
  if (newContent) {
    const { error } = await supabase
      .from('group_messages')
      .update({ content: newContent })
      .eq('id', editingMessage)
      .eq('sender_id', user.id);
  
    if (error) {
      alert('Error updating message: ' + error.message);
    } else {
      await loadHistory();
    }
  }
  closeModals();
};
// UPDATED: Admin can delete any message
deleteMessageConfirm.onclick = async () => {
  if (!deletingMessage) return;
  let query = supabase
    .from('group_messages')
    .delete()
    .eq('id', deletingMessage);
  if (userRole === 'member') {
    query = query.eq('sender_id', user.id);
  }
  const { error } = await query;
  if (error) {
    alert('Error deleting message: ' + error.message);
  } else {
    await loadHistory();
  }
  closeModals();
};
editMessageCancel.onclick = closeModals;
deleteMessageCancel.onclick = closeModals;
editMessageModal.addEventListener('click', (e) => {
  if (e.target === editMessageModal) closeModals();
});
deleteMessageModal.addEventListener('click', (e) => {
  if (e.target === deleteMessageModal) closeModals();
});
filePreviewCancel.onclick = () => {
  filePreviewModal.classList.remove('visible');
  stagedFile = null;
};
filePreviewSend.onclick = () => {
  if (stagedFile) {
    uploadAndSendFile(stagedFile);
  }
  filePreviewModal.classList.remove('visible');
  stagedFile = null;
};
// File sharing functionality
const fileInput = document.getElementById('fileInput');
fileShareButton.onclick = () => {
  fileInput.click();
};
fileInput.addEventListener('change', (e) => {
  const file = e.target.files[0];
    if (file) {
        stagedFile = file;
        showFilePreview(file);
    }
    e.target.value = ''; // Reset input
});
async function uploadAndSendFile(file) {
    if (!file) return;
    // 1. Create a placeholder message
    const { data: placeholderMessage, error: placeholderError } = await supabase.from('group_messages').insert({
        group_id: gid,
        sender_id: user.id,
        sender_name: user.user_metadata.firstName,
        content: 'Uploading...',
        message_type: 'uploading',
        file_name: file.name,
        file_size: file.size
    }).select().single();
    if (placeholderError) {
        console.error('Error creating placeholder message:', placeholderError);
        alert('Failed to start upload.');
        return;
    }
    render(placeholderMessage);
    try {
        const fileType = file.type.split('/')[0];
        let messageType = (fileType === 'image' || fileType === 'video') ? fileType : 'file';
        // 2. Upload the file to Supabase Storage with progress
        const fileExt = file.name.split('.').pop();
        const fileName = `${user.id}-${Date.now()}.${fileExt}`;
        const filePath = `group_files/${gid}/${fileName}`;
        const { data: uploadData, error: uploadError } = await supabase.storage
            .from('group_files')
            .upload(filePath, file, {
                cacheControl: '3600',
                upsert: false
            }, (event) => {
                if (event.type === 'progress') {
                    const percent = Math.round((event.loaded / event.total) * 100);
                    const progressBar = document.getElementById(`progress-${placeholderMessage.id}`);
                    const progressText = document.getElementById(`progress-text-${placeholderMessage.id}`);
                    if (progressBar) progressBar.style.width = `${percent}%`;
                    if (progressText) progressText.textContent = `${percent}%`;
                }
            });
        if (uploadError) throw uploadError;
        // 3. Get the public URL
        const { data: { publicUrl } } = supabase.storage.from('group_files').getPublicUrl(filePath);
        // 4. Update the placeholder message with the final file info
        const { error: updateError } = await supabase.from('group_messages')
            .update({
                content: publicUrl,
                message_type: messageType
            })
            .eq('id', placeholderMessage.id);
        if (updateError) throw updateError;
        // The real-time subscription will handle updating the UI from placeholder to final message
        await loadHistory(); // Force a reload to ensure UI is correct
    } catch (error) {
        console.error('Error uploading file:', error);
        alert('Failed to upload file. Please try again.');
        // Optionally, delete the placeholder message on failure
        await supabase.from('group_messages').delete().eq('id', placeholderMessage.id);
        document.querySelector(`.msg[data-id="${placeholderMessage.id}"]`)?.remove();
    }
}
voiceCallButton.onclick = () => alert('Starting voice call...');
videoCallButton.onclick = () => alert('Starting video call...');
// ---------- UPDATED GESTURES - OWN MESSAGES WITH LONG TAP AND DOUBLE TAP ----------
function attachGestures(el, mine, msg) {
  // Don't attach gestures for voice messages (they have their own delete button)
  if (msg.message_type === 'audio') return;
  let startX, startY, isSwiping = false;
  let longTapTimer;
  let lastTapTime = 0;
  let tapCount = 0;
  const swipeIndicator = document.createElement('div');
  swipeIndicator.className = 'swipe-indicator';
  swipeIndicator.innerHTML = '<i class="fas fa-reply"></i><span>Reply</span>';
  el.appendChild(swipeIndicator);
  const handleStart = (x, y) => {
    startX = x;
    startY = y;
    isSwiping = false;
  
    // Set up long tap timer (0.5 seconds) for own messages or admin
    if (mine || userRole !== 'member') {
      longTapTimer = setTimeout(() => {
        showDeleteMessageModal(msg.id);
      }, 500);
    }
  };
  const handleMove = (x, y) => {
    const deltaX = x - startX;
    const deltaY = Math.abs(y - startY);
  
    // Clear long tap timer if swiping
    if (Math.abs(deltaX) > 10) {
      clearTimeout(longTapTimer);
    }
  
    if (deltaX > 15 && deltaY < 50 && !isSwiping) {
      isSwiping = true;
      el.classList.add('swiping');
      swipeIndicator.classList.add('show');
    }
  
    if (isSwiping) {
      const swipeProgress = Math.min(deltaX / 100, 1);
      const translateX = -60 * swipeProgress;
      el.style.transform = `translateX(${translateX}px)`;
    
      if (deltaX > 100) {
        startReply(msg);
        resetSwipe(el, swipeIndicator);
      }
    }
  };
  const handleEnd = () => {
    clearTimeout(longTapTimer);
  
    if (isSwiping) {
      el.style.transition = 'transform 0.3s ease';
      el.style.transform = 'translateX(0)';
    
      setTimeout(() => {
        resetSwipe(el, swipeIndicator);
      }, 300);
    }
  
    isSwiping = false;
  };
  const handleTap = () => {
    const currentTime = new Date().getTime();
    const tapLength = currentTime - lastTapTime;
  
    if (tapLength < 300 && tapCount === 1) {
      // Double tap detected for own messages
      if (mine) {
        showEditMessageModal(msg.id, msg.content);
      }
      tapCount = 0;
    } else {
      tapCount = 1;
    }
  
    lastTapTime = currentTime;
  };
  const resetSwipe = (element, indicator) => {
    element.classList.remove('swiping');
    indicator.classList.remove('show');
    element.style.transform = '';
    element.style.transition = '';
  };
  el.addEventListener('mousedown', (e) => {
    if (e.button !== 0) return;
    handleStart(e.clientX, e.clientY);
    document.addEventListener('mousemove', handleMouseMove);
    document.addEventListener('mouseup', handleMouseUp);
  });
  function handleMouseMove(e) {
    if (isSwiping || Math.abs(e.clientX - startX) > 10) {
      handleMove(e.clientX, e.clientY);
    }
  }
  function handleMouseUp() {
    handleEnd();
    document.removeEventListener('mousemove', handleMouseMove);
    document.removeEventListener('mouseup', handleMouseUp);
  }
  el.addEventListener('touchstart', (e) => {
    handleStart(e.touches[0].clientX, e.touches[0].clientY);
  });
  el.addEventListener('touchmove', (e) => {
    if (isSwiping || Math.abs(e.touches[0].clientX - startX) > 10) {
      handleMove(e.touches[0].clientX, e.touches[0].clientY);
    }
  });
  el.addEventListener('touchend', handleEnd);
  // Add click/tap listener for double tap detection
  el.addEventListener('click', handleTap);
}
// Special gesture for deleting own voice messages
function attachDeleteGesture(el, msg) {
  let longTapTimer;
  const handleStart = () => {
    // Set up long tap timer (0.8 seconds) for own voice messages or admin
    if (msg.sender_id === user.id || userRole !== 'member') {
      longTapTimer = setTimeout(() => {
        showDeleteMessageModal(msg.id);
      }, 800);
    }
  };
  const handleEnd = () => {
    clearTimeout(longTapTimer);
  };
  el.addEventListener('mousedown', handleStart);
  el.addEventListener('mouseup', handleEnd);
  el.addEventListener('mouseleave', handleEnd);
  el.addEventListener('touchstart', handleStart);
  el.addEventListener('touchend', handleEnd);
  el.addEventListener('touchcancel', handleEnd);
}
function startReply(msg) {
  replyingMsg = msg;
  replyContextSender.textContent = msg.sender_name;
  replyContextText.textContent = msg.content;
  replyContextBox.style.display = 'flex';
  const allMsgs = document.querySelectorAll('.msg');
  allMsgs.forEach(m => m.classList.remove('replying'));
  const repliedMsg = document.querySelector(`.msg[data-id="${msg.id}"]`);
  if (repliedMsg) {
    repliedMsg.classList.add('replying');
    setTimeout(() => {
      repliedMsg.classList.remove('replying');
    }, 2000);
  }
}
replyContextClose.onclick = () => {
  replyingMsg = null;
  replyContextBox.style.display = 'none';
};
// ---------- Lightbox Functionality ----------
const lightbox = document.getElementById('lightbox');
const lightboxContent = document.getElementById('lightboxContent');
const lightboxClose = document.getElementById('lightboxClose');
function openLightbox(src, type) {
  if (type === 'image') {
    lightboxContent.innerHTML = `<img src="${src}" alt="Lightbox image">`;
  } else if (type === 'video') {
    lightboxContent.innerHTML = `<video src="${src}" controls autoplay></video>`;
  }
  lightbox.classList.add('visible');
}
function closeLightbox() {
  lightbox.classList.remove('visible');
  // Stop video playback when closing
  lightboxContent.innerHTML = '';
}
lightboxClose.addEventListener('click', closeLightbox);
lightbox.addEventListener('click', (e) => {
  // Close if the user clicks on the blurred background, but not on the content itself
  if (e.target === lightbox) {
    closeLightbox();
  }
});
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape' && lightbox.classList.contains('visible')) {
    closeLightbox();
  }
});
// Make openLightbox globally available for onclick attributes
window.openLightbox = openLightbox;
// ---------- File Size Formatter ----------
function formatFileSize(bytes, decimals = 2) {
  if (bytes === 0) return '0 Bytes';
  const k = 1024;
  const dm = decimals < 0 ? 0 : decimals;
  const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
}
// Make formatFileSize globally available for use in template literals
window.formatFileSize = formatFileSize;
// Handle mobile keyboard visibility
function handleKeyboardVisibility() {
  if (window.visualViewport) {
    window.visualViewport.addEventListener('resize', () => {
      if (window.visualViewport.height < window.innerHeight * 0.8) {
        // Keyboard is visible
        messagePanel.style.height = 'calc(100vh - 180px)';
      } else {
        // Keyboard is hidden
        messagePanel.style.height = 'calc(100vh - 160px)';
      }
    });
  }
}
// Initialize keyboard handling
handleKeyboardVisibility();
// ---------- ADMIN PANEL FUNCTIONS ----------
function renderAdminActions() {
  let actionsHtml = `
    <button class="admin-action" data-action="members"><i class="fas fa-users"></i> 1. Add or Remove Members</button>
    <button class="admin-action" data-action="promote"><i class="fas fa-star"></i> 2. Promote or Demote Admins</button>
    <button class="admin-action" data-action="join"><i class="fas fa-check"></i> 3. Approve Join Requests</button>
    <button class="admin-action" data-action="editgroup"><i class="fas fa-edit"></i> 4. Edit Group Name, Description, and Cover Photo</button>
    <button class="admin-action" data-action="pin"><i class="fas fa-thumbtack"></i> 5. Pin or Unpin Messages</button>
    <button class="admin-action" data-action="mute"><i class="fas fa-volume-mute"></i> 6. Mute Members</button>
    <button class="admin-action" data-action="deleteMsg"><i class="fas fa-trash"></i> 7. Delete Messages for Everyone</button>
    <button class="admin-action" data-action="freeze"><i class="fas fa-pause"></i> 8. Freeze or Unfreeze Chat</button>
    <button class="admin-action" data-action="warn"><i class="fas fa-exclamation-triangle"></i> 9. Warn or Suspend Members</button>
    <button class="admin-action" data-action="log"><i class="fas fa-history"></i> 10. View Group Activity Log</button>
    <button class="admin-action" data-action="everyone"><i class="fas fa-at"></i> 11. Use @Everyone Mention</button>
    <button class="admin-action" data-action="broadcast"><i class="fas fa-bullhorn"></i> 12. Send Broadcast Announcements</button>
    <button class="admin-action" data-action="poll"><i class="fas fa-poll"></i> 13. Create and Manage Polls or Surveys</button>
    <button class="admin-action" data-action="schedule"><i class="fas fa-clock"></i> 14. Schedule Messages or Reminders</button>
    <button class="admin-action" data-action="rules"><i class="fas fa-rules"></i> 15. Keep Pinned Group Rules visible</button>
    <button class="admin-action" data-action="privacy"><i class="fas fa-lock"></i> 16. Set Group Privacy</button>
    <button class="admin-action" data-action="media"><i class="fas fa-image"></i> 17. Restrict Media Types</button>
    <button class="admin-action" data-action="frequency"><i class="fas fa-stopwatch"></i> 18. Limit Message Frequency</button>
    <button class="admin-action" data-action="categories"><i class="fas fa-tag"></i> 19. Add or Edit Group Categories or Tags</button>
    <button class="admin-action" data-action="reset"><i class="fas fa-refresh"></i> 20. Reset Chat or Clear History</button>
    <button class="admin-action" data-action="stats"><i class="fas fa-chart-bar"></i> 21. View Member Count and Simple Stats</button>
    <button class="admin-action" data-action="reports"><i class="fas fa-flag"></i> 22. View User Reports or Flagged Messages</button>
    <button class="admin-action" data-action="code"><i class="fas fa-qrcode"></i> 23. Create Custom Group Code for joining</button>
    <button class="admin-action" data-action="welcome"><i class="fas fa-comment-dots"></i> 24. Set Custom Welcome Message</button>
    <button class="admin-action" data-action="export"><i class="fas fa-download"></i> 25. Export Chat or Notes as text/PDF</button>
    <button class="admin-action" data-action="levels"><i class="fas fa-layer-group"></i> 26. Support Multiple Admin Levels</button>
    <button class="admin-action" data-action="reactions"><i class="fas fa-thumbs-up"></i> 27. Enable or Disable Emoji Reactions</button>
    <button class="admin-action" data-action="roles"><i class="fas fa-user-tag"></i> 28. Assign Member Role Tags</button>
    <button class="admin-action" data-action="pollhistory"><i class="fas fa-history"></i> 29. View Poll History</button>
    <button class="admin-action" data-action="approvejoin"><i class="fas fa-user-plus"></i> 30. Approve Member Join Notifications</button>
  `;
  // Add delete group if owner
  if (userRole === 'owner') {
    actionsHtml += `<button class="admin-action" style="background: rgba(255, 71, 87, 0.2); color: #ff4757; border: 1px solid rgba(255, 71, 87, 0.3);" data-action="deletegroup"><i class="fas fa-trash-alt"></i> Delete Group (Owner Only)</button>`;
  }
  document.getElementById('adminActions').innerHTML = actionsHtml;
  // Add event listeners
  document.querySelectorAll('.admin-action').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const action = e.currentTarget.dataset.action;
      handleAdminAction(action);
    });
  });
}
async function handleAdminAction(action) {
  switch (action) {
    case 'members':
    case 'promote':
      openDrawer(); // Use drawer for add/remove/promote/demote
      break;
    case 'editgroup':
      showEditGroupModal();
      break;
    case 'log':
      showActivityLog();
      break;
    case 'privacy':
      showPrivacyModal();
      break;
    case 'stats':
      showStats();
      break;
    case 'everyone':
      messageBar.value += '@everyone ';
      messageBar.focus();
      adminModal.classList.remove('visible');
      break;
    case 'broadcast':
      const broadcastMsg = prompt('Enter broadcast announcement:');
      if (broadcastMsg) {
        messageBar.value = `[ANNOUNCEMENT] ${broadcastMsg}`;
        sendMsg();
      }
      adminModal.classList.remove('visible');
      break;
    case 'reset':
      if (confirm('Clear all chat history? This cannot be undone.')) {
        supabase.from('group_messages').delete().eq('group_id', gid).then(() => {
          loadHistory();
          alert('Chat history cleared.');
        });
      }
      adminModal.classList.remove('visible');
      break;
    case 'export':
      exportChat();
      adminModal.classList.remove('visible');
      break;
    // FIXED: Full group deletion including related tables
    case 'deletegroup':
      if (confirm('Delete this group? This will remove all members, messages, and the group. Cannot be undone.')) {
        try {
          await supabase.from('group_messages').delete().eq('group_id', gid);
          await supabase.from('group_members').delete().eq('group_id', gid);
          await supabase.from('groups').delete().eq('id', gid);
          alert('Group deleted successfully.');
          window.location.href = 'dashboard.html';
        } catch (err) {
          alert('Error deleting group: ' + err.message);
        }
      }
      break;
    case 'deleteMsg':
      alert('Use long-press on any message to delete (admins can delete all).');
      break;
    case 'levels':
    case 'roles':
      alert('Multiple admin levels and role tags supported via role field (owner, admin, moderator, member). Use promote/demote in members list.');
      break;
    default:
      alert(`Feature "${action}" requires additional database schema updates (e.g., new tables/columns for polls, mutes, etc.). Coming soon.`);
  }
  adminModal.classList.remove('visible');
}
// Edit Group Modal
function showEditGroupModal() {
  const modal = document.createElement('div');
  modal.className = 'modal-backdrop visible';
  modal.style.zIndex = '2500';
  modal.innerHTML = `
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Edit Group Info</div>
        <div class="modal-description">Update name and description (cover photo requires DB update).</div>
      </div>
      <input type="text" class="modal-input" id="newName" value="${groupInfo.name}" placeholder="Group Name">
      <textarea class="modal-input" id="newDesc" rows="3" placeholder="Description">${groupInfo.description || ''}</textarea>
      <div class="modal-actions">
        <button class="modal-btn cancel" onclick="this.closest('.modal-backdrop').remove()">Cancel</button>
        <button class="modal-btn confirm" onclick="updateGroup(this)">Update</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
}
window.updateGroup = async (btn) => {
  const name = document.getElementById('newName').value.trim();
  const desc = document.getElementById('newDesc').value.trim();
  if (!name) return alert('Name required');
  const { error } = await supabase.from('groups').update({ name, description: desc }).eq('id', gid);
  if (error) {
    alert('Error: ' + error.message);
  } else {
    alert('Group updated!');
    location.reload();
  }
  btn.closest('.modal-backdrop').remove();
};
// Privacy Modal
function showPrivacyModal() {
  const modal = document.createElement('div');
  modal.className = 'modal-backdrop visible';
  modal.style.zIndex = '2500';
  const publicChecked = isPublic ? 'checked' : '';
  const privateChecked = !isPublic ? 'checked' : '';
  modal.innerHTML = `
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Set Group Privacy</div>
      </div>
      <label style="display: block; margin-bottom: 1rem;"><input type="radio" name="privacy" value="true" ${publicChecked}> Public (Anyone can join)</label>
      <label style="display: block;"><input type="radio" name="privacy" value="false" ${privateChecked}> Private (Invite-only)</label>
      <div class="modal-actions">
        <button class="modal-btn cancel" onclick="this.closest('.modal-backdrop').remove()">Cancel</button>
        <button class="modal-btn confirm" onclick="updatePrivacy(this)">Save</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
}
window.updatePrivacy = async (btn) => {
  const privacyVal = document.querySelector('input[name="privacy"]:checked').value;
  const isPublicNew = privacyVal === 'true';
  const { error } = await supabase.from('groups').update({ is_public: isPublicNew }).eq('id', gid);
  if (error) {
    alert('Error: ' + error.message);
  } else {
    alert('Privacy updated!');
    location.reload();
  }
  btn.closest('.modal-backdrop').remove();
};
// Activity Log
function showActivityLog() {
  let logHtml = '<h3 style="margin-bottom: 1rem;">Group Activity Log (Joins)</h3><ul style="list-style: none; padding: 0;">';
  memberDetails.forEach(m => {
    if (m.joined_at) {
      const name = getDisplayName(m);
      const date = new Date(m.joined_at).toLocaleString();
      logHtml += `<li style="padding: 0.5rem; border-bottom: 1px solid rgba(255,255,255,0.1);">${name} joined on ${date}</li>`;
    }
  });
  logHtml += '</ul>';
  const modal = document.createElement('div');
  modal.className = 'modal-backdrop visible';
  modal.style.zIndex = '2500';
  modal.innerHTML = `
    <div class="modal-content" style="max-height: 60vh; overflow-y: auto;">
      <div class="modal-header">
        <div class="modal-title">Activity Log</div>
      </div>
      <div style="font-size: 0.9rem;">${logHtml}</div>
      <div class="modal-actions">
        <button class="modal-btn cancel" onclick="this.closest('.modal-backdrop').remove()">Close</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
}
// Stats
async function showStats() {
  const memberCount = memberDetails.length;
  const { count: msgCount, error } = await supabase
    .from('group_messages')
    .select('*', { count: 'exact', head: true })
    .eq('group_id', gid);
  if (error) {
    alert(`Members: ${memberCount}\nMessages: Error loading`);
  } else {
    alert(`Member Count: ${memberCount}\nTotal Messages: ${msgCount || 0}\nPrivacy: ${isPublic ? 'Public' : 'Private'}`);
  }
}
// Export Chat
async function exportChat() {
  const { data: messages, error } = await supabase
    .from('group_messages')
    .select('*')
    .eq('group_id', gid)
    .order('created_at');
  if (error || !messages) {
    alert('Error exporting chat.');
    return;
  }
  let content = messages.map(m => {
    const sender = m.sender_name || 'Unknown';
    const time = new Date(m.created_at).toLocaleString();
    return `[${time}] ${sender}: ${m.content}`;
  }).join('\n');
  const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `${groupInfo.name || 'chat'}.txt`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  alert('Chat exported as TXT.');
}
  </script>
</body>
</html>
