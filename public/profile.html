<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PeerLoom Profile</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f7f7f7; }
    .profile-card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 0 10px rgba(0,0,0,0.1); width: 400px; margin: auto; }
    .avatar { width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 3px solid #333; }
    .glow-badge { display: inline-block; background: gold; color: white; border-radius: 12px; padding: 2px 8px; margin-right: 5px; box-shadow: 0 0 10px gold; font-size: 0.8em; }
    .chat-preview { background: #e9e9e9; padding: 10px; margin-top: 10px; border-radius: 10px; }
    .edit-section { display: flex; gap: 8px; margin-top: 8px; }
  </style>
</head>
<body>
  <div class="profile-card">
    <h2 id="userName">👤 </h2>
    <img id="userAvatar" class="avatar" src="" alt="Profile Picture"/>
    <input type="file" id="avatarInput" accept="image/*" style="display:none"/>
    <button onclick="document.getElementById('avatarInput').click()">Change Avatar</button>

    <p><strong>Course:</strong> <span id="userCourse"></span></p>
    <p><strong>Index Number:</strong> <span id="userIndex"></span></p>
    <p><strong>Joined:</strong> <span id="sinceDate"></span></p>

    <p><strong>Groups Joined:</strong> <span id="groupsCount"></span></p>
    <p><strong>Connections:</strong> <span id="connectionsCount"></span></p>

    <div>
      <strong>Bio:</strong>
      <p id="bioDisplay"></p>
      <textarea id="bioEdit" style="display:none;"></textarea>
      <div class="edit-section">
        <button id="editBtn">Edit</button>
        <button id="saveBtn" style="display:none;">Save</button>
      </div>
    </div>

    <div id="badgesSection">
      <strong>Badges:</strong>
      <span id="badgesContainer"></span>
    </div>

    <div>
      <strong>Group Chat Previews:</strong>
      <div id="chatPreviews"></div>
    </div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    const supabase = createClient(
      'https://mdofjippejpqylwuzsqp.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1kb2ZqaXBwZWpwcXlsd3V6c3FwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI2NjcyNzAsImV4cCI6MjA2ODI0MzI3MH0.PKtUqmGKciAQH3f_kz2q9VeYSdOcYHQDCJFu6UHcAw4'
    );

    const sessionRes = await supabase.auth.getSession();
    const session = sessionRes.data.session;
    if (!session) location.href = "index.html";

    const user = session.user;

    const { data: profile, error } = await supabase
      .from('profiles')
      .select('*')
      .eq('id', user.id)
      .single();

    if (error) {
      alert("Failed to fetch profile: " + error.message);
    }

    document.getElementById('userName').textContent += profile.full_name || user.email;
    document.getElementById('userCourse').textContent = profile.course || 'Unknown';
    document.getElementById('userIndex').textContent = profile.index_number || 'N/A';
    document.getElementById('sinceDate').textContent = new Date(profile.created_at).toLocaleDateString();
    document.getElementById('groupsCount').textContent = profile.groups_joined || 0;
    document.getElementById('connectionsCount').textContent = profile.connections || 0;

    document.getElementById('bioDisplay').textContent = profile.bio || '';
    document.getElementById('bioEdit').value = profile.bio || '';

    const avatarImg = document.getElementById('userAvatar');
    if (profile.avatar_url) {
      avatarImg.src = profile.avatar_url;
    } else {
      avatarImg.src = 'https://placehold.co/120x120?text=User';
    }

    // 🔄 Bio editing logic
    const editBtn = document.getElementById('editBtn');
    const saveBtn = document.getElementById('saveBtn');
    const bioDisplay = document.getElementById('bioDisplay');
    const bioEdit = document.getElementById('bioEdit');

    editBtn.onclick = () => {
      bioDisplay.style.display = "none";
      bioEdit.style.display = "block";
      editBtn.style.display = "none";
      saveBtn.style.display = "inline-block";
    };

    saveBtn.onclick = async () => {
      const { error: updateError } = await supabase
        .from('profiles')
        .update({ bio: bioEdit.value })
        .eq('id', user.id);

      if (updateError) return alert("Bio update failed: " + updateError.message);

      bioDisplay.textContent = bioEdit.value;
      bioDisplay.style.display = "block";
      bioEdit.style.display = "none";
      saveBtn.style.display = "none";
      editBtn.style.display = "inline-block";
    };

    // 🏷️ Badges
    const badgeContainer = document.getElementById('badgesContainer');
    (profile.badges || []).forEach(badge => {
      const span = document.createElement('span');
      span.className = 'glow-badge';
      span.textContent = badge;
      badgeContainer.appendChild(span);
    });

    // 🗨️ Group chat previews
    const { data: chats } = await supabase
      .from('group_chats')
      .select('name, last_message')
      .eq('user_id', user.id)
      .limit(3);

    const chatPreviews = document.getElementById('chatPreviews');
    if (chats && chats.length > 0) {
      chats.forEach(chat => {
        const div = document.createElement('div');
        div.className = 'chat-preview';
        div.innerHTML = `<strong>${chat.name}</strong><br>${chat.last_message || "No recent message"}`;
        chatPreviews.appendChild(div);
      });
    } else {
      chatPreviews.innerHTML = "<p>No group chats joined yet.</p>";
    }

    // 🖼️ Avatar Upload
    document.getElementById('avatarInput').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      const filePath = `${user.id}/${Date.now()}-${file.name}`;
      const { data, error: uploadErr } = await supabase.storage
        .from('avatars')
        .upload(filePath, file, { upsert: true });

      if (uploadErr) return alert("Upload error: " + uploadErr.message);

      const { data: publicUrl } = supabase.storage
        .from('avatars')
        .getPublicUrl(filePath);

      await supabase
        .from('profiles')
        .update({ avatar_url: publicUrl.publicUrl })
        .eq('id', user.id);

      avatarImg.src = publicUrl.publicUrl;
    });
  </script>
</body>
</html>
