<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile - Peerloom</title>
    <link rel="icon" href="/android-chrome-192x192.png" sizes="192x192" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js"></script>
</head>
<body class="bg-gray-100">

    <!-- Profile container -->
    <div class="max-w-md mx-auto mt-10 bg-white shadow-lg rounded-2xl p-6">
        <div class="flex flex-col items-center">
            <div id="avatar" class="w-24 h-24 rounded-full bg-gray-200 flex items-center justify-center mb-4">
                <span class="text-gray-400">No Image</span>
            </div>
            <input type="file" id="avatar-upload" class="hidden" accept="image/*">
            <button onclick="document.getElementById('avatar-upload').click()" class="text-blue-500 text-sm mb-4">Change Avatar</button>

            <h2 id="full_name" class="text-xl font-semibold"></h2>
            <p id="level" class="text-gray-600"></p>
            <p id="campus" class="text-gray-600"></p>
            <p id="department" class="text-gray-600"></p>
            <p id="bio" class="text-gray-500 italic mt-2"></p>

            <div id="verified" class="mt-2"></div>

            <div class="mt-4 w-full">
                <h3 class="font-semibold mb-2">Groups Joined:</h3>
                <ul id="groups" class="list-disc pl-6 text-gray-700"></ul>
            </div>
        </div>
    </div>

    <script>
        const supabaseUrl = "https://hktvulwosprmltvcldci.supabase.co";
        const supabaseKey = "YOUR_PUBLIC_ANON_KEY"; // replace with your real anon key
        const supabase = supabase.createClient(supabaseUrl, supabaseKey);

        document.addEventListener("DOMContentLoaded", async () => {
            await loadProfile();
            document.getElementById('avatar-upload').addEventListener('change', uploadAvatar);
        });

        async function loadProfile() {
            const { data: { user }, error: userError } = await supabase.auth.getUser();
            if (userError || !user) {
                console.error("User fetch error:", userError);
                alert("User not logged in");
                return;
            }

            // ✅ include verified + privacy so they’re available
            const { data: profile, error: profileError } = await supabase
                .from('profiles')
                .select('full_name, level, campus, department, bio, verified, privacy')
                .eq('id', user.id)
                .single();

            if (profileError) {
                console.error("Profile fetch error:", profileError);
                alert("Error loading profile");
                return;
            }

            document.getElementById("full_name").innerText = profile.full_name || "No Name";
            document.getElementById("level").innerText = profile.level || "No Level";
            document.getElementById("campus").innerText = profile.campus || "No Campus";
            document.getElementById("department").innerText = profile.department || "No Department";
            document.getElementById("bio").innerText = profile.bio || "No Bio";

            // ✅ verified check
            if (profile.verified) {
                document.getElementById("verified").innerHTML =
                    '<span class="text-green-500 font-bold">✔ Verified</span>';
            }

            // ✅ groups query
            const { data: groups, error: groupsError } = await supabase
                .from('group_members')
                .select('groups(name)')
                .eq('user_id', user.id);

            if (groupsError) {
                console.error("Groups fetch error:", groupsError);
                return;
            }

            const groupsList = document.getElementById("groups");
            groupsList.innerHTML = "";
            if (groups && groups.length > 0) {
                groups.forEach(g => {
                    const li = document.createElement("li");
                    li.innerText = g.groups?.name || "Unnamed Group";
                    groupsList.appendChild(li);
                });
            } else {
                groupsList.innerHTML = "<li>No Groups Joined</li>";
            }
        }

        async function uploadAvatar(event) {
            const file = event.target.files[0];
            if (!file) return;

            const { data: { user }, error: userError } = await supabase.auth.getUser();
            if (userError || !user) {
                console.error("User fetch error:", userError);
                return;
            }

            const filePath = `public/${user.id}/${Date.now()}_${file.name}`;
            const { error: uploadError } = await supabase.storage
                .from("avatars")
                .upload(filePath, file, { upsert: true });

            if (uploadError) {
                console.error("Upload error:", uploadError);
                return;
            }

            const { data: publicUrlData } = supabase.storage
                .from("avatars")
                .getPublicUrl(filePath);

            if (publicUrlData?.publicUrl) {
                document.getElementById("avatar").innerHTML =
                    `<img src="${publicUrlData.publicUrl}" alt="Avatar" class="w-24 h-24 rounded-full">`;
            }
        }
    </script>
</body>
</html>
