<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Profile Page</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100">
  <!-- Navbar -->
  <nav class="p-4 bg-white dark:bg-gray-800 shadow flex justify-between items-center">
    <h1 class="text-xl font-bold">Profile</h1>
    <button id="darkToggle" class="px-3 py-1 rounded bg-gray-200 dark:bg-gray-700">ðŸŒ™</button>
  </nav>

  <!-- Cover + Avatar -->
  <section class="relative">
    <div class="h-40 bg-gradient-to-r from-indigo-500 to-purple-600"></div>
    <div class="absolute -bottom-12 left-1/2 transform -translate-x-1/2">
      <label class="cursor-pointer">
        <input type="file" class="hidden" onchange="uploadAvatar(event)">
        <div id="avatar" class="w-24 h-24 rounded-full border-4 border-white overflow-hidden bg-gray-300 flex items-center justify-center">
          <span class="text-xl font-bold">?</span>
        </div>
      </label>
    </div>
  </section>

  <!-- Profile Info -->
  <section class="mt-16 p-6 text-center">
    <h2 id="fullName" class="text-2xl font-bold">Loading...</h2>
    <p id="username" class="text-sm text-gray-500">@username</p>
    <p id="bio" class="mt-2 text-gray-700 dark:text-gray-300"></p>
    <button id="editBioBtn" class="mt-2 px-3 py-1 rounded bg-indigo-500 text-white">Edit Bio</button>

    <!-- Verified Badge -->
    <div id="verifiedBadge" class="mt-2 hidden text-green-600 font-semibold">âœ” Verified</div>
  </section>

  <!-- Academic Details -->
  <section class="mt-8 px-6">
    <h3 class="font-semibold mb-2">Academic Details</h3>
    <div id="academicDetails" class="bg-white dark:bg-gray-800 rounded-lg p-4 shadow"></div>
    <button id="editAcademicBtn" class="mt-2 px-3 py-1 rounded bg-indigo-500 text-white">Edit Details</button>
  </section>

  <!-- Groups -->
  <section class="mt-8 px-6">
    <h3 class="font-semibold mb-2">Groups</h3>
    <ul id="groupsList" class="bg-white dark:bg-gray-800 rounded-lg p-4 shadow space-y-2"></ul>
  </section>

  <script>
    const supabase = supabase.createClient("YOUR_SUPABASE_URL", "YOUR_SUPABASE_ANON_KEY");

    let currentUser = null;

    // Load profile on start
    document.addEventListener("DOMContentLoaded", async () => {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        alert("Please log in");
        return;
      }
      currentUser = user;
      loadProfile();
    });

    // Load profile data
    async function loadProfile() {
      const { data: profile, error } = await supabase
        .from("profiles")
        .select("full_name, username, bio, campus, level, department, verified, profile_photo")
        .eq("id", currentUser.id)
        .single();

      if (error || !profile) {
        console.error("Profile load error:", error);
        return;
      }

      // Fill fields
      document.getElementById("fullName").innerText = profile.full_name || "Unnamed";
      document.getElementById("username").innerText = profile.username ? `@${profile.username}` : "";
      document.getElementById("bio").innerText = profile.bio || "No bio yet.";
      if (profile.profile_photo) {
        document.getElementById("avatar").innerHTML = `<img src="${profile.profile_photo}" class="w-full h-full object-cover" />`;
      } else {
        document.getElementById("avatar").innerHTML = `<span class="text-xl font-bold">${profile.full_name?.charAt(0) || "?"}</span>`;
      }
      document.getElementById("verifiedBadge").classList.toggle("hidden", !profile.verified);

      // Academic details
      document.getElementById("academicDetails").innerHTML = `
        <p><strong>Campus:</strong> ${profile.campus || "N/A"}</p>
        <p><strong>Level:</strong> ${profile.level || "N/A"}</p>
        <p><strong>Department:</strong> ${profile.department || "N/A"}</p>
      `;

      // Groups
      const { data: groups } = await supabase
        .from("group_members")
        .select("groups(name)")
        .eq("user_id", currentUser.id);

      const groupsList = document.getElementById("groupsList");
      groupsList.innerHTML = "";
      groups?.forEach(g => {
        groupsList.innerHTML += `<li class="p-2 rounded bg-gray-100 dark:bg-gray-700">${g.groups.name}</li>`;
      });
    }

    // Edit Bio
    document.getElementById("editBioBtn").addEventListener("click", () => {
      const bioEl = document.getElementById("bio");
      const currentBio = bioEl.innerText;
      bioEl.innerHTML = `<textarea id="bioInput" class="w-full p-2 rounded border">${currentBio}</textarea>
                         <button onclick="saveBio()" class="mt-2 px-3 py-1 bg-green-500 text-white rounded">Save</button>`;
    });

    async function saveBio() {
      const newBio = document.getElementById("bioInput").value;
      await supabase.from("profiles").update({ bio: newBio }).eq("id", currentUser.id);
      loadProfile();
    }

    // Edit Academic Details
    document.getElementById("editAcademicBtn").addEventListener("click", () => {
      const container = document.getElementById("academicDetails");
      const currentValues = Array.from(container.querySelectorAll("p")).map(p => p.innerText.split(": ")[1]);
      container.innerHTML = `
        <input value="${currentValues[0] || ""}" class="w-full p-2 rounded border mb-2" placeholder="Campus" />
        <input value="${currentValues[1] || ""}" class="w-full p-2 rounded border mb-2" placeholder="Level" />
        <input value="${currentValues[2] || ""}" class="w-full p-2 rounded border mb-2" placeholder="Department" />
        <button onclick="saveAcademicDetails()" class="mt-2 px-3 py-1 bg-green-500 text-white rounded">Save</button>
      `;
    });

    async function saveAcademicDetails() {
      const inputs = document.querySelectorAll("#academicDetails input");
      const [campus, level, department] = Array.from(inputs).map(i => i.value.trim());
      await supabase.from("profiles").update({ campus, level, department }).eq("id", currentUser.id);
      loadProfile();
    }

    // Avatar Upload
    async function uploadAvatar(event) {
      const file = event.target.files[0];
      if (!file) return;

      const filePath = `${currentUser.id}/${Date.now()}_${file.name}`;
      const { error } = await supabase.storage.from("avatars").upload(filePath, file, { upsert: true });
      if (error) {
        console.error("Upload error:", error.message);
        alert("Error uploading avatar.");
      } else {
        const { data } = supabase.storage.from("avatars").getPublicUrl(filePath);
        await supabase.from("profiles").update({ profile_photo: data.publicUrl }).eq("id", currentUser.id);
        loadProfile();
      }
    }

    // Dark Mode
    document.getElementById("darkToggle").addEventListener("click", () => {
      document.documentElement.classList.toggle("dark");
    });
  </script>
</body>
</html>
