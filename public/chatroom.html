<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PeerLoom Chat</title>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script type="module" src="js/supabaseClient.js"></script>
<style>
  /* Global & theming */
  :root {
    --bg: #0e0e16;
    --panel: rgba(255,255,255,0.06);
    --text: #e5e7eb;
    --accent: #7c3aed;
    --accent-light: #4f46e5;
    --sent-bg: linear-gradient(135deg,#7c3aed,#4f46e5);
    --rec-bg: rgba(255,255,255,0.1);
  }
  [data-theme="light"] {
    --bg: #f3f4f6;
    --panel: rgba(255,255,255,0.8);
    --text: #1f2937;
    --accent: #7c3aed;
    --accent-light: #4f46e5;
    --sent-bg: linear-gradient(135deg,#7c3aed,#4f46e5);
    --rec-bg: rgba(255,255,255,0.9);
  }
  * { margin:0;padding:0;box-sizing:border-box; }
  body {
    background: var(--bg);
    color: var(--text);
    font-family:'Inter',sans-serif;
    display:flex;justify-content:center;align-items:center;
    height:100vh;
  }
  .container {
    width:90%;max-width:900px;height:90vh;
    display:flex;flex-direction:column;
    backdrop-filter:blur(16px);
    background:var(--panel);
    border-radius:16px;
    overflow:hidden;
  }
  .header {
    flex:none;padding:1rem;
    display:flex;justify-content:space-between;align-items:center;
    backdrop-filter:blur(10px); background:var(--panel);
  }
  .header h1 { font-size:1.25rem; }
  .toggle-btn {
    background:transparent;border:none;
    font-size:1.25rem;cursor:pointer;color:var(--text);
  }
  .chat-body {
    flex:1;display:flex;flex-direction:column;
    padding:1rem;overflow-y:auto;
  }
  .bubble {
    max-width:75%; padding:0.75rem;
    margin-bottom:0.5rem; border-radius:12px;
    backdrop-filter:blur(6px); position:relative;
    user-select:none; touch-action:pan-y;
    transition:transform .2s ease;
  }
  .bubble.mine {
    align-self:flex-end; background:var(--sent-bg); color:#fff;
  }
  .bubble.theirs {
    align-self:flex-start; background:var(--rec-bg); color:var(--text);
  }
  .reply-banner {
    font-size:.875rem;color:var(--text);
    padding-left:8px; border-left:3px solid var(--accent-light);
    margin-bottom:4px;
  }
  .timestamp {
    font-size:.75rem;color:var(--text);
    text-align:right;margin-top:4px;
  }
  .emoji-picker {
    position:absolute;bottom:60px;left:1rem;
    background:var(--panel); padding:0.5rem;
    display:flex;flex-wrap:wrap;gap:5px;
    border-radius:8px;
    backdrop-filter:blur(10px);
  }
  .mention-dropdown {
    position:absolute;top:-150px;left:1rem;
    background:var(--panel);padding:0.5rem;
    border-radius:8px;backdrop-filter:blur(10px);
    display:flex;flex-direction:column;
    gap:4px;
  }
  .mention-dropdown div {
    padding:4px 8px;
    border-radius:4px;
    cursor:pointer;
  }
  .mention-dropdown div:hover {
    background:var(--accent);
    color:#fff;
  }
  .footer {
    flex:none;padding:1rem;backdrop-filter:blur(10px);
    background:var(--panel);position:relative;
  }
  .reply-box {
    display:flex;justify-content:space-between;
    align-items:center;padding:0.5rem 0.75rem;
    background:rgba(0,0,0,0.1);border-left:4px solid var(--accent);
    margin-bottom:0.5rem;border-radius:8px;
  }
  .reply-box button {
    background:transparent;border:none;color:var(--text);
    font-size:1.25rem;cursor:pointer;
  }
  .footer textarea {
    width:100%;height:60px;border:none;
    border-radius:12px;padding:.75rem;
    resize:none;background:var(--bg);
    color:var(--text);font-size:1rem;
  }
  .footer .actions {
    margin-top:0.5rem;display:flex;justify-content:space-between;
  }
  .footer button {
    background:var(--accent);color:#fff;
    border:none;padding:.5rem 1rem;border-radius:8px;
    cursor:pointer;transition:background .2s;
  }
  .footer button:hover {
    background:var(--accent-light);
  }
</style>
</head>
<body>
<div class="container" data-theme="dark">
  <div class="header">
    <h1 id="groupName">Group Chat</h1>
    <button class="toggle-btn" id="themeToggle">🌙</button>
  </div>
  <div class="chat-body" id="chatBody"></div>
  <div class="footer">
    <div id="replyBox" class="reply-box hidden">
      <span id="replyLabel"></span>
      <button id="cancelReply">&times;</button>
    </div>
    <div class="mention-dropdown hidden" id="mentionDropdown"></div>
    <textarea id="chatMessage" placeholder="Type your message..."></textarea>
    <div class="actions">
      <button id="emojiBtn">😄</button>
      <button id="sendBtn">Send</button>
    </div>
    <div class="emoji-picker hidden" id="emojiPicker">😀😁😂😎🥳😍😢😡👏💯</div>
  </div>
</div>

<script type="module">
import { supabase } from './js/supabaseClient.js'
const userRes = await supabase.auth.getSession()
if (!userRes.data.session) location='login.html'
const user = userRes.data.session.user
const params = new URLSearchParams(location.search)
const gid = params.get('groupId')
let replyingTo = null, members = []

// Theme toggle
const container = document.querySelector('.container')
const themeToggle = document.getElementById('themeToggle')
const saveTheme = theme => {
  container.setAttribute('data-theme', theme)
  themeToggle.textContent = theme==='dark'?'🌙':'☀️'
  localStorage.setItem('pl-theme', theme)
}
const initTheme = () => {
  const t = localStorage.getItem('pl-theme') || 'dark'
  saveTheme(t)
}
themeToggle.onclick = () => saveTheme(container.getAttribute('data-theme')==='dark'?'light':'dark')
initTheme()

// Elements
const chatBody = document.getElementById('chatBody')
const chatMessage = document.getElementById('chatMessage')
const emojiBtn = document.getElementById('emojiBtn')
const emojiPicker = document.getElementById('emojiPicker')
const mentionDropdown = document.getElementById('mentionDropdown')
const sendBtn = document.getElementById('sendBtn')
const replyBox = document.getElementById('replyBox')
const replyLabel = document.getElementById('replyLabel')
const cancelReply = document.getElementById('cancelReply')

// Fetch group + members
const grp = await supabase.from('groups').select('*').eq('id',gid).single()
document.getElementById('groupName').textContent = grp.data.name
const m = await supabase.from('group_members').select('users(*)').eq('group_id',gid)
members = m.data.map(r=>r.users)
mentionDropdown.innerHTML = members.map(u=>`<div>@${u.user_metadata.full_name}</div>`).join('')

// Message renders
function render(m){
  const mine = m.sender_id===user.id
  const msg = document.createElement('div')
  msg.className = 'bubble ' + (mine?'mine':'theirs')
  msg.dataset.id = m.id

  if (m.reply_to) {
    const ban = document.createElement('div')
    ban.className = 'reply-banner'
    ban.textContent = `${m.reply_to_sender}: ${m.reply_to_text}`
    msg.appendChild(ban)
  }

  msg.innerHTML += 
    `<div>${m.content}</div>
     <div class="timestamp">${new Date(m.created_at).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>`

  chatBody.appendChild(msg)
  chatBody.scrollTop = chatBody.scrollHeight

  attachGestures(msg, mine, m)
}

// Load existing
let { data:history } = await supabase
  .from('group_messages')
  .select('*')
  .eq('group_id',gid)
  .order('created_at')
history?.forEach(render)

// Real-time
supabase.channel(`grp_${gid}`)
  .on('postgres_changes',{event:'INSERT',schema:'public',table:'group_messages',filter:`group_id=eq.${gid}`},
    payload => render(payload.new))
  .on('postgres_changes',{event:'UPDATE',schema:'public',table:'group_messages',filter:`group_id=eq.${gid}`},
    ({new:m}) => {
      const el = chatBody.querySelector(`[data-id="${m.id}"]`)
      if (el) el.querySelector('div').textContent = m.content
    })
  .on('postgres_changes',{event:'DELETE',schema:'public',table:'group_messages',filter:`group_id=eq.${gid}`},
    ({old:m}) => {
      const el = chatBody.querySelector(`[data-id="${m.id}"]`)
      if (el) el.remove()
    })
  .subscribe()

emojiBtn.onclick = () => emojiPicker.classList.toggle('hidden')
emojiPicker.onclick = e => {
  chatMessage.value += e.target.textContent
}
chatMessage.oninput = () => {
  const at = chatMessage.value.lastIndexOf('@')
  mentionDropdown.classList.toggle('hidden', at<0)
}
mentionDropdown.onclick = e => {
  if(e.target.tagName==='DIV'){
    const name = e.target.textContent
    const v = chatMessage.value
    const at = v.lastIndexOf('@')
    chatMessage.value = v.slice(0,at) + name + ' '
    mentionDropdown.classList.add('hidden')
  }
}
cancelReply.onclick = () => {
  replyingTo = null
  replyBox.classList.add('hidden')
}
sendBtn.onclick = async () => {
  const content = chatMessage.value.trim()
  if (!content) return
  await supabase.from('group_messages').insert({
    group_id:gid,
    sender_id:user.id,
    sender_name:user.user_metadata.full_name,
    content,
    reply_to: replyingTo?.id,
    reply_to_sender: replyingTo?.sender_name,
    reply_to_text: replyingTo?.content
  })
  chatMessage.value = ''
  replyingTo = null
  replyBox.classList.add('hidden')
}

// Gestures
function attachGestures(el, mine, msg){
  let startX, longT
  el.addEventListener('dblclick', ()=> {
    if (!mine) return
    const u = prompt('Edit message', msg.content)
    if (u && u!==msg.content){
      supabase.from('group_messages').update({content:u}).eq('id',msg.id)
    }
  })
  el.addEventListener('touchstart',e=>{
    if(!mine)return
    startX = e.touches[0].clientX
    longT = setTimeout(()=>{
      if(confirm('Delete?')){ supabase.from('group_messages').delete().eq('id',msg.id) }
    },800)
  })
  el.addEventListener('touchmove',e=>{
    const dx = e.touches[0].clientX - startX
    if (dx>100){
      replyingTo = msg
      replyLabel.textContent = `${msg.sender_name}: ${msg.content}`
      replyBox.classList.remove('hidden')
    }
  })
  el.addEventListener('touchend', ()=> clearTimeout(longT))
  el.addEventListener('mousedown',e=>{
    if(!mine)return
    startX = e.clientX
    longT = setTimeout(()=>{
      if(confirm('Delete?')){ supabase.from('group_messages').delete().eq('id',msg.id) }
    },800)
  })
  el.addEventListener('mousemove',e=>{
    if (e.buttons && e.clientX-startX>100){
      replyingTo = msg
      replyLabel.textContent = `${msg.sender_name}: ${msg.content}`
      replyBox.classList.remove('hidden')
    }
  })
  el.addEventListener('mouseup',()=>clearTimeout(longT))
}
</script>
</body>
</html>
